<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#androidhealth-1-0-hidl">Android弃用health&#64;1.0 HIDL</a></li>
<li><a class="reference internal" href="#id2">术语</a></li>
<li><a class="reference internal" href="#id3">参考</a></li>
<li><a class="reference internal" href="#id4">软件架构</a></li>
<li><a class="reference internal" href="#id5">涉及文件</a></li>
<li><a class="reference internal" href="#id6">软件流程</a></li>
<li><a class="reference internal" href="#hidl">HIDL服务注册</a></li>
<li><a class="reference internal" href="#initpsy">Init获取所有psy属性节点的路径</a></li>
<li><a class="reference internal" href="#id7">上报流程</a></li>
<li><a class="reference internal" href="#healthd-2-1">Healthd 2.1要求</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>高通A6650 healthd 守护进程分析。</p>
<p>Android 9 引入了从 health&#64;1.0 HAL 升级的主要版本 android.hardware.health HAL 2.0。这一新 HAL 具有以下优势：</p>
<ul class="simple">
<li><p>框架代码和供应商代码之间的区别更清楚。</p></li>
<li><p>弃用了不必要的 healthd 守护程序。</p></li>
<li><p>供应商对运行状况信息报告进行自定义的自由度更高。</p></li>
<li><p>更多设备运行状况信息（不仅包括电池信息）。</p></li>
</ul>
<p>Android 11 包含 android.hardware.health HAL 2.1，这是一个从 health&#64;2.0 HAL 升级的次要版本。这一新 HAL 具有以下优势：</p>
<ul class="simple">
<li><p>更易于实现</p></li>
<li><p>更好地与现有 2.0 HAL API 保持一致</p></li>
<li><p>在关机模式充电代码中可以实现更好的 Treble 分离</p></li>
<li><p>更好地支持框架来指示设备的电池运行状况</p></li>
</ul>
<p>在 Android 11 中，所有healthd代码都被重构为libhealthloop和libhealth2impl ，然后进行修改以实现 health&#64;2.1 HAL。
这两个库由health&#64;2.0-impl-2.1静态链接，health&#64;2.0-impl-2.1 是 health 2.1 的直通实现。静态链接库使health&#64;2.0-impl-2.1能够执行与healthd相同的工作，例如运行healthd_mainloop和轮询。在 init 中， health&#64;2.1-service将接口IHealth的实现注册到hwservicemanager 。升级具有 Android 8.x 或 9 供应商映像和 Android 11 框架的设备时，供应商映像可能不提供 health&#64;2.1 服务。</p>
<p><img alt="0014_0005.png" src="../../../_images/0014_0005.png" /></p>
</section>
<section id="androidhealth-1-0-hidl">
<h1>Android弃用health&#64;1.0 HIDL<a class="headerlink" href="#androidhealth-1-0-hidl" title="此标题的永久链接"></a></h1>
<p>Framework 将继续使用health&#64;1.0直到按标准HAL弃用计划完全弃用为止 。当health&#64;1.0被弃用（条目从 框架兼容性矩阵除去）， healthd和libbatterymonitor必须也系统中除去，以避免未知的healthd行为。由于health&#64;1.0是一个可选的HAL，并且所有 healthd对health&#64;1.0的依赖都受到NULL检查的保护，因此在弃用时不应该中断。</p>
<p>当Android删除旧代码路径（healthd，health&#64;1.0）时，按弃用计划Health&#64;1.0 HAL将被弃用。此外，Android还删除了以下内容：</p>
<ul class="simple">
<li><p>Framework 中的healthd依赖</p></li>
<li><p>healthd</p></li>
<li><p>系统中 health&#64;1.0的HAL定义库</p></li>
<li><p>Framework 兼容性矩阵中的health&#64;1.0条目</p></li>
</ul>
<p>移除healthd
对于运行Android 9的设备和升级到Android 9且在新vendor镜像中提供Health 2.0 HAL的设备，我们建议从系统镜像中删除healthd以节省磁盘空间并加快启动时间。</p>
<p>使用Android 9启动的设备必须提供2.0 HAL（并且不得提供1.0 HAL）。未使用Android 9启动但计划更新供应商映像为Target Framework Compatibility Matrix Version 3（在Android 9中发布）的设备必须删除现有的1.0 HAL实现并提供2.0 HAL。</p>
<p>AOSP包含多个帮助库，旨在帮助您实现2.0 HAL和从旧的1.0 HAL过渡。</p>
</section>
<section id="id2">
<h1>术语<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>health&#64;1.0：android.hardware.health&#64;1.0 的缩写。指的是 Android 8.0 中发布的运行状况 HIDL 的 1.0 版 HAL。</p></li>
<li><p>health&#64;2.0：android.hardware.health&#64;2.0 的缩写。指的是 Android 9 中发布的运行状况 HIDL 的 2.0 版 HAL。</p></li>
<li><p>health&#64;2.1：android.hardware.health&#64;2.1 的缩写。指的是 Android 11 中发布的运行状况 HIDL 的 2.1 版 HAL。</p></li>
<li><p>charger：在关机模式充电过程中运行的可执行文件，用于显示手机充电动画。</p></li>
<li><p>recovery：在恢复模式下运行的可执行文件，必须检索电池信息。</p></li>
<li><p>healthd：在 Android 中运行的旧版守护进程，用于检索与运行状况相关的信息并将其提供给框架。</p></li>
<li><p>storaged：在 Android 中运行的守护进程，用于检索存储信息并将其提供给框架。</p></li>
</ul>
</section>
<section id="id3">
<h1>参考<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://source.android.com/devices/tech/health?hl=zh-cn">Android 运行状况</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/u010632165/article/details/88651035">Android 电池管理系统架构总结 Android power and battery management architecture summaries</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/qq_37858386/article/details/122087237#comments_23271353">2021-12-22 AndroidR 电池信息 简单分析记录</a></p></li>
<li><p><a class="reference external" href="https://source.android.com/docs/core/health/implementation-2-1">Google 实现 Health 2.1</a></p></li>
<li><p><a class="reference external" href="https://cloud.tencent.com/developer/article/1847402">power supply是如何上报电池信息的</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/qq_62718027/article/details/125922249">c++：继承（超详解）</a></p></li>
</ul>
</section>
<section id="id4">
<h1>软件架构<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<p><img alt="0014_0006.png" src="../../../_images/0014_0006.png" />
<img alt="0014_0004.png" src="../../../_images/0014_0004.png" /></p>
<p>可以看到文件比较多，主要是通过<code class="docutils literal notranslate"><span class="pre">BatteryMonitor.cpp</span></code>中的<code class="docutils literal notranslate"><span class="pre">BatteryMonitor::update(void)</span></code>函数上报信息，其中，内核首先会更新数据到<code class="docutils literal notranslate"><span class="pre">/sys/class/power_supply/battery</span></code>节点下各个属性，这个在上一个小节有做解释，先来看一下整体的架构，后面再来深入到代码中去分析；具体图片（该图片来自互联网，因为被转载较多，已经不知道出处），具体的流程整理的很清楚，如下所示；</p>
<p><img alt="0014_0001.png" src="../../../_images/0014_0001.png" /></p>
<p>这幅图片再一次把整体的数据走向具体化，可以看到主要负责工作的是<code class="docutils literal notranslate"><span class="pre">BatteryMonitor</span></code>，主要分析一下该文件中的init和update就可以搞清楚大部分的问题。</p>
</section>
<section id="id5">
<h1>涉及文件<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>编译文件</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./vendor/lib64/hw/android.hardware.health@2.0-impl-2.1-qti.so
./vendor/lib64/libsystem_health_mon.so
./vendor/etc/vintf/manifest/android.hardware.health@2.1.xml
./vendor/etc/init/android.hardware.health@2.1-service.rc
./vendor/bin/hw/android.hardware.health@2.1-service
</pre></div>
</div>
<ul class="simple">
<li><p>healthd涉及文件：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span> system/core/healthd：
.
├── Android.bp
├── android.hardware.health@2.0-service.rc
├── Android.mk
├── animation.h
├── AnimationParser.cpp
├── AnimationParser.h
├── api
│   ├── charger_sysprop-current.txt
│   └── charger_sysprop-latest.txt
├── BatteryMonitor.cpp
├── charger.cpp
├── charger.sysprop
├── charger_test.cpp
├── charger_utils.cpp
├── charger_utils.h
├── healthd_draw.cpp
├── healthd_draw.h
├── healthd_mode_charger.cpp
├── healthd_mode_charger.h
├── healthd_mode_charger_nops.cpp
├── healthd_mode_charger_nops.h
├── healthd.rc
├── HealthServiceDefault.cpp
├── HealthServiceHealthd.cpp
├── images
│   ├── battery_fail.png
│   └── battery_scale.png
├── include
│   └── healthd
│       ├── BatteryMonitor.h
│       └── healthd.h
├── manifest_healthd.xml
├── OWNERS
└── tests
    ├── Android.mk
    └── AnimationParser_test.cpp
</pre></div>
</div>
<ul class="simple">
<li><p>HIDL涉及文件：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>hardware/interfaces/health：
├── 2.1
│   ├── Android.bp
│   ├── default
│   │   ├── Android.bp
│   │   ├── android.hardware.health@2.1-service.rc
│   │   ├── android.hardware.health@2.1.xml
│   │   ├── impl.cpp
│   │   └── service.cpp
│   ├── IHealth.hal
│   ├── IHealthInfoCallback.hal
│   ├── README.md
│   ├── types.hal
│   └── vts
│       ├── functional
│       │   ├── Android.bp
│       │   └── VtsHalHealthV2_1TargetTest.cpp
│       └── OWNERS
├── storage
│   └── 1.0
│       ├── Android.bp
│       ├── default
│       │   ├── Android.bp
│       │   ├── android.hardware.health.storage@1.0-service.rc
│       │   ├── manifest_android.hardware.health.storage@1.0.xml
│       │   ├── service.cpp
│       │   ├── Storage.cpp
│       │   └── Storage.h
│       ├── IGarbageCollectCallback.hal
│       ├── IStorage.hal
│       ├── types.hal
│       └── vts
│           └── functional
│               ├── Android.bp
│               ├── VtsHalHealthStorageV1_0TargetTest.config
│               └── VtsHalHealthStorageV1_0TargetTest.cpp
└── utils
    ├── libhealth2impl
    │   ├── Android.bp
    │   ├── BinderHealth.cpp
    │   ├── HalHealthLoop.cpp
    │   ├── Health.cpp
    │   └── include
    │       └── health2impl
    │           ├── BinderHealth.h
    │           ├── Callback.h
    │           ├── HalHealthLoop.h
    │           └── Health.h
    └── libhealthloop
        ├── Android.bp
        ├── HealthLoop.cpp
        ├── include
        │   └── health
        │       ├── HealthLoop.h
        │       └── utils.h
        └── utils.cpp
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">system/core/healthd/Android.bp</span></code>health编译了一个可执行文件<code class="docutils literal notranslate"><span class="pre">charger</span></code>，该程序用于关机充电模式：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cc_binary <span class="o">{</span>
    name: <span class="s2">&quot;charger&quot;</span>,
    defaults: <span class="o">[</span><span class="s2">&quot;charger_defaults&quot;</span><span class="o">]</span>,
    recovery_available: true,
    srcs: <span class="o">[</span>
        <span class="s2">&quot;charger.cpp&quot;</span>,
        <span class="s2">&quot;charger_utils.cpp&quot;</span>,
    <span class="o">]</span>,

    target: <span class="o">{</span>
        recovery: <span class="o">{</span>
            // No UI and libsuspend <span class="k">for</span> recovery charger.
            cflags: <span class="o">[</span>
                <span class="s2">&quot;-DCHARGER_FORCE_NO_UI=1&quot;</span>,
            <span class="o">]</span>,
            exclude_shared_libs: <span class="o">[</span>
                <span class="s2">&quot;libpng&quot;</span>,
            <span class="o">]</span>,
            exclude_static_libs: <span class="o">[</span>
                <span class="s2">&quot;libhealthd_draw&quot;</span>,
                <span class="s2">&quot;libhealthd_charger&quot;</span>,
                <span class="s2">&quot;libminui&quot;</span>,
                <span class="s2">&quot;libsuspend&quot;</span>,
            <span class="o">]</span>,
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id6">
<h1>软件流程<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h1>
<p>由于uevent机制仅将一个简单的字符串传递给了用户空间，而安卓系统建立在kernel之上，需要思考如何将设备属性的变化值及时更新到用户空间，于是就有了healthd服务，healthd目前已经更新到了2.1版本，其主要工作通过epoll_wait来监听kernel中的uevent事件。具体的函数调用流程图如下：</p>
<p><img alt="0014_0003.png" src="../../../_images/0014_0003.png" /></p>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>从service.cpp开始理一下调用流程，可以整理出上述的调用流程，构造函数为初始化流程，<code class="docutils literal notranslate"><span class="pre">Uevent</span></code>那条虚线为当psy-uevent上报后触发epoll之后的调用流程。与底层节点交互的逻辑都在<code class="docutils literal notranslate"><span class="pre">BatteryMonitor</span></code>中，在初始化过程中会初始化healthd_config结构体，用于保存psy属性节点的路径。</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p>在监听循环MainLoop函数中，一个while(1)循环，调用epoll_wait()函数来监听uevent，收到事件之后会调用初始化时注册好的func（UeventEvent），该函数会通过uevent_kernel_multicast_recv接口去读取netlink发送的sk_buff-&gt;data，通过查找其中的字符串来判断事件是否为psy子系统发送的，如果不是的话，不会进行处理。进一步的处理流程主要是调用到BatteryMonitor中的updateValues，在该函数中会遍历读取psy属性节点，存储在HealthInfo结构体中，之后通过BinderHealth中注册好的回调函数IHealthInfoCallback通知BatterySerice，具体的通知函数为BinderHealth：OnHealthInfoChanged。</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p>Healthd是一个根植于powersupply子系统，并采用了epoll监听底层节点的uevent事件，之后轮询底层属性节点的守护进程。在安卓R版本中，Healthd相关代码重构为libhealthloop和libhealth2impl，但为了保证向后兼容，可以看到在ScheduleBatteryUpdate()函数中调用了两次updateValues，这样会遍历两次底层节点造成了冗余。另外在psy-uevent机制中，也有一次属性节点的遍历，一共三次遍历，这就要求底层驱动在更新属性值时，不能加入耗时的IO操作，否则会影响系统性能。</p></li>
</ol>
</li>
</ul>
</section>
<section id="hidl">
<h1>HIDL服务注册<a class="headerlink" href="#hidl" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hardware/interfaces/health/2.0/README</span></code>我们可以从以下得知2.0下是改为实施 2.1 HAL:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Implement the 2.1 HAL instead!

It is strongly recommended that you implement the 2.1 HAL directly. See
`hardware/interfaces/health/2.1/README.md` for more details.

强烈建议您直接实现 2.1 HAL。 看`hardware/interfaces/health/2.1/README.md`了解更多详情。
</pre></div>
</div>
<p>查看package情况：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>device/qcom/vendor-common/base.mk
<span class="m">1103</span>:PRODUCT_PACKAGES +<span class="o">=</span> android.hardware.health@2.1-impl-qti
<span class="m">1104</span>:PRODUCT_PACKAGES +<span class="o">=</span> android.hardware.health@2.1-service
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">\hardware\interfaces\health\2.1\default\service.cpp</span></code>通过<code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">BinderHealth</span></code>创建HIDL binder服务:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">IHealth_2_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">health</span><span class="o">::</span><span class="n">V2_0</span><span class="o">::</span><span class="n">IHealth</span><span class="p">;</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">gInstanceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="cm">/* argc */</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="cm">/* argv */</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IHealth</span><span class="o">&gt;</span><span class="w"> </span><span class="n">passthrough</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">IHealth</span><span class="o">::</span><span class="n">castFrom</span><span class="p">(</span><span class="n">IHealth_2_0</span><span class="o">::</span><span class="n">getService</span><span class="p">(</span><span class="n">gInstanceName</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="cm">/* getStub */</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">CHECK</span><span class="p">(</span><span class="n">passthrough</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Cannot find passthrough implementation of health 2.1 HAL for instance &quot;</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gInstanceName</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">BinderHealth</span><span class="o">&gt;</span><span class="w"> </span><span class="n">binder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BinderHealth</span><span class="p">(</span><span class="n">gInstanceName</span><span class="p">,</span><span class="w"> </span><span class="n">passthrough</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">binder</span><span class="o">-&gt;</span><span class="n">StartLoop</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BinderHealth</span></code>实际上是继承<code class="docutils literal notranslate"><span class="pre">HalHealthLoop</span></code>类，<code class="docutils literal notranslate"><span class="pre">HalHealthLoop</span></code>继承<code class="docutils literal notranslate"><span class="pre">HealthLoop</span></code>，所以<code class="docutils literal notranslate"><span class="pre">binder-&gt;StartLoop</span></code>调用的是<code class="docutils literal notranslate"><span class="pre">HealthLoop.cpp</span></code>里面的<code class="docutils literal notranslate"><span class="pre">StartLoop()</span></code>函数：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="c1">//health/utils/libhealth2impl/BinderHealth.cpp:</span>
<span class="n">BinderHealth</span><span class="o">::</span><span class="n">BinderHealth</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IHealth</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">impl</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">HalHealthLoop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">impl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//继承</span>
<span class="w">    </span><span class="n">CHECK_NE</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">impl</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">impl</span><span class="o">-&gt;</span><span class="n">isRemote</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">//health/utils/libhealth2impl/include/health2impl/HalHealthLoop.h:</span>
<span class="w">  </span><span class="c1">// An implementation of HealthLoop for using a given health HAL. This is useful</span>
<span class="w">  </span><span class="c1">// for services that opens the passthrough implementation and starts the HealthLoop</span>
<span class="w">  </span><span class="c1">// to periodically poll data from the implementation.</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">HalHealthLoop</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">HealthLoop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//继承</span>
<span class="w">    </span><span class="n">CHECK_NE</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">impl</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">HalHealthLoop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IHealth</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">service</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="n">instance_name_</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="n">service_</span><span class="p">(</span><span class="n">service</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>绑定模式的服务通过<code class="docutils literal notranslate"><span class="pre">registerAsService</span></code>接口实现，代码流程:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>hardware\interfaces\health\2.1\default\service.cpp
StartLoop()
 
hardware\interfaces\health\utils\libhealthloop\HealthLoop.cpp
StartLoop()  &gt;InitInternal()  &gt;   Init(&amp;healthd_config_)
 
hardware\interfaces\health\utils\libhealth2impl\BinderHealth.cpp
Init(struct healthd_config* config) &gt; CHECK_EQ(registerAsService(instance_name()), android::OK)
</pre></div>
</div>
<p>到这里从log上看就打开一个android.hardware.health&#64;2.1-service服务了。</p>
<p><img alt="0014_0002.png" src="../../../_images/0014_0002.png" /></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-A</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">health</span></code>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A6650</span><span class="p">:</span><span class="o">/</span> <span class="c1"># ps -A | grep health</span>
<span class="n">system</span>         <span class="mi">646</span>     <span class="mi">1</span> <span class="mi">12978784</span>  <span class="mi">3608</span> <span class="n">do_epoll_wait</span>       <span class="mi">0</span> <span class="n">S</span> <span class="n">android</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">health</span><span class="o">@</span><span class="mf">2.1</span><span class="o">-</span><span class="n">service</span>
</pre></div>
</div>
</section>
<section id="initpsy">
<h1>Init获取所有psy属性节点的路径<a class="headerlink" href="#initpsy" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Main</span></code>函数中，我们看到第一行是<code class="docutils literal notranslate"><span class="pre">sp&lt;IHealth&gt;</span> <span class="pre">passthrough</span></code>，创建了一个<code class="docutils literal notranslate"><span class="pre">Ihealth</span></code>类，那必然会跑它的构造函数，跟踪发现<code class="docutils literal notranslate"><span class="pre">Health</span></code>继承<code class="docutils literal notranslate"><span class="pre">Ihealth</span></code>类，编译器会默认先调用父类的构造函数，再调用子类的构造函数，如下：</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">utils/libhealth2impl/include/health2impl/Health.h</span></code>:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Health</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IHealth</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">43</span><span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>

<span class="c1">//utils/libhealth2impl/Health.cpp:</span>
<span class="n">Health</span><span class="o">::</span><span class="n">Health</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">healthd_config</span><span class="o">&gt;&amp;&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">healthd_config_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">battery_monitor_</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">healthd_config_</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BatteryMonitor::init</span></code>函数主要是先读取psy节点的type类型，<code class="docutils literal notranslate"><span class="pre">ANDROID_POWER_SUPPLY_TYPE_USB</span></code>和<code class="docutils literal notranslate"><span class="pre">ANDROID_POWER_SUPPLY_TYPE_AC</span></code>充电器类型只需要保存<code class="docutils literal notranslate"><span class="pre">online</span></code>值，而<code class="docutils literal notranslate"><span class="pre">ANDROID_POWER_SUPPLY_TYPE_BATTERY</span></code>电池类型保存的比较多，下面有个表：</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>sys节点</p></th>
<th class="head"><p>名词解释</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>/sys/class/power_supply/ac/online</p></td>
<td><p>AC 电源连接状态</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/usb/online</p></td>
<td><p>USB电源连接状态</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/capacity_level （在健康 2.1 中添加）</p></td>
<td><p>容量等级</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/capacity</p></td>
<td><p>电池电量百分比</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/charge_counter</p></td>
<td><p>剩余容量 uAh</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/charge_full</p></td>
<td><p>最大容量</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/charge_full_design （在健康 2.1 中添加）</p></td>
<td><p>最大容量</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/current_avg</p></td>
<td><p>平均电流</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/current_max</p></td>
<td><p>最大电流</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/current_now</p></td>
<td><p>当前电流</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/cycle_count</p></td>
<td><p>循环次数</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/health</p></td>
<td><p>电池状态</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/present</p></td>
<td><p>在位状态</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/status</p></td>
<td><p>充电状态</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/technology</p></td>
<td><p>电池技术</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/temp</p></td>
<td><p>电池温度</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/time_to_full_now （在健康 2.1 中添加）</p></td>
<td><p>充电到100%需要的时间</p></td>
</tr>
<tr class="row-odd"><td><p>/sys/class/power_supply/*/voltage_max</p></td>
<td><p>最大电压</p></td>
</tr>
<tr class="row-even"><td><p>/sys/class/power_supply/*/voltage_now</p></td>
<td><p>目前电压</p></td>
</tr>
</tbody>
</table>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">BatteryMonitor::init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">healthd_config</span><span class="w"> </span><span class="o">*</span><span class="n">hc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">String8</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="kt">char</span><span class="w"> </span><span class="n">pval</span><span class="p">[</span><span class="n">PROPERTY_VALUE_MAX</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span>
<span class="w">      </span><span class="n">mHealthdConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hc</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">DIR</span><span class="p">,</span><span class="w"> </span><span class="n">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">closedir</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dir</span><span class="p">(</span><span class="n">opendir</span><span class="p">(</span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">),</span><span class="w"> </span><span class="n">closedir</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">KLOG_ERROR</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">struct</span><span class="w"> </span><span class="nc">dirent</span><span class="o">*</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;..&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                  </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">String8</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">itIgnoreName</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                      </span><span class="n">find</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ignorePowerSupplyNames</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ignorePowerSupplyNames</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"></span>
<span class="w">                           </span><span class="n">String8</span><span class="p">(</span><span class="n">name</span><span class="p">));</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">itIgnoreName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ignorePowerSupplyNames</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"></span>
<span class="w">                  </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">              </span><span class="c1">// Look for &quot;type&quot; file in each subdirectory</span>
<span class="w">              </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">switch</span><span class="p">(</span><span class="n">readPowerSupplyType</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_AC</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_USB</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_WIRELESS</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_DOCK</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/online&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="p">(),</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="n">mChargerNames</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">String8</span><span class="p">(</span><span class="n">name</span><span class="p">));</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_BATTERY</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="c1">// Some devices expose the battery status of sub-component like</span>
<span class="w">                  </span><span class="c1">// stylus. Such a device-scoped battery info needs to be skipped</span>
<span class="w">                  </span><span class="c1">// in BatteryMonitor, which is intended to report the status of</span>
<span class="w">                  </span><span class="c1">// the battery supplying the power to the whole system.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isScopedPowerSupply</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="n">mBatteryDevicePresent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryStatusPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/status&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryStatusPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryHealthPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/health&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryHealthPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryPresentPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/present&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryPresentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCapacityPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/capacity&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCapacityPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryVoltagePath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/voltage_now&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryVoltagePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryFullChargePath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/charge_full&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryFullChargePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCurrentNowPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/current_now&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCurrentNowPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCycleCountPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/cycle_count&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCycleCountPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCapacityLevelPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/capacity_level&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCapacityLevelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryChargeTimeToFullNowPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/time_to_full_now&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryChargeTimeToFullNowPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryFullChargeDesignCapacityUahPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/charge_full_design&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryFullChargeDesignCapacityUahPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCurrentAvgPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/current_avg&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCurrentAvgPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryChargeCounterPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/charge_counter&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryChargeCounterPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryTemperaturePath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/temp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryTemperaturePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryTechnologyPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                      </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/technology&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                          </span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryTechnologyPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_UNKNOWN</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">              </span><span class="c1">// Look for &quot;is_dock&quot; file</span>
<span class="w">              </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">              </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/is_dock&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="p">(),</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">                  </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/online&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="p">(),</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="n">mChargerNames</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">String8</span><span class="p">(</span><span class="n">name</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span>
<span class="w">              </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">      </span><span class="c1">// Typically the case for devices which do not have a battery and</span>
<span class="w">      </span><span class="c1">// and are always plugged into AC mains.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mBatteryDevicePresent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No battery devices found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">periodic_chores_interval_fast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">periodic_chores_interval_slow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryStatusPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryStatusPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryHealthPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryHealthPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryPresentPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryPresentPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCapacityPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryCapacityPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryVoltagePath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryVoltagePath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryTemperaturePath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryTemperaturePath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryTechnologyPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryTechnologyPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCurrentNowPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryCurrentNowPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryFullChargePath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryFullChargePath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCycleCountPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BatteryCycleCountPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryCapacityLevelPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;batteryCapacityLevelPath not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryChargeTimeToFullNowPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;batteryChargeTimeToFullNowPath. not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHealthdConfig</span><span class="o">-&gt;</span><span class="n">batteryFullChargeDesignCapacityUahPath</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span><span class="w"></span>
<span class="w">              </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;batteryFullChargeDesignCapacityUahPath. not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">property_get</span><span class="p">(</span><span class="s">&quot;ro.boot.fake_battery&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pval</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">                                                 </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">strtol</span><span class="p">(</span><span class="n">pval</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">mBatteryFixedCapacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FAKE_BATTERY_CAPACITY</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">mBatteryFixedTemperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FAKE_BATTERY_TEMPERATURE</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id7">
<h1>上报流程<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h1>
<p>跟踪得到上面的大概流程如下，最后的打印在BatteryMonitor.cpp里面的logValues。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hardware</span>\<span class="n">interfaces</span>\<span class="n">health</span>\<span class="mf">2.1</span>\<span class="n">default</span>\<span class="n">service</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">binder</span><span class="o">-&gt;</span><span class="n">StartLoop</span><span class="p">();</span>
 
<span class="n">hardware</span>\<span class="n">interfaces</span>\<span class="n">health</span>\<span class="n">utils</span>\<span class="n">libhealthloop</span>\<span class="n">HealthLoop</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">StartLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MainLoop</span><span class="o">-&gt;</span>  <span class="n">PeriodicChores</span>    <span class="o">-&gt;</span>  <span class="n">ScheduleBatteryUpdate</span><span class="p">();</span>  <span class="o">-&gt;</span>
 
<span class="n">hardware</span>\<span class="n">interfaces</span>\<span class="n">health</span>\<span class="n">utils</span>\<span class="n">libhealth2impl</span>\<span class="n">HalHealthLoop</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">ScheduleBatteryUpdate</span><span class="p">()</span> <span class="n">_</span><span class="o">&gt;</span><span class="n">update</span><span class="p">();</span>
<span class="n">ScheduleBatteryUpdate</span><span class="p">()</span> <span class="n">_</span><span class="o">&gt;</span> <span class="n">OnHealthInfoChanged</span><span class="p">(</span><span class="n">health_info</span><span class="p">);</span> <span class="o">//</span><span class="n">通知BatterySevices</span>
 
\<span class="n">hardware</span>\<span class="n">interfaces</span>\<span class="n">health</span>\<span class="n">utils</span>\<span class="n">libhealth2impl</span>\<span class="n">Health</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">update</span><span class="p">()</span> <span class="o">&gt;</span><span class="n">logValues</span><span class="p">()</span>
<span class="n">update</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">getHealthInfo_2_1</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">auto</span> <span class="n">res</span><span class="p">,</span> <span class="n">const</span> <span class="n">auto</span><span class="o">&amp;</span> <span class="n">health_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">battery_monitor_</span><span class="o">.</span><span class="n">updateValues</span><span class="p">();</span>

\<span class="n">system</span>\<span class="n">core</span>\<span class="n">healthd</span>\<span class="n">BatteryMonitor</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">logValues</span>
<span class="n">updateValues</span>
</pre></div>
</div>
</section>
<section id="healthd-2-1">
<h1>Healthd 2.1要求<a class="headerlink" href="#healthd-2-1" title="此标题的永久链接"></a></h1>
<p>健康 2.0 HAL 对 HAL 接口提出了一组要求，但相应的 VTS 测试在执行方面相对宽松。在 Android 11 中，添加了新的 VTS 测试以对搭载 Android 11 及更高版本的设备强制执行以下要求：</p>
<ul class="simple">
<li><p>无电流和平均电池电流的单位必须是微安 (μA)。</p></li>
<li><p>瞬时和平均电池电流的符号必须正确。具体来说：</p>
<ul>
<li><p>current == 0 当电池状态为UNKNOWN时</p></li>
<li><p>当电池状态为CHARGING时，电流 &gt; 0</p></li>
<li><p>当电池状态为NOT_CHARGING时，电流 &lt;= 0</p></li>
<li><p>当电池状态为DISCHARGING时，电流 &lt; 0</p></li>
<li><p>电池状态为FULL时不强制执行</p></li>
</ul>
</li>
<li><p>电池状态必须与是否连接电源正确。具体来说：</p>
<ul>
<li><p>当且仅当连接了电源时，电池状态必须是CHARGING 、 NOT_CHARGING或FULL之一；</p></li>
<li><p>当且仅当电源断开时，电池状态必须为DISCHARGING 。</p></li>
</ul>
</li>
</ul>
<p>如果您在实现中使用libbatterymonitor并传递来自内核接口的值，请确保 sysfs 节点报告正确的值：</p>
<ul class="simple">
<li><p>确保使用正确的符号和单位报告电池电流。这包括以下 sysfs 节点：</p>
<ul>
<li><p>/sys/class/power_supply/*/current_avg</p></li>
<li><p>/sys/class/power_supply/*/current_max</p></li>
<li><p>/sys/class/power_supply/*/current_now</p></li>
<li><p>正值表示进入电池的电流。</p></li>
<li><p>值应以微安 (μA) 为单位。</p></li>
</ul>
</li>
<li><p>确保以微伏 (μV) 为单位报告电池电压。这包括以下 sysfs 节点：</p>
<ul>
<li><p>/sys/class/power_supply/*/voltage_max</p></li>
<li><p>/sys/class/power_supply/*/voltage_now</p></li>
<li><p>请注意，默认 HAL 实现将voltage_now除以 1000 并以毫伏 (mV) 为单位报告值。</p></li>
</ul>
</li>
</ul>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>