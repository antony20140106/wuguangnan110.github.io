<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#androidhealth-1-0-hidl">Android弃用health&#64;1.0 HIDL</a></li>
<li><a class="reference internal" href="#id2">术语</a></li>
<li><a class="reference internal" href="#id3">参考</a></li>
<li><a class="reference internal" href="#id4">软件架构</a></li>
<li><a class="reference internal" href="#id5">涉及文件</a></li>
<li><a class="reference internal" href="#id6">软件流程</a></li>
<li><a class="reference internal" href="#hidl">HIDL服务注册</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>高通A6650 healthd 守护进程分析。</p>
<p>Android 9 引入了从 health&#64;1.0 HAL 升级的主要版本 android.hardware.health HAL 2.0。这一新 HAL 具有以下优势：</p>
<ul class="simple">
<li><p>框架代码和供应商代码之间的区别更清楚。</p></li>
<li><p>弃用了不必要的 healthd 守护程序。</p></li>
<li><p>供应商对运行状况信息报告进行自定义的自由度更高。</p></li>
<li><p>更多设备运行状况信息（不仅包括电池信息）。</p></li>
</ul>
<p>Android 11 包含 android.hardware.health HAL 2.1，这是一个从 health&#64;2.0 HAL 升级的次要版本。这一新 HAL 具有以下优势：</p>
<ul class="simple">
<li><p>更易于实现</p></li>
<li><p>更好地与现有 2.0 HAL API 保持一致</p></li>
<li><p>在关机模式充电代码中可以实现更好的 Treble 分离</p></li>
<li><p>更好地支持框架来指示设备的电池运行状况</p></li>
</ul>
</section>
<section id="androidhealth-1-0-hidl">
<h1>Android弃用health&#64;1.0 HIDL<a class="headerlink" href="#androidhealth-1-0-hidl" title="此标题的永久链接"></a></h1>
<p>Framework 将继续使用health&#64;1.0直到按标准HAL弃用计划完全弃用为止 。当health&#64;1.0被弃用（条目从 框架兼容性矩阵除去）， healthd和libbatterymonitor必须也系统中除去，以避免未知的healthd行为。由于health&#64;1.0是一个可选的HAL，并且所有 healthd对health&#64;1.0的依赖都受到NULL检查的保护，因此在弃用时不应该中断。</p>
<p>当Android删除旧代码路径（healthd，health&#64;1.0）时，按弃用计划Health&#64;1.0 HAL将被弃用。此外，Android还删除了以下内容：</p>
<ul class="simple">
<li><p>Framework 中的healthd依赖</p></li>
<li><p>healthd</p></li>
<li><p>系统中 health&#64;1.0的HAL定义库</p></li>
<li><p>Framework 兼容性矩阵中的health&#64;1.0条目</p></li>
</ul>
<p>移除healthd
对于运行Android 9的设备和升级到Android 9且在新vendor镜像中提供Health 2.0 HAL的设备，我们建议从系统镜像中删除healthd以节省磁盘空间并加快启动时间。</p>
<p>使用Android 9启动的设备必须提供2.0 HAL（并且不得提供1.0 HAL）。未使用Android 9启动但计划更新供应商映像为Target Framework Compatibility Matrix Version 3（在Android 9中发布）的设备必须删除现有的1.0 HAL实现并提供2.0 HAL。</p>
<p>AOSP包含多个帮助库，旨在帮助您实现2.0 HAL和从旧的1.0 HAL过渡。</p>
</section>
<section id="id2">
<h1>术语<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>health&#64;1.0：android.hardware.health&#64;1.0 的缩写。指的是 Android 8.0 中发布的运行状况 HIDL 的 1.0 版 HAL。</p></li>
<li><p>health&#64;2.0：android.hardware.health&#64;2.0 的缩写。指的是 Android 9 中发布的运行状况 HIDL 的 2.0 版 HAL。</p></li>
<li><p>health&#64;2.1：android.hardware.health&#64;2.1 的缩写。指的是 Android 11 中发布的运行状况 HIDL 的 2.1 版 HAL。</p></li>
<li><p>charger：在关机模式充电过程中运行的可执行文件，用于显示手机充电动画。</p></li>
<li><p>recovery：在恢复模式下运行的可执行文件，必须检索电池信息。</p></li>
<li><p>healthd：在 Android 中运行的旧版守护进程，用于检索与运行状况相关的信息并将其提供给框架。</p></li>
<li><p>storaged：在 Android 中运行的守护进程，用于检索存储信息并将其提供给框架。</p></li>
</ul>
</section>
<section id="id3">
<h1>参考<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://source.android.com/devices/tech/health?hl=zh-cn">Android 运行状况</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/u010632165/article/details/88651035">Android 电池管理系统架构总结 Android power and battery management architecture summaries</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/dfysy/article/details/7330919">Android Uevent 分析，从kernel到framework</a></p></li>
<li><p><a class="reference external" href="https://source.android.com/docs/core/health/implementation-2-1">Google 实现 Health 2.1 </a></p></li>
<li><p><a class="reference external" href="https://cloud.tencent.com/developer/article/1847402">power supply是如何上报电池信息的</a></p></li>
</ul>
</section>
<section id="id4">
<h1>软件架构<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<p><img alt="0014_0000.png" src="../../../_images/0014_0000.png" />
<img alt="0014_0004.png" src="../../../_images/0014_0004.png" /></p>
<p>可以看到文件比较多，主要是通过<code class="docutils literal notranslate"><span class="pre">BatteryMonitor.cpp</span></code>中的<code class="docutils literal notranslate"><span class="pre">BatteryMonitor::update(void)</span></code>函数上报信息，其中，内核首先会更新数据到<code class="docutils literal notranslate"><span class="pre">/sys/class/power_supply/battery</span></code>节点下各个属性，这个在上一个小节有做解释，先来看一下整体的架构，后面再来深入到代码中去分析；具体图片（该图片来自互联网，因为被转载较多，已经不知道出处），具体的流程整理的很清楚，如下所示；</p>
<p><img alt="0014_0001.png" src="../../../_images/0014_0001.png" /></p>
<p>这幅图片再一次把整体的数据走向具体化，可以看到主要负责工作的是BatteryMonitor，主要分析一下该文件中的init和update就可以搞清楚大部分的问题。</p>
</section>
<section id="id5">
<h1>涉及文件<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>编译文件</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./vendor/lib64/hw/android.hardware.health@2.0-impl-2.1-qti.so
./vendor/lib64/libsystem_health_mon.so
./vendor/etc/vintf/manifest/android.hardware.health@2.1.xml
./vendor/etc/init/android.hardware.health@2.1-service.rc
./vendor/bin/hw/android.hardware.health@2.1-service
</pre></div>
</div>
<ul class="simple">
<li><p>healthd涉及文件：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span> system/core/healthd：
.
├── Android.bp
├── android.hardware.health@2.0-service.rc
├── Android.mk
├── animation.h
├── AnimationParser.cpp
├── AnimationParser.h
├── api
│   ├── charger_sysprop-current.txt
│   └── charger_sysprop-latest.txt
├── BatteryMonitor.cpp
├── charger.cpp
├── charger.sysprop
├── charger_test.cpp
├── charger_utils.cpp
├── charger_utils.h
├── healthd_draw.cpp
├── healthd_draw.h
├── healthd_mode_charger.cpp
├── healthd_mode_charger.h
├── healthd_mode_charger_nops.cpp
├── healthd_mode_charger_nops.h
├── healthd.rc
├── HealthServiceDefault.cpp
├── HealthServiceHealthd.cpp
├── images
│   ├── battery_fail.png
│   └── battery_scale.png
├── include
│   └── healthd
│       ├── BatteryMonitor.h
│       └── healthd.h
├── manifest_healthd.xml
├── OWNERS
└── tests
    ├── Android.mk
    └── AnimationParser_test.cpp
</pre></div>
</div>
<ul class="simple">
<li><p>HIDL涉及文件：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>hardware/interfaces/health：
├── 2.1
│   ├── Android.bp
│   ├── default
│   │   ├── Android.bp
│   │   ├── android.hardware.health@2.1-service.rc
│   │   ├── android.hardware.health@2.1.xml
│   │   ├── impl.cpp
│   │   └── service.cpp
│   ├── IHealth.hal
│   ├── IHealthInfoCallback.hal
│   ├── README.md
│   ├── types.hal
│   └── vts
│       ├── functional
│       │   ├── Android.bp
│       │   └── VtsHalHealthV2_1TargetTest.cpp
│       └── OWNERS
├── storage
│   └── 1.0
│       ├── Android.bp
│       ├── default
│       │   ├── Android.bp
│       │   ├── android.hardware.health.storage@1.0-service.rc
│       │   ├── manifest_android.hardware.health.storage@1.0.xml
│       │   ├── service.cpp
│       │   ├── Storage.cpp
│       │   └── Storage.h
│       ├── IGarbageCollectCallback.hal
│       ├── IStorage.hal
│       ├── types.hal
│       └── vts
│           └── functional
│               ├── Android.bp
│               ├── VtsHalHealthStorageV1_0TargetTest.config
│               └── VtsHalHealthStorageV1_0TargetTest.cpp
└── utils
    ├── libhealth2impl
    │   ├── Android.bp
    │   ├── BinderHealth.cpp
    │   ├── HalHealthLoop.cpp
    │   ├── Health.cpp
    │   └── include
    │       └── health2impl
    │           ├── BinderHealth.h
    │           ├── Callback.h
    │           ├── HalHealthLoop.h
    │           └── Health.h
    └── libhealthloop
        ├── Android.bp
        ├── HealthLoop.cpp
        ├── include
        │   └── health
        │       ├── HealthLoop.h
        │       └── utils.h
        └── utils.cpp
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">system/core/healthd/Android.bp</span></code>health编译了一个可执行文件<code class="docutils literal notranslate"><span class="pre">charger</span></code>，该程序用于关机充电模式：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cc_binary <span class="o">{</span>
    name: <span class="s2">&quot;charger&quot;</span>,
    defaults: <span class="o">[</span><span class="s2">&quot;charger_defaults&quot;</span><span class="o">]</span>,
    recovery_available: true,
    srcs: <span class="o">[</span>
        <span class="s2">&quot;charger.cpp&quot;</span>,
        <span class="s2">&quot;charger_utils.cpp&quot;</span>,
    <span class="o">]</span>,

    target: <span class="o">{</span>
        recovery: <span class="o">{</span>
            // No UI and libsuspend <span class="k">for</span> recovery charger.
            cflags: <span class="o">[</span>
                <span class="s2">&quot;-DCHARGER_FORCE_NO_UI=1&quot;</span>,
            <span class="o">]</span>,
            exclude_shared_libs: <span class="o">[</span>
                <span class="s2">&quot;libpng&quot;</span>,
            <span class="o">]</span>,
            exclude_static_libs: <span class="o">[</span>
                <span class="s2">&quot;libhealthd_draw&quot;</span>,
                <span class="s2">&quot;libhealthd_charger&quot;</span>,
                <span class="s2">&quot;libminui&quot;</span>,
                <span class="s2">&quot;libsuspend&quot;</span>,
            <span class="o">]</span>,
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id6">
<h1>软件流程<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h1>
<p>由于uevent机制仅将一个简单的字符串传递给了用户空间，而安卓系统建立在kernel之上，需要思考如何将设备属性的变化值及时更新到用户空间，于是就有了healthd服务，healthd目前已经更新到了2.1版本，其主要工作通过epoll_wait来监听kernel中的uevent事件。具体的函数调用流程图如下：</p>
<p><img alt="0014_0003.png" src="../../../_images/0014_0003.png" /></p>
</section>
<section id="hidl">
<h1>HIDL服务注册<a class="headerlink" href="#hidl" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hardware/interfaces/health/2.0/README</span></code>我们可以从以下得知2.0下是改为实施 2.1 HAL:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Implement the 2.1 HAL instead!

It is strongly recommended that you implement the 2.1 HAL directly. See
`hardware/interfaces/health/2.1/README.md` for more details.

强烈建议您直接实现 2.1 HAL。 看`hardware/interfaces/health/2.1/README.md`了解更多详情。
</pre></div>
</div>
<p>查看package情况：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>device/qcom/vendor-common/base.mk
<span class="m">1103</span>:PRODUCT_PACKAGES +<span class="o">=</span> android.hardware.health@2.1-impl-qti
<span class="m">1104</span>:PRODUCT_PACKAGES +<span class="o">=</span> android.hardware.health@2.1-service
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">\hardware\interfaces\health\2.1\default\service.cpp</span></code>通过<code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">BinderHealth</span></code>创建HIDL binder服务:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">IHealth_2_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">health</span><span class="o">::</span><span class="n">V2_0</span><span class="o">::</span><span class="n">IHealth</span><span class="p">;</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">gInstanceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="cm">/* argc */</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="cm">/* argv */</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IHealth</span><span class="o">&gt;</span><span class="w"> </span><span class="n">passthrough</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">IHealth</span><span class="o">::</span><span class="n">castFrom</span><span class="p">(</span><span class="n">IHealth_2_0</span><span class="o">::</span><span class="n">getService</span><span class="p">(</span><span class="n">gInstanceName</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="cm">/* getStub */</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">CHECK</span><span class="p">(</span><span class="n">passthrough</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Cannot find passthrough implementation of health 2.1 HAL for instance &quot;</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">gInstanceName</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">BinderHealth</span><span class="o">&gt;</span><span class="w"> </span><span class="n">binder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BinderHealth</span><span class="p">(</span><span class="n">gInstanceName</span><span class="p">,</span><span class="w"> </span><span class="n">passthrough</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">binder</span><span class="o">-&gt;</span><span class="n">StartLoop</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>绑定模式的服务通过<code class="docutils literal notranslate"><span class="pre">registerAsService</span></code>接口实现，代码流程:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>hardware\interfaces\health\2.1\default\service.cpp
StartLoop()
 
hardware\interfaces\health\utils\libhealthloop\HealthLoop.cpp
StartLoop()  &gt;InitInternal()  &gt;   Init(&amp;healthd_config_)
 
hardware\interfaces\health\utils\libhealth2impl\BinderHealth.cpp
Init(struct healthd_config* config) &gt; CHECK_EQ(registerAsService(instance_name()), android::OK)
</pre></div>
</div>
<p>到这里从log上看就打开一个android.hardware.health&#64;2.1-service服务了。</p>
<p><img alt="0014_0002.png" src="../../../_images/0014_00021.png" /></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"> <span class="pre">ps</span> <span class="pre">-A</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">health</span></code>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A6650</span><span class="p">:</span><span class="o">/</span> <span class="c1"># ps -A | grep health</span>
<span class="n">system</span>         <span class="mi">646</span>     <span class="mi">1</span> <span class="mi">12978784</span>  <span class="mi">3608</span> <span class="n">do_epoll_wait</span>       <span class="mi">0</span> <span class="n">S</span> <span class="n">android</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">health</span><span class="o">@</span><span class="mf">2.1</span><span class="o">-</span><span class="n">service</span>
</pre></div>
</div>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>