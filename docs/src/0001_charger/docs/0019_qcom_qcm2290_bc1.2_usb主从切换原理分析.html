<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">代码</a></li>
<li><a class="reference internal" href="#id4">程序流程</a></li>
<li><a class="reference internal" href="#charger-extcon">charger extcon通知原理</a><ul>
<li><a class="reference internal" href="#qusbhost-device">qusb设置host/device逻辑</a><ul>
<li><a class="reference internal" href="#pm4125extcon">pm4125初始化extcon</a></li>
<li><a class="reference internal" href="#qusb-dtsedev-pm2250-charger-usb-add-phy-dev">qusb 根据dts找到edev(pm2250_charger)，并注册到其内核通知链中(usb_add_phy_dev)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#charger-bc1-2">charger BC1.2检测原理</a><ul>
<li><a class="reference internal" href="#qusb-port-det-w-work">qusb port_det_w.work识别流程</a></li>
<li><a class="reference internal" href="#smblite-usb">smblite usb设置充电类型接口</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dw3usb">DW3驱动设置USB主从模式</a><ul>
<li><a class="reference internal" href="#resume-work">resume_work主从切换原理</a></li>
<li><a class="reference internal" href="#usb-device">USB device切换</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usbpower-supply-type-unknown">拔usb时设置充电类型为POWER_SUPPLY_TYPE_UNKNOWN</a></li>
<li><a class="reference internal" href="#device">device流程实例</a></li>
<li><a class="reference internal" href="#pax-extcon">PAX extcon实例</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>高通qcm2290 bc1.2目前使用纯micro usb方式无法获取，看一下原理</p>
</section>
<section id="id2">
<h1>参考<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<p>qcom有的平台直接通过寄存器获取，接口<code class="docutils literal notranslate"><span class="pre">smblib_get_apsd_result</span></code>：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/qq_40405527/article/details/124740245">Android Qcom USB Driver学习(二)</a></p></li>
</ul>
</section>
<section id="id3">
<h1>代码<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>涉及文件如下：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>vendor/bengal_defconfig
<span class="m">470</span>:CONFIG_MSM_QUSB_PHY<span class="o">=</span>y
<span class="nv">CONFIG_USB_MSM_SSPHY_QMP</span><span class="o">=</span>y

drivers/usb/phy/Makefile：
obj-<span class="k">$(</span>CONFIG_MSM_QUSB_PHY<span class="k">)</span>              +<span class="o">=</span> phy-msm-qusb.o phy-msm-qusb-v2.o
obj-<span class="k">$(</span>CONFIG_USB_MSM_SSPHY_QMP<span class="k">)</span>         +<span class="o">=</span> phy-msm-ssusb-qmp.o
</pre></div>
</div>
</section>
<section id="id4">
<h1>程序流程<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<p><img alt="0017_0003.png" src="../../../_images/0017_0003.png" /></p>
</section>
<section id="charger-extcon">
<h1>charger extcon通知原理<a class="headerlink" href="#charger-extcon" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/u012804784/article/details/124762990">extcon驱动及其在USB驱动中的应用</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/qq_24622489/article/details/120436289">Linux extcon驱动学习</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/mike8825/article/details/121186656">linux下的extcon驱动小析</a></p></li>
</ul>
<section id="qusbhost-device">
<h2>qusb设置host/device逻辑<a class="headerlink" href="#qusbhost-device" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>qusb驱动通过extcon绑定pm2250_charger驱动，两者可以进行extcon notify通信，dts:</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>scuba-usb.dtsi:
        /* Primary USB port related High Speed PHY */
        qusb_phy0: qusb@1613000 <span class="o">{</span>
                <span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;qcom,qusb2phy&quot;</span><span class="p">;</span>
        <span class="o">}</span><span class="p">;</span>

scuba-iot-idp.dtsi:
<span class="p">&amp;</span>qusb_phy0 <span class="o">{</span>
        <span class="nv">extcon</span> <span class="o">=</span> &lt;<span class="p">&amp;</span>pm2250_charger&gt;<span class="p">;</span>
        vdda33-supply <span class="o">=</span> &lt;<span class="p">&amp;</span>vreg_usb_3p1&gt;<span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<section id="pm4125extcon">
<h3>pm4125初始化extcon<a class="headerlink" href="#pm4125extcon" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>首先是pmic收到usb插入中断，流程图如下：</p></li>
</ul>
<p><img alt="0017_0001.png" src="../../../_images/0017_0001.png" /></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">drivers/power/supply/qcom/qpnp-smblite.c</span></code>charger先分配edev，初始化extcon和内核通知链:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">smblite_lib_extcon_cable</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">EXTCON_NONE</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">smblite_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* extcon registration */</span><span class="w"></span>
<span class="w">	</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_dev_allocate</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">smblite_lib_extcon_cable</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Couldn&#39;t to allocate extcon device rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">rc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_dev_register</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Couldn&#39;t to register extcon device rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">rc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Support reporting polarity and speed via properties */</span><span class="w"></span>
<span class="cm">/*EXTCON_USB/EXTCON_USB_HOST 支持设置typec的方向还有usb的速度 */</span><span class="w"></span>
<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_PROP_USB_TYPEC_POLARITY</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_PROP_USB_SS</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_PROP_USB_TYPEC_POLARITY</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_PROP_USB_SS</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="s">&quot;Couldn&#39;t to configure extcon capabilities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kt">int</span><span class="w"> </span><span class="nf">devm_extcon_dev_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">edev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_dev_allocate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">usb_extcon_cable</span><span class="p">);</span><span class="c1">//注册对应的edev</span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_dev_register</span><span class="p">(</span><span class="n">edev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="w"> </span>
<span class="kt">int</span><span class="w"> </span><span class="nf">extcon_dev_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">edev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">nh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_kcalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">max_supported</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">nh</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="o">-</span><span class="w"></span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">max_supported</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">RAW_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">nh</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span><span class="w"></span>
<span class="w"> </span>
<span class="w">	</span><span class="n">RAW_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">nh_all</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w">	</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="qusb-dtsedev-pm2250-charger-usb-add-phy-dev">
<h3>qusb 根据dts找到edev(pm2250_charger)，并注册到其内核通知链中(usb_add_phy_dev)<a class="headerlink" href="#qusb-dtsedev-pm2250-charger-usb-add-phy-dev" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>这里做了两件事：</p>
<ul>
<li><ol class="arabic simple">
<li><p>qusb 根据dts找到edev(pm2250_charger)，并将vbus_nb和id_nb注册到其内核通知链中(usb_add_phy_dev)</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p>向DW3驱动分配edev，初始化extcon内核通知链。</p></li>
</ol>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">drivers/usb/phy/phy-msm-qusb.c</span></code>:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">qusb_phy_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">of_property_read_bool</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;extcon&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_det_w</span><span class="p">,</span><span class="w"> </span><span class="n">qusb_phy_port_state_work</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qusb_phy_extcon_register</span><span class="p">(</span><span class="n">qphy</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_add_phy_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//1.qusb 根据dts找到edev(pm2250_charger)，并将vbus_nb和id_nb注册到其内核通知链中(usb_add_phy_dev)</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">usb_add_phy_dev</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w">	</span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_add_extcon</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w">	</span>
<span class="p">}</span><span class="w"></span>
<span class="w"> </span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">usb_add_extcon</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">of_property_read_bool</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;extcon&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_get_edev_by_phandle</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="c1">//找对对应的edev</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">vbus_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_register_notifier</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">edev</span><span class="p">,</span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">vbus_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>

<span class="w">	</span><span class="c1">//1.注册vbus_nb，绑定EXTCON_USB</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">vbus_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_register_notifier</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">edev</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">vbus_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="s">&quot;register VBUS notifier failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="c1">//2.注册id_nb，绑定EXTCON_USB_HOST</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">id_ext</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id_edev</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">id_ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id_edev</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="n">id_ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">edev</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_register_notifier</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">id_ext</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">id_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="s">&quot;register ID notifier failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="w"> </span>
<span class="kt">int</span><span class="w"> </span><span class="n">devm_extcon_register_notifier</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">edev</span><span class="p">,</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">nb</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w">	</span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_register_notifier</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w">	</span>
<span class="p">}</span><span class="w"></span>
<span class="w"> </span>
<span class="kt">int</span><span class="w"> </span><span class="n">extcon_register_notifier</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">nb</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_cable_index_by_id</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">nh</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="c1">//注册两个notify，分别是vbus和id脚，由charger发起通知，qusb接收：</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">qusb_phy_extcon_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">qusb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">qphy</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Register extcon for notifications from charger driver */</span><span class="w"></span>
<span class="w">	</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">vbus_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qusb_phy_vbus_notifier</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">id_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qusb_phy_id_notifier</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Register extcon to notify USB driver */</span><span class="w"></span>
<span class="w">	</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_dev_allocate</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">qusb_phy_extcon_cable</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to allocate extcon device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="c1">//向DW3驱动注册extcon设备，并设置属性EXTCON_USB_HOST EXTCON_USB</span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_extcon_dev_register</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to register extcon device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_PROP_USB_TYPEC_POLARITY</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_PROP_USB_SS</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_PROP_USB_TYPEC_POLARITY</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">extcon_set_property_capability</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_extcon</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">EXTCON_PROP_USB_SS</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>dw3驱动dts如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="p">&amp;</span>usb0 <span class="o">{</span>
        <span class="nv">extcon</span> <span class="o">=</span> &lt;<span class="p">&amp;</span>qusb_phy0&gt;, &lt;<span class="p">&amp;</span>eud&gt;<span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

<span class="p">&amp;</span>soc <span class="o">{</span>
        /* Primary USB port related controller */
        usb0: ssusb@4e00000 <span class="o">{</span>
                <span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;qcom,dwc-usb3-msm&quot;</span><span class="p">;</span>
                <span class="nv">reg</span> <span class="o">=</span> &lt;0x4e00000 0x100000&gt;<span class="p">;</span>
                reg-names <span class="o">=</span> <span class="s2">&quot;core_base&quot;</span><span class="p">;</span>
		<span class="o">}</span><span class="p">;</span>

                dwc3@4e00000 <span class="o">{</span>
                        <span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;snps,dwc3&quot;</span><span class="p">;</span>
                        <span class="nv">reg</span> <span class="o">=</span> &lt;0x4e00000 0xcd00&gt;<span class="p">;</span>
                        interrupt-parent <span class="o">=</span> &lt;<span class="p">&amp;</span>intc&gt;<span class="p">;</span>
                        <span class="nv">interrupts</span> <span class="o">=</span> &lt;GIC_SPI <span class="m">255</span> IRQ_TYPE_LEVEL_HIGH&gt;<span class="p">;</span>
                        usb-phy <span class="o">=</span> &lt;<span class="p">&amp;</span>qusb_phy0&gt;, &lt;<span class="p">&amp;</span>usb_qmp_phy&gt;<span class="p">;</span>
                        tx-fifo-resize<span class="p">;</span>
                        linux,sysdev_is_parent<span class="p">;</span>
                        snps,disable-clk-gating<span class="p">;</span>
                        snps,dis_u2_susphy_quirk<span class="p">;</span>
                        snps,dis_enblslpm_quirk<span class="p">;</span>
                        snps,has-lpm-erratum<span class="p">;</span>
                        snps,hird-threshold <span class="o">=</span> /bits/ <span class="m">8</span> &lt;0x10&gt;<span class="p">;</span>
                        snps,usb3-u1u2-disable<span class="p">;</span>
                        snps,usb3_lpm_capable<span class="p">;</span>
                        usb-core-id <span class="o">=</span> &lt;<span class="m">0</span>&gt;<span class="p">;</span>
                        maximum-speed <span class="o">=</span> <span class="s2">&quot;super-speed&quot;</span><span class="p">;</span>
                        <span class="nv">dr_mode</span> <span class="o">=</span> <span class="s2">&quot;otg&quot;</span><span class="p">;</span>
                <span class="o">}</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>两个notify如下:</p>
<ul>
<li><p>也就是charger那边发送<code class="docutils literal notranslate"><span class="pre">extcon_set_state_sync(chg-&gt;extcon,</span> <span class="pre">EXTCON_USB,</span> <span class="pre">enable)</span></code>后会发通知给qusb的<code class="docutils literal notranslate"><span class="pre">qusb_phy_vbus_notifier</span></code>，然后<code class="docutils literal notranslate"><span class="pre">queue_delayed_work</span> <span class="pre">port_det_w</span></code>工作队列。</p></li>
<li><p>charger那边发送<code class="docutils literal notranslate"><span class="pre">extcon_set_state_sync(chg-&gt;extcon,</span> <span class="pre">EXTCON_USB_HOST,</span> <span class="pre">enable)</span></code>后会发通知给qusb的<code class="docutils literal notranslate"><span class="pre">qusb_phy_id_notifier</span></code>，然后<code class="docutils literal notranslate"><span class="pre">queue_delayed_work</span> <span class="pre">port_det_w</span></code>工作队列。</p></li>
</ul>
</li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">qusb_phy_vbus_notifier</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">nb</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">phy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_phy</span><span class="p">,</span><span class="w"> </span><span class="n">vbus_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">qusb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">qphy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qusb_phy</span><span class="p">,</span><span class="w"> </span><span class="n">phy</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">qphy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to get PHY for vbus_notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">dump_stack</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="n">event</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_err</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got VBUS notification: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_freezable_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_det_w</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">qusb_phy_id_notifier</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">nb</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">phy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_phy</span><span class="p">,</span><span class="w"> </span><span class="n">id_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">qusb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">qphy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qusb_phy</span><span class="p">,</span><span class="w"> </span><span class="n">phy</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">qphy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to get PHY for vbus_notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">dump_stack</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">event</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_err</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got id notification: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_freezable_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_det_w</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="charger-bc1-2">
<h1>charger BC1.2检测原理<a class="headerlink" href="#charger-bc1-2" title="此标题的永久链接"></a></h1>
<p>检测原理：</p>
<p>(1)DCD：DP上有150mV（= 10uA x 15K欧姆下拉电阻）的电压，DM上电压为0
DCD机制向D+提供的电流源，可用定时器替代，但DCD能尽快检测数据线的连接，不必等待定时器超时，
DCD（data contact detect）的检测机制等待时间是可编程的通常是300ms 或者 600 ms。
(2)Primary Det（DP发起检测DM）：
DP上加载0.6V电压，DM上电压为0，充电器类型是SDP
DP上加载0.6V电压，DM上电压为0.6V，进入Secondary Det
(3)Secondary Det（DM发起检测DP）：
DM上加载0.8V电压，DP上电压为0，充电器类型是CDP
DM上加载0.8V电压，DP上电压为0.8V，充电器类型是DCP</p>
<p><img alt="0017_0002.png" src="../../../_images/0017_0002.png" /></p>
<section id="qusb-port-det-w-work">
<h2>qusb port_det_w.work识别流程<a class="headerlink" href="#qusb-port-det-w-work" title="此标题的永久链接"></a></h2>
<p>总体usb bc12识别流程由上层charger通知device插入后，将调用vbus通知链，以下是SDP识别过程及log：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>* INIT_DELAYED_WORK(&amp;qphy-&gt;port_det_w, qusb_phy_port_state_work);
  └── switch (qphy-&gt;port_state)
      └── PORT_UNKNOWN
          └── PORT_DISCONNECTED
              └── PORT_DCD_IN_PROGRESS
                  └── PORT_DISCONNECTED
                      └── PORT_DCD_IN_PROGRESS
                          └── PORT_PRIMARY_IN_PROGRESS
                              └── PORT_DCD_IN_PROGRESS
                                  ├── qusb_phy_notify_charger(qphy, POWER_SUPPLY_TYPE_USB); //设置charger充电类型
                                  │   └── power_supply_set_property(qphy-&gt;usb_psy, POWER_SUPPLY_PROP_REAL_TYPE,&amp;pval);
                          	       └── qusb_phy_notify_extcon(qphy, EXTCON_USB, 1); //通知dw3驱动切换device
                          	           └── extcon_set_state_sync(qphy-&gt;usb_extcon, extcon_id, event);
</pre></div>
</div>
<p>log如下，识别过程花费时间<code class="docutils literal notranslate"><span class="pre">0.302503</span></code>s：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>   <span class="mf">74.957732</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">Got</span> <span class="n">VBUS</span> <span class="n">notification</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">[</span>   <span class="mf">74.963686</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">name_show</span> <span class="o">=</span> <span class="n">NAME</span><span class="o">=</span><span class="n">soc</span><span class="p">:</span><span class="n">rt_pd_manager</span>
<span class="p">[</span>   <span class="mf">74.969536</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">state_show</span> <span class="o">=</span> <span class="n">STATE</span><span class="o">=</span><span class="n">USB</span><span class="o">=</span><span class="mi">1</span>
<span class="p">[</span>   <span class="mf">74.969536</span><span class="p">]</span> <span class="n">USB</span><span class="o">-</span><span class="n">HOST</span><span class="o">=</span><span class="mi">0</span>
<span class="p">[</span>   <span class="mf">74.979288</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>   <span class="mf">74.983873</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">qusb_phy_enable_power</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">regulators</span>
<span class="p">[</span>   <span class="mf">74.991506</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">min_vol</span><span class="p">:</span><span class="mi">925000</span> <span class="n">max_vol</span><span class="p">:</span><span class="mi">970000</span>
<span class="p">[</span>   <span class="mf">74.999738</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">qusb_phy_enable_clocks</span><span class="p">():</span> <span class="n">on</span><span class="p">:</span><span class="mi">1</span>
<span class="p">[</span>   <span class="mf">75.006219</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">[</span>   <span class="mf">75.043606</span><span class="p">]</span> <span class="o">///</span><span class="n">PD</span> <span class="n">dbg</span> <span class="n">info</span> <span class="mi">42</span><span class="n">d</span>
<span class="p">[</span>   <span class="mf">75.043779</span><span class="p">]</span> <span class="n">PAX_CHG_MP2721</span><span class="p">:</span> <span class="n">mp2721_info</span> <span class="n">tcpc_notifier_call</span><span class="p">,</span> <span class="n">old_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">null</span><span class="p">),</span> <span class="n">new_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="p">[</span>   <span class="mf">75.046699</span><span class="p">]</span> <span class="o">&lt;</span>   <span class="mf">75.043</span><span class="o">&gt;</span><span class="n">Trigger</span> <span class="n">PD_TIMER_SINK_WAIT_CAP</span>
<span class="p">[</span>   <span class="mf">75.060061</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">[</span>   <span class="mf">75.062241</span><span class="p">]</span> <span class="n">PAX_CHG_MP2721</span><span class="p">:</span> <span class="n">mp2721_info</span> <span class="n">tcpc_notifier_call</span><span class="p">,</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">UNATTACHED</span><span class="p">,</span> <span class="n">new_state</span> <span class="o">=</span> <span class="n">UNATTACHED</span>
<span class="p">[</span>   <span class="mf">75.065356</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">1</span> <span class="n">reg</span><span class="p">:</span> <span class="mh">0x0</span>
<span class="p">[</span>   <span class="mf">75.065359</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">[</span>   <span class="mf">75.085011</span><span class="p">]</span> <span class="n">rt</span><span class="o">-</span><span class="n">pd</span><span class="o">-</span><span class="n">manager</span> <span class="n">soc</span><span class="p">:</span><span class="n">rt_pd_manager</span><span class="p">:</span> <span class="n">pd_tcp_notifier_call</span> <span class="n">pd</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">9</span>
<span class="p">[</span>   <span class="mf">75.088173</span><span class="p">]</span> <span class="n">E</span><span class="p">:</span><span class="n">pd_state</span><span class="o">=</span><span class="mi">9</span>
<span class="p">[</span>   <span class="mf">75.138681</span><span class="p">]</span> <span class="n">PAX_CHG_MP2721</span><span class="p">:</span> <span class="n">tcpc_notifier_call</span> <span class="n">sink</span> <span class="n">vbus</span> <span class="mi">5000</span><span class="n">mV</span> <span class="mi">100</span><span class="n">mA</span> <span class="nb">type</span><span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
<span class="p">[</span>   <span class="mf">75.164064</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">[</span>   <span class="mf">75.175473</span><span class="p">]</span> <span class="n">rt</span><span class="o">-</span><span class="n">pd</span><span class="o">-</span><span class="n">manager</span> <span class="n">soc</span><span class="p">:</span><span class="n">rt_pd_manager</span><span class="p">:</span> <span class="n">pd_tcp_notifier_call</span> <span class="n">sink</span> <span class="n">vbus</span> <span class="mi">5000</span><span class="n">mV</span> <span class="mi">100</span><span class="n">mA</span> <span class="nb">type</span><span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
<span class="p">[</span>   <span class="mf">75.221475</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">2</span> <span class="n">reg</span><span class="p">:</span> <span class="mh">0x0</span>
<span class="p">[</span>   <span class="mf">75.226998</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">qusb_phy_enable_clocks</span><span class="p">():</span> <span class="n">on</span><span class="p">:</span><span class="mi">0</span>
<span class="p">[</span>   <span class="mf">75.233477</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">qusb_phy_enable_power</span> <span class="n">turn</span> <span class="n">off</span> <span class="n">regulators</span>
<span class="p">[</span>   <span class="mf">75.241424</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">min_vol</span><span class="p">:</span><span class="mi">0</span> <span class="n">max_vol</span><span class="p">:</span><span class="mi">970000</span>
<span class="p">[</span>   <span class="mf">75.247378</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">QUSB</span> <span class="n">PHY</span><span class="s1">&#39;s regulators are turned OFF.</span>
<span class="p">[</span>   <span class="mf">75.254457</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">Notify</span> <span class="n">charger</span> <span class="nb">type</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">[</span>   <span class="mf">75.260235</span><span class="p">]</span> <span class="n">mp2721</span> <span class="mi">0</span><span class="o">-</span><span class="mi">003</span><span class="n">f</span><span class="p">:</span> <span class="n">mp2721_set_property</span><span class="p">()</span> <span class="nb">set</span> <span class="n">charge_type</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">ret</span><span class="p">:</span><span class="mi">0</span>
</pre></div>
</div>
<p>DCP识别过程log如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">行</span> <span class="mi">1585</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">14</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">Got</span> <span class="n">VBUS</span> <span class="n">notification</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">行</span> <span class="mi">1594</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">14</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">行</span> <span class="mi">1595</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">qusb_phy_enable_power</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">regulators</span>
<span class="n">行</span> <span class="mi">1600</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">min_vol</span><span class="p">:</span><span class="mi">925000</span> <span class="n">max_vol</span><span class="p">:</span><span class="mi">970000</span>
<span class="n">行</span> <span class="mi">1618</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">qusb_phy_enable_clocks</span><span class="p">():</span> <span class="n">on</span><span class="p">:</span><span class="mi">1</span>
<span class="n">行</span> <span class="mi">1619</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">行</span> <span class="mi">1630</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">行</span> <span class="mi">1635</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">1</span> <span class="n">reg</span><span class="p">:</span> <span class="mh">0x0</span>
<span class="n">行</span> <span class="mi">1639</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">行</span> <span class="mi">1649</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">行</span> <span class="mi">1650</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">2</span> <span class="n">reg</span><span class="p">:</span> <span class="mh">0x10101010</span>
<span class="n">行</span> <span class="mi">1654</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">行</span> <span class="mi">1661</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">行</span> <span class="mi">1662</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">state</span><span class="p">:</span> <span class="mi">3</span> <span class="n">reg</span><span class="p">:</span> <span class="mh">0x10101010</span>
<span class="n">行</span> <span class="mi">1666</span><span class="p">:</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">15</span> <span class="mi">1969</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">Notify</span> <span class="n">charger</span> <span class="nb">type</span><span class="p">:</span> <span class="mi">5</span>
</pre></div>
</div>
<p>处理函数如下工作队列：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">qusb_phy_port_state_work</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">qusb_phy</span><span class="w"> </span><span class="o">*</span><span class="n">qphy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qusb_phy</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">port_det_w</span><span class="p">.</span><span class="n">work</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">vbus_active</span><span class="p">,</span><span class="w"> </span><span class="n">id_state</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_err</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * The events for cable connect should be ignored if</span>
<span class="cm">	 * the is_port_valid set to false to prevent the USB</span>
<span class="cm">	 * stack being brought up and voting for the regulators.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">is_port_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qphy_get_notifier_gpio_state</span><span class="p">(</span><span class="n">qphy</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">is_port_valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Port not valid, notify disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">id_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">id_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PORT_UNKNOWN</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">id_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_extcon</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vbus_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">eud_enable_reg</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">					</span><span class="n">readl_relaxed</span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">eud_enable_reg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;qusb: EUD is enabled, no charger detection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">qusb_phy_notify_charger</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">qusb_phy_notify_extcon</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_CHG_DET_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>

<span class="w">			</span><span class="cm">/* Enable DCD sequence */</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qusb_phy_prepare_chg_det</span><span class="p">(</span><span class="n">qphy</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">			</span><span class="n">qusb_phy_chg_det_enable_seq</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">STATE_DCD</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_DCD_IN_PROGRESS</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">dcd_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHG_DCD_POLL_TIME_MSEC</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PORT_DISCONNECTED</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">qusb_phy_unprepare_chg_det</span><span class="p">(</span><span class="n">qphy</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_UNKNOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PORT_DCD_IN_PROGRESS</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vbus_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* Disable PHY sequence */</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_DISCONNECTED</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qusb_phy_chg_det_status</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">STATE_DCD</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">dcd_timeout</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CHG_DCD_TIMEOUT_MSEC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHG_DCD_POLL_TIME_MSEC</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">dcd_timeout</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delay</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_chg_det_enable_seq</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">STATE_PRIMARY</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_PRIMARY_IN_PROGRESS</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHG_PRIMARY_DET_TIME_MSEC</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">dcd_timeout</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">CHG_DCD_TIMEOUT_MSEC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_charger</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">POWER_SUPPLY_TYPE_USB_DCP</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_unprepare_chg_det</span><span class="p">(</span><span class="n">qphy</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_CHG_DET_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PORT_PRIMARY_IN_PROGRESS</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vbus_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_DISCONNECTED</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qusb_phy_chg_det_status</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">STATE_PRIMARY</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_chg_det_enable_seq</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">STATE_SECONDARY</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_SECONDARY_IN_PROGRESS</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHG_SECONDARY_DET_TIME_MSEC</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_unprepare_chg_det</span><span class="p">(</span><span class="n">qphy</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_charger</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_extcon</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_CHG_DET_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PORT_SECONDARY_IN_PROGRESS</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vbus_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_DISCONNECTED</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qusb_phy_chg_det_status</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">STATE_SECONDARY</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_charger</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">POWER_SUPPLY_TYPE_USB_DCP</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_charger</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">POWER_SUPPLY_TYPE_USB_CDP</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_extcon</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">qusb_phy_unprepare_chg_det</span><span class="p">(</span><span class="n">qphy</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_CHG_DET_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="cm">/*</span>
<span class="cm">		 * Fall through to check if cable got disconnected</span>
<span class="cm">		 * during detection.</span>
<span class="cm">		 */</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PORT_CHG_DET_DONE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vbus_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_UNKNOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_extcon</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PORT_HOST_MODE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PORT_UNKNOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">qusb_phy_notify_extcon</span><span class="p">(</span><span class="n">qphy</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_freezable_wq</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="o">&amp;</span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">port_det_w</span><span class="p">,</span><span class="w"> </span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="smblite-usb">
<h2>smblite usb设置充电类型接口<a class="headerlink" href="#smblite-usb" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">drivers/power/supply/qcom/qpnp-smblite.c</span></code>:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">smblite_usb_set_prop</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_property</span><span class="w"> </span><span class="n">psp</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="k">const</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">power_supply_propval</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">psp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">POWER_SUPPLY_PROP_REAL_TYPE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smblite_lib_set_prop_usb_type</span><span class="p">(</span><span class="n">chg</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;set prop %d is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">psp</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply_desc</span><span class="w"> </span><span class="n">usb_psy_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;usb&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smblite_usb_props</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">num_properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smblite_usb_props</span><span class="p">),</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">get_property</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smblite_usb_get_prop</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">set_property</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smblite_usb_set_prop</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">property_is_writeable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smblite_usb_prop_is_writeable</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">smblite_init_usb_psy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">smblite</span><span class="w"> </span><span class="o">*</span><span class="n">chip</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply_config</span><span class="w"> </span><span class="n">usb_cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">smb_charger</span><span class="w"> </span><span class="o">*</span><span class="n">chg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chg</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">usb_cfg</span><span class="p">.</span><span class="n">drv_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chip</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">usb_cfg</span><span class="p">.</span><span class="n">of_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_power_supply_register</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						  </span><span class="o">&amp;</span><span class="n">usb_psy_desc</span><span class="p">,</span><span class="w"></span>
<span class="w">						  </span><span class="o">&amp;</span><span class="n">usb_cfg</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register USB power supply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">chg</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;wugn test register USB power supply OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">smblite_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smblite_init_usb_psy</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t initialize usb psy rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="dw3usb">
<h1>DW3驱动设置USB主从模式<a class="headerlink" href="#dw3usb" title="此标题的永久链接"></a></h1>
<p>dw3驱动额注册了extcon notify，有2个notify接收主从切换信息，分别是<code class="docutils literal notranslate"><span class="pre">dwc3_msm_id_notifier</span></code>和<code class="docutils literal notranslate"><span class="pre">dwc3_msm_vbus_notifier</span></code>，主要是BC12检测完后，用来接收qusb phy的USB切换信息，当dw3接收到消息后都会启用工作队列<code class="docutils literal notranslate"><span class="pre">resume_work</span></code>,代码流程如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">dwc3_msm_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">resume_work</span><span class="p">,</span><span class="w"> </span><span class="n">dwc3_resume_work</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">of_property_read_bool</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;extcon&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc3_msm_extcon_register</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">put_dwc3</span><span class="p">;</span><span class="w">	</span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dwc3_msm_extcon_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">extcon_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_count_phandle_with_args</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;extcon&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_kcalloc</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">extcon_cnt</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span><span class="w">	</span>

<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">extcon_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">idx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_get_edev_by_phandle</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">edev</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">edev</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">edev</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">edev</span><span class="p">))</span><span class="w"></span>
<span class="w">			</span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">check_vbus_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_id_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">phandle_found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">mdwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mdwc</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edev</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">vbus_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">						</span><span class="n">dwc3_msm_vbus_notifier</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_register_notifier</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">vbus_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">check_vbus_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">id_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc3_msm_id_notifier</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_register_notifier</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">id_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">check_id_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">blocking_sync_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">					</span><span class="n">dwc3_usb_blocking_sync</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">extcon_register_blocking_notifier</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">blocking_sync_nb</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* Update initial VBUS/ID state */</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_vbus_state</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">extcon_get_state</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">))</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_vbus_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">vbus_nb</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">edev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_id_state</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">				</span><span class="n">extcon_get_state</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">))</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_id_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">id_nb</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">edev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="c1">//这里主要绑定了两个notify：</span>
<span class="nl">EXTCON_USB_HOST</span><span class="p">:</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dwc3_msm_id_notifier</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">nb</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3</span><span class="w"> </span><span class="o">*</span><span class="n">dwc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_nb</span><span class="w"> </span><span class="o">*</span><span class="n">enb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_nb</span><span class="p">,</span><span class="w"> </span><span class="n">id_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enb</span><span class="o">-&gt;</span><span class="n">mdwc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">enum</span><span class="w"> </span><span class="nc">dwc3_id_state</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">edev</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">mdwc</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;extcon idx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">enb</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DWC3_ID_GROUND</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">DWC3_ID_FLOAT</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ext_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enb</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;host:%ld (id:%d) event received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">queue_work</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">resume_work</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nl">EXTCON_USB</span><span class="p">:</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dwc3_msm_vbus_notifier</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">nb</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3</span><span class="w"> </span><span class="o">*</span><span class="n">dwc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_nb</span><span class="w"> </span><span class="o">*</span><span class="n">enb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_nb</span><span class="p">,</span><span class="w"> </span><span class="n">vbus_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enb</span><span class="o">-&gt;</span><span class="n">mdwc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">eud_str</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">edev_name</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">edev</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">mdwc</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;extcon idx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">enb</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vbus:%ld event received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">edev_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_get_edev_name</span><span class="p">(</span><span class="n">edev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;edev:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">edev_name</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* detect USB spoof disconnect/connect notification with EUD device */</span><span class="w"></span>
<span class="w">	</span><span class="n">eud_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strnstr</span><span class="p">(</span><span class="n">edev_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eud&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">edev_name</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eud_str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">eud_active</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">eud_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">check_eud_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * Drive a pulse on DP to ensure proper CDP detection</span>
<span class="cm">	 * and only when the vbus connect event is a valid one.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_psy_type</span><span class="p">(</span><span class="n">mdwc</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">POWER_SUPPLY_TYPE_USB_CDP</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">check_eud_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Connected to CDP, pull DP up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_drive_dp_pulse</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="p">,</span><span class="w"> </span><span class="n">DP_PULSE_WIDTH_MSEC</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc3_is_otg_or_drd</span><span class="p">(</span><span class="n">dwc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_restart</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">queue_work</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">resume_work</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<section id="resume-work">
<h2>resume_work主从切换原理<a class="headerlink" href="#resume-work" title="此标题的永久链接"></a></h2>
<p>USB主从切换主要是通过resume_work工作队列来完成，</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">dwc3_resume_work</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">dwc3_msm_resume</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置usb phy</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">dwc3_ext_event_notify</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="c1">//启动工作队列切主从</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_usb_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">	  </span><span class="o">*</span><span class="w"> </span><span class="n">dwc3_otg_sm_work</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">dwc3_otg_start_peripheral</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">//从</span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">dwc3_otg_start_host</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">//主</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dwc3_resume_work</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="p">,</span><span class="w"> </span><span class="n">resume_work</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3</span><span class="w"> </span><span class="o">*</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="w"> </span><span class="nc">extcon_property_value</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">extcon_id</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">extcon_dev</span><span class="w"> </span><span class="o">*</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">edev_name</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">eud_str</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: dwc3 resume work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_restart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">extcon_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXTCON_USB</span><span class="p">;</span><span class="w"> </span><span class="c1">//从</span>
<span class="w">		</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ext_idx</span><span class="p">].</span><span class="n">edev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DWC3_ID_GROUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">extcon_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXTCON_USB_HOST</span><span class="p">;</span><span class="w"> </span><span class="c1">//主</span>
<span class="w">		</span><span class="n">edev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">extcon</span><span class="p">[</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ext_idx</span><span class="p">].</span><span class="n">edev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">edev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">edev_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_get_edev_name</span><span class="p">(</span><span class="n">edev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dbg_log_string</span><span class="p">(</span><span class="s">&quot;edev:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">edev_name</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* Skip querying speed and cc_state for EUD edev */</span><span class="w"></span>
<span class="w">		</span><span class="n">eud_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strnstr</span><span class="p">(</span><span class="n">edev_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eud&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">edev_name</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eud_str</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">skip_update</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">max_hw_supp_speed</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* Check speed and Type-C polarity values in order to configure PHY */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">edev</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">extcon_get_state</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">extcon_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_get_property</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">extcon_id</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">EXTCON_PROP_USB_SS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USB_SPEED_HIGH</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_get_property</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">extcon_id</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">EXTCON_PROP_USB_TYPEC_POLARITY</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">typec_orientation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ORIENTATION_NONE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">typec_orientation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="w"> </span><span class="o">?</span><span class="w"></span>
<span class="w">					</span><span class="nl">ORIENTATION_CC2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ORIENTATION_CC1</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cc_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">typec_orientation</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extcon_get_property</span><span class="p">(</span><span class="n">edev</span><span class="p">,</span><span class="w"> </span><span class="n">extcon_id</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">EXTCON_PROP_USB_TYPEC_MED_HIGH_CURRENT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">is_selfpowered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">is_selfpowered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="nl">skip_update</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="n">dbg_log_string</span><span class="p">(</span><span class="s">&quot;max_speed:%d hw_supp_speed:%d override_speed:%d&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="p">,</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">max_hw_supp_speed</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">override_usb_speed</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">override_usb_speed</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">override_usb_speed</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">override_usb_speed</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;speed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * Skip scheduling sm work if no work is pending. When boot-up</span>
<span class="cm">	 * with USB cable connected, usb state m/c is skipped to avoid</span>
<span class="cm">	 * any changes to dp/dm lines. As PM supsend and resume can</span>
<span class="cm">	 * happen while charger is connected, scheduling sm work during</span>
<span class="cm">	 * pm resume will reset the controller and phy which might impact</span>
<span class="cm">	 * dp/dm lines (and charging voltage).</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DRD_STATE_UNDEFINED</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">		</span><span class="o">!</span><span class="n">edev</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">resume_pending</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * exit LPM first to meet resume timeline from device side.</span>
<span class="cm">	 * resume_pending flag would prevent calling</span>
<span class="cm">	 * dwc3_msm_resume() in case we are here due to system</span>
<span class="cm">	 * wide resume without usb cable connected. This flag is set</span>
<span class="cm">	 * only in case of power event irq in lpm.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">resume_pending</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_resume</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">resume_pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_suspended</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RWrk PMSus&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* let pm resume kick in resume work later */</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">dwc3_ext_event_notify</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//设置usb phy：</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">dwc3_msm_resume</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">long</span><span class="w"> </span><span class="n">core_clk_rate</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3</span><span class="w"> </span><span class="o">*</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_irq</span><span class="w"> </span><span class="o">*</span><span class="n">uirq</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: exiting lpm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * If h/w exited LPM without any events, ensure</span>
<span class="cm">	 * h/w is reset before processing any new events.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">set_bit</span><span class="p">(</span><span class="n">WAIT_FOR_LPM</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">suspend_resume_mutex</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">in_lpm</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: Already resumed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">suspend_resume_mutex</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">pm_stay_awake</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_host_mode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">max_rh_port_speed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">USB_SPEED_HIGH</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_update_bus_bw</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="n">BUS_VOTE_SVS</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_update_bus_bw</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">default_bus_vote</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Vote for TCXO while waking up USB HSPHY */</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">xo_clk</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s failed to vote TCXO buffer%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Restore controller power collapse */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MDWC3_POWER_COLLAPSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: exit power collapse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_config_gdsc</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset_control_assert</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_reset</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:core_reset assert failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* HW requires a short delay for reset to take place properly */</span><span class="w"></span>
<span class="w">		</span><span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">1200</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset_control_deassert</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_reset</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:core_reset deassert failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sleep_clk</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gdsc_collapse_in_host_suspend</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_host_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Turn on GDSC in host mode bus resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_config_gdsc</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>


<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * Enable clocks</span>
<span class="cm">	 * Turned ON iface_clk before core_clk due to FSM depedency.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">iface_clk</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">noc_aggr_clk</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">noc_aggr_clk</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">core_clk_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_clk_rate</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_host_mode</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">max_rh_port_speed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">USB_SPEED_HIGH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">core_clk_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_clk_rate_hs</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: set hs core clk rate %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">core_clk_rate</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">clk_set_rate</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_clk</span><span class="p">,</span><span class="w"> </span><span class="n">core_clk_rate</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_clk</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* set Memory core: ON, Memory periphery: ON */</span><span class="w"></span>
<span class="w">	</span><span class="n">clk_set_flags</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_clk</span><span class="p">,</span><span class="w"> </span><span class="n">CLKFLAG_RETAIN_MEM</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">clk_set_flags</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">core_clk</span><span class="p">,</span><span class="w"> </span><span class="n">CLKFLAG_RETAIN_PERIPH</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">utmi_clk</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">bus_aggr_clk</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">bus_aggr_clk</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * Disable any wakeup events that were enabled if pwr_event_irq</span>
<span class="cm">	 * is used as wakeup interrupt.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MDWC3_USE_PWR_EVENT_IRQ_FOR_WAKEUP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">wakeup_irq</span><span class="p">[</span><span class="n">PWR_EVNT_IRQ</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_set_pwr_events</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">MDWC3_USE_PWR_EVENT_IRQ_FOR_WAKEUP</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Resume SS PHY */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">USB_SPEED_SUPER</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MDWC3_SS_PHY_SUSPEND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">PHY_LANE_A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PHY_LANE_B</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">orientation_override</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">orientation_override</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">typec_orientation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ORIENTATION_CC1</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PHY_LANE_A</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">typec_orientation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ORIENTATION_CC2</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PHY_LANE_B</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_set_suspend</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">DEVICE_IN_SS_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">MDWC3_SS_PHY_SUSPEND</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_host_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">u32</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">DWC3_GUSB3PIPECTL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">			</span><span class="n">reg</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">DWC3_GUSB3PIPECTL_DISRXDETU3</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_writel</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">DWC3_GUSB3PIPECTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">reg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">PHY_HSFS_MODE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PHY_LS_MODE</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* Resume HS PHY */</span><span class="w"></span>
<span class="w">	</span><span class="n">usb_phy_set_suspend</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Recover from controller power collapse */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MDWC3_POWER_COLLAPSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: exit power collapse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">dwc3_msm_power_collapse_por</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">MDWC3_POWER_COLLAPSE</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">in_lpm</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* enable power evt irq for IN P3 detection */</span><span class="w"></span>
<span class="w">	</span><span class="n">enable_irq</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">wakeup_irq</span><span class="p">[</span><span class="n">PWR_EVNT_IRQ</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Disable HSPHY auto suspend */</span><span class="w"></span>
<span class="w">	</span><span class="n">dwc3_msm_write_reg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">DWC3_GUSB2PHYCFG</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_read_reg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">DWC3_GUSB2PHYCFG</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">				</span><span class="o">~</span><span class="n">DWC3_GUSB2PHYCFG_SUSPHY</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Disable wakeup capable for HS_PHY IRQ &amp; SS_PHY_IRQ if enabled */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MDWC3_ASYNC_IRQ_WAKE_CAPABILITY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">use_pdc_interrupts</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">			</span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">wakeup_irq</span><span class="p">[</span><span class="n">HS_PHY_IRQ</span><span class="p">].</span><span class="n">irq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">configure_usb_wakeup_interrupts</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">uirq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">wakeup_irq</span><span class="p">[</span><span class="n">HS_PHY_IRQ</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span><span class="n">configure_nonpdc_usb_interrupt</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="n">uirq</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">uirq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">wakeup_irq</span><span class="p">[</span><span class="n">SS_PHY_IRQ</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span><span class="n">configure_nonpdc_usb_interrupt</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="n">uirq</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">lpm_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">MDWC3_ASYNC_IRQ_WAKE_CAPABILITY</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_info</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;DWC3 exited from low power mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Enable core irq */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">enable_irq</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * Handle other power events that could not have been handled during</span>
<span class="cm">	 * Low Power Mode</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="n">dwc3_pwr_event_handler</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pm_qos_request_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">))</span><span class="w"></span>
<span class="w">		</span><span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">perf_vote_work</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PM_QOS_SAMPLE_SEC</span><span class="p">));</span><span class="w"></span>

<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Ctl Res&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">in_lpm</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">suspend_resume_mutex</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//主从切换实际是sm_work做的：</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dwc3_ext_event_notify</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* Flush processing any pending events before handling new ones */</span><span class="w"></span>
<span class="w">	</span><span class="n">flush_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">id_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DWC3_ID_FLOAT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XCVR: ID set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">set_bit</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XCVR: ID clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">clear_bit</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_restart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">EUD_SPOOF_DISCONNECT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XCVR:EUD: BSV clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">clear_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XCVR: BSV set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">set_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XCVR: BSV clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">clear_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XCVR: SUSP set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">set_bit</span><span class="p">(</span><span class="n">B_SUSPEND</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XCVR: SUSP clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">clear_bit</span><span class="p">(</span><span class="n">B_SUSPEND</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">check_eud_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"></span>
<span class="w">			</span><span class="o">~</span><span class="p">(</span><span class="n">EUD_SPOOF_CONNECT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">EUD_SPOOF_DISCONNECT</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eud: state:%d active:%d hs_phy_flags:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">check_eud_state</span><span class="p">,</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">eud_active</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">eud_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">EUD_SPOOF_CONNECT</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;EUD: XCVR: BSV set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">set_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">EUD_SPOOF_DISCONNECT</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;EUD: XCVR: BSV clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">clear_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">check_eud_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>


<span class="w">	</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eud: state:%d active:%d hs_phy_flags:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">check_eud_state</span><span class="p">,</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">eud_active</span><span class="p">,</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* handle case of USB cable disconnect after USB spoof disconnect */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">EUD_SPOOF_DISCONNECT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">EUD_SPOOF_DISCONNECT</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PHY_SUS_OVERRIDE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_set_suspend</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PHY_SUS_OVERRIDE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_usb_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="o">*</span><span class="w"> </span><span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">,</span><span class="w"> </span><span class="n">dwc3_otg_sm_work</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_usb_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">dwc3_otg_sm_work</span><span class="w"></span>
<span class="cm">/**</span>
<span class="cm"> * dwc3_otg_sm_work - workqueue function.</span>
<span class="cm"> *</span>
<span class="cm"> * @w: Pointer to the dwc3 otg workqueue</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: After any change in drd_state, we must reschdule the state machine.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dwc3_otg_sm_work</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="p">,</span><span class="w"> </span><span class="n">sm_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3</span><span class="w"> </span><span class="o">*</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">state</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dwc is NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc3_drd_state_string</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Check OTG state */</span><span class="w"></span>
<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">DRD_STATE_UNDEFINED</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dpdm_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">regulator_unregister_notifier</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dpdm_reg</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dpdm_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dpdm_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* put controller and phy in suspend if no cable connected */</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">				</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;undef_id_!bsv&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_resume</span><span class="p">(</span><span class="n">mdwc</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Undef NoUSB&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exit UNDEF&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_runtime_set_suspended</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* fall-through */</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">DRD_STATE_IDLE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WAIT_FOR_LPM</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;still not in lpm, wait.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;!id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_HOST_IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b_sess_vld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_psy_type</span><span class="p">(</span><span class="n">mdwc</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">POWER_SUPPLY_TYPE_USB_FLOAT</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3_wq</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sdp_check</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">SDP_CONNETION_CHECK_TIME</span><span class="p">));</span><span class="w"></span>

<span class="w">			</span><span class="cm">/*</span>
<span class="cm">			 * Increment pm usage count upon cable connect. Count</span>
<span class="cm">			 * is decremented in DRD_STATE_PERIPHERAL state on</span>
<span class="cm">			 * cable disconnect or in bus suspend.</span>
<span class="cm">			 */</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BIDLE gsync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_otg_start_peripheral</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_PERIPHERAL</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_gadget_vbus_draw</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cable disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">DRD_STATE_PERIPHERAL</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">				</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;!id || !bsv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sdp_check</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_otg_start_peripheral</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="cm">/*</span>
<span class="cm">			 * Decrement pm usage count upon cable disconnect</span>
<span class="cm">			 * which was incremented upon cable connect in</span>
<span class="cm">			 * DRD_STATE_IDLE state</span>
<span class="cm">			 */</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_put_sync_suspend</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;!BSV psync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">			</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">B_SUSPEND</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="n">test_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BPER bsv &amp;&amp; susp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_PERIPHERAL_SUSPEND</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="cm">/*</span>
<span class="cm">			 * Decrement pm usage count upon bus suspend.</span>
<span class="cm">			 * Count was incremented either upon cable</span>
<span class="cm">			 * connect in DRD_STATE_IDLE or host</span>
<span class="cm">			 * initiated resume after bus suspend in</span>
<span class="cm">			 * DRD_STATE_PERIPHERAL_SUSPEND state</span>
<span class="cm">			 */</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SUSP put&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">DRD_STATE_PERIPHERAL_SUSPEND</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">B_SESS_VLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BSUSP: !bsv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sdp_check</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_otg_start_peripheral</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">B_SUSPEND</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BSUSP !susp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_PERIPHERAL</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="cm">/*</span>
<span class="cm">			 * Increment pm usage count upon host</span>
<span class="cm">			 * initiated resume. Count was decremented</span>
<span class="cm">			 * upon bus suspend in</span>
<span class="cm">			 * DRD_STATE_PERIPHERAL state.</span>
<span class="cm">			 */</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;!SUSP gsync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">DRD_STATE_HOST_IDLE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* Switch to A-Device*/</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_retry_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc3_otg_start_host</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">						</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_retry_count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="cm">/*</span>
<span class="cm">				 * Get regulator failed as regulator driver is</span>
<span class="cm">				 * not up yet. Will try to start host after 1sec</span>
<span class="cm">				 */</span><span class="w"></span>
<span class="w">				</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unable to get vbus regulator. Retrying...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VBUS_REG_CHECK_DELAY</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_retry_count</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unable to start host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="k">goto</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_HOST</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">DRD_STATE_HOST</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hc_died</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id || hc_died</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_otg_start_host</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">drd_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DRD_STATE_IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_retry_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hc_died</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;still in a_host state. Resuming root hub.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;XHCIResume&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="n">pm_runtime_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: invalid otg-state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">work</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_usb_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">sm_work</span><span class="p">,</span><span class="w"> </span><span class="n">delay</span><span class="p">);</span><span class="w"></span>

<span class="nl">ret</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>以上得知主从切换的主要函数是<code class="docutils literal notranslate"><span class="pre">dwc3_otg_start_peripheral</span></code>和<code class="docutils literal notranslate"><span class="pre">dwc3_otg_start_host</span></code>。</p>
<p>具体看一下干了些什么：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * dwc3_otg_start_host -  helper function for starting/stoping the host</span>
<span class="cm"> * controller driver.</span>
<span class="cm"> *</span>
<span class="cm"> * @mdwc: Pointer to the dwc3_msm structure.</span>
<span class="cm"> * @on: start / stop the host controller driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success otherwise negative errno.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">dwc3_otg_start_host</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">on</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3</span><span class="w"> </span><span class="o">*</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">	 * The vbus_reg pointer could have multiple values</span>
<span class="cm">	 * NULL: regulator_get() hasn&#39;t been called, or was previously deferred</span>
<span class="cm">	 * IS_ERR: regulator could not be obtained, so skip using it</span>
<span class="cm">	 * Valid pointer otherwise</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_regulator_get_optional</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="s">&quot;vbus_dwc3&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">				</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* regulators may not be ready, so retry again later */</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: turn on host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;StrtHost gync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">maximum_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">USB_SPEED_SUPER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">usb_phy_notify_connect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">USB_SPEED_SUPER</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">usb_phy_notify_connect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="p">,</span><span class="w"> </span><span class="n">USB_SPEED_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">))</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regulator_enable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unable to enable vbus_reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vregerr psync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>


<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">host_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc3_msm_host_notifier</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_register_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">host_nb</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">dwc3_set_prtcap</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span><span class="w"> </span><span class="n">DWC3_GCTL_PRTCAP_HOST</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_en_sleep_mode</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">usbdev_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msm_dwc3_usbdev_notify</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_register_atomic_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">usbdev_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc3_host_init</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="s">&quot;%s: failed to add XHCI pdev ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">))</span><span class="w"></span>
<span class="w">				</span><span class="n">regulator_disable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">);</span><span class="w"></span>

<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pdeverr psync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">			</span><span class="n">usb_unregister_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">host_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_host_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_usb3_phy_suspend</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* Reduce the U3 exit handshake timer from 8us to approximately</span>
<span class="cm">		 * 300ns to avoid lfps handshake interoperability issues</span>
<span class="cm">		 */</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">revision</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DWC3_USB31_REVISION_170A</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_write_reg_field</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">DWC31_LINK_LU3LFPSRXTIM</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">					</span><span class="n">GEN2_U3_EXIT_RSP_RX_CLK_MASK</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_write_reg_field</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">DWC31_LINK_LU3LFPSRXTIM</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">					</span><span class="n">GEN1_U3_EXIT_RSP_RX_CLK_MASK</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LU3:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">dwc3_msm_read_reg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">DWC31_LINK_LU3LFPSRXTIM</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* xHCI should have incremented child count as necessary */</span><span class="w"></span>
<span class="w">		</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;StrtHost psync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_runtime_put_sync_autosuspend</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PM_QOS_REQ_AFFINE_IRQ</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">.</span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">		</span><span class="n">pm_qos_add_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">PM_QOS_CPU_DMA_LATENCY</span><span class="p">,</span><span class="w"> </span><span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* start in perf mode for better performance initially */</span><span class="w"></span>
<span class="w">		</span><span class="n">msm_dwc3_perf_vote_update</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">perf_vote_work</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PM_QOS_SAMPLE_SEC</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: turn off host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">usb_unregister_atomic_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">usbdev_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">))</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regulator_disable</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">vbus_reg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unable to disable vbus_reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">perf_vote_work</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">msm_dwc3_perf_vote_update</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_qos_remove_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;StopHost gsync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_notify_disconnect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="p">,</span><span class="w"> </span><span class="n">USB_SPEED_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PHY_HOST_MODE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">usb_phy_notify_disconnect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">USB_SPEED_SUPER</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PHY_HOST_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_host_exit</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_unregister_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">host_nb</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">dwc3_set_prtcap</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span><span class="w"> </span><span class="n">DWC3_GCTL_PRTCAP_DEVICE</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_usb3_phy_suspend</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_host_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* wait for LPM, to ensure h/w is reset after stop_host */</span><span class="w"></span>
<span class="w">		</span><span class="n">set_bit</span><span class="p">(</span><span class="n">WAIT_FOR_LPM</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">pm_runtime_put_sync_suspend</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;StopHost psync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * dwc3_otg_start_peripheral -  bind/unbind the peripheral controller.</span>
<span class="cm"> *</span>
<span class="cm"> * @mdwc: Pointer to the dwc3_msm structure.</span>
<span class="cm"> * @on:   Turn ON/OFF the gadget.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success otherwise negative errno.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">dwc3_otg_start_peripheral</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3_msm</span><span class="w"> </span><span class="o">*</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">on</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">dwc3</span><span class="w"> </span><span class="o">*</span><span class="n">dwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dwc3</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;StrtGdgt gsync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: turn on gadget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">dwc3_override_vbus_status</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_notify_connect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="p">,</span><span class="w"> </span><span class="n">USB_SPEED_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_notify_connect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="p">,</span><span class="w"> </span><span class="n">USB_SPEED_SUPER</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="cm">/*</span>
<span class="cm">		 * Core reset is not required during start peripheral. Only</span>
<span class="cm">		 * DBM reset is required, hence perform only DBM reset here.</span>
<span class="cm">		 */</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_msm_block_reset</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_set_prtcap</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span><span class="w"> </span><span class="n">DWC3_GCTL_PRTCAP_DEVICE</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_dis_sleep_mode</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_device_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* Reduce the U3 exit handshake timer from 8us to approximately</span>
<span class="cm">		 * 300ns to avoid lfps handshake interoperability issues</span>
<span class="cm">		 */</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">revision</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DWC3_USB31_REVISION_170A</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_write_reg_field</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">DWC31_LINK_LU3LFPSRXTIM</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">					</span><span class="n">GEN2_U3_EXIT_RSP_RX_CLK_MASK</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dwc3_msm_write_reg_field</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">DWC31_LINK_LU3LFPSRXTIM</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">					</span><span class="n">GEN1_U3_EXIT_RSP_RX_CLK_MASK</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LU3:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">dwc3_msm_read_reg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">DWC31_LINK_LU3LFPSRXTIM</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">usb_gadget_vbus_connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span><span class="w"></span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PM_QOS_REQ_AFFINE_IRQ</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">.</span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">		</span><span class="n">pm_qos_add_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">PM_QOS_CPU_DMA_LATENCY</span><span class="p">,</span><span class="w"> </span><span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* start in perf mode for better performance initially */</span><span class="w"></span>
<span class="w">		</span><span class="n">msm_dwc3_perf_vote_update</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">perf_vote_work</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PM_QOS_SAMPLE_SEC</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: turn off gadget %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">perf_vote_work</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">msm_dwc3_perf_vote_update</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_qos_remove_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">pm_qos_req_dma</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">in_device_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_gadget_vbus_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_notify_disconnect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">hs_phy</span><span class="p">,</span><span class="w"> </span><span class="n">USB_SPEED_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">usb_phy_notify_disconnect</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">ss_phy</span><span class="p">,</span><span class="w"> </span><span class="n">USB_SPEED_SUPER</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_override_vbus_status</span><span class="p">(</span><span class="n">mdwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dwc3_usb3_phy_suspend</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* wait for LPM, to ensure h/w is reset after stop_peripheral */</span><span class="w"></span>
<span class="w">		</span><span class="n">set_bit</span><span class="p">(</span><span class="n">WAIT_FOR_LPM</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;StopGdgt psync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="usb-device">
<h2>USB device切换<a class="headerlink" href="#usb-device" title="此标题的永久链接"></a></h2>
<p>前面BC12检测完后，将调用<code class="docutils literal notranslate"><span class="pre">qusb_phy_notify_extcon(qphy,</span> <span class="pre">EXTCON_USB,</span> <span class="pre">1)</span></code> 通知dw3驱动切换device</p>
</section>
</section>
<section id="usbpower-supply-type-unknown">
<h1>拔usb时设置充电类型为POWER_SUPPLY_TYPE_UNKNOWN<a class="headerlink" href="#usbpower-supply-type-unknown" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>目前smblite是在拔插中断中判断vbus是否在位，不在位则设置为POWER_SUPPLY_TYPE_UNKNOWN，打印如下：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="mf">51.107378</span><span class="p">]</span> <span class="n">PM2250_charger</span><span class="p">:</span> <span class="n">smblite_usbin_uv_irq_handler</span><span class="p">:</span> <span class="n">IRQ</span><span class="p">:</span> <span class="n">usbin</span><span class="o">-</span><span class="n">uv</span>
<span class="p">[</span>   <span class="mf">51.109555</span><span class="p">]</span> <span class="n">PM2250_charger</span><span class="p">:</span> <span class="n">smblite_usb_plugin_irq_handler</span><span class="p">:</span> <span class="n">smblite_usb_plugin_irq_handler</span>
<span class="p">[</span>   <span class="mf">51.109588</span><span class="p">]</span> <span class="n">PM2250_charger</span><span class="p">:</span> <span class="n">smblite_lib_set_charge_param</span><span class="p">:</span> <span class="n">AICL</span> <span class="mi">5</span><span class="n">V</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">4200</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
<span class="p">[</span>   <span class="mf">51.109622</span><span class="p">]</span> <span class="n">PM2250_charger</span><span class="p">:</span> <span class="n">smblite_lib_usb_plugin_locked</span><span class="p">:</span> <span class="n">IRQ</span><span class="p">:</span> <span class="n">usbin</span><span class="o">-</span><span class="n">plugin</span> <span class="n">detached</span>
</pre></div>
</div>
<ul class="simple">
<li><p>程序流程：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>* smblite_usb_plugin_irq_handler(int irq, void *data)
  └── smblite_lib_usb_plugin_locked(chg);
      └── if (!vbus_rising)
          └── smblite_lib_update_usb_type(chg, POWER_SUPPLY_TYPE_UNKNOWN);
              └── chg-&gt;real_charger_type = type;
</pre></div>
</div>
</section>
<section id="device">
<h1>device流程实例<a class="headerlink" href="#device" title="此标题的永久链接"></a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>source plug in:
[   74.748103] rt-pd-manager soc:rt_pd_manager: usb_dwork_handler Device
[   74.753185] &lt;   74.670&gt;TCPC-TCPC:wake_lock=1
[   74.753185] &lt;   74.670&gt;TCPC-TCPC:sink_vbus: 5000 mV, 100 mA
[   74.753185] &lt;   74.670&gt;Enable TYPEC_RT_TIMER_NOT_LEGACY
[   74.753185] &lt;
[   74.753187]  74.670&gt;TCPC-TYPEC:Attached-&gt; SINK
[   74.753187] &lt;   74.670&gt;TCPC-TCPC:usb_port_attached
[   74.753187] &lt;   74.671&gt;TCPC-DC&gt; dc_dfp_none
[   74.753187] &lt;   74.671&gt;TCPC-PE:PD
[   48.386548] pax-pd-manager soc:pax_pd_manager: pd_tcp_notifier_call Charger plug in, polarity = 0
[   48.404179] pax-pd-manager soc:pax_pd_manager: usb_dwork_handler Device
[   48.410913] extcon extcon2: extcon_set_state_sync id = 2 state = 0
[   48.417736] extcon extcon2: extcon_set_state_sync state 1
[   48.423351] extcon extcon2: extcon_set_state_sync id = 1 state = 1
[   48.429615] mp2721 0-003f: type=1, chg_type=0, count=2
[   48.429620] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.429626] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 471600084
[   48.429631] mp2721 0-003f: device check bc12 fail!
[   48.430040] extcon extcon2: extcon_set_state_sync state 1
[   48.449529] extcon extcon2: extcon_sync state 1
[   48.465202] extcon extcon2: extcon_sync state 2 index = 0
[   48.471262] extcon extcon2: extcon_sync state 3
[   48.476160] msm-qusb-phy 1613000.qusb: Got VBUS notification: 1
[   48.482220] mp2721 0-003f: type=1, chg_type=0, count=3
[   48.482223] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.482230] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 524203366
[   48.482235] mp2721 0-003f: device check bc12 fail!
[   48.507245] extcon extcon2: name_show = NAME=soc:pax_pd_manager
[   48.513191] extcon extcon2: state_show = STATE=USB=1
[   48.513191] USB-HOST=0
[   48.521141] msm-qusb-phy 1613000.qusb: state: 0
[   48.530050] msm-qusb-phy 1613000.qusb: qusb_phy_enable_power turn on regulators
[   48.537465] mp2721 0-003f: type=1, chg_type=0, count=4
[   48.537469] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.537475] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 579448678
[   48.537480] mp2721 0-003f: device check bc12 fail!
[   48.563235] msm-qusb-phy 1613000.qusb: min_vol:925000 max_vol:970000
[   48.579924] msm-qusb-phy 1613000.qusb: qusb_phy_enable_clocks(): on:1
[   48.587511] mp2721 0-003f: type=1, chg_type=0, count=5
[   48.592682] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.598814] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 640786490
[   48.606938] mp2721 0-003f: device check bc12 fail!
[   48.621453] msm-qusb-phy 1613000.qusb: state: 1
[   48.648845] mp2721 0-003f: type=1, chg_type=0, count=6
[   48.654010] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.660135] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 702107845
[   48.668261] mp2721 0-003f: device check bc12 fail!
[   48.676209] msm-qusb-phy 1613000.qusb: state: 2
[   48.681101] msm-qusb-phy 1613000.qusb: state: 1 reg: 0x0
[   48.686592] msm-qusb-phy 1613000.qusb: state: 2
[   48.710171] mp2721 0-003f: type=1, chg_type=0, count=7
[   48.715334] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.721447] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 763417688
[   48.729580] mp2721 0-003f: device check bc12 fail!
[   48.771487] mp2721 0-003f: type=1, chg_type=0, count=8
[   48.776649] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.776656] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 818629303
[   48.776663] mp2721 0-003f: device check bc12 fail!
[   48.788213] msm-qusb-phy 1613000.qusb: state: 3
[   48.820139] msm-qusb-phy 1613000.qusb: state: 2 reg: 0x0
[   48.826684] mp2721 0-003f: type=1, chg_type=0, count=9
[   48.831853] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.837974] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 879946751
[   48.846091] mp2721 0-003f: device check bc12 fail!
[   48.886176] msm-qusb-phy 1613000.qusb: qusb_phy_enable_clocks(): on:0
[   48.892753] mp2721 0-003f: type=1, chg_type=0, count=10
[   48.892757] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.892762] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 934736647
[   48.892767] mp2721 0-003f: device check bc12 fail!
[   48.942797] mp2721 0-003f: type=1, chg_type=0, count=11
[   48.948042] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   48.954162] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 48 996134824
[   48.962297] mp2721 0-003f: device check bc12 fail!
[   48.972099] msm-qusb-phy 1613000.qusb: qusb_phy_enable_power turn off regulators
[   48.980846] msm-qusb-phy 1613000.qusb: min_vol:0 max_vol:970000
[   48.986876] msm-qusb-phy 1613000.qusb: QUSB PHY&#39;s regulators are turned OFF.
[   48.994081] msm-qusb-phy 1613000.qusb: Notify charger type: 4
[   49.004177] mp2721 0-003f: type=1, chg_type=0, count=12
[   49.009425] mp2721 0-003f: restart pax_wait_bc12_alarm_timer_func
[   49.015547] mp2721 0-003f: pax_wait_bc12_start_timer: alarm timer start:-1, 49 57517011
[   49.023586] mp2721 0-003f: device check bc12 fail!
[   49.029583] mp2721 0-003f: mp2721_set_property() set charge_type:4, ret:0
[   49.037074] msm-qusb-phy 1613000.qusb: Notify event: 1 for extcon_id: 1
[   49.043889] extcon extcon3: extcon_set_state_sync id = 1 state = 1
[   49.050686] extcon extcon3: extcon_set_state_sync state 1
[   49.060712] extcon extcon3: extcon_sync state 1
[   49.065557] mp2721 0-003f: type=1, chg_type=4, count=13
[   49.065579] mp2721 0-003f: device check bc12 fail!
[   49.065628] plug status: plug in
[   49.071225] extcon extcon3: extcon_sync state 2 index = 0
[   49.087428] extcon extcon3: extcon_sync state 3
[   49.092125] msm-dwc3 4e00000.ssusb: vbus:1 event received
[   49.099253] extcon extcon3: name_show = NAME=1613000.qusb
[   49.100370] msm-dwc3 4e00000.ssusb: dwc3_resume_work: dwc3 resume work
[   49.104686] extcon extcon3: state_show = STATE=USB=1
[   49.104686] USB-HOST=0
[   49.109038] msm-qusb-phy 1613000.qusb: state: 5
[   49.155382] msm-dwc3 4e00000.ssusb: XCVR: ID set
[   49.163556] msm-dwc3 4e00000.ssusb: XCVR: BSV set
[   49.180118] msm-dwc3 4e00000.ssusb: XCVR: SUSP clear
[   49.185375] msm-dwc3 4e00000.ssusb: eud: state:0 active:0 hs_phy_flags:0x0
[   49.212318] msm-dwc3 4e00000.ssusb: idle state
[   49.217269] msm-dwc3 4e00000.ssusb: b_sess_vld
[   49.221918] msm-dwc3 4e00000.ssusb: DWC3-msm runtime resume
[   49.242776] msm-dwc3 4e00000.ssusb: dwc3_msm_resume: exiting lpm
[   49.256189] msm-dwc3 4e00000.ssusb: dwc3_msm_resume: exit power collapse
[   49.281388] msm-qusb-phy 1613000.qusb: qusb_phy_enable_power turn on regulators
[   49.316391] msm-qusb-phy 1613000.qusb: min_vol:925000 max_vol:970000
[   49.347048] msm-qusb-phy 1613000.qusb: qusb_phy_enable_clocks(): on:1
[   49.372279] msm-dwc3 4e00000.ssusb: dwc3_msm_resume: exit power collapse
[   49.423957] msm-qusb-phy 1613000.qusb: qusb_phy_init
[   49.456549] msm-qusb-phy 1613000.qusb: QUSB2PHY_PLL_STATUS:30
[   49.483932] msm-usb-ssphy-qmp 1615000.ssphy: USB QMP PHY: Update TYPEC CTRL(2)
[   49.524418] msm-qusb-phy 1613000.qusb: qusb_phy_set_suspend: USB PHY is already suspended
[   49.560749] msm-dwc3 4e00000.ssusb: DWC3_CONTROLLER_POST_RESET_EVENT received
[   49.584225] msm-dwc3 4e00000.ssusb: msm_dwc3_pwr_irq received
[   49.584231] msm-dwc3 4e00000.ssusb: dwc3_pwr_event_handler irq_stat=8000C
[   49.596805] msm-dwc3 4e00000.ssusb: dwc3_pwr_event_handler link state = 0x0004
[   49.601896] msm-dwc3 4e00000.ssusb: dwc3_pwr_event_handler irq_stat=8000C
[   49.604045] msm-dwc3 4e00000.ssusb: dwc3_pwr_event_handler: unexpected PWR_EVNT, irq_stat=80000
[   49.621312] mp2721 0-003f: chg_dump: CHG [online: 1, type: SDP, status: Charging, fault: OK, health: Good, ICHG = 4000mA, AICR = 2000mA, MIVR = 4440mV, IEOC = 240mA, CV = 4350mV]
[   49.627252] msm-dwc3 4e00000.ssusb: dwc3_pwr_event_handler link state = 0x0004
[   49.658680] msm-dwc3 4e00000.ssusb: dwc3_pwr_event_handler: unexpected PWR_EVNT, irq_stat=80000
[   49.672169] msm-dwc3 4e00000.ssusb: dwc3_otg_start_peripheral: turn on gadget dwc3-gadget
[   49.692780] msm-qusb-phy 1613000.qusb: QUSB PHY: connect notification cable_connected=1
[   49.706225] msm-dwc3 4e00000.ssusb: DWC3_GSI_EVT_BUF_SETUP
[   49.711740] msm-dwc3 4e00000.ssusb: Evt buf ffffff80098ad000 dma affdb000 length 4096
[   49.719606] msm-dwc3 4e00000.ssusb: Evt buf ffffff80098b5000 dma affda000 length 4096
[   49.727468] msm-dwc3 4e00000.ssusb: Evt buf ffffff80098bd000 dma affd9000 length 4096
[   49.786785] msm-dwc3 4e00000.ssusb: peripheral state

plug out:
[   73.168794] rt-pd-manager soc:rt_pd_manager: pd_tcp_notifier_call Charger plug out
[   73.176642] rt-pd-manager soc:rt_pd_manager: usb_dwork_handler Idle
[   73.177428] set prop 125 is not supported
[   73.183395] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.188369] PM2250_charger: smblite_lib_get_charge_param: input current limit status = 0 (0x00)
[   73.190253] SET_PLUG_EN: 1
[   73.195323] msm-qusb-phy 1613000.qusb: Got VBUS notification: 0
[   73.195940] msm-qusb-phy 1613000.qusb: state: 5
[   73.195944] msm-qusb-phy 1613000.qusb: Notify event: 0 for extcon_id: 1
[   73.196221] PM2250_charger: smblite_lib_get_prop_batt_health: CHARGER_VBAT_STATUS_REG = 0x04
[   73.196375] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.204006] set prop 122 is not supported
[   73.204471] PM2250_charger: smblite_lib_get_prop_batt_health: CHARGER_VBAT_STATUS_REG = 0x04
[   73.205042] PM2250_charger: smblite_lib_get_charge_param: input current limit status = 0 (0x00)
[   73.205179] PM2250_charger: smblite_lib_get_prop_batt_health: CHARGER_VBAT_STATUS_REG = 0x04
[   73.211462] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.211539] PM2250_charger: smblite_lib_get_prop_batt_health: CHARGER_VBAT_STATUS_REG = 0x04
[   73.211675] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.234879] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.245143] PM2250_charger: smblite_lib_get_prop_batt_health: CHARGER_VBAT_STATUS_REG = 0x04
[   73.262564] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01

console:/ $ [   73.330003] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.338079] PM2250_charger: smblite_lib_get_prop_batt_health: CHARGER_VBAT_STATUS_REG = 0x00
[   73.346910] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.357028] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
[   73.365073] PM2250_charger: smblite_lib_get_prop_batt_health: CHARGER_VBAT_STATUS_REG = 0x00
[   73.374007] PM2250_charger: smblite_lib_get_prop_usb_online: POWER_PATH_STATUS = 0x01
</pre></div>
</div>
</section>
<section id="pax-extcon">
<h1>PAX extcon实例<a class="headerlink" href="#pax-extcon" title="此标题的永久链接"></a></h1>
<p>目前将qcom charger的extcon通知改为我们自己PD驱动去通知，在qusb接收notify中加<code class="docutils literal notranslate"><span class="pre">dump_stack</span></code>打印如下，表示是从pax接收的通知：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1553.131</span><span class="o">&gt;</span><span class="n">TCPC</span><span class="o">-</span><span class="n">TCPC</span><span class="p">:</span><span class="n">RA_DETACH</span>\<span class="n">x0a</span><span class="o">&lt;</span> <span class="mf">1553.131</span><span class="o">&gt;</span><span class="n">TCPC</span><span class="o">-</span><span class="n">TCPC</span><span class="p">:</span><span class="n">tcpci_alert_cc_changed</span> <span class="o">++</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">pax</span><span class="o">-</span><span class="n">pd</span><span class="o">-</span><span class="n">manager</span> <span class="n">soc</span><span class="p">:</span><span class="n">pax_pd_manager</span><span class="p">:</span> <span class="n">pd_tcp_notifier_call</span> <span class="o">-</span> <span class="n">sink</span> <span class="n">vbus</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">pax</span><span class="o">-</span><span class="n">pd</span><span class="o">-</span><span class="n">manager</span> <span class="n">soc</span><span class="p">:</span><span class="n">pax_pd_manager</span><span class="p">:</span> <span class="n">pd_tcp_notifier_call</span> <span class="n">event</span> <span class="o">=</span> <span class="mi">14</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">pax</span><span class="o">-</span><span class="n">pd</span><span class="o">-</span><span class="n">manager</span> <span class="n">soc</span><span class="p">:</span><span class="n">pax_pd_manager</span><span class="p">:</span> <span class="n">pd_tcp_notifier_call</span> <span class="n">Charger</span> <span class="n">plug</span> <span class="ow">in</span><span class="p">,</span> <span class="n">polarity</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">//</span><span class="n">PD识别插入usb</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">set_charger_plug_status</span> <span class="n">status</span> <span class="mi">1</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">plug</span> <span class="n">status</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="o">///</span><span class="n">PD</span> <span class="n">dbg</span> <span class="n">info</span> <span class="mi">37</span><span class="n">d</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1553.194</span><span class="o">&gt;</span><span class="n">TCPC</span><span class="o">-</span><span class="n">TYPEC</span><span class="p">:[</span><span class="n">CC_Alert</span><span class="p">]</span> <span class="mi">0</span><span class="o">/</span><span class="mi">7</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">pax</span><span class="o">-</span><span class="n">pd</span><span class="o">-</span><span class="n">manager</span> <span class="n">soc</span><span class="p">:</span><span class="n">pax_pd_manager</span><span class="p">:</span> <span class="n">usb_dwork_handler</span> <span class="n">Device</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">PAX_CHG</span><span class="p">:</span> <span class="n">handle_typec_attach_dettach</span><span class="p">:</span> <span class="o">++</span> <span class="n">en</span><span class="p">:</span><span class="mi">1</span> <span class="n">g_info</span><span class="o">-&gt;</span><span class="n">sink_mv_new</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">extcon_set_state_sync</span> <span class="nb">id</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">PAX_CHG_MP2721</span><span class="p">:</span> <span class="n">mp2721_enable_vbus_ovp</span> <span class="n">en</span><span class="p">:</span><span class="mi">0</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">pax_is_charger_on</span> <span class="n">chr_type</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">extcon_set_state_sync</span> <span class="n">state</span> <span class="mi">1</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">extcon_set_state_sync</span> <span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">extcon_set_state_sync</span> <span class="n">state</span> <span class="mi">1</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">extcon_sync</span> <span class="n">state</span> <span class="mi">1</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">extcon_sync</span> <span class="n">state</span> <span class="mi">2</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon</span> <span class="n">extcon2</span><span class="p">:</span> <span class="n">extcon_sync</span> <span class="n">state</span> <span class="mi">3</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">CPU</span><span class="p">:</span> <span class="mi">1</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">46</span> <span class="n">Comm</span><span class="p">:</span> <span class="n">kworker</span><span class="o">/</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span> <span class="n">Tainted</span><span class="p">:</span> <span class="n">G</span>        <span class="n">W</span>         <span class="mf">4.19.157</span> <span class="c1">#1</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">Hardware</span> <span class="n">name</span><span class="p">:</span> <span class="n">Qualcomm</span> <span class="n">Technologies</span><span class="p">,</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">Scuba</span> <span class="n">IOT</span> <span class="n">IDP</span> <span class="p">(</span><span class="n">DT</span><span class="p">)</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">Workqueue</span><span class="p">:</span> <span class="n">events</span> <span class="n">usb_dwork_handler</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">Call</span> <span class="n">trace</span><span class="p">:</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">dump_backtrace</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x250</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">show_stack</span><span class="o">+</span><span class="mh">0x14</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">dump_stack</span><span class="o">+</span><span class="mh">0xc8</span><span class="o">/</span><span class="mh">0x104</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">qusb_phy_vbus_notifier</span><span class="o">+</span><span class="mh">0x20</span><span class="o">/</span><span class="mh">0x78</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">raw_notifier_call_chain</span><span class="o">+</span><span class="mh">0x78</span><span class="o">/</span><span class="mh">0xb8</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon_sync</span><span class="o">+</span><span class="mh">0x120</span><span class="o">/</span><span class="mh">0x330</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">extcon_set_state_sync</span><span class="o">+</span><span class="mh">0xd4</span><span class="o">/</span><span class="mh">0xf8</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">usb_dwork_handler</span><span class="o">+</span><span class="mh">0x164</span><span class="o">/</span><span class="mh">0x170</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">process_one_work</span><span class="o">+</span><span class="mh">0x278</span><span class="o">/</span><span class="mh">0x468</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">worker_thread</span><span class="o">+</span><span class="mh">0x238</span><span class="o">/</span><span class="mh">0x4c8</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0x148</span><span class="o">/</span><span class="mh">0x158</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x10</span><span class="o">/</span><span class="mh">0x1c</span>
<span class="p">[</span><span class="n">Tue</span> <span class="n">Aug</span>  <span class="mi">2</span> <span class="mi">20</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2022</span><span class="p">]</span> <span class="n">msm</span><span class="o">-</span><span class="n">qusb</span><span class="o">-</span><span class="n">phy</span> <span class="mf">1613000.</span><span class="n">qusb</span><span class="p">:</span> <span class="n">Got</span> <span class="n">VBUS</span> <span class="n">notification</span><span class="p">:</span> <span class="mi">1</span>
</pre></div>
</div>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>