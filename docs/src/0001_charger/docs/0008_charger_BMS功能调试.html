<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">测试要求</a></li>
<li><a class="reference internal" href="#id4">68电量异常关闭充电</a></li>
<li><a class="reference internal" href="#pd">PD快充插入充电无法关闭充电</a></li>
<li><a class="reference internal" href="#bms">BMS回充打印</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>BMS功能介绍</p>
</section>
<section id="id2">
<h1>参考<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><span class="xref myst">0008_BMS相关介绍</span></p></li>
</ul>
</section>
<section id="id3">
<h1>测试要求<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<p><img alt="0008_0000.png" src="../../../_images/0008_0000.png" /></p>
</section>
<section id="id4">
<h1>68电量异常关闭充电<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<p>68%电量，bms服务关闭了充电，异常打印如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>11-02 10:08:01.317  1001  1001 D PaxBatteryManagerService: onReceive action = android.intent.action.BOOT_COMPLETED
11-02 10:08:03.495  1001  2114 D PaxBatteryManagerService: Wait ACTION_BOOT_COMPLETED
11-02 10:08:03.495  1001  2114 D PaxBatteryManagerService: PaxBatteryThread run1
11-02 10:08:03.496  1001  2114 D PaxBatteryManagerService: PaxBatteryManagerService init
11-02 10:08:03.521  1001  2114 D PaxBatteryManagerService: batterylog_db path = /data/system/batterylog.db
11-02 10:08:03.521  1001  2114 D PaxBatteryManagerService: mode = 0
11-02 10:08:03.521  1001  2114 D PaxBatteryManagerService: init initcurMode = 1
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: onReceive action = android.intent.action.BATTERY_CHANGED
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: onReceive bms_switch = 1
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: mode = 0
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: chargeState = 1
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: getInitcurMode = 0
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: batteryTermInfo.getCurmode() = 0
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: mBatteryLevel = 68
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: batteryTermInfo.getFullcharge() = 0
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: batteryTermInfo.getRecharge() = 0
11-02 10:08:03.527  1001  1001 D PaxBatteryManagerService: discharge
11-02 10:08:03.528  1001  1001 D PaxBatteryManagerService: setChargeState: 0
11-02 10:08:03.531  1001  1001 D PaxBatteryManagerService: setChargeState over
11-02 10:08:03.532  1001  1001 D PaxBatteryManagerService: disablePowerPath
11-02 10:08:03.558  1001  2114 D PaxBatteryManagerService: mBatteryManagerInternal.getPlugType() = 2
11-02 10:08:03.558  1001  2114 D PaxBatteryManagerService: count_times = 0
11-02 10:08:03.559  1001  2114 D PaxBatteryManagerService: Boot_flag = 1
11-02 10:08:03.559  1001  2114 D PaxBatteryManagerService: Remove_outdated_data

#40秒后才获取到Curmode
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: onReceive action = android.intent.action.BATTERY_CHANGED
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: onReceive bms_switch = 1
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: mode = 0
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: chargeState = 0
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: getInitcurMode = 0
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: batteryTermInfo.getCurmode() = 1
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: mBatteryLevel = 72
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: batteryTermInfo.getFullcharge() = 100
11-02 10:08:43.057   976   976 D PaxBatteryManagerService: batteryTermInfo.getRecharge() = 85
11-02 10:08:49.598   976  2115 D PaxBatteryManagerService: count_times = 180
11-02 10:08:49.599   976  2115 D PaxBatteryManagerService: Boot_flag = 0
11-02 10:08:49.599   976  2115 D PaxBatteryManagerService: mode = 0

</pre></div>
</div>
<p>底层收到关闭的ioctrl，log如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>11-02 10:08:35.350 I/PAX_BMS (    0): SET_CHG_EN: 0
11-02 10:08:35.350 E/        (    0): bms_notify_call_chain
11-02 10:08:35.350 E/PAX_CHG (    0): bms_notify_event evt = SET_CHG_EN en:0
11-02 10:08:35.352 E/PAX_CHG (    0): enable_charging en: 0 last_en: 1
11-02 10:08:35.352 E/PAX_CHG (    0): pax_charger_update, delay&lt;40&gt;
11-02 10:08:35.352 I/PAX_BMS (    0): type: NC_DISABLE_CHG_BY_USER, disable: 1, vote: 0x200000
11-02 10:08:35.352 I/PAX_BMS (    0): SET_POWER_PATH: 0
11-02 10:08:35.352 E/        (    0): bms_notify_call_chain
11-02 10:08:35.352 E/PAX_CHG (    0): bms_notify_event evt = SET_POWER_PATH en:0
11-02 10:08:35.353 E/PAX_CHG (    0): enable_powerpath en: 0
11-02 10:08:35.353 E/PAX_CHG (    0): pax_charger_update, delay&lt;40&gt;
</pre></div>
</div>
<p>发现是bms没有设置<code class="docutils literal notranslate"><span class="pre">Fullcharge</span></code>和<code class="docutils literal notranslate"><span class="pre">Recharge</span></code>默认值，加上就好了：</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="nf">BatteryTermInfo</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">curmode</span><span class="p">){</span><span class="w"></span>
<span class="w">		</span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;ro.product.model&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;M8&quot;</span><span class="p">)){</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">predicted_hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PREDICTED_HOURS_DEFAULT_M8</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;M50&quot;</span><span class="p">)){</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">predicted_hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PREDICTED_HOURS_DEFAULT_M50</span><span class="p">;</span><span class="w">	</span>
<span class="w">		</span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;A6650&quot;</span><span class="p">)){</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">predicted_hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PREDICTED_HOURS_DEFAULT_A6650</span><span class="p">;</span><span class="w">	</span>
<span class="w">		</span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;M9200&quot;</span><span class="p">)){</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">predicted_hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PREDICTED_HOURS_DEFAULT_M9200</span><span class="p">;</span><span class="w">	</span>
<span class="w">		</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">predicted_hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PREDICTED_HOURS_DEFAULT</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">//if(model.equals(&quot;M50&quot;) || model.equals(&quot;A800&quot;) || model.equals(&quot;M8&quot;)){//M50,3, , 5</span><span class="w"></span>
<span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">curmode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curmode</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">save_data_min</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="na">predicted_hours</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PREDICTED_DAYS_MIN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">95</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="c1">//至少3天的数据</span><span class="w"></span>
<span class="w">		</span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="s">&quot;save_data_min0 = &quot;</span><span class="o">+</span><span class="n">save_data_min</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">curmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">COUNTER_TOP_MODE</span><span class="p">){</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">recharge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNTER_TOP_MODE_RECHARGE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">fullcharge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNTER_TOP_MODE_FULLCHARGE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">recharge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MOBILE_MODE_RECHARGE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">fullcharge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MOBILE_MODE_FULLCHARGE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">saveday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SAVE_DAYS</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="c1">// }</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="pd">
<h1>PD快充插入充电无法关闭充电<a class="headerlink" href="#pd" title="此标题的永久链接"></a></h1>
<p>首先确认一下PD充电的时序，log如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>11-03 04:10:33.995 I/&lt;61888.910&gt;TCPC-TYPEC(    0): [CC_Alert] 7/0
11-03 04:10:33.995 I/&lt;61888.911&gt;TCPC-TCPC(    0): [Warning] ps_changed 1 -&gt; 0
11-03 04:10:33.995 I/&lt;61888.912&gt;TCPC-TYPEC(    0): ** AttachWait.SNK
11-03 04:10:33.995 I/        (    0): &lt;6
11-03 04:10:33.995 I/1888.913&gt;TCPC-TCPC(    0): Alert:0x220000, Mask:0x20fff
11-03 04:10:33.995 I/&lt;61888.913&gt;TCPC-TCPC(    0): tcpci_alert_power_status_changed_v10 ++
11-03 04:10:33.995 I/        (    0): &lt;61888.914&gt;TCPC-TCP
11-03 04:10:33.995 I/        (    0): C:ps_change=0
11-03 04:10:33.995 I/&lt;61888.917&gt;TCPC-TCPC(    0): Alert:0x200000, Mask:0x20fff
11-03 04:10:34.096 I/        (    0): ///PD dbg info 80d
11-03 04:10:34.096 I/&lt;61889.032&gt;TCPC-TYPEC(    0): [CC_Change] 7/0
11-03 04:10:34.096 I/&lt;61889.032&gt;TCPC-TYPEC(    0): wait_ps=SNK_VSafe5V
11-03 04:10:34.127 I/        (    0): ///PD dbg info 111d
11-03 04:10:34.127 I/&lt;61889.063&gt;TCPC-TCPC(    0): Alert:0x200002, Mask:0x20fff
11-03 04:10:34.127 I/&lt;61889.063&gt;TCPC-TCPC(    0): tcpci_alert_power_status_changed_v10 ++
11-03 04:10:34.151 I/        (    0): ///PD dbg info 382d
11-03 04:10:34.151 I/&lt;61889.064&gt;TCPC-TCPC(    0): ps_change=2
11-03 04:10:34.151 I/&lt;61889.065&gt;TCPC-TYPEC(    0): wait_ps=Disable
11-03 04:10:34.151 I/&lt;61889.065&gt;TCPC-TYPEC(    0): ** Try.SRC
11-03 04:10:34.151 I/&lt;61889.067&gt;TCPC-TCPC(    0): Ale
11-03 04:10:34.151 I/rt      (    0): 0x200001, Mask:0x20fff
11-03 04:10:34.151 I/&lt;61889.068&gt;TCPC-TCPC(    0): tcpci_alert_cc_changed ++
11-03 04:10:34.151 I/&lt;61889.069&gt;TCPC-TYPEC(    0): [CC_Alert] 0/1
11-03 04:10:34.151 I/        (    0): &lt;61889.086&gt;TCPC-TC
11-03 04:10:34.151 I/PC      (    0): Alert:0x200002, Mask:0x20fff
11-03 04:10:34.151 I/&lt;61889.086&gt;TCPC-TCPC(    0): tcpci_alert_power_status_changed_v10 ++
11-03 04:10:34.151 I/&lt;61889.087&gt;TCPC-TCPC(    0): ps_change=1
11-03 04:10:34.175 I/        (    0): ///PD dbg info 144d
11-03 04:10:34.175 I/&lt;61889.100&gt;TCPC-TCPC(    0): Alert:0x220000, Mask:0x20fff
11-03 04:10:34.175 I/&lt;61889.100&gt;TCPC-TCPC(    0): tcpci_alert_power_status_changed_v10 ++
11-03 04:10:34.175 I/        (    0): &lt;61889.101&gt;TCPC-T
11-03 04:10:34.175 I/CPC     (    0): ps_change=0
11-03 04:10:34.232 I/        (    0): ///PD dbg info 75d
11-03 04:10:34.232 I/&lt;61889.167&gt;TCPC-TYPEC(    0): [CC_Change] 0/1
11-03 04:10:34.232 I/&lt;61889.167&gt;TCPC-TYPEC(    0): ** TryWait.SNK
11-03 04:10:34.232 E/        (    0): pd_tcp_notifier_call event = SOURCE_VBUS
11-03 04:10:34.232 E/        (    0): pd_tcp_notifier_call source vbus 0mV
11-03 04:10:34.232 E/        (    0): pd_tcp_notifier_call - source vbus 0v output
11-03 04:10:34.232 E/PAX_CHG (    0): vbus_off
11-03 04:10:34.232 E/PAX_CHG (    0): issue work, ops&lt;0&gt;, delay&lt;0&gt;
11-03 04:10:34.232 E/PAX_CHG (    0): _set_otg_enable now_status:0 set_status:0
11-03 04:10:34.255 I/        (    0): ///PD dbg info 134d
11-03 04:10:34.255 I/&lt;61889.171&gt;TCPC-TCPC(    0): Alert:0x200001, Mask:0x20fff
11-03 04:10:34.255 I/&lt;61889.171&gt;TCPC-TCPC(    0): tcpci_alert_cc_changed ++
11-03 04:10:34.255 I/&lt;61889.172&gt;TCPC-TYPEC(    0): [CC_Alert
11-03 04:10:34.255 I/        (    0): ] 7/0
11-03 04:10:34.357 I/        (    0): ///PD dbg info 80d
11-03 04:10:34.357 I/&lt;61889.293&gt;TCPC-TYPEC(    0): [CC_Change] 7/0
11-03 04:10:34.357 I/&lt;61889.293&gt;TCPC-TYPEC(    0): wait_ps=SNK_VSafe5V
11-03 04:10:34.389 I/        (    0): ///PD dbg info 111d
11-03 04:10:34.389 I/&lt;61889.324&gt;TCPC-TCPC(    0): Alert:0x200002, Mask:0x20fff
11-03 04:10:34.389 I/&lt;61889.325&gt;TCPC-TCPC(    0): tcpci_alert_power_status_changed_v10 ++
11-03 04:10:34.392 E/        (    0): pd_tcp_notifier_call event = SINK_VBUS
11-03 04:10:34.392 E/charger soc(    0): charger: pd_tcp_notifier_call sink vbus 5000mV 3000mA type(0x01)
11-03 04:10:34.392 E/        (    0): pd_tcp_notifier_call - sink vbus
11-03 04:10:34.392 E/        (    0): pd_tcp_notifier_call event = TYPEC_STATE
11-03 04:10:34.392 E/        (    0): tcpc_notifier_call, old_state = UNATTACHED, new_state = ATTACHED_SNK //1. ATTACHED_SNK
11-03 04:10:34.392 E/        (    0): pd_tcp_notifier_call Charger plug in, polarity = 0
11-03 04:10:34.392 E/PAX_CHG (    0): handle_typec_attach_dettach: ++ en:1
11-03 04:10:34.403 I/charger soc(    0): charger: usb_dwork_handler Device
11-03 04:10:34.411 I/        (    0): ///PD dbg info 186d
11-03 04:10:34.411 I/&lt;61889.325&gt;TCPC-TCPC(    0): ps_change=2
11-03 04:10:34.411 I/&lt;61889.326&gt;TCPC-TYPEC(    0): wait_ps=Disable
11-03 04:10:34.411 I/&lt;61889.326&gt;TCPC-TYPEC(    0): ** Attached.SNK
11-03 04:10:34.411 I/        (    0): &lt;61889.327&gt;TCPC-TYP
11-03 04:10:34.411 I/EC      (    0): Attached-&gt; SINK
11-03 04:10:34.411 I/&lt;61889.327&gt;TCPC-TCPC(    0): usb_port_attached
11-03 04:10:34.442 I/        (    0): ///PD dbg info 56d
11-03 04:10:34.442 I/&lt;61889.378&gt;TCPC-TYPEC(    0): type=1, ret,chg_type=0,0, count=1
11-03 04:10:34.492 I/        (    0): ///PD dbg info 56d
11-03 04:10:34.492 I/&lt;61889.428&gt;TCPC-TYPEC(    0): type=1, ret,chg_type=0,0, count=2
11-03 04:10:34.522 I/        (    0): ///PD dbg info 50d
11-03 04:10:34.522 I/&lt;61889.457&gt;TCPC-TCPC(    0): Alert:0x200001, Mask:0x20fff
11-03 04:10:34.543 I/        (    0): ///PD dbg info 178d
11-03 04:10:34.543 I/&lt;61889.458&gt;TCPC-TCPC(    0): tcpci_alert_cc_changed ++
11-03 04:10:34.543 I/&lt;61889.459&gt;TCPC-TYPEC(    0): [CC_Alert] 7/0
11-03 04:10:34.543 I/&lt;61889.470&gt;TCPC-TYPEC(    0): [CC_Change] 7/0
11-03 04:10:34.543 I/        (    0): &lt;61889
11-03 04:10:34.543 I/.478&gt;TCPC-TYPEC(    0): type=1, ret,chg_type=0,0, count=3
11-03 04:10:34.571 I/        (    0): ///PD dbg info 356d
11-03 04:10:34.571 I/&lt;61889.483&gt;TCPC-TCPC(    0): Alert:0x200001, Mask:0x20fff
11-03 04:10:34.571 I/&lt;61889.483&gt;TCPC-TCPC(    0): tcpci_alert_cc_changed ++
11-03 04:10:34.571 I/&lt;61889.485&gt;TCPC-TYPEC(    0): [CC_Alert
11-03 04:10:34.571 I/        (    0): ] 7/0
11-03 04:10:34.571 I/&lt;61889.487&gt;TCPC-TCPC(    0): Alert:0x200001, Mask:0x20fff
11-03 04:10:34.571 I/&lt;61889.487&gt;TCPC-TCPC(    0): tcpci_alert_cc_changed ++
11-03 04:10:34.571 I/&lt;61889.488&gt;TCPC-TYPEC(    0): [CC
11-03 04:10:34.571 I/        (    0): _Alert] 7/0
11-03 04:10:34.571 I/&lt;61889.490&gt;TCPC-TCPC(    0): Alert:0x200000, Mask:0x20fff
11-03 04:10:34.571 I/&lt;61889.499&gt;TCPC-TYPEC(    0): [CC_Change] 7/0
11-03 04:10:34.595 I/        (    0): ///PD dbg info 56d
11-03 04:10:34.595 I/&lt;61889.528&gt;TCPC-TYPEC(    0): type=1, ret,chg_type=0,0, count=4
11-03 04:10:34.643 I/        (    0): ///PD dbg info 56d
11-03 04:10:34.643 I/&lt;61889.578&gt;TCPC-TYPEC(    0): type=1, ret,chg_type=0,0, count=5
11-03 04:10:34.655 E/PAX_CHG (    0): set charge_type: DCP //2. qcom完成bc1.2检测
11-03 04:10:34.656 E/PAX_CHG (    0): pax_is_charger_on chr_type = [DCP] last_chr_type = [Unknown]
11-03 04:10:34.656 E/PAX_CHG (    0): pax_charger_plug_in
11-03 04:10:34.656 E/PAX_CHG (    0): enable_charging en: 1 last_en: 0 //3. 使能充电
11-03 04:10:34.657 E/PAX_CHG (    0): pax_charger_update, delay&lt;40&gt; 4. 上报信息
11-03 04:10:34.657 E/PAX_CHG (    0): [SW_JEITA] Battery Normal Temperature between 15 and 45 !!
11-03 04:10:34.657 E/PAX_CHG (    0): [SW_JEITA]preState:3 newState:3 tmp:30 cv:0
11-03 04:10:34.657 E/PAX_CHG (    0): tmp:30 (jeita:1 sm:3 cv:0 en:1) thm_sm:1 en:1 can_en:1
11-03 04:10:34.658 E/PAX_CHG (    0): is typec adapter rp = 3000
11-03 04:10:34.658 E/PAX_CHG (    0): type-C pd_type:0 typec_rp_level:3000
11-03 04:10:34.658 E/PAX_CHG (    0): chg:-1,-1,2000,4140 type:5:0 aicl:-1 bootmode:0 pd:0
11-03 04:10:34.658 E/PAX_CHG (    0): do_algorithm input_current_limit:2000 charging_current_limit:4140
11-03 04:10:34.662 E/PAX_CHG (    0): CHG [online: 0, type: DCP, status: Not charging, fault: 0x0, ICHG = 4080mA, AICR = 2000mA, MIVR = 4360mV, IEOC = 240mA, CV = 4375mV]
11-03 04:10:34.690 I/afe_close(    0): port_id = 0xb030
11-03 04:10:34.693 I/        (    0): ///PD dbg info 56d
11-03 04:10:34.693 I/&lt;61889.629&gt;TCPC-TYPEC(    0): type=1, ret,chg_type=0,5, count=6
11-03 04:10:34.715 I/        (    0): ///PD dbg info 207d
11-03 04:10:34.715 I/        (    0): &lt;61889.629&gt;TCPC-DC&gt; dc_dfp_none
11-03 04:10:34.715 I/&lt;61889.629&gt;TCPC-PE(    0): PD-&gt; SNK_START
11-03 04:10:34.715 I/&lt;61889.630&gt;TCPC-PE-EVT(    0): reset_prl_done
11-03 04:10:34.715 I/&lt;61889.630&gt;TCPC-PE(    0): PD-&gt;
11-03 04:10:34.715 I/        (    0): SNK_DISC
11-03 04:10:34.715 I/&lt;61889.630&gt;TCPC-PE-EVT(    0): vbus_high
11-03 04:10:34.715 I/&lt;61889.630&gt;TCPC-PE(    0): PD-&gt; SNK_WAIT_CAP
11-03 04:10:34.741 E/PAX_BAT (    0): [status:Discharging, health:Good, present:1, tech:Li-ion, capcity:80,cap_rm:3578 mah, vol:4038 mv, temp:30, curr:-421 ma, ui_soc:80]
11-03 04:10:34.741 E/PAX_BAT (    0): pax_battery_external_power_changed event, online:0, status:3, cur_chr_type:5 //5. Battery收到回调，此时online = 0 非充电状态
11-03 04:10:34.741 E/PAX_BMS (    0): bms_wakeup
11-03 04:10:34.747 W/audit   (    0): audit_lost=70627 audit_rate_limit=5 audit_backlog_limit=64
11-03 04:10:34.747 E/audit   (    0): rate limit exceeded
11-03 04:10:34.751 E/PAX_BMS (    0): pax_bms_external_power_changed online = 0
11-03 04:10:34.751 E/PAX_BMS (    0): CHG [online: 0, type: 5, vol: 5000000, cur: 500000, time: 0], BAT [present: 1, status: 3, vol: 4038000, cur: -421000, resistance: 0, temp: 300, soc: 80], OTHER [skin_temp: 0, chg_vote: 0x0, notify_code: 0x0],
11-03 04:10:34.762 W/healthd (    0): battery l=80 v=4038 t=30.0 h=2 st=3 c=-421000 fc=4512000 cc=0 chg=u
11-03 04:10:34.785 W/healthd (    0): battery l=80 v=4038 t=30.0 h=2 st=3 c=-421000 fc=4512000 cc=0 chg=u
11-03 04:10:34.804 I/        (    0): ///PD dbg info 50d
11-03 04:10:34.804 I/&lt;61889.740&gt;TCPC-TCPC(    0): Alert:0x200004, Mask:0x20fff
11-03 04:10:34.814 E/        (    0): pd_tcp_notifier_call event = SINK_VBUS
11-03 04:10:34.814 E/charger soc(    0): charger: pd_tcp_notifier_call sink vbus 9000mV 277mA type(0x86)
11-03 04:10:34.814 E/        (    0): pd_tcp_notifier_call - sink vbus
11-03 04:10:34.814 E/PAX_CHG (    0): pd_status:1 // 6. 接下来PD设置快充电压电流，先设置了9v充电电压
11-03 04:10:34.814 E/PAX_CHG (    0): set pd_charging_voltage_max:9000 mv
11-03 04:10:34.814 E/PAX_CHG (    0): set pd_charging_current_max:277 ma
11-03 04:10:34.827 I/        (    0): ///PD dbg info 466d
11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE-EVT(    0): src_cap // 7. 根据PD策略选择档位信息
11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE(    0): PD-&gt; SNK_EVA_CAP
11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE(    0): pd_rev=2
11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-DPM(    0): Policy=0x31
11-03 04:10:34.827 I/        (    0): &lt;
11-03 04:10:34.827 I/61889.742&gt;TCPC-DPM(    0): Select SrcCap2
11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE-EVT(    0): dpm_ack
11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE(    0): PD-&gt; SNK_SEL_CAP
11-03 04:10:34.827 I/&lt;61889.745&gt;TCPC-TCPC(    0): Alert:
11-03 04:10:34.827 I/0x200040, Mask(    0): 0x20fff
11-03 04:10:34.827 I/&lt;61889.745&gt;TCPC-PE-EVT(    0): good_crc
11-03 04:10:34.827 I/&lt;61889.749&gt;TCPC-TCPC(    0): Alert:0x200004, Mask:0x20fff
11-03 04:10:34.827 I/&lt;61889.750&gt;TCPC-PE-EVT(    0):  
11-03 04:10:34.827 I/        (    0): accept
11-03 04:10:34.827 I/&lt;61889.750&gt;TCPC-PE(    0): PD-&gt; SNK_TRANS_SINK
11-03 04:10:34.827 I/&lt;61889.750&gt;TCPC-PE(    0): VC_HIGHV_PROT: 1
11-03 04:10:34.973 I/        (    0): ///PD dbg info 50d
11-03 04:10:34.973 I/&lt;61889.909&gt;TCPC-TCPC(    0): Alert:0x200004, Mask:0x20fff
11-03 04:10:34.974 E/        (    0): pd_tcp_notifier_call event = SINK_VBUS
11-03 04:10:34.974 E/charger soc(    0): charger: pd_tcp_notifier_call sink vbus 9000mV 2000mA type(0x84) //8. 收到tcpc notify设置9v/2a属性
11-03 04:10:34.974 E/        (    0): pd_tcp_notifier_call - sink vbus
11-03 04:10:34.974 E/PAX_CHG (    0): set pd_charging_voltage_max:9000 mv
11-03 04:10:34.974 E/PAX_CHG (    0): set pd_charging_current_max:2000 ma
11-03 04:10:34.995 I/        (    0): ///PD dbg info 64d
11-03 04:10:34.995 I/&lt;61889.910&gt;TCPC-PE-EVT(    0): ps_rdy
11-03 04:10:34.995 I/&lt;61889.910&gt;TCPC-PE(    0): PD-&gt; SNK_READY
11-03 04:10:35.275 I/        (    0): ///PD dbg info 122d
11-03 04:10:35.275 I/&lt;61890.210&gt;TCPC-PE-EVT(    0): timer
11-03 04:10:35.275 I/&lt;61890.210&gt;TCPC-PE-EVT(    0): tcp_event(get_src_cap_ext), 17
11-03 04:10:35.275 I/&lt;61890.210&gt;TCPC-PE(    0): PD-&gt; SNK_GET_CAP_EX
11-03 04:10:35.298 E/        (    0): pd_tcp_notifier_call event = PD_STATE
11-03 04:10:35.298 I/charger soc(    0): charger: pd_tcp_notifier_call pd state = 6 // 9.PD设置完成，连接状态为PD_CONNECT_PE_READY_SNK_PD30
11-03 04:10:35.299 E/PAX_CHG (    0): pd_status:1
11-03 04:10:35.299 E/PAX_CHG (    0): set pd_charging_current_max:2000 ma
11-03 04:10:35.299 I/        (    0): ///PD dbg info 750d
11-03 04:10:35.299 I/&lt;61890.214&gt;TCPC-TCPC(    0): Alert:0x200040, Mask:0x20fff
11-03 04:10:35.299 I/&lt;61890.215&gt;TCPC-PE-EVT(    0): good_crc
11-03 04:10:35.299 I/&lt;61890.218&gt;TCPC-TCPC(    0): Alert:0x200004, Mask:0x20
11-03 04:10:35.299 I/        (    0): fff
11-03 04:10:35.299 I/&lt;61890.220&gt;TCPC-PE-EVT(    0): no_support
11-03 04:10:35.299 I/&lt;61890.220&gt;TCPC-PE(    0): PD-&gt; SNK_READY
11-03 04:10:35.299 I/&lt;61890.220&gt;TCPC-PE-EVT(    0): tcp_event(disc_id), 29
11-03 04:10:35.299 I/        (    0): &lt;61890.220
11-03 04:10:35.299 I/&gt;TCPC-PE(    0): VDM-&gt; D_UID_REQ
11-03 04:10:35.299 I/&lt;61890.223&gt;TCPC-TCPC(    0): Alert:0x200040, Mask:0x20fff
11-03 04:10:35.299 I/&lt;61890.224&gt;TCPC-PE-EVT(    0): good_crc
11-03 04:10:35.299 I/&lt;61890.232&gt;TCPC-TCPC(    0):  
11-03 04:10:35.299 I/Alert   (    0): 0x200004, Mask:0x20fff
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE-EVT(    0): no_support
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE(    0): PD-&gt; SNK_NO_SUPP_RECV
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE-EVT(    0): d
11-03 04:10:35.299 I/        (    0): pm_ack
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE(    0): PD-&gt; SNK_READY
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE-EVT(    0): vdm_not_support
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE(    0): VDM-&gt; D_UID_N
11-03 04:10:35.299 I/        (    0): &lt;61890.234&gt;TCPC
11-03 04:10:35.299 I/-PE-EVT (    0): dpm_ack
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE(    0): VDM-&gt; SNK_READY
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-DPM(    0): PE_READY
11-03 04:10:35.299 I/&lt;61890.234&gt;TCPC-PE(    0): pd_state=6
11-03 04:10:36.123 E/PAX_BAT (    0): [status:Discharging, health:Good, present:1, tech:Li-ion, capcity:80,cap_rm:3578 mah, vol:4254 mv, temp:30, curr:2537 ma, ui_soc:80]
11-03 04:10:36.129 W/audit   (    0): audit_lost=70649 audit_rate_limit=5 audit_backlog_limit=64
11-03 04:10:36.129 E/audit   (    0): rate limit exceeded
11-03 04:10:36.136 W/healthd (    0): battery l=80 v=4254 t=30.0 h=2 st=3 c=2537000 fc=4512000 cc=0 chg=u
11-03 04:10:39.657 E/PAX_CHG (    0): pax_is_charger_on chr_type = [DCP] last_chr_type = [DCP]
11-03 04:10:39.659 E/PAX_CHG (    0): [SW_JEITA] Battery Normal Temperature between 15 and 45 !!
11-03 04:10:39.659 E/PAX_CHG (    0): [SW_JEITA]preState:3 newState:3 tmp:30 cv:0
11-03 04:10:39.659 E/PAX_CHG (    0): tmp:30 (jeita:1 sm:3 cv:0 en:1) thm_sm:1 en:1 can_en:1
11-03 04:10:39.660 E/PAX_CHG (    0): chg:-1,-1,2000,4160 type:5:6 aicl:-1 bootmode:0 pd:1
11-03 04:10:39.660 E/PAX_CHG (    0): do_algorithm input_current_limit:2000 charging_current_limit:4160
11-03 04:10:39.665 E/PAX_CHG (    0): CHG [online: 1, type: DCP, status: Charging, fault: 0x0, ICHG = 4160mA, AICR = 2000mA, MIVR = 4360mV, IEOC = 240mA, CV = 4375mV]
11-03 04:10:39.958 E/PAX_BMS (    0): CHG [online: 1, type: 5, vol: 5000000, cur: 2000000, time: 0], BAT [present: 1, status: 3, vol: 4254000, cur: 2537000, resistance: 0, temp: 300, soc: 80], OTHER [skin_temp: 0, chg_vote: 0x0, notify_code: 0x0],
</pre></div>
</div>
<p>PD充电大概流程如下：</p>
<ul class="simple">
<li><p>11-03 04:10:34.392 E/        (    0): tcpc_notifier_call, old_state = UNATTACHED, new_state = ATTACHED_SNK //1. ATTACHED_SNK</p></li>
<li><p>11-03 04:10:34.655 E/PAX_CHG (    0): set charge_type: DCP //2. qcom完成bc1.2检测</p></li>
<li><p>11-03 04:10:34.656 E/PAX_CHG (    0): enable_charging en: 1 last_en: 0 //3. 使能充电</p></li>
<li><p>11-03 04:10:34.657 E/PAX_CHG (    0): pax_charger_update, delay&lt;40&gt; 4. 上报信息</p></li>
<li><p>11-03 04:10:34.741 E/PAX_BAT (    0): pax_battery_external_power_changed event, online:0, status:3, cur_chr_type:5 //5. Battery收到回调，此时online = 0 非充电状态</p></li>
<li><p>11-03 04:10:34.814 E/PAX_CHG (    0): pd_status:1 //6. 接下来PD设置快充电压电流，先设置了9v充电电压</p></li>
<li><p>11-03 04:10:34.814 E/PAX_CHG (    0): set pd_charging_voltage_max:9000 mv</p></li>
<li><p>11-03 04:10:34.814 E/PAX_CHG (    0): set pd_charging_current_max:277 ma</p></li>
<li><p>11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE-EVT(    0): src_cap // 7. 根据PD策略选择档位信息</p></li>
<li><p>11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE(    0): PD-&gt; SNK_EVA_CAP</p></li>
<li><p>11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-PE(    0): pd_rev=2</p></li>
<li><p>11-03 04:10:34.827 I/&lt;61889.742&gt;TCPC-DPM(    0): Policy=0x31</p></li>
<li><p>11-03 04:10:34.827 I/61889.742&gt;TCPC-DPM(    0): Select SrcCap2</p></li>
<li><p>11-03 04:10:34.974 E/charger soc(    0): charger: pd_tcp_notifier_call sink vbus 9000mV 2000mA type(0x84) //7. 收到tcpc notify设置9v/2a属性</p></li>
<li><p>11-03 04:10:34.974 E/        (    0): pd_tcp_notifier_call - sink vbus</p></li>
<li><p>11-03 04:10:34.974 E/PAX_CHG (    0): set pd_charging_voltage_max:9000 mv</p></li>
<li><p>11-03 04:10:34.974 E/PAX_CHG (    0): set pd_charging_current_max:2000 ma</p></li>
<li><p>11-03 04:10:35.298 I/charger soc(    0): charger: pd_tcp_notifier_call pd state = 6 // 8.PD设置完成，连接状态为PD_CONNECT_PE_READY_SNK_PD30</p></li>
</ul>
<p>可以看到在步骤4上报信息时，charger还是<code class="docutils literal notranslate"><span class="pre">online</span> <span class="pre">=</span> <span class="pre">0</span></code>非充电状态，此时上报电池状态肯定是不对的，我们需要等到PD完成时再上报一次，可以看到步骤8，当收到tcpc notify设置9v/2a属性时，PD设置完成，连接状态为PD_CONNECT_PE_READY_SNK_PD30，我们在这里再上报一次，修改如下：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/UM.9.15/kernel/msm-4.19/drivers/misc/pax/power/paxpd-charger-manager.c</span><span class="w"></span>
<span class="gi">+++ b/UM.9.15/kernel/msm-4.19/drivers/misc/pax/power/paxpd-charger-manager.c</span><span class="w"></span>
<span class="gu">@@ -217,14 +217,6 @@ static void pd_sink_set_vol_and_cur(int mv, int ma, uint8_t type)</span><span class="w"></span>
<span class="w"> </span>       unsigned long sel = 0;<span class="w"></span>
<span class="w"> </span>       union power_supply_propval val = {.intval = 0};<span class="w"></span>

<span class="gd">-       // Charger plug-in first time</span><span class="w"></span>
<span class="gd">-       smblib_get_prop(POWER_SUPPLY_PROP_PD_ACTIVE, &amp;val);</span><span class="w"></span>
<span class="gd">-       if (val.intval == POWER_SUPPLY_PD_INACTIVE) {</span><span class="w"></span>
<span class="gd">-               val.intval = POWER_SUPPLY_PD_ACTIVE;</span><span class="w"></span>
<span class="gd">-               //pax_charger_dev_enable_vbus_ovp(g_info-&gt;chg1_dev, false);</span><span class="w"></span>
<span class="gd">-               smblib_set_prop(POWER_SUPPLY_PROP_PD_ACTIVE, &amp;val);</span><span class="w"></span>
<span class="gd">-       }</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="w"> </span>       switch (type) {<span class="w"></span>
<span class="w"> </span>       case TCP_VBUS_CTRL_PD_HRESET:<span class="w"></span>
<span class="w"> </span>       case TCP_VBUS_CTRL_PD_PR_SWAP:<span class="w"></span>
<span class="gu">@@ -1087,8 +1079,9 @@ static int pax_charger_plug_in(struct pax_charger *info,</span><span class="w"></span>

<span class="w"> </span>       info-&gt;chr_type = chr_type;<span class="w"></span>
<span class="w"> </span>       info-&gt;charger_thread_polling = true;<span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="w"> </span>       info-&gt;can_charging = true;<span class="w"></span>
<span class="gi">+       info-&gt;bms_charge_enable = 1;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>       //info-&gt;enable_dynamic_cv = true;<span class="w"></span>

<span class="w"> </span>       chr_info(&quot;%s\n&quot;, __func__);<span class="w"></span>
<span class="gu">@@ -1467,6 +1460,10 @@ int psy_charger_set_property(struct power_supply *psy,</span><span class="w"></span>
<span class="w"> </span>       switch (psp) {<span class="w"></span>
<span class="w"> </span>       case POWER_SUPPLY_PROP_PD_ACTIVE:<span class="w"></span>
<span class="w"> </span>               info-&gt;pd_active = val-&gt;intval;<span class="w"></span>
<span class="gi">+               /* PD SNK complite */</span><span class="w"></span>
<span class="gi">+               if (info-&gt;pd_active) {</span><span class="w"></span>
<span class="gi">+                       pax_charger_update(20);</span><span class="w"></span>
<span class="gi">+               }</span><span class="w"></span>
<span class="w"> </span>               chr_info(&quot;pd_status:%d\n&quot;, info-&gt;pd_active);<span class="w"></span>
</pre></div>
</div>
<p>修改后，状态重新上报没问题：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>11-02 10:09:15.501 I/charger soc(    0): charger: pd_tcp_notifier_call pd state = 6
11-02 10:09:15.501 E/PAX_CHG (    0): pax_charger_update, delay&lt;20&gt; //1.重新上报状态
11-02 10:09:15.502 E/PAX_CHG (    0): pd_status:1
11-02 10:09:15.502 E/PAX_CHG (    0): set pd_charging_current_max:2000 ma
11-02 10:09:15.532 I/        (    0): ///PD dbg info 44d
11-02 10:09:15.532 I/&lt;  147.000&gt;TCPC-PE-EVT(    0): tcp_event(dummy), 16
11-02 10:09:15.537 W/healthd (    0): battery l=81 v=4050 t=32.0 h=2 st=2 c=-442000 fc=4512000 cc=0 chg=u
11-02 10:09:15.566 E/PAX_BAT (    0): [status:Charging, health:Good, present:1, tech:Li-ion, capcity:81,cap_rm:3626 mah, vol:4050 mv, temp:32, curr:-442 ma, ui_soc:81]
11-02 10:09:15.566 E/PAX_BAT (    0): pax_battery_external_power_changed event, online:1, status:1, cur_chr_type:5 //2. Battery 状态获取正确
11-02 10:09:15.566 E/PAX_BMS (    0): bms_wakeup
11-02 10:09:15.574 E/PAX_BMS (    0): pax_bms_external_power_changed online = 1
11-02 10:09:15.576 I/PAX_BMS (    0): charge start: 147
11-02 10:09:15.576 E/PAX_BMS (    0): CHG [online: 1, type: 5, vol: 5000000, cur: 2000000, time: 0], BAT [present: 1, status: 1, vol: 4050000, cur: -442000, resistance: 0, temp: 320, soc: 81], OTHER [skin_temp: 0, chg_vote: 0x0, notify_code: 0x0],
11-02 10:09:15.576 W/healthd (    0): battery l=81 v=4050 t=32.0 h=2 st=2 c=-442000 fc=4512000 cc=0 chg=u
11-02 10:09:15.591 W/healthd (    0): battery l=81 v=4050 t=32.0 h=2 st=2 c=-442000 fc=4512000 cc=0 chg=u
11-02 10:09:15.740 I/PAX_BMS (    0): SET_CHG_EN: 0 // 3. BMS服务发现此时电量大于满充点，则关闭充电。
11-02 10:09:15.740 E/        (    0): bms_notify_call_chain
11-02 10:09:15.740 E/PAX_CHG (    0): bms_notify_event evt = SET_CHG_EN en:0
11-02 10:09:15.741 E/PAX_CHG (    0): enable_charging en: 0 last_en: 1
11-02 10:09:15.741 E/PAX_CHG (    0): pax_charger_update, delay&lt;40&gt;
11-02 10:09:15.741 I/PAX_BMS (    0): type: NC_DISABLE_CHG_BY_USER, disable: 1, vote: 0x200000
11-02 10:09:15.750 I/PAX_BMS (    0): SET_CHG_EN: 0
11-02 10:09:15.750 E/        (    0): bms_notify_call_chain
11-02 10:09:15.750 E/PAX_CHG (    0): bms_notify_event evt = SET_CHG_EN en:0
11-02 10:09:15.752 E/PAX_CHG (    0): enable_charging en: 0 last_en: 0
11-02 10:09:15.752 E/PAX_CHG (    0): pax_charger_update, delay&lt;40&gt;
11-02 10:09:15.752 I/PAX_BMS (    0): type: NC_DISABLE_CHG_BY_USER, disable: 1, vote: 0x200000
11-02 10:09:15.797 I/        (    0): ///PD dbg info 44d
11-02 10:09:15.797 I/&lt;  147.266&gt;TCPC-PE-EVT(    0): tcp_event(dummy), 16
11-02 10:09:15.798 W/healthd (    0): battery l=81 v=4050 t=32.0 h=2 st=4 c=-442000 fc=4512000 cc=0 chg=
11-02 10:09:15.812 E/PAX_BAT (    0): [status:Not charging, health:Good, present:1, tech:Li-ion, capcity:81,cap_rm:3626 mah, vol:4050 mv, temp:32, curr:-442 ma, ui_soc:81]
11-02 10:09:15.812 E/PAX_BAT (    0): pax_battery_external_power_changed event, online:1, status:3, cur_chr_type:5
11-02 10:09:15.812 E/PAX_BMS (    0): bms_wakeup
11-02 10:09:15.816 E/PAX_BMS (    0): pax_bms_external_power_changed online = 1
11-02 10:09:15.818 I/PAX_BMS (    0): charge end: charge_start_time: 147, charge_total_time: 0
</pre></div>
</div>
</section>
<section id="bms">
<h1>BMS回充打印<a class="headerlink" href="#bms" title="此标题的永久链接"></a></h1>
<p>将电量低于回充点65时启动充电。</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>188669: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): onReceive action = android.intent.action.BATTERY_CHANGED
188670: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): onReceive bms_switch = 1
188671: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): mode = 2
188672: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): chargeState = 0
188673: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): getInitcurMode = 2
188674: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): batteryTermInfo.getCurmode() = 2
188675: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): mBatteryLevel = 65
188676: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): batteryTermInfo.getFullcharge() = 80
188677: 11-02 12:28:32.180 D/PaxBatteryManagerService( 1052): batteryTermInfo.getRecharge() = 65
188783: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): onReceive action = android.intent.action.BATTERY_CHANGED
188784: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): onReceive bms_switch = 1
188785: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): mode = 2
188786: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): chargeState = 0
188787: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): getInitcurMode = 2
188788: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): batteryTermInfo.getCurmode() = 2
188789: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): mBatteryLevel = 64
188790: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): batteryTermInfo.getFullcharge() = 80
188791: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): batteryTermInfo.getRecharge() = 65
188792: 11-02 12:28:40.382 D/PaxBatteryManagerService( 1052): chargeing //将电量低于回充点65时启动充电。
188796: 11-02 12:28:40.383 D/PaxBatteryManagerService( 1052): setChargeState: 1
188800: 11-02 12:28:40.384 D/PaxBatteryManagerService( 1052): setChargeState over
188902: 11-02 12:28:40.454 D/PaxBatteryManagerService( 1052): onReceive action = android.intent.action.BATTERY_CHANGED
188903: 11-02 12:28:40.454 D/PaxBatteryManagerService( 1052): onReceive bms_switch = 1
</pre></div>
</div>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>