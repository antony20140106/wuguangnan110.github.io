<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">架构图</a></li>
<li><a class="reference internal" href="#charger-class">charger_class架构介绍</a></li>
<li><a class="reference internal" href="#id4">充电状态上报逻辑</a></li>
<li><a class="reference internal" href="#pm">PM电源管理</a></li>
<li><a class="reference internal" href="#id5">底座充电功能开发</a></li>
<li><a class="reference internal" href="#id6">问题点</a><ul>
<li><a class="reference internal" href="#bc1-2">bc1.2轮询方案</a></li>
<li><a class="reference internal" href="#charger-routine-threadmsleep">charger_routine_thread不能加msleep</a></li>
<li><a class="reference internal" href="#id7">原子通知链不允许嵌套</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>目前charger使用外置的mp2721，qcom pm4125模块功能全部关闭了，需要自己搭建charger架构。</p>
</section>
<section id="id2">
<h1>参考<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/yuewen2008/article/details/80594198">MT6739 充电&amp;电量计代码架构变化梳理</a></p></li>
</ul>
</section>
<section id="id3">
<h1>架构图<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<p>目前mp2721在检测到SNK attach后，会反复轮询bc12检测是否完成，完成后会通知pax_charger并唤醒充电线程进行plug in配置充电，并5s轮询一次充电状态。
<img alt="0017_0000.png" src="../../../_images/0017_0000.png" /></p>
</section>
<section id="charger-class">
<h1>charger_class架构介绍<a class="headerlink" href="#charger-class" title="此标题的永久链接"></a></h1>
<p>charger_class.c文件封装了底层操作chargeric的一些函数，并向linux内核注册一个类文件，名称为switch_charging的类。每一个驱动ic在加载时只需要在该类文件下向内核注册名为primary_chg的设备文件即可。</p>
<ul class="simple">
<li><p>charger ic注册：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>dts:
	mp2721@3f {
			compatible = &quot;pax,mp2721&quot;;
			charger_name = &quot;primary_chg&quot;;
	}
		
代码：
static int mp2721_parse_dt(struct device *dev)
{
	if (of_property_read_string(np, &quot;charger_name&quot;,
						&amp;g_mp2721_info-&gt;chg_dev_name) &lt; 0) {
		g_mp2721_info-&gt;chg_dev_name = &quot;primary_chg&quot;;
		chr_mp2721_debug(&quot;%s: no charger name\n&quot;, __func__);
	}

}

注册,最主要的是charger ic的ops：
static struct charger_ops mp2721_chg_ops = {
	/* Normal charging */
	.dump_registers = chg_dump,
	.plug_out = mp2721_plug_out,
	.plug_in = mp2721_plug_in,
	.enable = mp2721_enable_charger,

	//.enable_termination = mp2721_enable_te,

	/* charging current or voltage limit */
	.get_min_charging_current = mp2721_get_min_ichg,
	.get_min_input_current = mp2721_get_min_aicr,
	.set_input_current = mp2721_set_aicr,
	.set_charging_current = mp2721_set_ichg,
	.set_constant_voltage = mp2721_set_cv,
	.set_mivr = mp2721_set_mivr,
	.get_mivr = mp2721_get_mivr,

	.is_charging_done = mp2721_get_charging_status,

	/* Safety timer
	.enable_safety_timer = mp2721_enable_safetytimer,
	.is_safety_timer_enabled = mp2721_is_safetytimer_enable,
	.set_safety_timer = mp2721_set_safetytimer,
	*/

	/* Power path */
	.enable_powerpath = mp2721_enable_powerpath,
	.is_powerpath_enabled = mp2721_get_is_powerpath_enable,

	/* Charger type detection */
	.get_charger_type = mp2721_charge_type,
	//.enable_chg_type_det = mp2721_enable_chg_type_det,

	/* OTG */
	.enable_otg = mp2721_set_otg_enable,
	.set_boost_current_limit = mp2721_set_otg_current,

#if 0
	.get_ibus_adc = mp2721_get_ibus,
	.get_vbus_adc = mp2721_get_vbus,
#endif
	//.event = mp2721_do_event,

	.enable_vbus_ovp = mp2721_enable_vbus_ovp,
	.get_fault_status = mp2721_get_fault_status,

	//set_en_hiz = mp2721_set_en_hiz,
	//.get_en_hiz = mp2721_get_en_hiz,
};

static int mp2721_charger_probe(struct i2c_client *client,
				 const struct i2c_device_id *id)
{
	mp2721_info-&gt;chg_dev = charger_dev_register(mp2721_info-&gt;chg_dev_name,
						&amp;client-&gt;dev, mp2721_info, &amp;mp2721_chg_ops, &amp;mp2721_info-&gt;chg_props);
}
</pre></div>
</div>
<ul class="simple">
<li><p>charger_class注册函数：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">charger_class</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="n">charger_dev_register</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">devdata</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_properties</span><span class="w"> </span><span class="o">*</span><span class="n">props</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="n">chg_dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">key</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">srcu_notifier_head</span><span class="w"> </span><span class="o">*</span><span class="n">head</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: name=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">chg_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chg_dev</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">chg_dev</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">evt_nh</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">srcu_init_notifier_head</span><span class="p">(</span><span class="n">head</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* Rename srcu&#39;s lock to avoid LockProve warning */</span><span class="w"></span>
<span class="w">	</span><span class="n">lockdep_init_map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dep_map</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="k">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">charger_class</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">charger_device_release</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">devdata</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Copy properties */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">props</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">,</span><span class="w"> </span><span class="n">props</span><span class="p">,</span><span class="w"></span>
<span class="w">			   </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_properties</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"> </span><span class="c1">//每一个驱动ic在加载时只需要在该类文件下向内核注册名为primary_chg的设备文件即可。</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">kfree</span><span class="p">(</span><span class="n">chg_dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">chg_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="p">;</span><span class="w"> </span><span class="c1">//负责该设备的ops操作</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">chg_dev</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">charger_class_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">charger_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;switching_charger&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">charger_class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Unable to create charger class; errno = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">charger_class</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">charger_class</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">charger_class</span><span class="o">-&gt;</span><span class="n">dev_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">charger_groups</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">charger_class_init</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>pax_charger调用，首先线程会判断primary_chg有没有注册，注册了才会跑线程，不然一直阻塞：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="n">get_charger_by_name</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_find_device</span><span class="p">(</span><span class="n">charger_class</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">charger_match_dev_by_name</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">to_charger_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">charger_init_algo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_charger_by_name</span><span class="p">(</span><span class="s">&quot;primary_chg&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;Found primary charger</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;*** Error : can&#39;t find primary charger ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">charger_routine_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_module_init_done</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">is_charger_on</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">wait_event</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">wait_que</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_timeout</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="w"></span>

<span class="w">		</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">is_module_init_done</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">charger_init_algo</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="n">is_module_init_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;charger_init fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">msleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>调用历程，直接调用已注册charger_dev的ops函数：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">pax_charger</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">pax_is_charger_on</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">chr_type</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">chr_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pax_charger_dev_get_charger_type</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">pax_charger_class</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">pax_charger_dev_get_charger_type</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="n">charger_dev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">charger_dev</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">charger_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">					   </span><span class="n">charger_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_charger_type</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">charger_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_charger_type</span><span class="p">(</span><span class="n">charger_dev</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pax_charger_dev_get_charger_type</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id4">
<h1>充电状态上报逻辑<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>目前MTK平台充电状态上报分为以下几种：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">FULL</span></code>事件在<code class="docutils literal notranslate"><span class="pre">do_algorithm</span></code>中轮询，并通过<code class="docutils literal notranslate"><span class="pre">charger_dev_do_event</span></code>通知charger ic调用<code class="docutils literal notranslate"><span class="pre">power_supply_changed</span></code>上报状态。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EVENT_DISCHARGE</span></code>和<code class="docutils literal notranslate"><span class="pre">EVENT_RECHARGE</span></code>事件在调用<code class="docutils literal notranslate"><span class="pre">enable_charging</span></code>时发送给charger ic。</p></li>
</ul>
</li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">enable_charging</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="kt">bool</span><span class="w"> </span><span class="n">en</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">;</span><span class="w"></span>


<span class="w">	</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">);</span><span class="w"></span>

<span class="cp">#ifdef CONFIG_PAX_BMS</span>
<span class="w">	</span><span class="n">en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bms_charge_enable</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_ALG_NO</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">alg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">chg_alg_stop_algo</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="n">charger_dev_enable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">charger_dev_do_event</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_DISCHARGE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">charger_dev_enable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">charger_dev_do_event</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_RECHARGE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_algorithm</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_chg_done</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">chg_done</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">((</span><span class="n">last_soc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">soc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">soc</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chg_done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">charger_dev_do_event</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_FULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s battery full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">charger_dev_do_event</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_RECHARGE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s battery recharge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>pax_charger采用直接轮询charger ic状态的方式，更加方便，而且现在把psy设备注册放到pax_charger端，如果状态有变化直接调用<code class="docutils literal notranslate"><span class="pre">power_supply_changed</span></code>上报状态，无需再转手。</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pax_charger_check_status</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">chg_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">chg_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pax_charger_dev_get_charging_status</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chg_status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">psy1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;charger status changed: chg_status = %d old_chg_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">chg_status</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg_state</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">power_supply_changed</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">psy1</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chg_status</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">charger_routine_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">pax_charger_check_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="pm">
<h1>PM电源管理<a class="headerlink" href="#pm" title="此标题的永久链接"></a></h1>
<p>目前wakelock充电逻辑如下：</p>
<p><img alt="0017_0007.png" src="../../../_images/0017_0007.png" /></p>
<p>主要讲解一下充电时阻止系统进入休眠，方案流程如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">alarmtimer_restart</span><span class="w"></span>
<span class="w">	</span><span class="n">pax_charger_alarm_timer_func</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">alarm</span><span class="w"> </span><span class="o">*</span><span class="n">alarm</span><span class="p">,</span><span class="w"> </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">	</span><span class="n">container_of</span><span class="p">(</span><span class="n">alarm</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="p">,</span><span class="w"> </span><span class="n">charger_timer</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_suspend</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_debug</span><span class="p">(</span><span class="s">&quot;%s: not suspend, wake up charger</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">_wake_up_charger</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_info</span><span class="p">(</span><span class="s">&quot;%s: alarm timer timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">__pm_stay_awake</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ALARMTIMER_NORESTART</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">pax_charger_start_timer</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">time_now</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">ktime_t</span><span class="w"> </span><span class="n">ktime</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* If the timer was already set, cancel it */</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alarm_try_to_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_timer</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s: callback was running, skip timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">get_monotonic_boottime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time_now</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">polling_interval</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">time</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timespec_add</span><span class="p">(</span><span class="n">time_now</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">ktime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ktime_set</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="c1">//chr_err(&quot;%s: alarm timer start:%d, %ld %ld\n&quot;, __func__, ret,</span>
<span class="c1">//		info-&gt;endtime.tv_sec, info-&gt;endtime.tv_nsec);</span>
<span class="w">	</span><span class="n">alarm_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_timer</span><span class="p">,</span><span class="w"> </span><span class="n">ktime</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">charger_pm_event</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">notifier</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pm_event</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">unused</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">now</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">notifier</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="k">struct</span><span class="w"> </span><span class="nc">pax_charger</span><span class="p">,</span><span class="w"> </span><span class="n">pm_notifier</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pm_event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PM_SUSPEND_PREPARE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_suspend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s: enter PM_SUSPEND_PREPARE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PM_POST_SUSPEND</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_suspend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s: enter PM_POST_SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">get_monotonic_boottime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timespec_compare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s: alarm timeout, wake up charger</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">__pm_relax</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">endtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">_wake_up_charger</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">NOTIFY_DONE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">charger_routine_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_lock</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">__pm_stay_awake</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="p">);</span><span class="w"> </span><span class="c1">//进入线程，持锁</span>
<span class="w">		</span><span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_polling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">pax_charger_start_timer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">__pm_relax</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_debug</span><span class="p">(</span><span class="s">&quot;%s end , %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_timeout</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_lock</span><span class="p">);</span><span class="w">		</span>
<span class="p">}</span><span class="w"></span>

<span class="n">probe</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cp">#ifdef CONFIG_PM</span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">charger_pm_event</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>休眠唤醒流程如下：</p>
<ul class="simple">
<li><p>1、<code class="docutils literal notranslate"><span class="pre">PM_SUSPEND_PREPARE</span></code>阶段:当系统调用suspend_prepare做进一步suspend前期准备工作，准备控制台，冻结内核线程等，此时充电线程<code class="docutils literal notranslate"><span class="pre">is_suspend</span></code>标志位置1。</p></li>
<li><p>2、定时器超时函数<code class="docutils literal notranslate"><span class="pre">pax_charger_alarm_timer_func</span></code>，根据<code class="docutils literal notranslate"><span class="pre">is_suspend</span></code>状态，这里会持锁唤醒系统。</p></li>
<li><p>3、<code class="docutils literal notranslate"><span class="pre">PM_POST_SUSPEND阶段</span></code>:唤醒后进入PM_POST_SUSPEND阶段，就是退出休眠，并唤醒充电线程。</p></li>
</ul>
<p>以下是阻止休眠的全过程打印：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span><span class="m">10990</span>.074535<span class="o">]</span> PM: <span class="nb">suspend</span> entry <span class="o">(</span>deep<span class="o">)</span>
<span class="o">[</span><span class="m">10990</span>.078255<span class="o">]</span> PM: Syncing filesystems ... <span class="k">done</span>.
<span class="o">[</span><span class="m">10990</span>.193251<span class="o">]</span> PAX_CHG: charger_pm_event: enter PM_SUSPEND_PREPARE //调用suspend_prepare做进一步suspend前期准备工作，准备控制台，冻结内核线程等
<span class="o">[</span><span class="m">10990</span>.199399<span class="o">]</span> Freezing user space processes ...
<span class="o">[</span><span class="m">10990</span>.200488<span class="o">]</span> i2c_read: err wakeup of wq
<span class="o">[</span><span class="m">10990</span>.215157<span class="o">]</span> <span class="o">(</span>elapsed <span class="m">0</span>.015 seconds<span class="o">)</span> <span class="k">done</span>.
<span class="o">[</span><span class="m">10990</span>.219229<span class="o">]</span> OOM killer disabled.
<span class="o">[</span><span class="m">10990</span>.222500<span class="o">]</span> Freezing remaining freezable tasks ... <span class="o">(</span>elapsed <span class="m">0</span>.004 seconds<span class="o">)</span> <span class="k">done</span>.
<span class="o">[</span><span class="m">10990</span>.234057<span class="o">]</span> Suspending console<span class="o">(</span>s<span class="o">)</span> <span class="o">(</span>use no_console_suspend to debug<span class="o">)</span>
<span class="o">[</span><span class="m">10990</span>.245041<span class="o">]</span> ILITEK: <span class="o">(</span>ilitek_tp_pm_suspend, <span class="m">765</span><span class="o">)</span>: CALL BACK TP PM SUSPEND
<span class="o">[</span><span class="m">10990</span>.255154<span class="o">]</span> <span class="o">[</span>Binder<span class="o">][</span>0x474f46a859<span class="o">][</span><span class="m">13</span>:37:07.732510<span class="o">]</span> wlan: <span class="o">[</span><span class="m">4210</span>:I:HDD<span class="o">]</span> __wlan_hdd_bus_suspend: <span class="m">1035</span>: starting bus <span class="nb">suspend</span>
<span class="o">[</span><span class="m">10990</span>.258777<span class="o">]</span> <span class="o">======</span>sp_cat_tp_suspend <span class="m">336</span>
<span class="o">[</span><span class="m">10990</span>.258791<span class="o">]</span> <span class="o">[</span>pax_authinfo<span class="o">]</span>: gpio_sleep_sp, <span class="nv">en</span><span class="o">=</span><span class="m">1</span>
<span class="o">[</span><span class="m">10990</span>.258791<span class="o">]</span>
<span class="o">[</span><span class="m">10990</span>.258812<span class="o">]</span> PAX_BMS:bms_suspend. <span class="nv">secs</span> <span class="o">=</span> <span class="m">572700</span>
<span class="o">[</span><span class="m">10990</span>.258838<span class="o">]</span> pax_base_detect_suspend
<span class="o">[</span><span class="m">10990</span>.378107<span class="o">]</span> Disabling non-boot CPUs ...
<span class="o">[</span><span class="m">10990</span>.378846<span class="o">]</span> IRQ <span class="m">6</span>: no longer affine to CPU1
<span class="o">[</span><span class="m">10990</span>.379073<span class="o">]</span> CPU1: shutdown
<span class="o">[</span><span class="m">10990</span>.379642<span class="o">]</span> psci: CPU1 killed <span class="o">(</span>polled <span class="m">4</span> ms<span class="o">)</span>
<span class="o">[</span><span class="m">10990</span>.380939<span class="o">]</span> IRQ <span class="m">1</span>: no longer affine to CPU2
<span class="o">[</span><span class="m">10990</span>.381172<span class="o">]</span> CPU2: shutdown
<span class="o">[</span><span class="m">10990</span>.382284<span class="o">]</span> psci: CPU2 killed <span class="o">(</span>polled <span class="m">0</span> ms<span class="o">)</span>
<span class="o">[</span><span class="m">10990</span>.384069<span class="o">]</span> CPU3: shutdown
<span class="o">[</span><span class="m">10990</span>.384115<span class="o">]</span> psci: CPU3 killed <span class="o">(</span>polled <span class="m">0</span> ms<span class="o">)</span>
<span class="o">[</span><span class="m">10990</span>.384718<span class="o">]</span> <span class="nb">suspend</span> ns:   <span class="m">10990384714503</span>     <span class="nb">suspend</span> cycles:     <span class="m">306275196449</span>
<span class="o">[</span><span class="m">10990</span>.384714<span class="o">]</span> resume cycles:     <span class="m">306373970012</span>
<span class="o">[</span><span class="m">10990</span>.384761<span class="o">]</span> pm_system_irq_wakeup: <span class="m">173</span> triggered pm8xxx_rtc_alarm
<span class="o">[</span><span class="m">10990</span>.385117<span class="o">]</span> PAX_CHG: pax_charger_alarm_timer_func: alarm timer timeout //定时器超时函数，这里会持锁唤醒系统
<span class="o">[</span><span class="m">10990</span>.385230<span class="o">]</span> Enabling non-boot CPUs ...
<span class="o">[</span><span class="m">10990</span>.385768<span class="o">]</span> Detected VIPT I-cache on CPU1
<span class="o">[</span><span class="m">10990</span>.385843<span class="o">]</span> arch_timer: CPU1: Trapping CNTVCT access
<span class="o">[</span><span class="m">10990</span>.385895<span class="o">]</span> CPU1: Booted secondary processor 0x0000000001 <span class="o">[</span>0x51af8014<span class="o">]</span>
<span class="o">[</span><span class="m">10990</span>.386670<span class="o">]</span> CPU1 is up
<span class="o">[</span><span class="m">10990</span>.387438<span class="o">]</span> Detected VIPT I-cache on CPU2
<span class="o">[</span><span class="m">10990</span>.387518<span class="o">]</span> arch_timer: CPU2: Trapping CNTVCT access
<span class="o">[</span><span class="m">10990</span>.387566<span class="o">]</span> CPU2: Booted secondary processor 0x0000000002 <span class="o">[</span>0x51af8014<span class="o">]</span>
<span class="o">[</span><span class="m">10990</span>.388390<span class="o">]</span> CPU2 is up
<span class="o">[</span><span class="m">10990</span>.389089<span class="o">]</span> Detected VIPT I-cache on CPU3
<span class="o">[</span><span class="m">10990</span>.389169<span class="o">]</span> arch_timer: CPU3: Trapping CNTVCT access
<span class="o">[</span><span class="m">10990</span>.389220<span class="o">]</span> CPU3: Booted secondary processor 0x0000000003 <span class="o">[</span>0x51af8014<span class="o">]</span>
<span class="o">[</span><span class="m">10990</span>.389987<span class="o">]</span> CPU3 is up
<span class="o">[</span><span class="m">10990</span>.506155<span class="o">]</span> pax_base_detect_resume
<span class="o">[</span><span class="m">10990</span>.506957<span class="o">]</span> PAX_BAT: pax_battery_resume: pre_soc: <span class="m">100</span> soc: <span class="m">100</span>
<span class="o">[</span><span class="m">10990</span>.507767<span class="o">]</span> <span class="o">======</span>sp_cat_tp_resume <span class="m">347</span>
<span class="o">[</span><span class="m">10990</span>.507931<span class="o">]</span> ///PD dbg info 122d
<span class="o">[</span><span class="m">10990</span>.507937<span class="o">]</span> &lt;<span class="m">10990</span>.507&gt;TCPC-TCPC:bat_update_work_func battery update <span class="nv">soc</span> <span class="o">=</span> <span class="m">100</span>
<span class="o">[</span><span class="m">10990</span>.507937<span class="o">]</span> &lt;<span class="m">10990</span>.507&gt;TCPC-TCPC:bat_update_work_func Battery Idle
<span class="o">[</span><span class="m">10990</span>.510388<span class="o">]</span> <span class="o">[</span>Binder<span class="o">][</span>0x475574994c<span class="o">][</span><span class="m">13</span>:37:13.132203<span class="o">]</span> wlan: <span class="o">[</span><span class="m">4210</span>:I:HDD<span class="o">]</span> wlan_hdd_bus_resume: <span class="m">1226</span>: starting bus resume
<span class="o">[</span><span class="m">10990</span>.513090<span class="o">]</span> ILITEK: <span class="o">(</span>drm_notifier_callback, <span class="m">471</span><span class="o">)</span>: DRM event:2,blank:3
<span class="o">[</span><span class="m">10990</span>.513094<span class="o">]</span> ILITEK: <span class="o">(</span>drm_notifier_callback, <span class="m">492</span><span class="o">)</span>: DRM BLANK<span class="o">(</span><span class="m">3</span><span class="o">)</span> <span class="k">do</span> not need process
<span class="o">[</span><span class="m">10990</span>.513147<span class="o">]</span> ILITEK: <span class="o">(</span>drm_notifier_callback, <span class="m">471</span><span class="o">)</span>: DRM event:1,blank:3
<span class="o">[</span><span class="m">10990</span>.513149<span class="o">]</span> ILITEK: <span class="o">(</span>drm_notifier_callback, <span class="m">492</span><span class="o">)</span>: DRM BLANK<span class="o">(</span><span class="m">3</span><span class="o">)</span> <span class="k">do</span> not need process
<span class="o">[</span><span class="m">10990</span>.513663<span class="o">]</span> ILITEK: <span class="o">(</span>ilitek_tp_pm_resume, <span class="m">779</span><span class="o">)</span>: CALL BACK TP PM RESUME
<span class="o">[</span><span class="m">10990</span>.577217<span class="o">]</span> PAX_BAT: <span class="o">[</span>status:Full, health:Good, present:1, tech:Li-ion, capcity:100,cap_rm:5045 mah, vol:4301 mv, temp:29, curr:0 ma, ui_soc:100<span class="o">]</span>
<span class="o">[</span><span class="m">10990</span>.577935<span class="o">]</span> ///PD dbg info 122d
<span class="o">[</span><span class="m">10990</span>.581826<span class="o">]</span> OOM killer enabled.
<span class="o">[</span><span class="m">10990</span>.584558<span class="o">]</span> &lt;<span class="m">10990</span>.577&gt;TCPC-TCPC:bat_update_work_func battery update <span class="nv">soc</span> <span class="o">=</span> <span class="m">100</span>
<span class="o">[</span><span class="m">10990</span>.584558<span class="o">]</span> &lt;<span class="m">10990</span>.577&gt;TCPC-TCPC:bat_update_work_func Battery Idle
<span class="o">[</span><span class="m">10990</span>.778158<span class="o">]</span> Restarting tasks ...
<span class="o">[</span><span class="m">10990</span>.784613<span class="o">]</span> healthd: battery <span class="nv">l</span><span class="o">=</span><span class="m">100</span> <span class="nv">v</span><span class="o">=</span><span class="m">4301</span> <span class="nv">t</span><span class="o">=</span><span class="m">29</span>.0 <span class="nv">h</span><span class="o">=</span><span class="m">2</span> <span class="nv">st</span><span class="o">=</span><span class="m">5</span> <span class="nv">c</span><span class="o">=</span><span class="m">0</span> <span class="nv">fc</span><span class="o">=</span><span class="m">5045000</span> <span class="nv">cc</span><span class="o">=</span><span class="m">6</span> <span class="nv">chg</span><span class="o">=</span>u
<span class="o">[</span><span class="m">10990</span>.790006<span class="o">]</span> <span class="k">done</span>.
<span class="o">[</span><span class="m">10990</span>.797764<span class="o">]</span> thermal thermal_zone26: failed to <span class="nb">read</span> out thermal zone <span class="o">(</span>-61<span class="o">)</span>
<span class="o">[</span><span class="m">10990</span>.804820<span class="o">]</span> PAX_CHG: charger_pm_event: enter PM_POST_SUSPEND //唤醒后进入PM_POST_SUSPEND阶段，就是退出休眠
<span class="o">[</span><span class="m">10990</span>.810534<span class="o">]</span> PAX_CHG: charger_pm_event: alarm timeout, wake up charger //并唤醒充电线程
<span class="o">[</span><span class="m">10990</span>.817061<span class="o">]</span> Resume caused by IRQ <span class="m">173</span>, pm8xxx_rtc_alarm
<span class="o">[</span><span class="m">10990</span>.817305<span class="o">]</span> PAX_CHG: pax_is_charger_on <span class="nv">chr_type</span> <span class="o">=</span> <span class="o">[</span>DCP<span class="o">]</span> <span class="nv">last_chr_type</span> <span class="o">=</span> <span class="o">[</span>DCP<span class="o">]</span>
<span class="o">[</span><span class="m">10990</span>.822242<span class="o">]</span> PM: <span class="nb">suspend</span> <span class="nb">exit</span>
</pre></div>
</div>
</section>
<section id="id5">
<h1>底座充电功能开发<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>硬件信息：</p></li>
</ul>
<p><img alt="0017_0004.png" src="../../../_images/0017_0004.png" />
<img alt="0017_0005.png" src="../../../_images/0017_0005.png" /></p>
</section>
<section id="id6">
<h1>问题点<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h1>
<section id="bc1-2">
<h2>bc1.2轮询方案<a class="headerlink" href="#bc1-2" title="此标题的永久链接"></a></h2>
<p>我们目前需要等待usb先做完bc1.2，才开始执行充电，目前采用timer轮询的方案，如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>
static void pax_wait_bc12_start_timer(void)
{
	struct timespec time, time_now;
	ktime_t ktime;
	int ret = 0;

	/* If the timer was already set, cancel it */
	ret = alarm_try_to_cancel(&amp;g_info-&gt;wait_bc12_timer);

	get_monotonic_boottime(&amp;time_now);
	time.tv_sec = 0;
	time.tv_nsec = CHR_BC12_POLL_INTERVAL*1000*1000;
	g_info-&gt;waitbc12_endtime = timespec_add(time_now, time);
	ktime = ktime_set(g_info-&gt;endtime.tv_sec, g_info-&gt;waitbc12_endtime.tv_nsec);

	pr_err(&quot;%s: alarm timer start:%d, %ld %ld\n&quot;, __func__, ret,
		g_info-&gt;waitbc12_endtime.tv_sec, g_info-&gt;waitbc12_endtime.tv_nsec);
	alarm_start(&amp;g_info-&gt;wait_bc12_timer, ktime);
}

static enum alarmtimer_restart
	pax_wait_bc12_alarm_timer_func(struct alarm *alarm, ktime_t now)
{
	uint8_t type = TYPEC_UNATTACHED;
	type = g_info-&gt;typec_state;

	g_info-&gt;chr_type = pax_charger_dev_get_charger_type(g_info-&gt;chg1_dev);

	pr_err(&quot;111type=%d, chg_type=%d, count=%d\n&quot;, type,
		g_info-&gt;chr_type, g_info-&gt;wait_bc12_count);

	if (!g_info-&gt;attach)
		goto out;

	if (g_info-&gt;chr_type != POWER_SUPPLY_TYPE_UNKNOWN ||
		g_info-&gt;wait_bc12_count &gt;= 50) {
		g_info-&gt;wait_bc12_count = 0;
		/* start charging after getting the charging type */
		_wake_up_charger(g_info);
		pr_err(&quot;get charger type OK\n&quot;);
	} else {
		pr_err(&quot;restart pax_wait_bc12_alarm_timer_func\n&quot;);
		g_info-&gt;wait_bc12_count++;
		pax_wait_bc12_start_timer();
	}
out:
	pr_err(&quot;device check bc12 fail!\n&quot;);


	return ALARMTIMER_NORESTART;
}

static void pax_charger_init_timer(struct pax_charger *info)
{
	alarm_init(&amp;info-&gt;charger_timer, ALARM_BOOTTIME,
			pax_charger_alarm_timer_func);
	pax_charger_start_timer(info);

	alarm_init(&amp;info-&gt;wait_bc12_timer, ALARM_BOOTTIME,
	pax_wait_bc12_alarm_timer_func); //初始化timer


#ifdef CONFIG_PM
	if (register_pm_notifier(&amp;info-&gt;pm_notifier))
		chr_err(&quot;%s: register pm failed\n&quot;, __func__);
#endif /* CONFIG_PM */
}

在这里调用：
void handle_typec_attach_dettach(bool en)
{
	union power_supply_propval val;

	chr_err(&quot;%s: ++ en:%d g_info-&gt;sink_mv_new = %d\n&quot;, __func__,en,g_info-&gt;sink_mv_new);
	mutex_lock(&amp;g_info-&gt;attach_lock);
	/* The thread notifies the pax charger that the device is connected */
	g_info-&gt;attach = en;
	if (en) {
		/* turn on the timer to poll the charging type when the device is connected */
		pax_wait_bc12_start_timer();
	}
	else {
		/* set prop unknown after device is disconnected */
		val.intval = POWER_SUPPLY_USB_TYPE_UNKNOWN;
		power_supply_set_property(g_info-&gt;usb_psy, POWER_SUPPLY_PROP_REAL_TYPE,
								&amp;val);
	}
	mutex_unlock(&amp;g_info-&gt;attach_lock);
}


typec发送通知：
	case TCP_NOTIFY_TYPEC_STATE:
		old_state = noti-&gt;typec_state.old_state;
		new_state = noti-&gt;typec_state.new_state;
		if (old_state == TYPEC_UNATTACHED &amp;&amp;
		    (new_state == TYPEC_ATTACHED_SNK ||
		     new_state == TYPEC_ATTACHED_NORP_SRC ||
		     new_state == TYPEC_ATTACHED_CUSTOM_SRC ||
		     new_state == TYPEC_ATTACHED_DBGACC_SNK)) {
			dev_err(rpmd-&gt;dev,
				 &quot;%s Charger plug in, polarity = %d\n&quot;,
				 __func__, noti-&gt;typec_state.polarity);
			/*
			 * start charger type detection,
			 * and enable device connection
			 */
			cancel_delayed_work_sync(&amp;rpmd-&gt;usb_dwork);
			rpmd-&gt;usb_dr = DR_DEVICE;
			rpmd-&gt;usb_type_polling_cnt = 0;
			schedule_delayed_work(&amp;rpmd-&gt;usb_dwork,
					      msecs_to_jiffies(
					      USB_TYPE_POLLING_INTERVAL));
			typec_set_data_role(rpmd-&gt;typec_port, TYPEC_DEVICE);
			typec_set_pwr_role(rpmd-&gt;typec_port, TYPEC_SINK);
			typec_set_pwr_opmode(rpmd-&gt;typec_port,
					     noti-&gt;typec_state.rp_level -
					     TYPEC_CC_VOLT_SNK_DFT);
			typec_set_vconn_role(rpmd-&gt;typec_port, TYPEC_SINK);
			set_charger_plug_status(1);
		}
</pre></div>
</div>
<p>发现timer需要先轮询跑完，再跑<code class="docutils literal notranslate"><span class="pre">usb_dwork</span></code>发送通知给usb作切换，就没作用，需要换成dwork形式进行轮询：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pax_wait_bc12_work</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="o">*</span><span class="n">work</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>

<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">chr_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pax_charger_dev_get_charger_type</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;chg_type=%d, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">chr_type</span><span class="p">,</span><span class="w"> </span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_count</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">attach</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_dwork</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">chr_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">POWER_SUPPLY_TYPE_UNKNOWN</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">		</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* start charging after getting the charging type */</span><span class="w"></span>
<span class="w">		</span><span class="n">_wake_up_charger</span><span class="p">(</span><span class="n">g_info</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;get charger type OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;restart pax_wait_bc12 dwork</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_count</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_dwork</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_dwork</span><span class="p">,</span><span class="w"> </span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CHR_BC12_POLL_INTERVAL</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">handle_typec_attach_dettach</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">en</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="w"> </span><span class="nc">power_supply_propval</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s: ++ en:%d g_info-&gt;sink_mv_new = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="n">en</span><span class="p">,</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">sink_mv_new</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">attach_lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* The thread notifies the pax charger that the device is connected */</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">attach</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">en</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* turn on the timer to poll the charging type when the device is connected */</span><span class="w"></span>
<span class="w">		</span><span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">wait_bc12_dwork</span><span class="p">,</span><span class="w"> </span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CHR_BC12_POLL_INTERVAL</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* set prop unknown after device is disconnected */</span><span class="w"></span>
<span class="w">		</span><span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POWER_SUPPLY_USB_TYPE_UNKNOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">power_supply_set_property</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_PROP_REAL_TYPE</span><span class="p">,</span><span class="w"></span>
<span class="w">								</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">attach_lock</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>打印如下,可以看到轮询了5次，也就是250ms才得到充电类型：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>[  859.346234] pax-pd-manager soc:pax_pd_manager: pd_tcp_notifier_call event = 10
[  859.364617] pax-pd-manager soc:pax_pd_manager: pd_tcp_notifier_call sink vbus 5000mV 100mA type(0x01)
[  859.377953] pax-pd-manager soc:pax_pd_manager: pd_tcp_notifier_call event = 14
[  859.385984] pax-pd-manager soc:pax_pd_manager: pd_tcp_notifier_call Charger plug in, polarity = 0
[  859.395758] plug status: 1
[  859.400562] init: Control message: Could not find &#39;android.hardware.soundtrigger@2.0::ISoundTriggerHw/default&#39; for ctl.interface_start from pid: 407 (/system/bin/hwservicemanager)
[  859.417091] pax-pd-manager soc:pax_pd_manager: usb_dwork_handler Device
[  859.423999] extcon extcon2: extcon_set_state_sync id = 2 state = 0
[  859.430939] extcon extcon2: extcon_set_state_sync state 1
[  859.437289] extcon extcon2: extcon_set_state_sync id = 1 state = 1
[  859.444120] extcon extcon2: extcon_set_state_sync state 1
[  859.449662] extcon extcon2: extcon_sync state 1
[  859.454407] extcon extcon2: extcon_sync state 2 index = 0
[  859.459955] extcon extcon2: extcon_sync state 3
[  859.464821] msm-qusb-phy 1613000.qusb: Got VBUS notification: 1
[  859.470872] extcon extcon2: name_show = NAME=soc:pax_pd_manager
[  859.476819] extcon extcon2: state_show = STATE=USB=1
[  859.476819] USB-HOST=0
[  859.488540] chg_type=0, count=0
[  859.491710] restart pax_wait_bc12 dwork
[  859.495755] msm-qusb-phy 1613000.qusb: state: 0
[  859.500526] msm-qusb-phy 1613000.qusb: qusb_phy_enable_power turn on regulators
[  859.508491] msm-qusb-phy 1613000.qusb: min_vol:925000 max_vol:970000
[  859.520947] msm-qusb-phy 1613000.qusb: qusb_phy_enable_clocks(): on:1
[  859.527608] msm-qusb-phy 1613000.qusb: state: 1
[  859.548206] chg_type=0, count=1
[  859.551367] restart pax_wait_bc12 dwork
[  859.584748] msm-qusb-phy 1613000.qusb: state: 2
[  859.589466] msm-qusb-phy 1613000.qusb: state: 1 reg: 0x0
[  859.595064] msm-qusb-phy 1613000.qusb: state: 2
[  859.608212] chg_type=0, count=2
[  859.614515] restart pax_wait_bc12 dwork
[  859.668206] chg_type=0, count=3
[  859.671392] restart pax_wait_bc12 dwork
[  859.696608] msm-qusb-phy 1613000.qusb: state: 3
[  859.701468] msm-qusb-phy 1613000.qusb: state: 2 reg: 0x0
[  859.711492] msm-qusb-phy 1613000.qusb: qusb_phy_enable_clocks(): on:0
[  859.718749] msm-qusb-phy 1613000.qusb: qusb_phy_enable_power turn off regulators
[  859.727840] chg_type=0, count=4
[  859.732692] restart pax_wait_bc12 dwork
[  859.736817] msm-qusb-phy 1613000.qusb: min_vol:0 max_vol:970000
[  859.743300] msm-qusb-phy 1613000.qusb: QUSB PHY&#39;s regulators are turned OFF.
[  859.750898] msm-qusb-phy 1613000.qusb: Notify charger type: 4
[  859.756872] mp2721 0-003f: mp2721_set_property() set charge_type:4, ret:0
[  859.763816] msm-qusb-phy 1613000.qusb: Notify event: 1 for extcon_id: 1
[  859.763828] extcon extcon3: extcon_set_state_sync id = 1 state = 1
[  859.776918] extcon extcon3: extcon_set_state_sync state 1
[  859.782469] extcon extcon3: extcon_sync state 1
[  859.787595] extcon extcon3: extcon_sync state 2 index = 0
[  859.793356] extcon extcon3: extcon_sync state 3
[  859.798396] msm-dwc3 4e00000.ssusb: vbus:1 event received
[  859.803982] msm-dwc3 4e00000.ssusb: edev:1613000.qusb
[  859.809457] extcon extcon3: name_show = NAME=1613000.qusb
[  859.810420] msm-dwc3 4e00000.ssusb: dwc3_resume_work: dwc3 resume work
[  859.814892] extcon extcon3: state_show = STATE=USB=1
[  859.814892] USB-HOST=0
[  859.815757] msm-dwc3 4e00000.ssusb: XCVR: ID set
[  859.820883] chg_type=4, count=5
[  859.820919] get charger type OK
[  859.820932] msm-qusb-phy 1613000.qusb: state: 5
[  859.829601] pax_is_charger_on chr_type = 4
</pre></div>
</div>
<p>貌似这样做会阻塞typec通知，快速拔插会造成死机。</p>
</section>
<section id="charger-routine-threadmsleep">
<h2>charger_routine_thread不能加msleep<a class="headerlink" href="#charger-routine-threadmsleep" title="此标题的永久链接"></a></h2>
<p>参考：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/subfate/article/details/54380164">Linux内核小笔记：spin_lock锁内不能使用sleep休眠</a></p></li>
</ul>
<p>首先，执行了sleep，就可能切换到其它进程，此时，并没有调用spin_unlock释放锁。当另外的进程(线程)再次调用同一驱动时，需要获取相同的spin lock，由于之前并没有释放锁，于是就出现死锁了。</p>
<p>鉴于此，只能放弃msleep的做法，而使用循环达到延时的目标。</p>
</section>
<section id="id7">
<h2>原子通知链不允许嵌套<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h2>
</section>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>