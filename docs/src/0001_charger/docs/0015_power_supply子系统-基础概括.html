<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#power-supply">Power Supply软件架构</a></li>
<li><a class="reference internal" href="#struct-power-supply">struct power_supply</a></li>
<li><a class="reference internal" href="#psy">PSY的类型</a></li>
<li><a class="reference internal" href="#id3">PSY属性</a></li>
<li><a class="reference internal" href="#psy-driverapi">PSY driver提供的API</a><ul>
<li><a class="reference internal" href="#psy-register-unregister-api">1.PSY 的register/unregister API</a></li>
<li><a class="reference internal" href="#psypower-supply-coreapi">2.PSY状态改变时通知power supply core的API</a></li>
<li><a class="reference internal" href="#devm-power-supply-get-by-phandle">3.devm_power_supply_get_by_phandle接口使用</a></li>
<li><a class="reference internal" href="#power-supply-get-drvdata">4.power_supply_get_drvdata获取私有数据</a></li>
</ul>
</li>
<li><a class="reference internal" href="#power-supply-classpsy-driver">怎样基于power supply class编写PSY driver</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>kernel中为了方便对battery的管理，专门提供了power supply framework</p>
<ul class="simple">
<li><p>1、电池监控（fuelgauge）</p></li>
</ul>
<p>fuelgauge驱动主要是负责向上层android系统提供当前电池的电量以及健康状态信息等等，另外除了这个以外，它也向charger驱动提供电池的相关信息</p>
<p>*2、充放电管理（charger）</p>
<p>charger驱动主要负责电源线的插拔检测，以及充放电的过程管理。对于battery管理，硬件上有电量计IC和充放电IC</p>
</section>
<section id="id2">
<h1>参考<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/weixin_46376201/article/details/125201962">Linux Power supply子系统分析</a></p></li>
</ul>
</section>
<section id="power-supply">
<h1>Power Supply软件架构<a class="headerlink" href="#power-supply" title="此标题的永久链接"></a></h1>
<p>power supply framework在kernel/drivers/power/下，主要由3部分组成：</p>
<ul class="simple">
<li><p>1、power supply core，用于抽象核心数据结构、实现公共逻辑。位于drivers/power/power_supply_core.c中</p></li>
<li><p>2、power supply sysfs，实现sysfs以及uevent功能。位于drivers/power/power_supply_sysfs.c中</p></li>
<li><p>3、power supply leds，基于linux led class，提供PSY设备状态指示的通用实现。位于drivers/power/power_suppply_leds.c中。</p></li>
</ul>
</section>
<section id="struct-power-supply">
<h1>struct power_supply<a class="headerlink" href="#struct-power-supply" title="此标题的永久链接"></a></h1>
<p>struct power_supply为power supply class的核心数据结构，用于抽象PSY设备</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">   </span><span class="c1">//该PSY的名称</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_type</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="c1">//该PSY的类型，枚举类型，一般包括:battery、USB-charger、DC-charger。</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_property</span><span class="w"> </span><span class="o">*</span><span class="n">properties</span><span class="p">;</span><span class="w"> </span><span class="c1">//该PSY具有的属性列表，枚举型。</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_properties</span><span class="p">;</span><span class="w">  </span><span class="c1">//属性的个数</span>
<span class="w"> </span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">supplied_to</span><span class="p">;</span><span class="w"> </span><span class="c1">//一个字符串数组，保存了由该PSY供电的PSY列表，以此可将PAY组成互相级联的PSY链表。这些被供电的PSY，称作supplicant（客户端，乞求者）</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_supplicants</span><span class="p">;</span><span class="c1">//supplicant的个数。</span>
<span class="w"> </span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">supplied_from</span><span class="p">;</span><span class="w"> </span><span class="c1">//一个字符串数组，保存了该PSY供电的PSY列表，也称作supply（提供者），从另外一个方向组织PSY之间的级联关系。</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_supplies</span><span class="p">;</span><span class="w"> </span><span class="c1">//supply的个数</span>
<span class="cp">#ifdef CONFIG_OF</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_node</span><span class="w"> </span><span class="o">*</span><span class="n">of_node</span><span class="p">;</span><span class="w"> </span><span class="c1">//用于保存of_node指针。</span>
<span class="cp">#endif</span>
<span class="w"> </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_property</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="w"> </span><span class="c1">//PSY driver需要实现的回调函数，用于获取属性值。</span>
<span class="w">                </span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_property</span><span class="w"> </span><span class="n">psp</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">union</span><span class="w"> </span><span class="nc">power_supply_propval</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_property</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="w">  </span><span class="c1">//PSY driver需要实现的回调函数，用于设置属性值。</span>
<span class="w">                            </span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_property</span><span class="w"> </span><span class="n">psp</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">power_supply_propval</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">property_is_writeable</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="w">  </span><span class="c1">//返回指定的属性值是否可写（用于sysfs）；</span>
<span class="w">                     </span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_property</span><span class="w"> </span><span class="n">psp</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">external_power_changed</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">);</span><span class="w"> </span><span class="c1">//当一个PSY设备存在supply PSY，且该supply PSY的属性发生改变（如online offline）时，power supply core会调用该回调函数，通知PSY driver以便让它做出相应处理。</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_charged</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">);</span><span class="w">     </span><span class="c1">//该回调函数的应用场景有点奇怪，外部模块通知PAY driver，该PSY设备的状态改变了，自己改变了自己不知道，要外部通知，希望大家在实际工作中不要遇到，太纠结了。</span>
<span class="w"> </span>
<span class="w">    </span><span class="cm">/* For APM emulation, think legacy userspace. */</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">use_for_apm</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span>
<span class="w">    </span><span class="cm">/* private */</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="n">changed_work</span><span class="p">;</span><span class="w"> </span><span class="c1">//用户处理状态改变的work queue，主要思路是当该PSY的状态发生改变，启动一个workqueue，查询并通知所有的supplicants。</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">changed_lock</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">changed</span><span class="p">;</span><span class="w"></span>
<span class="cp">#ifdef CONFIG_THERMAL</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thermal_zone_device</span><span class="w"> </span><span class="o">*</span><span class="n">tzd</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thermal_cooling_device</span><span class="w"> </span><span class="o">*</span><span class="n">tcd</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w"> </span>
<span class="cp">#ifdef CONFIG_LEDS_TRIGGERS</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">led_trigger</span><span class="w"> </span><span class="o">*</span><span class="n">charging_full_trig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">charging_full_trig_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">led_trigger</span><span class="w"> </span><span class="o">*</span><span class="n">charging_trig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">charging_trig_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">led_trigger</span><span class="w"> </span><span class="o">*</span><span class="n">full_trig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">full_trig_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">led_trigger</span><span class="w"> </span><span class="o">*</span><span class="n">online_trig</span><span class="p">;</span><span class="w"> </span><span class="c1">//如果配置了CONFIC_LED_TRIGGERS，则调用的linux led class的接口，注册相应的LED设备，用于PSY状态指示。</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">online_trig_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">led_trigger</span><span class="w"> </span><span class="o">*</span><span class="n">charging_blink_full_solid_trig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">charging_blink_full_solid_trig_name</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="psy">
<h1>PSY的类型<a class="headerlink" href="#psy" title="此标题的永久链接"></a></h1>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_UNKNOWN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">//未知</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">,</span><span class="w">     </span><span class="c1">//电池，手机平板上面最常用的</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_UPS</span><span class="p">,</span><span class="w">         </span><span class="c1">//不间断供电的，一般用户服务器   </span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_MAINS</span><span class="p">,</span><span class="w">        </span><span class="c1">//主供电设备，如笔记本电脑适配器，特点是可以单独供电，当其断开时，再由辅助设备供电。</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">,</span><span class="w">      </span><span class="cm">/* Standard Downstream Port */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_USB_DCP</span><span class="p">,</span><span class="w">  </span><span class="cm">/* Dedicated Charging Port */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_USB_CDP</span><span class="p">,</span><span class="w">  </span><span class="cm">/* Charging Downstream Port */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_TYPE_USB_ACA</span><span class="p">,</span><span class="w">  </span><span class="cm">/* Accessory Charger Adapters */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id3">
<h1>PSY属性<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<p>power supply class将所有可能PSY属性，以枚举型变量形式抽象出来，PSY driver可以根据设备的实际情况，从中选取一些。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">power_supply_property</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Properties of type `int&#39; */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">//该PSY的status，主要是充电状态，包括：unknown,charging,discharging,not charging full,</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_TYPE</span><span class="p">,</span><span class="c1">//充电类型</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_HEALTH</span><span class="p">,</span><span class="w"> </span><span class="c1">//健康状况，包括：good dead  over voltage等</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span><span class="w"> </span><span class="c1">//电量百分比</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span><span class="w">  </span><span class="c1">//是否在线</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_AUTHENTIC</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span><span class="p">,</span><span class="w"> </span><span class="c1">//采用的技术</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CYCLE_COUNT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_VOLTAGE_MAX</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_VOLTAGE_MIN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_VOLTAGE_OCV</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CURRENT_MAX</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_POWER_NOW</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_POWER_AVG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_EMPTY_DESIGN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_EMPTY</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_AVG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_COUNTER</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT_MAX</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_ENERGY_FULL_DESIGN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_ENERGY_EMPTY_DESIGN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_ENERGY_FULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_ENERGY_EMPTY</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_ENERGY_NOW</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_ENERGY_AVG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span><span class="w"> </span><span class="cm">/* in percents! */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CAPACITY_ALERT_MIN</span><span class="p">,</span><span class="w"> </span><span class="cm">/* in percents! */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CAPACITY_ALERT_MAX</span><span class="p">,</span><span class="w"> </span><span class="cm">/* in percents! */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CAPACITY_LEVEL</span><span class="p">,</span><span class="w"> </span><span class="c1">//容量</span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TEMP</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TEMP_ALERT_MIN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TEMP_ALERT_MAX</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TEMP_AMBIENT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TEMP_AMBIENT_ALERT_MIN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TEMP_AMBIENT_ALERT_MAX</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TIME_TO_FULL_NOW</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TIME_TO_FULL_AVG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_TYPE</span><span class="p">,</span><span class="w"> </span><span class="cm">/* use power_supply.type instead */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_SCOPE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Local extensions */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_USB_HC</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_USB_OTG</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_ENABLED</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Local extensions of type int64_t */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_CHARGE_COUNTER_EXT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Properties of type `const char *&#39; */</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_MODEL_NAME</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_MANUFACTURER</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">POWER_SUPPLY_PROP_SERIAL_NUMBER</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="psy-driverapi">
<h1>PSY driver提供的API<a class="headerlink" href="#psy-driverapi" title="此标题的永久链接"></a></h1>
<p>power supply class 首要任务，是向PSY driver提供统一的驱动编程接口，主要包括：</p>
<section id="psy-register-unregister-api">
<h2>1.PSY 的register/unregister API<a class="headerlink" href="#psy-register-unregister-api" title="此标题的永久链接"></a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">power_supply_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">power_supply_unregister</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">power_supply_powers</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="psypower-supply-coreapi">
<h2>2.PSY状态改变时通知power supply core的API<a class="headerlink" href="#psypower-supply-coreapi" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>extern void power_supply_changed(struct power_supply *psy);</p></li>
</ul>
<p>当PSY driver检测到该设备某些属性改变时，需要调用这个接口，通知power supply core，power supply core会有如下动作
如果该PSY是其他PSY的供电源，调用这些PSY的external_power_changed回调函数，通知他们（这些PSY具体要做什么，由他们自身的逻辑决定）；
发送notifier通知那些关心PSY设备状态的drivers；
以统一的格式向用户空间发送uevent。</p>
<p>其他一些接口</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">power_supply_get_by_name</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="c1">//通过名字获取PSY指针</span>
<span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">power_supply_get_by_phandle</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device_node</span><span class="w"> </span><span class="o">*</span><span class="n">np</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                           </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">property</span><span class="p">);</span><span class="w"> </span><span class="c1">//从DTS中，解析出对应的PSY指针。</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">power_supply_am_i_supplied</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">);</span><span class="c1">//查询自己是否由其他PSY供电</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">power_supply_set_battery_charged</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">);</span><span class="c1">//调用指定的PSY的set_changed回调。</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">power_supply_is_system_supplied</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"> </span><span class="c1">//检查系统中是否有有效的或者处于online状态的PSY，如果没有，可能为桌面系统、</span>
<span class="w"> </span>
<span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">power_supply_powers</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="c1">//在指定的设备的sysfs目录下创建指定的PSY符合连接。</span>
</pre></div>
</div>
</section>
<section id="devm-power-supply-get-by-phandle">
<h2>3.devm_power_supply_get_by_phandle接口使用<a class="headerlink" href="#devm-power-supply-get-by-phandle" title="此标题的永久链接"></a></h2>
<p>参考：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/hanguangce/article/details/116270277">power_supply 探究设备 关系</a></p></li>
<li><p>power_supply_get_by_phandle实例</p></li>
</ul>
<p>以下是从dts中获取</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>dts:
        mt6370_chg: charger {
                    compatible = &quot;mediatek,mt6370_pmu_charger&quot;;
                    charger = &lt;&amp;mt6370_chg&gt;;
        }

code：

static int mt6370_pmu_charger_probe(struct platform_device *pdev)
{
#ifdef CONFIG_TCPC_CLASS
	chg_data-&gt;chg_psy = devm_power_supply_get_by_phandle(&amp;pdev-&gt;dev,
							     &quot;charger&quot;);
	if (IS_ERR(chg_data-&gt;chg_psy)) {
		dev_notice(&amp;pdev-&gt;dev, &quot;Failed to get charger psy\n&quot;);
		ret = PTR_ERR(chg_data-&gt;chg_psy);
		goto err_psy_get_phandle;
	}
#endif
}

static const struct of_device_id mt_ofid_table[] = {
	{ .compatible = &quot;mediatek,mt6370_pmu_charger&quot;, },
	{ },
};
MODULE_DEVICE_TABLE(of, mt_ofid_table);

static const struct platform_device_id mt_id_table[] = {
	{ &quot;mt6370_pmu_charger&quot;, 0},
	{ },
};
MODULE_DEVICE_TABLE(platform, mt_id_table);

static struct platform_driver mt6370_pmu_charger = {
	.driver = {
		.name = &quot;mt6370_pmu_charger&quot;,
		.owner = THIS_MODULE,
		.of_match_table = of_match_ptr(mt_ofid_table),
	},
	.probe = mt6370_pmu_charger_probe,
	.remove = mt6370_pmu_charger_remove,
	.id_table = mt_id_table,
};
</pre></div>
</div>
<ul class="simple">
<li><p>原理</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">devm_power_supply_get_by_phandle</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">power_supply_get_by_phandle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span><span class="w"> </span><span class="n">property</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">power_supply_np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_find_device</span><span class="p">(</span><span class="n">power_supply_class</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">power_supply_np</span><span class="p">,</span><span class="n">power_supply_match_device_node</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">psy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"> </span><span class="c1">//私有数据我们找到设备-通过私有数据找到 psy</span>
</pre></div>
</div>
<ul class="simple">
<li><p>注册原理</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">power_supply_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">__power_supply_register</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="k">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">power_supply_class</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">psy</span><span class="p">);</span><span class="w">  </span><span class="c1">//和前面对应构建psy  信息 并创建个设备 ，设置为dev 的私有数据</span>
</pre></div>
</div>
<p>还有一种更简单的方法，通过psy设备名获取，但是可移植性不强，如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">qphy</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">power_supply_get_by_name</span><span class="p">(</span><span class="s">&quot;xxx-usb&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="power-supply-get-drvdata">
<h2>4.power_supply_get_drvdata获取私有数据<a class="headerlink" href="#power-supply-get-drvdata" title="此标题的永久链接"></a></h2>
<p>我们可以在注册psy设备时，将结构体数据保存在power_supply提供的drv_data中</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">xxx_charger_external_power_changed</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">xxx_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="w"> </span><span class="nc">power_supply_propval</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">prop2</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xxx_charger</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">power_supply_get_drvdata</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">xxx_charger_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy_cfg1</span><span class="p">.</span><span class="n">drv_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">power_supply_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy_desc1</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy_cfg1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>原理：drv_data是一个vold类型的数据，获取时直接返回。</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* Driver private data */</span><span class="w"></span>
<span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">drv_data</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">power_supply_get_drvdata</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="n">psy</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">psy</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="power-supply-classpsy-driver">
<h1>怎样基于power supply class编写PSY driver<a class="headerlink" href="#power-supply-classpsy-driver" title="此标题的永久链接"></a></h1>
<p>（1）根据硬件spec，确定PSY设备具备哪些特性，并把他们和enum power_supply_property对应。
（2）根据实际情况，实现这些properties的get/set接口。
（3）定义一个struct power_supply 变量，并初始化必要字段后，调用power_supply_register或者power_supply_register_no_ws，将其注册到kernel中。
（4）根据实际情况，启动设备属性变化的监控逻辑，例如中断，轮询等，并在发生改变时，调用power_supply_changed，通知power suopply core。</p>
<ul class="simple">
<li><p>向用户空间程序提供的API</p></li>
</ul>
<p>power supply class通过两种形式向用户空间提供接口。</p>
<ul class="simple">
<li><p>1）uevent 以“名字=value”的形式，上报所有property的值 uevent一般会在PSY设备添加到kernel时，或者PSY属性发生改变时发送。</p></li>
<li><p>2）sysfs 如果某个PSY设备具有某个属性，该属性对应的attribute就会体现在sysfs中（一般位于“/sys/class/power_supply/xxx/”中）</p></li>
</ul>
<p>作者：酥酥肉
链接：https://www.jianshu.com/p/36ddaa857e5c
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</section>


           </div>
         <div class="articleComments">
               <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>