<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#id2">硬件</a></li>
<li><a class="reference internal" href="#id3">软件架构</a></li>
<li><a class="reference internal" href="#id4">软件分析</a><ul>
<li><a class="reference internal" href="#dts">dts配置</a></li>
<li><a class="reference internal" href="#charger-probe">charger probe流程</a><ul>
<li><a class="reference internal" href="#id5">1.charger probe工作</a></li>
<li><a class="reference internal" href="#charger-routine-thread">charger_routine_thread唤醒</a></li>
<li><a class="reference internal" href="#timer">timer初始化</a></li>
<li><a class="reference internal" href="#id6">timer使能与关闭</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">charger_routine_thread线程流程</a><ul>
<li><a class="reference internal" href="#chargerchg-alg-init-algo-pd">1.charger线程chg_alg_init_algo(PD充电判断)</a></li>
<li><a class="reference internal" href="#do-algorithm-pdpd">2.do_algorithm算法(判断PD协议是否准备好PD充电)</a></li>
<li><a class="reference internal" href="#select-charging-current-limit">3.select_charging_current_limit解析</a></li>
<li><a class="reference internal" href="#support-fast-chargingpd-pd-hw-ready-pd-run">4.support_fast_charging判断是否支持PD充电(PD_HW_READY-&gt;PD_RUN)</a></li>
<li><a class="reference internal" href="#chg-alg-start-algopd">5.chg_alg_start_algo开始PD充电</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#pd">PD充电程序流程</a><ul>
<li><a class="reference internal" href="#pd-run">__pd_run具体流程</a></li>
<li><a class="reference internal" href="#id8">dts配置</a><ul>
<li><a class="reference internal" href="#id9">PD策略介绍</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mtk-pdc-get-setting">__mtk_pdc_get_setting函数</a><ul>
<li><a class="reference internal" href="#mtk-pdc-init-tablecap">1.__mtk_pdc_init_table获取适配器cap供电能力</a></li>
<li><a class="reference internal" href="#mtk-pdc-get-reset-idx-dts">2.__mtk_pdc_get_reset_idx获取最大最小电压(dts指定)</a></li>
<li><a class="reference internal" href="#mtk-pdc-get-cap-max-watt">3.__mtk_pdc_get_cap_max_watt获取最大功率</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mtk-pdc-setup">__mtk_pdc_setup函数</a><ul>
<li><a class="reference internal" href="#mtk-pdc-get-idx">1.__mtk_pdc_get_idx匹配最大档位</a></li>
<li><a class="reference internal" href="#pd-hal-set-adapter-cap">2.pd_hal_set_adapter_cap设置适配器档位</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10">PD充电步骤</a></li>
<li><a class="reference internal" href="#id11">PD充电图及配置</a><ul>
<li><a class="reference internal" href="#id12">1.dts配置</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id13">修改历程</a><ul>
<li><a class="reference internal" href="#pd9v-2a12v-1-5a">将PD充电从9v/2a提高到12v/1.5a</a></li>
<li><a class="reference internal" href="#usb-bc1-2">优化usb唤醒速度，跳过bc1.2检测</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>讲述MTK平台充电流程</p>
</section>
<section id="id2">
<h1>硬件<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>首先需要确定中断使能脚，不然无法充电：</p></li>
</ul>
<p><img alt="0001_0004.png" src="../../../_images/0001_0004.png" /></p>
<ul class="simple">
<li><p>软件配置：</p></li>
</ul>
<p><img alt="0001_0003.png" src="../../../_images/0001_0003.png" /></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/kernel-4.19/drivers/misc/mediatek/dws/mt6765/k62v1_64_pax.dws</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/misc/mediatek/dws/mt6765/k62v1_64_pax.dws</span><span class="w"></span>
<span class="gu">@@ -1,5 +1,5 @@</span><span class="w"></span>
<span class="w"> </span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<span class="w"></span>
<span class="gd">-&lt;!--dct_version=&quot;2.5&quot; buid_sn=&quot;161102&quot; dws_modification_time=&quot;03.13.2021.15:59:06&quot;--&gt;</span><span class="w"></span>
<span class="gi">+&lt;!--dct_version=&quot;2.5&quot; buid_sn=&quot;161102&quot; dws_modification_time=&quot;04.20.2021.17:21:23&quot;--&gt;</span><span class="w"></span>
<span class="w"> </span>&lt;dct_cfg&gt;<span class="w"></span>
<span class="w"> </span>    &lt;general chip=&quot;MT6765&quot;&gt;<span class="w"></span>
<span class="w"> </span>        &lt;proj&gt;MT6765&lt;/proj&gt;<span class="w"></span>
<span class="gu">@@ -1696,8 +1696,8 @@</span><span class="w"></span>
<span class="w"> </span>                &lt;inpull_en&gt;false&lt;/inpull_en&gt;<span class="w"></span>
<span class="w"> </span>                &lt;inpull_selhigh&gt;false&lt;/inpull_selhigh&gt;<span class="w"></span>
<span class="w"> </span>                &lt;def_dir&gt;OUT&lt;/def_dir&gt;<span class="w"></span>
<span class="gd">-                &lt;out_high&gt;true&lt;/out_high&gt;</span><span class="w"></span>
<span class="gd">-                &lt;varName0&gt;GPIO_LCM_LED_EN&lt;/varName0&gt;</span><span class="w"></span>
<span class="gi">+                &lt;out_high&gt;false&lt;/out_high&gt;</span><span class="w"></span>
<span class="gi">+                &lt;varName0&gt;GPIO_SWCHARGER_EN_PIN&lt;/varName0&gt;</span><span class="w"></span>
<span class="w"> </span>                &lt;smt&gt;false&lt;/smt&gt;<span class="w"></span>
<span class="w"> </span>                &lt;ies&gt;true&lt;/ies&gt;<span class="w"></span>
<span class="w"> </span>            &lt;/gpio154&gt;<span class="w"></span>
<span class="gu">@@ -1917,7 +1917,6 @@</span><span class="w"></span>
<span class="w"> </span>                &lt;inpull_selhigh&gt;false&lt;/inpull_selhigh&gt;<span class="w"></span>
<span class="w"> </span>                &lt;def_dir&gt;OUT&lt;/def_dir&gt;<span class="w"></span>
<span class="w"> </span>                &lt;out_high&gt;false&lt;/out_high&gt;<span class="w"></span>
<span class="gd">-                &lt;varName0&gt;GPIO_SWCHARGER_EN_PIN&lt;/varName0&gt;</span><span class="w"></span>
<span class="w"> </span>                &lt;smt&gt;false&lt;/smt&gt;<span class="w"></span>
<span class="w"> </span>                &lt;ies&gt;true&lt;/ies&gt;<span class="w"></span>
<span class="w"> </span>            &lt;/gpio175&gt;<span class="w"></span>
</pre></div>
</div>
</section>
<section id="id3">
<h1>软件架构<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>整体架构</p></li>
</ul>
<p><img alt="0001_0002.png" src="../../../_images/0001_0002.png" /></p>
<ul class="simple">
<li><p>kernel架构</p></li>
</ul>
<p><img alt="0001_0005.png" src="../../../_images/0001_0005.png" /></p>
</section>
<section id="id4">
<h1>软件分析<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<section id="dts">
<h2>dts配置<a class="headerlink" href="#dts" title="此标题的永久链接"></a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">mt6765</span><span class="p">.</span><span class="n">dts</span><span class="o">:</span><span class="w"></span>
<span class="nl">charger</span><span class="p">:</span><span class="w"> </span><span class="n">charger</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mediatek,charger&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">gauge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">mtk_gauge</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">charger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">mt6370_chg</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">bootmode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">chosen</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">pmic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">main_pmic</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">algorithm_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Basic&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//选择基础充电</span>
<span class="w">        </span><span class="n">charger_configuration</span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* common */</span><span class="w"></span>
<span class="w">        </span><span class="n">battery_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4350000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">max_charger_voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6500000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">min_charger_voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4500000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* sw jeita */</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* enable_sw_jeita; */</span><span class="w"></span>
<span class="w">        </span><span class="n">jeita_temp_above_t4_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4240000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">jeita_temp_t3_to_t4_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4240000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">jeita_temp_t2_to_t3_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4340000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">jeita_temp_t1_to_t2_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4240000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">jeita_temp_t0_to_t1_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4040000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">jeita_temp_below_t0_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4040000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t4_thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">50</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t4_thres_minus_x_degree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">47</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t3_thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">45</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t3_thres_minus_x_degree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">39</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t2_thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t2_thres_plus_x_degree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t1_thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t1_thres_plus_x_degree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t0_thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_t0_thres_plus_x_degree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_neg_10_thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* battery temperature protection */</span><span class="w"></span>
<span class="w">        </span><span class="n">enable_min_charge_temp</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">min_charge_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">min_charge_temp_plus_x_degree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">max_charge_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">50</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">max_charge_temp_minus_x_degree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">47</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* charging current */</span><span class="w"></span>
<span class="w">        </span><span class="n">usb_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">500000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ac_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ac_charger_input_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">charging_host_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1500000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* dynamic mivr */</span><span class="w"></span>
<span class="w">        </span><span class="n">enable_dynamic_mivr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">min_charger_voltage_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4400000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">min_charger_voltage_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4200000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">max_dmivr_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2500000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="charger-probe">
<h2>charger probe流程<a class="headerlink" href="#charger-probe" title="此标题的永久链接"></a></h2>
<section id="id5">
<h3>1.charger probe工作<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mtk_charger.c</span></code>:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">mtk_charger_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">mtk_charger_parse_dt</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"> </span><span class="c1">//解析dts</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wakeup_source_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="c1">//注册wakeup锁</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">polling_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHARGING_INTERVAL</span><span class="p">;</span><span class="w"> </span><span class="c1">//#define CHARGING_INTERVAL 5 timer间隔时间5s启动一次充电线程</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">mtk_charger_init_timer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">alarm_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_timer</span><span class="p">,</span><span class="w"> </span><span class="n">ALARM_BOOTTIME</span><span class="p">,</span><span class="n">mtk_charger_alarm_timer_func</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="o">*</span><span class="w"> </span><span class="n">register_pm_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">)</span><span class="c1">//监听PM休眠唤醒事件</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">charger_pm_event</span><span class="p">;</span><span class="w"> </span><span class="c1">//监听PM休眠唤醒事件</span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">PM_POST_SUSPEND</span><span class="p">:</span><span class="w"> </span><span class="c1">//休眠状态</span>
<span class="w">          </span><span class="o">*</span><span class="w"> </span><span class="n">_wake_up_charger</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w"> </span><span class="c1">//唤醒充电线程，检查是否有适配器插入在充电</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">mtk_charger_setup_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span><span class="w"> </span><span class="c1">//创建各种sysfs</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy_desc1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mtk-master-charger&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//psy设备名称，节点：sys/class/power_supply/mtk-master-charger</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">power_supply_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy_desc1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">psy_cfg1</span><span class="p">);</span><span class="w"> </span><span class="c1">//注册psy</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pd_nb</span><span class="p">.</span><span class="n">notifier_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">notify_adapter_event</span><span class="p">;</span><span class="w"> </span><span class="c1">//监听PD适配器充电事件，比如复位、PD30支持等</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">bms_notify_register_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bms_nb</span><span class="p">);</span><span class="w"> </span><span class="c1">//注册bms监听,我们自己定制的</span>
</pre></div>
</div>
</section>
<section id="charger-routine-thread">
<h3>charger_routine_thread唤醒<a class="headerlink" href="#charger-routine-thread" title="此标题的永久链接"></a></h3>
<p>charger_routine_thread该线程只在_wake_up_charger被调用后才执行,否则就会一直休眠等待。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">wait_event</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">wait_que</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_timeout</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span><span class="c1">//此处进程休眠等待,充电器插入.</span>
<span class="w">		</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">//跑一次线程，就会进入下次的wait_event</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>只有条件info-&gt;charger_thread_timeout为true时才被唤醒继续执行.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">_wake_up_charger</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_manager</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wake_lock_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">wake_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_wakelock</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="c1">//重要</span>
<span class="w">    </span><span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">wait_que</span><span class="p">);</span><span class="c1">//唤醒等待队列上休眠的进程</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>具体看看哪些地方调用了<code class="docutils literal notranslate"><span class="pre">_wake_up_charger</span></code>函数：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>1.alarm timeout, wake up charger 休眠时会唤醒检查是否有适配器插入：
static int charger_pm_event(struct notifier_block *notifier,
			unsigned long pm_event, void *unused)
{
···
	case PM_POST_SUSPEND:
		info-&gt;is_suspend = false;
		chr_debug(&quot;%s: enter PM_POST_SUSPEND\n&quot;, __func__);
		get_monotonic_boottime(&amp;now);

		if (timespec_compare(&amp;now, &amp;info-&gt;endtime) &gt;= 0 &amp;&amp;
			info-&gt;endtime.tv_sec != 0 &amp;&amp;
			info-&gt;endtime.tv_nsec != 0) {
			chr_err(&quot;%s: alarm timeout, wake up charger\n&quot;,
				__func__);
			__pm_relax(info-&gt;charger_wakelock);
			info-&gt;endtime.tv_sec = 0;
			info-&gt;endtime.tv_nsec = 0;
			_wake_up_charger(info);
		}
		break;
	default:
		break;
···
}

2.被调用psy_charger_set_property时唤醒：
int psy_charger_set_property(struct power_supply *psy,
			enum power_supply_property psp,
			const union power_supply_propval *val)
{
	switch (psp) {
	case POWER_SUPPLY_PROP_VOLTAGE_MAX:
		if (val-&gt;intval &gt; 0)
			info-&gt;enable_hv_charging = true;
		else
			info-&gt;enable_hv_charging = false;
		break;
	case POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:
		info-&gt;chg_data[idx].thermal_charging_current_limit =
			val-&gt;intval;
		break;
	case POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:
		info-&gt;chg_data[idx].thermal_input_current_limit =
			val-&gt;intval;
		break;
	default:
		return -EINVAL;
	}
	_wake_up_charger(info);

	return 0;
}

3.external_power_changed被调用时唤醒：
static void mtk_charger_external_power_changed(struct power_supply *psy)
{
	struct mtk_charger *info;
	union power_supply_propval prop, prop2;
	struct power_supply *chg_psy = NULL;
	int ret;

	info = (struct mtk_charger *)power_supply_get_drvdata(psy);
	chg_psy = devm_power_supply_get_by_phandle(&amp;info-&gt;pdev-&gt;dev,
						       &quot;charger&quot;);
	if (IS_ERR_OR_NULL(chg_psy)) {
		pr_notice(&quot;%s Couldn&#39;t get chg_psy\n&quot;, __func__);
	} else {
		ret = power_supply_get_property(chg_psy,
			POWER_SUPPLY_PROP_ONLINE, &amp;prop);
		ret = power_supply_get_property(chg_psy,
			POWER_SUPPLY_PROP_USB_TYPE, &amp;prop2);
	}

	pr_notice(&quot;%s event, name:%s online:%d type:%d vbus:%d\n&quot;, __func__,
		psy-&gt;desc-&gt;name, prop.intval, prop2.intval,
		get_vbus(info));

	mtk_is_charger_on(info);
	_wake_up_charger(info);
}

4.作为SNK或者PD硬复位时唤醒：
int notify_adapter_event(struct notifier_block *notifier,
			unsigned long evt, void *val)
{
		switch (evt) {
···
	case MTK_PD_CONNECT_HARD_RESET:
		mutex_lock(&amp;pinfo-&gt;pd_lock);
		chr_err(&quot;PD Notify HardReset\n&quot;);
		pinfo-&gt;pd_type = MTK_PD_CONNECT_NONE;
		pinfo-&gt;pd_reset = true;
		mutex_unlock(&amp;pinfo-&gt;pd_lock);
		_wake_up_charger(pinfo);
		/* reset PE40 */
		break;
···
	case MTK_PD_CONNECT_PE_READY_SNK_APDO:
		mutex_lock(&amp;pinfo-&gt;pd_lock);
		chr_err(&quot;PD Notify APDO Ready\n&quot;);
		pinfo-&gt;pd_type = MTK_PD_CONNECT_PE_READY_SNK_APDO;
		mutex_unlock(&amp;pinfo-&gt;pd_lock);
		/* PE40 is ready */
		_wake_up_charger(pinfo);
		break;
···
	case MTK_PD_CONNECT_TYPEC_ONLY_SNK:
		mutex_lock(&amp;pinfo-&gt;pd_lock);
		chr_err(&quot;PD Notify Type-C Ready\n&quot;);
		pinfo-&gt;pd_type = MTK_PD_CONNECT_TYPEC_ONLY_SNK;
		mutex_unlock(&amp;pinfo-&gt;pd_lock);
		/* type C is ready */
		_wake_up_charger(pinfo);
		break;
	return NOTIFY_DONE;
}

</pre></div>
</div>
</section>
<section id="timer">
<h3>timer初始化<a class="headerlink" href="#timer" title="此标题的永久链接"></a></h3>
<p>timer初始化工作是在probe函数里处理的：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>timer初始化函数：
static void mtk_charger_init_timer(struct mtk_charger *info)
{
	alarm_init(&amp;info-&gt;charger_timer, ALARM_BOOTTIME,
			mtk_charger_alarm_timer_func);
	mtk_charger_start_timer(info);

#ifdef CONFIG_PM
	if (register_pm_notifier(&amp;info-&gt;pm_notifier))
		chr_err(&quot;%s: register pm failed\n&quot;, __func__);
#endif /* CONFIG_PM */
}

static void mtk_charger_start_timer(struct mtk_charger *info)
{
	struct timespec time, time_now;
	ktime_t ktime;
	int ret = 0;

	/* If the timer was already set, cancel it */
	ret = alarm_try_to_cancel(&amp;info-&gt;charger_timer);
	if (ret &lt; 0) {
		chr_err(&quot;%s: callback was running, skip timer\n&quot;, __func__);
		return;
	}

	get_monotonic_boottime(&amp;time_now);
	time.tv_sec = info-&gt;polling_interval;
	time.tv_nsec = 0;
	info-&gt;endtime = timespec_add(time_now, time);
	ktime = ktime_set(info-&gt;endtime.tv_sec, info-&gt;endtime.tv_nsec);

	chr_err(&quot;%s: alarm timer start:%d, %ld %ld\n&quot;, __func__, ret,
		info-&gt;endtime.tv_sec, info-&gt;endtime.tv_nsec);
	alarm_start(&amp;info-&gt;charger_timer, ktime);
}

timer执行函数：
static enum alarmtimer_restart
	mtk_charger_alarm_timer_func(struct alarm *alarm, ktime_t now)
{
	struct mtk_charger *info =
	container_of(alarm, struct mtk_charger, charger_timer);

	if (info-&gt;is_suspend == false) { //非休眠状态
		chr_err(&quot;%s: not suspend, wake up charger\n&quot;, __func__);
		_wake_up_charger(info);
	} else {
		chr_err(&quot;%s: alarm timer timeout\n&quot;, __func__);
		__pm_stay_awake(info-&gt;charger_wakelock);
	}

	return ALARMTIMER_NORESTART;
}
</pre></div>
</div>
<p>timer时间设置为<code class="docutils literal notranslate"><span class="pre">time.tv_sec</span> <span class="pre">=</span> <span class="pre">info-&gt;polling_interval;</span></code>，跟到代码<code class="docutils literal notranslate"><span class="pre">info-&gt;polling_interval</span> <span class="pre">=</span> <span class="pre">CHARGING_INTERVAL</span></code>，timer每5s唤醒一次充电线程。</p>
</section>
<section id="id6">
<h3>timer使能与关闭<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<p>timer是在线程唤醒后，根据变量charger_thread_polling为真才会执行的，而charger_thread_polling是在usb插入和拔出时赋值的，插入使能，拔出关闭。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">charger_routine_thread</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_polling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">mtk_charger_start_timer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mtk_charger_plug_in</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="kt">int</span><span class="w"> </span><span class="n">chr_type</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_polling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">can_charging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mtk_charger_plug_out</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">charger_thread_polling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>charger_routine_thread和timer关系流程如下：</p>
<p><img alt="0001_0010.png" src="../../../_images/0001_0010.png" /></p>
</section>
</section>
<section id="id7">
<h2>charger_routine_thread线程流程<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h2>
<section id="chargerchg-alg-init-algo-pd">
<h3>1.charger线程chg_alg_init_algo(PD充电判断)<a class="headerlink" href="#chargerchg-alg-init-algo-pd" title="此标题的永久链接"></a></h3>
<p>根据<code class="docutils literal notranslate"><span class="pre">is_charger_on</span></code>可以知道当适识别到bc.12检测USB后，才调用充电算法<code class="docutils literal notranslate"><span class="pre">do_algorithm</span></code>。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>* kthread_run(charger_routine_thread, info, &quot;charger_thread&quot;); //创建充电线程
  * if (charger_init_algo(info) == true) //检测是否软件打开支持PD/PE或者普通充电，这里并没有发生协议，并注册相关notify
    * chr_err(&quot;get pd success\n&quot;);
    * chg_alg_init_algo(alg);
      * lg_dev-&gt;ops-&gt;init_algo(alg_dev);
        * _pd_init_algo(struct chg_alg_device *alg)
          * if (pd_hal_init_hardware(alg) != 0)
            * hal-&gt;chg1_dev = get_charger_by_name(&quot;primary_chg&quot;);
            * hal-&gt;adapter = get_adapter_by_name(&quot;pd_adapter&quot;);
              * pd-&gt;state = PD_HW_FAIL/PD_HW_READY; //重要，PD充电第一步
              * alg-&gt;config = SINGLE_CHARGER/DUAL_CHARGERS_IN_SERIES/DUAL_CHARGERS_IN_PARALLEL //判断是否支持单充、串行双充、并行双充
    * register_chg_alg_notifier(alg, &amp;info-&gt;chg_alg_nb); //比如支持PD
    * info-&gt;chg1_nb.notifier_call = info-&gt;algo.do_event; //关联basic charger驱动的do_event函数，主要识别回充、ovp、SAFETY_TIMEOUT充电安全时间等事件接受，接收到notify后会唤醒充电线程
      * register_charger_device_notifier(info-&gt;chg1_dev,&amp;info-&gt;chg1_nb);
  * charger_dev_event(struct notifier_block *nb, unsigned long event,
    * case CHARGER_DEV_NOTIFY_RECHG:
      * _wake_up_charger(info); //回充会唤醒充电线程
  * is_charger_on = mtk_is_charger_on(info); //重要，关系到bc1.2检测识别是否在充电
    * chr_type = get_charger_type(info);//bc1.2  检测充电器流程请看0003_Android11充电类型识别.md
      * if (chr_type == POWER_SUPPLY_TYPE_UNKNOWN) 
        * if (info-&gt;chr_type != POWER_SUPPLY_TYPE_UNKNOWN) {
    * mtk_charger_plug_out(info);//如果当前是UNKNOWN设备，上次检测不是UNKNOWN设备，则识别成拔出usb，断开充电
  * else if (info-&gt;chr_type == POWER_SUPPLY_TYPE_UNKNOWN) 
  * mtk_charger_plug_in(info, chr_type);//如果是从UNKNOWN设备-&gt;变为非UNKNOWN设备，则插入usb
    * info-&gt;can_charging = true; //重要，这里线程才会开始运行充电算法
    * chg_alg_notifier_call(alg, &amp;notify); //通知驱动usb插入
      * charger_dev_plug_in(info-&gt;chg1_dev);
        * chg_dev-&gt;ops-&gt;plug_in(chg_dev);
          * mt6370_plug_in(struct charger_device *chg_dev)
            * ret = mt6370_enable_charging(chg_dev, true); //使能充电
  * check_battery_exist(info); //检测电池是否存在
  * check_dynamic_mivr(info); //设置动态mivr，主要是AICL功能
  * #ifndef CONFIG_PAX_BMS charger_check_status(info);//这里本来是检测电池温度的，现在放到BMS里面做，mtk jeita也在里面，这样就没开
  * kpoc_power_off_check(info); //关机充电，拔出USB则关闭系统
  * if (is_disable_charger(info) == false &amp;&amp; is_charger_on == true &amp;&amp; info-&gt;can_charging == true) //详情如上mtk_is_charger_on，如果检测到插入充电器了，且正在充电，则调用充电算法。
    * info-&gt;algo.do_algorithm(info); //调用mtk_basic_charger.c
      * is_basic = select_charging_current_limit(info, &amp;info-&gt;setting); //选择充电限流电流
    * else is_disable_charger(info), //停止充电
</pre></div>
</div>
<ul class="simple">
<li><p>大概流程如下：</p>
<ul>
<li><p>开机解析dts</p></li>
<li><p>监听PD适配器充电事件，比如复位、PD30支持等，功能比如PD硬复位时会调用_wake_up_charger唤醒充电线程，注册bms监听。</p></li>
<li><p>关联basic charger驱动的do_event函数，主要识别回充、ovp、SAFETY_TIMEOUT充电安全时间等事件接受，接收到notify后会唤醒充电线程。</p></li>
<li><p>pd_hal_init_hardware解析dts是否支持PD、单充或双充，PD_HW_READY。</p></li>
<li><p>bc1.2检测识别是否可充电，如果是从UNKNOWN设备-&gt;变为非UNKNOWN设备，则插入usb使能充电。</p></li>
<li><p>检测电池是否存在</p></li>
<li><p>设置动态mivr，主要是AICL功能</p></li>
<li><p>如果检测到插入充电器了，且正在充电，则调用充电算法do_algorithm。</p></li>
<li><p>select_charging_current_limit选择充电限流电流。</p></li>
</ul>
</li>
<li><p>pys相关属性：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>mtk_charger注册的psy属性：
  static enum power_supply_property charger_psy_properties[] = {
	POWER_SUPPLY_PROP_ONLINE,
	POWER_SUPPLY_PROP_PRESENT,
	POWER_SUPPLY_PROP_VOLTAGE_MAX,
	POWER_SUPPLY_PROP_VOLTAGE_NOW,
	POWER_SUPPLY_PROP_TEMP,
	POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX,
	POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT,
};

PAYTABLETM8:/sys/class/power_supply # ls mtk-master-charger
constant_charge_current_max  online   subsystem  uevent       wakeup130
device                       power    temp       voltage_max
input_current_limit          present  type       voltage_now

psy属性实现：
int psy_charger_set_property(struct power_supply *psy,
			enum power_supply_property psp,
			const union power_supply_propval *val)
{
	struct mtk_charger *info;
	int idx;

	chr_err(&quot;%s: prop:%d %d\n&quot;, __func__, psp, val-&gt;intval);

	info = (struct mtk_charger *)power_supply_get_drvdata(psy);

	if (info-&gt;psy1 != NULL &amp;&amp;
		info-&gt;psy1 == psy)
		idx = CHG1_SETTING;
	else if (info-&gt;psy2 != NULL &amp;&amp;
		info-&gt;psy2 == psy)
		idx = CHG2_SETTING;
	else {
		chr_err(&quot;%s fail\n&quot;, __func__);
		return 0;
	}

	switch (psp) {
	case POWER_SUPPLY_PROP_VOLTAGE_MAX:
		if (val-&gt;intval &gt; 0)
			info-&gt;enable_hv_charging = true;
		else
			info-&gt;enable_hv_charging = false;
		break;
	case POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:
		info-&gt;chg_data[idx].thermal_charging_current_limit =
			val-&gt;intval;
		break;
	case POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:
		info-&gt;chg_data[idx].thermal_input_current_limit =
			val-&gt;intval;
		break;
	default:
		return -EINVAL;
	}
	_wake_up_charger(info);

	return 0;
}

static int psy_charger_get_property(struct power_supply *psy,
	enum power_supply_property psp, union power_supply_propval *val)
{
	struct mtk_charger *info;
	struct charger_device *chg;

	info = (struct mtk_charger *)power_supply_get_drvdata(psy);

	chr_err(&quot;%s psp:%d\n&quot;,
		__func__, psp);


	if (info-&gt;psy1 != NULL &amp;&amp;
		info-&gt;psy1 == psy)
		chg = info-&gt;chg1_dev;
	else if (info-&gt;psy2 != NULL &amp;&amp;
		info-&gt;psy2 == psy)
		chg = info-&gt;chg2_dev;
	else {
		chr_err(&quot;%s fail\n&quot;, __func__);
		return 0;
	}

	switch (psp) {
	case POWER_SUPPLY_PROP_ONLINE:
		val-&gt;intval = is_charger_exist(info);
		break;
	case POWER_SUPPLY_PROP_PRESENT:
		if (chg != NULL)
			val-&gt;intval = true;
		else
			val-&gt;intval = false;
		break;
	case POWER_SUPPLY_PROP_VOLTAGE_MAX:
		val-&gt;intval = info-&gt;enable_hv_charging;
		break;
	case POWER_SUPPLY_PROP_VOLTAGE_NOW:
		val-&gt;intval = get_vbus(info);
		break;
	case POWER_SUPPLY_PROP_TEMP:
		if (chg == info-&gt;chg1_dev)
			val-&gt;intval =
				info-&gt;chg_data[CHG1_SETTING].junction_temp_max;
		else if (chg == info-&gt;chg2_dev)
			val-&gt;intval =
				info-&gt;chg_data[CHG2_SETTING].junction_temp_max;
		else
			val-&gt;intval = -127;
		break;
	case POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:
		val-&gt;intval = get_charger_charging_current(info, chg);
		break;
	case POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:
		val-&gt;intval = get_charger_input_current(info, chg);
		break;
	case POWER_SUPPLY_PROP_USB_TYPE:
		val-&gt;intval = info-&gt;chr_type;
		break;
	case POWER_SUPPLY_PROP_VOLTAGE_BOOT:
		val-&gt;intval = get_charger_zcv(info, chg);
		break;
	default:
		return -EINVAL;
	}

	return 0;
}
</pre></div>
</div>
</section>
<section id="do-algorithm-pdpd">
<h3>2.do_algorithm算法(判断PD协议是否准备好PD充电)<a class="headerlink" href="#do-algorithm-pdpd" title="此标题的永久链接"></a></h3>
<p>根据dts内容<code class="docutils literal notranslate"><span class="pre">algorithm_name</span> <span class="pre">=</span> <span class="pre">&quot;Basic&quot;;</span></code>，得知选择的是基础充电，以下都已支持PD充电为例子做介绍。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">do_algorithm</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">charger_dev_is_charging_done</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">chg_done</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">mt6370_is_charging_done</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="n">chg_dev</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="n">done</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chg_done</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">charger_dev_do_event</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_FULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">is_basic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_charging_current_limit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">setting</span><span class="p">);</span><span class="w"> </span><span class="c1">//重要，1.根据bc1.2/CC Rp/thermal设置限流，判断是否支持快充。</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_basic</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="c1">//快充</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">chg_alg_notifier_call</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">notify</span><span class="p">);</span><span class="w"> </span><span class="c1">//通知满充及回充状态</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">chg_alg_set_current_limit</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">setting</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">alg_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_current_limit</span><span class="p">(</span><span class="n">alg_dev</span><span class="p">,</span><span class="w"> </span><span class="n">setting</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="w">  </span><span class="n">_pd_set_setting</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg_dev</span><span class="p">,</span><span class="w"> </span><span class="c1">//例如PD充电</span>
<span class="w">          </span><span class="o">*</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="p">;</span><span class="w"> </span><span class="c1">//限制电池端电流</span>
<span class="w">          </span><span class="o">*</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">charging_current_limit1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">charging_current_limit1</span><span class="p">;</span><span class="w"> </span><span class="c1">//限制适配器电流</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chg_alg_is_algo_ready</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"> </span><span class="c1">//判断快充是否已准备好</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">alg_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_algo_ready</span><span class="p">(</span><span class="n">alg_dev</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">_pd_is_algo_ready</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">)</span><span class="w"> </span><span class="c1">//mtk_pd.c</span>
<span class="w">          </span><span class="o">*</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">PD_HW_READY</span><span class="p">:</span><span class="w"> </span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_hal_is_pd_adapter_ready</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_CONNECT_PE_READY_SNK</span><span class="w"> </span><span class="o">||</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_CONNECT_PE_READY_SNK_PD30</span><span class="w"> </span><span class="o">||</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_CONNECT_PE_READY_SNK_APDO</span><span class="p">)</span><span class="w"> </span><span class="c1">//如果CC检测到是这几种情况表示支持PD充电</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_READY</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">is_basic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="n">chg_alg_start_algo</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">//开始PD充电</span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">_pd_start_algo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">*</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">PD_RUN</span><span class="p">:</span><span class="w"> </span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pd_run</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"> </span><span class="c1">//do while架构pd充电</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="c1">//普通充电</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">chg_alg_is_algo_running</span><span class="p">(</span><span class="n">alg</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">chg_alg_stop_algo</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"> </span><span class="c1">//如果快充时vbus大于5v，则停止pd充电。</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">input_current_limit</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置普充电池端电流</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">charger_dev_set_charging_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">charging_current_limit</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置普充适配器电流</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">charger_dev_set_constant_voltage</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">setting</span><span class="p">.</span><span class="n">cv</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置cv，一般设置为4.35v</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">charger_dev_dump_registers</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">mt6370_dump_register</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="n">chg_dev</span><span class="p">)</span><span class="w"> </span><span class="c1">//打印各种充电信息</span>
</pre></div>
</div>
<ul class="simple">
<li><p>大概流程如下：</p>
<ul>
<li><p>1.根据bc1.2/CC Rp/thermal设置限流，判断是否支持快充。</p></li>
<li><p>2.上报满充及回充状态。</p></li>
<li><p>3.如果支持快充，判断PD协议是否完成，快充CC是否已准备好，开始执行快充算法。</p></li>
<li><p>4.如果是普通充电，则设置电流、电压。</p></li>
<li><p>5.打印各种充电信息：</p></li>
</ul>
</li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">[</span><span class="w">  </span><span class="mf">334.128108</span><span class="p">]</span><span class="w">  </span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">303</span><span class="o">:</span><span class="n">charger_thread</span><span class="p">]</span><span class="n">mt6370_pmu_charger</span><span class="w"> </span><span class="n">mt6370_pmu_charger</span><span class="o">:</span><span class="w"> </span><span class="n">mt6370_dump_register</span><span class="o">:</span><span class="w"> </span><span class="n">ICHG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="n">mA</span><span class="p">,</span><span class="w"> </span><span class="n">AICR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">750</span><span class="n">mA</span><span class="p">,</span><span class="w"> </span><span class="n">MIVR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4400</span><span class="n">mV</span><span class="p">,</span><span class="w"> </span><span class="n">IEOC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">250</span><span class="n">mA</span><span class="p">,</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4370</span><span class="n">mV</span><span class="w"></span>
<span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">[</span><span class="w">  </span><span class="mf">334.128136</span><span class="p">]</span><span class="w">  </span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">303</span><span class="o">:</span><span class="n">charger_thread</span><span class="p">]</span><span class="n">mt6370_pmu_charger</span><span class="w"> </span><span class="n">mt6370_pmu_charger</span><span class="o">:</span><span class="w"> </span><span class="n">mt6370_dump_register</span><span class="o">:</span><span class="w"> </span><span class="n">VSYS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4130</span><span class="n">mV</span><span class="p">,</span><span class="w"> </span><span class="n">VBAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4110</span><span class="n">mV</span><span class="p">,</span><span class="w"> </span><span class="n">IBAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="n">mA</span><span class="p">,</span><span class="w"> </span><span class="n">IBUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">700</span><span class="n">mA</span><span class="p">,</span><span class="w"> </span><span class="n">VBUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4425</span><span class="n">mV</span><span class="w"></span>
<span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">[</span><span class="w">  </span><span class="mf">334.128143</span><span class="p">]</span><span class="w">  </span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">303</span><span class="o">:</span><span class="n">charger_thread</span><span class="p">]</span><span class="n">mt6370_pmu_charger</span><span class="w"> </span><span class="n">mt6370_pmu_charger</span><span class="o">:</span><span class="w"> </span><span class="n">mt6370_dump_register</span><span class="o">:</span><span class="w"> </span><span class="n">CHG_EN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">CHG_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">progress</span><span class="p">,</span><span class="w"> </span><span class="n">CHG_STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xA0</span><span class="w"></span>
<span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">[</span><span class="w">  </span><span class="mf">334.128150</span><span class="p">]</span><span class="w">  </span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">303</span><span class="o">:</span><span class="n">charger_thread</span><span class="p">]</span><span class="n">mt6370_pmu_charger</span><span class="w"> </span><span class="n">mt6370_pmu_charger</span><span class="o">:</span><span class="w"> </span><span class="n">mt6370_dump_register</span><span class="o">:</span><span class="w"> </span><span class="n">CHG_CTRL1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="n">CHG_CTRL2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1B</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="select-charging-current-limit">
<h3>3.select_charging_current_limit解析<a class="headerlink" href="#select-charging-current-limit" title="此标题的永久链接"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">select_charging_current_limit</span></code>函数主要功能是根据bc1.2/CC Rp/thermal设置限流，判断是否支持快充，下面来详细看一下具体处理流程：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>dts：
charger: charger {
      /* battery temperature protection */
        enable_min_charge_temp;
        min_charge_temp = &lt;0&gt;;
        min_charge_temp_plus_x_degree = &lt;6&gt;;
        max_charge_temp = &lt;50&gt;;
        max_charge_temp_minus_x_degree = &lt;47&gt;;

        /* charging current */
        usb_charger_current = &lt;500000&gt;;
        ac_charger_current = &lt;2000000&gt;;
        ac_charger_input_current = &lt;3000000&gt;;
        charging_host_charger_current = &lt;1500000&gt;;

        /* dynamic mivr */
        enable_dynamic_mivr;
        min_charger_voltage_1 = &lt;4400000&gt;;
        min_charger_voltage_2 = &lt;4200000&gt;;
        max_dmivr_charger_current = &lt;2500000&gt;;
}

static bool select_charging_current_limit(struct mtk_charger *info,
	struct chg_limit_setting *setting)
{
	struct charger_data *pdata, *pdata2;
	bool is_basic = false;
	u32 ichg1_min = 0, aicr1_min = 0;
	int ret;

	select_cv(info);

	pdata = &amp;info-&gt;chg_data[CHG1_SETTING];
	pdata2 = &amp;info-&gt;chg_data[CHG2_SETTING];
	if (info-&gt;usb_unlimited) {
		pdata-&gt;input_current_limit =
					info-&gt;data.ac_charger_input_current;
		pdata-&gt;charging_current_limit =
					info-&gt;data.ac_charger_current;
		is_basic = true;
		goto done;
	}

	if (info-&gt;water_detected) {
		pdata-&gt;input_current_limit = info-&gt;data.usb_charger_current;
		pdata-&gt;charging_current_limit = info-&gt;data.usb_charger_current;
		is_basic = true;
		goto done;
	}

	if ((info-&gt;bootmode == 1) ||
	    (info-&gt;bootmode == 5)) {
		pdata-&gt;input_current_limit = 200000; /* 200mA */  //meta模式限流
		is_basic = true;
		goto done;
	}

	if (info-&gt;atm_enabled == true
		&amp;&amp; (info-&gt;chr_type == POWER_SUPPLY_TYPE_USB ||
		info-&gt;chr_type == POWER_SUPPLY_TYPE_USB_CDP) 
		) {
		pdata-&gt;input_current_limit = 100000; /* 100mA */
		is_basic = true;
		goto done;
	}

	if (info-&gt;chr_type == POWER_SUPPLY_TYPE_USB) {
		pdata-&gt;input_current_limit =
				info-&gt;data.usb_charger_current; //bc1.2检测，sdp适配器充电限流500ma
		/* it can be larger */
		pdata-&gt;charging_current_limit =
				info-&gt;data.usb_charger_current;
		is_basic = true;
	} else if (info-&gt;chr_type == POWER_SUPPLY_TYPE_USB_CDP) {
		pdata-&gt;input_current_limit =
			info-&gt;data.charging_host_charger_current; //cdp适配器限流1.5a
		pdata-&gt;charging_current_limit =
			info-&gt;data.charging_host_charger_current;
		is_basic = true;

	} else if (info-&gt;chr_type == POWER_SUPPLY_TYPE_USB_DCP) {
		pdata-&gt;input_current_limit =
			info-&gt;data.ac_charger_input_current; // dcp适配器限流3a
		pdata-&gt;charging_current_limit =
			info-&gt;data.ac_charger_current; //电池端限流2a
		if (info-&gt;config == DUAL_CHARGERS_IN_SERIES) {
			pdata2-&gt;input_current_limit =
				pdata-&gt;input_current_limit;
			pdata2-&gt;charging_current_limit = 2000000;
		}
	} else if (info-&gt;chr_type == POWER_SUPPLY_TYPE_USB_FLOAT) {
		/* NONSTANDARD_CHARGER */
		//[BUGFIX]-BEGIN by wugangnan@paxsz.com 2021-12-11, float charger&#39;s current is limit as 2A for M50 leather case charging
		pdata-&gt;input_current_limit = 2000000; //浮充适配器限流2a
			//info-&gt;data.usb_charger_current;
		pdata-&gt;charging_current_limit = 2000000;
			//info-&gt;data.usb_charger_current;
		//[BUGFIX]-END by wugangnan@paxsz.com 2021-12-11, float charger&#39;s current is limit as 2A for M50 leather case charging
		is_basic = true;
	}

	if (support_fast_charging(info))
		is_basic = false;
	else {
		is_basic = true;
		/* AICL */
		charger_dev_run_aicl(info-&gt;chg1_dev,
			&amp;pdata-&gt;input_current_limit_by_aicl);
		if (info-&gt;enable_dynamic_mivr) {
			if (pdata-&gt;input_current_limit_by_aicl &gt;
				info-&gt;data.max_dmivr_charger_current)
				pdata-&gt;input_current_limit_by_aicl =
					info-&gt;data.max_dmivr_charger_current;
		}
		if (is_typec_adapter(info)) {  //type-c供电能力判断，根据DFP的上拉电阻Rp
			if (adapter_dev_get_property(info-&gt;pd_adapter, TYPEC_RP_LEVEL)
				== 3000) {
				pdata-&gt;input_current_limit = 3000000;  
				pdata-&gt;charging_current_limit = 3000000;
			} else if (adapter_dev_get_property(info-&gt;pd_adapter,
				TYPEC_RP_LEVEL) == 1500) {
				pdata-&gt;input_current_limit = 1500000;
				pdata-&gt;charging_current_limit = 2000000;
			} else {
				chr_err(&quot;type-C: inquire rp error\n&quot;);
				/* Add-BEGIN by (zhangwj@paxsz.com), 2021/04/29, for non-standard usb chg cable limit in 2.0A */
				//pdata-&gt;input_current_limit = 500000;
				//pdata-&gt;charging_current_limit = 500000;
				pdata-&gt;input_current_limit = 2000000;
				pdata-&gt;charging_current_limit = 2000000;
				/* Add-END by (zhangwj@paxsz.com), 2021/04/29, for non-standard usb chg cable limit in 2.0A */
			}

			chr_err(&quot;type-C:%d current:%d\n&quot;,
				info-&gt;pd_type,
				adapter_dev_get_property(info-&gt;pd_adapter,
					TYPEC_RP_LEVEL));
		}
	}

	if (info-&gt;enable_sw_jeita) {
		if (IS_ENABLED(CONFIG_USBIF_COMPLIANCE)
			&amp;&amp; info-&gt;chr_type == POWER_SUPPLY_TYPE_USB)
			chr_debug(&quot;USBIF &amp; STAND_HOST skip current check\n&quot;);
		else {
			if (info-&gt;sw_jeita.sm == TEMP_T0_TO_T1) {
				pdata-&gt;input_current_limit = 500000;
				pdata-&gt;charging_current_limit = 350000;
			}
		}
	}

	if (pdata-&gt;thermal_charging_current_limit != -1) { //thermal限流
		if (pdata-&gt;thermal_charging_current_limit &lt;
			pdata-&gt;charging_current_limit) {
			pdata-&gt;charging_current_limit =
					pdata-&gt;thermal_charging_current_limit;
			info-&gt;setting.charging_current_limit1 =
					pdata-&gt;thermal_charging_current_limit;
		}
	} else
		info-&gt;setting.charging_current_limit1 = -1;

	if (pdata-&gt;thermal_input_current_limit != -1) {
		if (pdata-&gt;thermal_input_current_limit &lt;
			pdata-&gt;input_current_limit) {
			pdata-&gt;input_current_limit =
					pdata-&gt;thermal_input_current_limit;
			info-&gt;setting.input_current_limit1 =
					pdata-&gt;input_current_limit;
		}
	} else
		info-&gt;setting.input_current_limit1 = -1;

	if (pdata2-&gt;thermal_charging_current_limit != -1) {
		if (pdata2-&gt;thermal_charging_current_limit &lt;
			pdata2-&gt;charging_current_limit) {
			pdata2-&gt;charging_current_limit =
					pdata2-&gt;thermal_charging_current_limit;
			info-&gt;setting.charging_current_limit2 =
					pdata2-&gt;charging_current_limit;
		}
	} else
		info-&gt;setting.charging_current_limit2 = -1;

	if (pdata2-&gt;thermal_input_current_limit != -1) {
		if (pdata2-&gt;thermal_input_current_limit &lt;
			pdata2-&gt;input_current_limit) {
			pdata2-&gt;input_current_limit =
					pdata2-&gt;thermal_input_current_limit;
			info-&gt;setting.input_current_limit2 =
					pdata2-&gt;input_current_limit;
		}
	} else
		info-&gt;setting.input_current_limit2 = -1;

	if (is_basic == true &amp;&amp; pdata-&gt;input_current_limit_by_aicl != -1) {
		if (pdata-&gt;input_current_limit_by_aicl &lt;
		    pdata-&gt;input_current_limit)
			pdata-&gt;input_current_limit =
					pdata-&gt;input_current_limit_by_aicl;
	}
done:

	ret = charger_dev_get_min_charging_current(info-&gt;chg1_dev, &amp;ichg1_min);
	if (ret != -ENOTSUPP &amp;&amp; pdata-&gt;charging_current_limit &lt; ichg1_min) {
		pdata-&gt;charging_current_limit = 0;
		chr_err(&quot;min_charging_current is too low %d %d\n&quot;,
			pdata-&gt;charging_current_limit, ichg1_min);
		is_basic = true;
		info-&gt;enable_hv_charging = false;
	}

	ret = charger_dev_get_min_input_current(info-&gt;chg1_dev, &amp;aicr1_min);
	if (ret != -ENOTSUPP &amp;&amp; pdata-&gt;input_current_limit &lt; aicr1_min) {
		pdata-&gt;input_current_limit = 0;
		chr_err(&quot;min_input_current is too low %d %d\n&quot;,
			pdata-&gt;input_current_limit, aicr1_min);
		is_basic = true;
		info-&gt;enable_hv_charging = false;
	}

	chr_err(&quot;m:%d chg1:%d,%d,%d,%d chg2:%d,%d,%d,%d type:%d:%d usb_unlimited:%d usbif:%d usbsm:%d aicl:%d atm:%d bm:%d b:%d\n&quot;,
		info-&gt;config,
		_uA_to_mA(pdata-&gt;thermal_input_current_limit),
		_uA_to_mA(pdata-&gt;thermal_charging_current_limit),
		_uA_to_mA(pdata-&gt;input_current_limit),
		_uA_to_mA(pdata-&gt;charging_current_limit),
		_uA_to_mA(pdata2-&gt;thermal_input_current_limit),
		_uA_to_mA(pdata2-&gt;thermal_charging_current_limit),
		_uA_to_mA(pdata2-&gt;input_current_limit),
		_uA_to_mA(pdata2-&gt;charging_current_limit),
		info-&gt;chr_type, info-&gt;pd_type,
		info-&gt;usb_unlimited,
		IS_ENABLED(CONFIG_USBIF_COMPLIANCE), info-&gt;usb_state,
		pdata-&gt;input_current_limit_by_aicl, info-&gt;atm_enabled,
		info-&gt;bootmode, is_basic);

	return is_basic;
}
</pre></div>
</div>
</section>
<section id="support-fast-chargingpd-pd-hw-ready-pd-run">
<h3>4.support_fast_charging判断是否支持PD充电(PD_HW_READY-&gt;PD_RUN)<a class="headerlink" href="#support-fast-chargingpd-pd-hw-ready-pd-run" title="此标题的永久链接"></a></h3>
<p>该函数是轮询一遍pd/pe算法的<code class="docutils literal notranslate"><span class="pre">is_algo_ready</span></code>，判断是否支持快充，主要原理是<code class="docutils literal notranslate"><span class="pre">mtk_pd_adapter</span></code>驱动监听<code class="docutils literal notranslate"><span class="pre">tcp</span> <span class="pre">notify</span></code>，相当于PD协议，如果CC检测到是这几种情况表示支持PD充电，<code class="docutils literal notranslate"><span class="pre">MTK_PD_CONNECT_PE_READY_SNK/MTK_PD_CONNECT_PE_READY_SNK_PD30/MTK_PD_CONNECT_PE_READY_SNK_APDO</span></code>，具体看一下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">mtk_basic_charger</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">support_fast_charging</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_charger</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_ALG_NO</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">alg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">chg_alg_set_current_limit</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">setting</span><span class="p">);</span><span class="w"></span>
<span class="w">		  </span><span class="o">*</span><span class="w"> </span><span class="n">_pd_set_setting</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">		    </span><span class="o">*</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">cv</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="o">*</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="o">*</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">charging_current_limit1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">charging_current_limit1</span><span class="p">;</span><span class="c1">//设置cv/适配器、电池端电流限制</span>
<span class="w">		</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chg_alg_is_algo_ready</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">alg_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_algo_ready</span><span class="p">(</span><span class="n">alg_dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_debug</span><span class="p">(</span><span class="s">&quot;%s %s ret:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span><span class="w"></span>
<span class="w">			</span><span class="n">chg_alg_state_to_str</span><span class="p">(</span><span class="n">state</span><span class="p">));</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_READY</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">mtk_pd</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_pd_is_algo_ready</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_pd</span><span class="w"> </span><span class="o">*</span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret_value</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">uisoc</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">pd_err</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PD_HW_UNINIT</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PD_HW_FAIL</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_INIT_FAIL</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PD_HW_READY</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_hal_is_pd_adapter_ready</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_READY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">uisoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_hal_get_uisoc</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">				</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">charging_current_limit1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">				</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">				</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">charging_current_limit2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">				</span><span class="n">uisoc</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_stop_battery_soc</span><span class="p">)</span><span class="w"> </span><span class="c1">//如果限流都没设置好，或soc电量大于停充电量，表示pd不支持了。</span>
<span class="w">				</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_NOT_READY</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_TA_NOT_SUPPORT</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_TA_NOT_SUPPORT</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_TA_CHECKING</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_HW_READY</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_TA_NOT_SUPPORT</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PD_TA_NOT_SUPPORT</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_TA_NOT_SUPPORT</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PD_RUN</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PD_TUNING</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">PD_POSTCC</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_RUNNING</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="n">pd_err</span><span class="p">(</span><span class="s">&quot;PD unknown state:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_INIT_FAIL</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret_value</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">mtk_pd_hal</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">pd_hal_is_pd_adapter_ready</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_pd</span><span class="w"> </span><span class="o">*</span><span class="n">pd</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">pd_hal</span><span class="w"> </span><span class="o">*</span><span class="n">hal</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: alg is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">hal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chg_alg_dev_get_drv_hal_data</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adapter_dev_get_property</span><span class="p">(</span><span class="n">hal</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">PD_TYPE</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s type:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_CONNECT_PE_READY_SNK</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">		</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_CONNECT_PE_READY_SNK_PD30</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">		</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_CONNECT_PE_READY_SNK_APDO</span><span class="p">)</span><span class="w"> </span><span class="c1">//重点</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ALG_READY</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_CONNECT_TYPEC_ONLY_SNK</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ALG_TA_NOT_SUPPORT</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ALG_TA_CHECKING</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>可以看到<code class="docutils literal notranslate"><span class="pre">pd_hal_is_pd_adapter_ready</span></code>函数是获取适配器的<code class="docutils literal notranslate"><span class="pre">PD_TYPE</span></code>属性，那来看一下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>mtk_pd_adapter.c:
static int pd_get_property(struct adapter_device *dev,
	enum adapter_property sta)
{
	struct mtk_pd_adapter_info *info;

	info = (struct mtk_pd_adapter_info *)adapter_dev_get_drvdata(dev);
	if (info == NULL || info-&gt;tcpc == NULL)
		return -1;

	switch (sta) {
	case TYPEC_RP_LEVEL:
		{
			return tcpm_inquire_typec_remote_rp_curr(info-&gt;tcpc);
		}
		break;
	case PD_TYPE:
		{
			return info-&gt;pd_type; //重要
		}
		break;
	default:
		{
		}
		break;
	}
	return -1;
}

继续看一下info-&gt;pd_type赋值，可以看到pd_adapter驱动其实就支持监听typec的PD状态：
mtk_pd_adapter_probe(struct platform_device *pdev)
{
  info-&gt;pd_nb.notifier_call = pd_tcp_notifier_call;
	ret = register_tcp_dev_notifier(info-&gt;tcpc, &amp;info-&gt;pd_nb,TCP_NOTIFY_TYPE_USB | TCP_NOTIFY_TYPE_MISC);
}

static int pd_tcp_notifier_call(struct notifier_block *pnb,
				unsigned long event, void *data)
{
	struct tcp_notify *noti = data;
	struct mtk_pd_adapter_info *pinfo;
	struct adapter_device *adapter;
	int ret = 0;

	pinfo = container_of(pnb, struct mtk_pd_adapter_info, pd_nb);
	adapter = pinfo-&gt;adapter_dev;

	pr_notice(&quot;PD charger event:%d %d\n&quot;, (int)event,
		(int)noti-&gt;pd_state.connected);

	switch (event) {
	case TCP_NOTIFY_PD_STATE:
		switch (noti-&gt;pd_state.connected) {
		case  PD_CONNECT_NONE:
			pinfo-&gt;pd_type = MTK_PD_CONNECT_NONE;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_NONE, NULL);
//			notify_adapter_event(MTK_PD_ADAPTER,
//				MTK_PD_CONNECT_NONE, NULL);
			break;

		case PD_CONNECT_HARD_RESET:
			pinfo-&gt;pd_type = MTK_PD_CONNECT_NONE;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_HARD_RESET, NULL);
//			notify_adapter_event(MTK_PD_ADAPTER,
//				MTK_PD_CONNECT_HARD_RESET, NULL);
			break;

		case PD_CONNECT_PE_READY_SNK:
			pinfo-&gt;pd_type = MTK_PD_CONNECT_PE_READY_SNK;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_PE_READY_SNK, NULL);
//			notify_adapter_event(MTK_PD_ADAPTER,
//				MTK_PD_CONNECT_PE_READY_SNK, NULL);
			break;

		case PD_CONNECT_PE_READY_SNK_PD30:
			pinfo-&gt;pd_type = MTK_PD_CONNECT_PE_READY_SNK_PD30;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_PE_READY_SNK_PD30, NULL);
//			notify_adapter_event(MTK_PD_ADAPTER,
//				MTK_PD_CONNECT_PE_READY_SNK_PD30, NULL);
			break;

		case PD_CONNECT_PE_READY_SNK_APDO:
			pinfo-&gt;pd_type = MTK_PD_CONNECT_PE_READY_SNK_APDO;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_PE_READY_SNK_APDO, NULL);
//			notify_adapter_event(MTK_PD_ADAPTER,
//				MTK_PD_CONNECT_PE_READY_SNK_APDO, NULL);
			break;

		case PD_CONNECT_TYPEC_ONLY_SNK_DFT:
			/* fall-through */
		case PD_CONNECT_TYPEC_ONLY_SNK:
			pinfo-&gt;pd_type = MTK_PD_CONNECT_TYPEC_ONLY_SNK;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_TYPEC_ONLY_SNK, NULL);
//			notify_adapter_event(MTK_PD_ADAPTER,
//				MTK_PD_CONNECT_PE_READY_SNK_APDO, NULL);
			break;
		};
		break;
	case TCP_NOTIFY_TYPEC_STATE:
		/* handle No-rp and dual-rp cable */
		if (noti-&gt;typec_state.old_state == TYPEC_UNATTACHED &amp;&amp;
		   (noti-&gt;typec_state.new_state == TYPEC_ATTACHED_CUSTOM_SRC ||
		    noti-&gt;typec_state.new_state == TYPEC_ATTACHED_NORP_SRC)) {
			pinfo-&gt;pd_type = MTK_PD_CONNECT_TYPEC_ONLY_SNK;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_TYPEC_ONLY_SNK, NULL);
		} else if ((noti-&gt;typec_state.old_state ==
			TYPEC_ATTACHED_CUSTOM_SRC ||
			noti-&gt;typec_state.old_state == TYPEC_ATTACHED_NORP_SRC)
			&amp;&amp; noti-&gt;typec_state.new_state == TYPEC_UNATTACHED) {
			pinfo-&gt;pd_type = MTK_PD_CONNECT_NONE;
			ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
				MTK_PD_CONNECT_NONE, NULL);
		}
		break;
	case TCP_NOTIFY_WD_STATUS:
		ret = srcu_notifier_call_chain(&amp;adapter-&gt;evt_nh,
			MTK_TYPEC_WD_STATUS, &amp;noti-&gt;wd_status.water_detected);
		break;
	}
	return ret;
}
</pre></div>
</div>
</section>
<section id="chg-alg-start-algopd">
<h3>5.chg_alg_start_algo开始PD充电<a class="headerlink" href="#chg-alg-start-algopd" title="此标题的永久链接"></a></h3>
<p>可以看到<code class="docutils literal notranslate"><span class="pre">_pd_start_algo</span></code>里面是<code class="docutils literal notranslate"><span class="pre">do</span> <span class="pre">while</span></code>循环架构，重复判断PD支持并执行PD充电算法。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">chg_alg_start_algo</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_pd_start_algo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_pd</span><span class="w"> </span><span class="o">*</span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">uisoc</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pd_info</span><span class="p">(</span><span class="s">&quot;%s state:%d %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">pd_state_to_str</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span><span class="w"></span>
<span class="w">			</span><span class="n">again</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">again</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_HW_UNINIT</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_HW_FAIL</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_INIT_FAIL</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_HW_READY</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_hal_is_pd_adapter_ready</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_TA_NOT_SUPPORT</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_TA_NOT_SUPPORT</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_READY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">uisoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_hal_get_uisoc</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">					</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">charging_current_limit1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">					</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">					</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">charging_current_limit2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">					</span><span class="n">uisoc</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_stop_battery_soc</span><span class="p">)</span><span class="w"></span>
<span class="w">					</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_NOT_READY</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">					</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_RUN</span><span class="p">;</span><span class="w"></span>
<span class="w">					</span><span class="n">again</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="p">}</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_TA_NOT_SUPPORT</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_TA_NOT_SUPPORT</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_RUN</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_TUNING</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_POSTCC</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pd_run</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">			</span><span class="n">pd_err</span><span class="p">(</span><span class="s">&quot;PD unknown state:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_INIT_FAIL</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">again</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret_value</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="pd">
<h1>PD充电程序流程<a class="headerlink" href="#pd" title="此标题的永久链接"></a></h1>
<section id="pd-run">
<h2>__pd_run具体流程<a class="headerlink" href="#pd-run" title="此标题的永久链接"></a></h2>
<p>__pd_run是PD充电的核心，主要是两个函数，一个是<code class="docutils literal notranslate"><span class="pre">__mtk_pdc_get_setting</span></code>获取当前适配器档位、最大最小电压、匹配最大功率信息，一个是<code class="docutils literal notranslate"><span class="pre">__mtk_pdc_setup</span></code>根据获取的电压阈值和最大功率信息去匹配档位信息，分析如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__pd_run</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_pd</span><span class="w"> </span><span class="o">*</span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">vbus</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_RUNNING</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__mtk_pdc_get_setting</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbus</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">__mtk_pdc_setup</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">input_current_limit1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">			</span><span class="n">PD_FAIL_CURRENT</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">charging_current_limit1</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">			</span><span class="n">PD_FAIL_CURRENT</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DUAL_CHARGERS_IN_SERIES</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd_dcs_set_charger</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="c1">//goto out;</span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd_sc_set_charger</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALG_DONE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="c1">//goto out;</span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret_value</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id8">
<h2>dts配置<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">M8</span><span class="p">.</span><span class="n">dts</span><span class="o">:</span><span class="w"></span>
<span class="o">&amp;</span><span class="n">pdc</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* single charger */</span><span class="w"></span>
<span class="w">        </span><span class="n">sc_input_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">sc_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">pd_stop_battery_soc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">pd_vbus_upper_bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">9000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">dcs_chg1_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">dcs_chg2_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="nl">mt6765</span><span class="p">:</span><span class="w"></span>
<span class="nl">dts</span><span class="p">:</span><span class="w"></span>
<span class="nl">pdc</span><span class="p">:</span><span class="w"> </span><span class="n">pdc</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mediatek,charger,pd&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">gauge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">mtk_gauge</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">min_charger_voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4600000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">pd_vbus_low_bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">5000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">pd_vbus_upper_bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">5000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">vsys_watt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">5000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">ibus_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">14</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">pd_stop_battery_soc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">80</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* single charger */</span><span class="w"></span>
<span class="w">		</span><span class="n">sc_input_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3200000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">sc_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* dual charger in series */</span><span class="w"></span>
<span class="w">		</span><span class="n">dcs_input_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3200000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">dcs_chg1_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1500000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">dcs_chg2_charger_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1500000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* dual charger */</span><span class="w"></span>
<span class="w">		</span><span class="n">dual_polling_ieoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">450000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">slave_mivr_diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">100000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">mt6370_pd</span><span class="p">.</span><span class="n">dtsi</span><span class="o">:</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nl">mt6370_typec</span><span class="p">:</span><span class="w"> </span><span class="n">type_c_port0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="cm">/* 0: dfp/ufp, 1: dfp, 2: ufp */</span><span class="w"></span>
<span class="w">                </span><span class="n">tcpc</span><span class="o">-</span><span class="n">dual</span><span class="p">,</span><span class="n">supported_modes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">mt</span><span class="o">-</span><span class="n">tcpc</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;type_c_port0&quot;</span><span class="p">;</span><span class="w"> </span><span class="cm">/* tcpc_device&#39;s name */</span><span class="w"></span>
<span class="w">                </span><span class="cm">/* 0: SNK Only, 1: SRC Only, 2: DRP, 3: Try.SRC, 4: Try.SNK */</span><span class="w"></span>
<span class="w">                </span><span class="n">mt</span><span class="o">-</span><span class="n">tcpc</span><span class="p">,</span><span class="n">role_def</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">mt</span><span class="o">-</span><span class="n">tcpc</span><span class="p">,</span><span class="n">rp_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 0: Default, 1: 1.5, 2: 3.0 */</span><span class="w"></span>
<span class="w">                </span><span class="cm">/* 0: Never, 1: Always, 2: EMarkOnly, 3: StartOnly */</span><span class="w"></span>
<span class="w">                </span><span class="n">mt</span><span class="o">-</span><span class="n">tcpc</span><span class="p">,</span><span class="n">vconn_supply</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">mt6370pd</span><span class="p">,</span><span class="n">intr_gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">pio</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mh">0x0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">mt6370pd</span><span class="p">,</span><span class="n">intr_gpio_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">24</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="n">pd</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">vid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x29cf</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x5081</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">source</span><span class="o">-</span><span class="n">cap</span><span class="o">-</span><span class="n">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x171129cf</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x00000102</span><span class="w"></span>
<span class="w">                                             </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x02000000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">mfrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;RichtekTCPC&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">                        </span><span class="cm">/*</span>
<span class="cm">                         *      VSAFE5V = 0, MAX_POWER = 1, CUSTOM = 2,</span>
<span class="cm">                         *      MAX_POWER_LV = 0x21, MAX_POWER_LVIC = 0x31</span>
<span class="cm">                         *      MAX_POWER_HV = 0x41, MAX_POWER_HVIC = 0x51</span>
<span class="cm">                         */</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">charging_policy</span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x41</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//PD策略</span>

<span class="w">                        </span><span class="cm">/*</span>
<span class="cm">                         * Fixed 5V, 500 mA &lt;0x00019032&gt;</span>
<span class="cm">                         * Fixed 5V, 1A &lt;0x00019064&gt;</span>
<span class="cm">                         * Fixed 5V, 2A &lt;0x000190c8&gt;</span>
<span class="cm">                         * Fixed 5V, 3A &lt;0x0001912c&gt;</span>
<span class="cm">                         * Fixed 9V, 500 mA &lt;0x0002d032&gt;</span>
<span class="cm">                         * Fixed 9V, 1A &lt;0x0002d064&gt;</span>
<span class="cm">                         * Fixed 9V, 2A &lt;0x0002d0c8&gt;</span>
<span class="cm">                         * Fixed 9V, 3A &lt;0x0002d12c&gt;</span>
<span class="cm">                         * Variable 5-9V, 1A &lt;0x8642d064&gt;</span>
<span class="cm">                         * Variable 5-9V, 2A &lt;0x8642d0c8&gt;</span>
<span class="cm">                         * Variable 5-9V, 3A &lt;0x8642d12c&gt;</span>
<span class="cm">                         * PPS 3V~5.9V, 3A &lt;0xC0761E3C&gt;</span>
<span class="cm">                         ***12v add by zhangwj@paxsz.com</span>
<span class="cm">                         * Fixed 12V, 2A &lt;0x0003c0c8&gt;</span>
<span class="cm">                         * Fixed 12V, 1.5A &lt;0x0003c096&gt;</span>
<span class="cm">                         * Fixed 12V, 1A &lt;0x0003c064&gt;</span>
<span class="cm">                         */</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">source</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//档位数量</span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">source</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00019032</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//放电时的档位支持，当充电宝</span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">sink</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">sink</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x000190c8</span><span class="w"> </span><span class="mh">0x0002d0c8</span><span class="w"> </span><span class="mh">0x0003c064</span><span class="w"> </span><span class="mh">0x0003c096</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//SINK时，也就是充电时的档位支持</span>

<span class="w">                        </span><span class="cm">/*</span>
<span class="cm">                         * No DP, host + device</span>
<span class="cm">                         *      pd,id-vdo-size = &lt;3&gt;;</span>
<span class="cm">                         *      pd,id-vdo-data = &lt;0xd10029cf 0x0 0x00010000&gt;;</span>
<span class="cm">                         * With DP</span>
<span class="cm">                         *      pd,id-vdo-size = &lt;4&gt;;</span>
<span class="cm">                         *      pd,id-vdo-data = &lt;0xed0029cf 0x0 0x00010000</span>
<span class="cm">                                                  0x11000001&gt;;</span>
<span class="cm">                         */</span><span class="w"></span>

<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">id</span><span class="o">-</span><span class="n">vdo</span><span class="o">-</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">id</span><span class="o">-</span><span class="n">vdo</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0xd10029cf</span><span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mh">0x00010000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">                        </span><span class="n">bat</span><span class="p">,</span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">pd</span><span class="p">,</span><span class="n">country_nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">                        </span><span class="n">bat</span><span class="o">-</span><span class="n">info0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="n">bat</span><span class="p">,</span><span class="n">vid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x29cf</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                                </span><span class="n">bat</span><span class="p">,</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x1711</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                                </span><span class="n">bat</span><span class="p">,</span><span class="n">mfrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bat1&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                                </span><span class="n">bat</span><span class="p">,</span><span class="n">design_cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3000</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">};</span><span class="w"></span>

<span class="w">                        </span><span class="c1">//bat-info1 {</span>
<span class="w">                        </span><span class="c1">//      bat,vid = &lt;0x8abc&gt;;</span>
<span class="w">                        </span><span class="c1">//      bat,pid = &lt;0x5234&gt;;</span>
<span class="w">                        </span><span class="c1">//      bat,mfrs = &quot;bat2&quot;;</span>
<span class="w">                        </span><span class="c1">//      bat,design_cap = &lt;4000&gt;;</span>
<span class="w">                        </span><span class="c1">//};</span>

<span class="w">                        </span><span class="c1">//country0 {</span>
<span class="w">                        </span><span class="c1">//      pd,country_code = &lt;0x5457&gt;;</span>
<span class="w">                        </span><span class="c1">//      pd,country_len = &lt;2&gt;; /* max len = 26 */</span>
<span class="w">                        </span><span class="c1">//      pd,country_data = &lt;0xff 0xff&gt;;</span>
<span class="w">                        </span><span class="c1">//};</span>

<span class="w">                        </span><span class="c1">//country1 {</span>
<span class="w">                        </span><span class="c1">//      pd,country_code = &lt;0x5553&gt;;</span>
<span class="w">                        </span><span class="c1">//      pd,country_len = &lt;3&gt;; /* max len = 26 */</span>
<span class="w">                        </span><span class="c1">//      pd,country_data = &lt;0xf1 0xf2 0xf3&gt;;</span>
<span class="w">                        </span><span class="c1">//};</span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="n">dpm_caps</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">local_dr_power</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">local_dr_data</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="c1">//local_ext_power;</span>
<span class="w">                        </span><span class="n">local_usb_comm</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="c1">//local_usb_suspend;</span>
<span class="w">                        </span><span class="c1">//local_high_cap;</span>
<span class="w">                        </span><span class="c1">//local_give_back;</span>
<span class="w">                        </span><span class="n">local_no_suspend</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">local_vconn_supply</span><span class="p">;</span><span class="w"></span>

<span class="w">                        </span><span class="c1">//attemp_discover_cable_dfp;</span>
<span class="w">                        </span><span class="n">attemp_enter_dp_mode</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">attemp_discover_cable</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">attemp_discover_id</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="cm">/* 0: disable, 1: prefer_snk, 2: prefer_src */</span><span class="w"></span>
<span class="w">                        </span><span class="n">pr_check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="c1">//pr_reject_as_source;</span>
<span class="w">                        </span><span class="c1">//pr_reject_as_sink;</span>
<span class="w">                        </span><span class="n">pr_check_gp_source</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="c1">//pr_check_gp_sink;</span>

<span class="w">                        </span><span class="cm">/* 0: disable, 1: prefer_ufp, 2: prefer_dfp */</span><span class="w"></span>
<span class="w">                        </span><span class="n">dr_check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="c1">//dr_reject_as_dfp;</span>
<span class="w">                        </span><span class="c1">//dr_reject_as_ufp;</span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<section id="id9">
<h3>PD策略介绍<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<p>根据dts，pd策略及档位配置主要为以下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">	</span><span class="cm">/*</span>
<span class="cm">		*      VSAFE5V = 0, MAX_POWER = 1, CUSTOM = 2,</span>
<span class="cm">		*      MAX_POWER_LV = 0x21, MAX_POWER_LVIC = 0x31</span>
<span class="cm">		*      MAX_POWER_HV = 0x41, MAX_POWER_HVIC = 0x51</span>
<span class="cm">		*/</span><span class="w"></span>
<span class="w">	</span><span class="n">pd</span><span class="p">,</span><span class="n">charging_policy</span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x41</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//PD策略</span>

<span class="w">	</span><span class="cm">/*</span>
<span class="cm">		* Fixed 5V, 500 mA &lt;0x00019032&gt;</span>
<span class="cm">		* Fixed 5V, 1A &lt;0x00019064&gt;</span>
<span class="cm">		* Fixed 5V, 2A &lt;0x000190c8&gt;</span>
<span class="cm">		* Fixed 5V, 3A &lt;0x0001912c&gt;</span>
<span class="cm">		* Fixed 9V, 500 mA &lt;0x0002d032&gt;</span>
<span class="cm">		* Fixed 9V, 1A &lt;0x0002d064&gt;</span>
<span class="cm">		* Fixed 9V, 2A &lt;0x0002d0c8&gt;</span>
<span class="cm">		* Fixed 9V, 3A &lt;0x0002d12c&gt;</span>
<span class="cm">		* Variable 5-9V, 1A &lt;0x8642d064&gt;</span>
<span class="cm">		* Variable 5-9V, 2A &lt;0x8642d0c8&gt;</span>
<span class="cm">		* Variable 5-9V, 3A &lt;0x8642d12c&gt;</span>
<span class="cm">		* PPS 3V~5.9V, 3A &lt;0xC0761E3C&gt;</span>
<span class="cm">		***12v add by zhangwj@paxsz.com</span>
<span class="cm">		* Fixed 12V, 2A &lt;0x0003c0c8&gt;</span>
<span class="cm">		* Fixed 12V, 1.5A &lt;0x0003c096&gt;</span>
<span class="cm">		* Fixed 12V, 1A &lt;0x0003c064&gt;</span>
<span class="cm">		*/</span><span class="w"></span>
<span class="w">	</span><span class="n">pd</span><span class="p">,</span><span class="n">source</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//档位数量</span>
<span class="w">	</span><span class="n">pd</span><span class="p">,</span><span class="n">source</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00019032</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//放电时的档位支持，当充电宝</span>
<span class="w">	</span><span class="n">pd</span><span class="p">,</span><span class="n">sink</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">pd</span><span class="p">,</span><span class="n">sink</span><span class="o">-</span><span class="n">pdo</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x000190c8</span><span class="w"> </span><span class="mh">0x0002d0c8</span><span class="w"> </span><span class="mh">0x0003c064</span><span class="w"> </span><span class="mh">0x0003c096</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//SINK时，也就是充电时的档位支持</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pd,charging_policy</span></code>解释如下，以下是所有充电策略：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">dpm_charging_policy</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* VSafe5V only */</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_VSAFE5V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Max Power */</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Custom defined Policy */</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_CUSTOM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="cm">/*  Runtime Policy, restore to default after plug-out or hard-reset */</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_RUNTIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Direct charge &lt;Variable PDO only&gt; */</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_DIRECT_CHARGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* PPS &lt;Augmented PDO only&gt; */</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_PPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* Default Charging Policy &lt;from DTS&gt;*/</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_IGNORE_MISMATCH_CURR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_PREFER_LOW_VOLTAGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_PREFER_HIGH_VOLTAGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER_LV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">//选最大功率，低电压</span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_PREFER_LOW_VOLTAGE</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER_LVIC</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="c1">//选最大功率，低电压，忽略不匹配的电流</span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER_LV</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_IGNORE_MISMATCH_CURR</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER_HV</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="c1">//选最大功率，高电压</span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_PREFER_HIGH_VOLTAGE</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER_HVIC</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="c1">//选最大功率，高电压，忽略不匹配的电流</span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_MAX_POWER_HV</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_IGNORE_MISMATCH_CURR</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* DPM_CHARGING_POLICY_PPS */</span><span class="w"></span>

<span class="w">	</span><span class="n">DPM_CHARGING_POLICY_PPS_IC</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_PPS</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">		</span><span class="n">DPM_CHARGING_POLICY_IGNORE_MISMATCH_CURR</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="mtk-pdc-get-setting">
<h2>__mtk_pdc_get_setting函数<a class="headerlink" href="#mtk-pdc-get-setting" title="此标题的永久链接"></a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>int __mtk_pdc_get_setting(struct chg_alg_device *alg, int *newvbus, int *newcur,
			int *newidx)
{
	int ret = 0;
	int idx, selected_idx;
	unsigned int pd_max_watt, pd_min_watt, now_max_watt;
	struct mtk_pd *pd = dev_get_drvdata(&amp;alg-&gt;dev);
	int ibus = 0, vbus;
	int chg2_watt = 0;
	bool boost = false, buck = false;
	struct pd_power_cap *cap;
	unsigned int mivr1 = 0;
	unsigned int mivr2 = 0;
	bool chg1_mivr = false;
	bool chg2_mivr = false;
	int chg_cnt, i, is_chip_enabled;
	//FEATURE-BEGIN by shanliangliang@paxsz.com, 2021/07/22
	int uisoc;
	//FEATURE-END by shanliangliang@paxsz.com, 2021/07/22


	__mtk_pdc_init_table(alg);
	__mtk_pdc_get_reset_idx(alg);
	__mtk_pdc_get_cap_max_watt(alg);

	cap = &amp;pd-&gt;cap;

	if (cap-&gt;nr == 0)
		return -1;

打印：
05-27 14:28:04.062287 &lt;6&gt;[10054.723373]  (6)[304:charger_thread]mt6370_pmu_charger mt6370_pmu_charger: mt6370_get_ibus: ibus = 1850mA
05-27 14:28:04.062625 &lt;5&gt;[10054.723711]  (6)[304:charger_thread]psy_chr_type_get_property: prop:12
05-27 14:28:04.062961 &lt;5&gt;[10054.724047]  (6)[304:charger_thread]get_pmic_vbus vbus:4598
	ret = pd_hal_get_ibus(alg, &amp;ibus);
	if (ret &lt; 0) {
		pd_err(&quot;[%s] get ibus fail, keep default voltage\n&quot;, __func__);
		return -1;
	}

#ifdef FIXME //不跑
	if (info-&gt;data.parallel_vbus) {
		ret = charger_dev_get_ibat(info-&gt;chg1_dev, &amp;chg1_ibat);
		if (ret &lt; 0)
			pd_err(&quot;[%s] get ibat fail\n&quot;, __func__);

		ret = charger_dev_get_ibat(info-&gt;chg2_dev, &amp;chg2_ibat);
		if (ret &lt; 0) {
			ibat = battery_get_bat_current();
			chg2_ibat = ibat * 100 - chg1_ibat;
		}

		if (ibat &lt; 0 || chg2_ibat &lt; 0)
			chg2_watt = 0;
		else
			chg2_watt = chg2_ibat / 1000 * battery_get_bat_voltage()
					/ info-&gt;data.chg2_eff * 100;

		pd_err(&quot;[%s] chg2_watt:%d ibat2:%d ibat1:%d ibat:%d\n&quot;,
			__func__, chg2_watt, chg2_ibat, chg1_ibat, ibat * 100);
	}
#endif

	pd_hal_get_mivr_state(alg, CHG1, &amp;chg1_mivr);
	pd_hal_get_mivr(alg, CHG1, &amp;mivr1);

	chg_cnt = pd_hal_get_charger_cnt(alg);
	if (chg_cnt &gt; 1 &amp;&amp; alg-&gt;config == DUAL_CHARGERS_IN_SERIES) {
		for (i = CHG2; i &lt; CHG_MAX; i++) {
			is_chip_enabled =
					pd_hal_is_chip_enable(alg, i);
			if (is_chip_enabled) {
				pd_hal_get_mivr_state(alg, CHG2, &amp;chg2_mivr);
				pd_hal_get_mivr(alg, CHG2, &amp;mivr2);
			}

		}
	}

	vbus = pd_hal_get_vbus(alg);
	ibus = ibus / 1000;
	if (ibus == 0)
		ibus = 1000;

	if ((chg1_mivr &amp;&amp; (vbus &lt; mivr1 / 1000 - 500)) ||
	    (chg2_mivr &amp;&amp; (vbus &lt; mivr2 / 1000 - 500)))
		goto reset;

	selected_idx = cap-&gt;selected_cap_idx;
	idx = selected_idx;

	if (idx &lt; 0 || idx &gt;= PD_CAP_MAX_NR)
		idx = selected_idx = 0;

	pd_err(&quot;idx:%d %d %d %d %d %d\n&quot;, idx,
		cap-&gt;max_mv[idx],
		cap-&gt;ma[idx],
		cap-&gt;maxwatt[idx],
		pd-&gt;ibus_err,
		ibus);

	pd_max_watt = cap-&gt;max_mv[idx] * (cap-&gt;ma[idx]
			/ 100 * (100 - pd-&gt;ibus_err) - 100);

	pd_dbg(&quot;pd_max_watt:%d %d %d %d %d\n&quot;, idx,
		cap-&gt;max_mv[idx],
		cap-&gt;ma[idx],
		pd-&gt;ibus_err,
		pd_max_watt);


	now_max_watt = cap-&gt;max_mv[idx] * ibus + chg2_watt;
	pd_dbg(&quot;now_max_watt:%d %d %d %d %d\n&quot;, idx,
		cap-&gt;max_mv[idx],
		ibus,
		chg2_watt,
		now_max_watt);

	pd_min_watt = cap-&gt;max_mv[pd-&gt;pd_buck_idx] * cap-&gt;ma[pd-&gt;pd_buck_idx]
			/ 100 * (100 - pd-&gt;ibus_err)
			- pd-&gt;vsys_watt;

	pd_dbg(&quot;pd_min_watt:%d %d %d %d %d\n&quot;, pd-&gt;pd_buck_idx,
		cap-&gt;max_mv[pd-&gt;pd_buck_idx],
		cap-&gt;ma[pd-&gt;pd_buck_idx],
		pd-&gt;ibus_err,
		pd-&gt;vsys_watt);

	if (pd_min_watt &lt;= 5000000)
		pd_min_watt = 5000000;

	//FEATURE-BEGIN by shanliangliang@paxsz.com, 2021/07/22
	uisoc = pd_hal_get_uisoc(alg);

	if ((now_max_watt &gt;= pd_max_watt) || chg1_mivr || chg2_mivr || (uisoc &lt;= pd-&gt;pd_stop_battery_soc)) {
	//FEATURE-END by shanliangliang@paxsz.com, 2021/07/22
		*newidx = pd-&gt;pd_boost_idx;
		boost = true;
	} else if (now_max_watt &lt;= pd_min_watt) {
		*newidx = pd-&gt;pd_buck_idx;
		buck = true;
	} else {
		*newidx = selected_idx;
		boost = false;
		buck = false;
	}

	*newvbus = cap-&gt;max_mv[*newidx];
	*newcur = cap-&gt;ma[*newidx];

打印：
05-27 14:28:14.154637 &lt;5&gt;[10064.815726]  (4)[304:charger_thread][__mtk_pdc_get_setting]watt:14580000,16200000,7900000 up:1,0 vbus:8515000 ibus:1800, mivr:0,0
05-27 14:28:14.154666 &lt;5&gt;[10064.815755]  (4)[304:charger_thread][__mtk_pdc_get_setting]vbus:9000:5000:9000 current:2000 idx:1 default_idx:1
得知vbus_h vbus_l等参数

	pd_err(&quot;[%s]watt:%d,%d,%d up:%d,%d vbus:%d ibus:%d, mivr:%d,%d\n&quot;,
		__func__,
		pd_max_watt, now_max_watt, pd_min_watt,
		boost, buck,
		vbus, ibus, chg1_mivr, chg2_mivr);

	pd_err(&quot;[%s]vbus:%d:%d:%d current:%d idx:%d default_idx:%d\n&quot;,
		__func__, pd-&gt;vbus_h, pd-&gt;vbus_l, *newvbus,
		*newcur, *newidx, selected_idx);

	return 0;

reset:
	mtk_pdc_reset(alg);
	*newidx = pd-&gt;pd_reset_idx;
	*newvbus = cap-&gt;max_mv[*newidx];
	*newcur = cap-&gt;ma[*newidx];

	return 0;
}
</pre></div>
</div>
<section id="mtk-pdc-init-tablecap">
<h3>1.__mtk_pdc_init_table获取适配器cap供电能力<a class="headerlink" href="#mtk-pdc-init-tablecap" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>程序流程如下：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">__pd_run</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">__mtk_pdc_get_setting</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbus</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">__mtk_pdc_init_table</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd_hal_is_pd_adapter_ready</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALG_READY</span><span class="p">)</span><span class="w"></span>
<span class="w">	    </span><span class="o">*</span><span class="w"> </span><span class="n">pd_hal_get_adapter_cap</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span><span class="w"></span>
<span class="w">		  </span><span class="o">*</span><span class="w"> </span><span class="n">hal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chg_alg_dev_get_drv_hal_data</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"></span>
<span class="w">		  </span><span class="o">*</span><span class="w"> </span><span class="n">adapter_dev_get_cap</span><span class="p">(</span><span class="n">hal</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">MTK_PD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">acap</span><span class="p">);</span><span class="w"> </span><span class="c1">//mtk_pd_hal.c</span>
<span class="w">		    </span><span class="o">*</span><span class="w"> </span><span class="n">adapter_dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_cap</span><span class="p">(</span><span class="n">adapter_dev</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">cap</span><span class="p">);</span><span class="w"></span>
<span class="w">			  </span><span class="o">*</span><span class="w"> </span><span class="n">adapter_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">get_cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_get_cap</span><span class="p">,}</span><span class="w"> </span><span class="c1">//mtk_pd_adapter.c</span>
<span class="w">			    </span><span class="o">*</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD_APDO</span><span class="p">)</span><span class="w"> </span><span class="c1">//PPS协议</span>
<span class="w">				  </span><span class="o">*</span><span class="w"> </span><span class="n">tcpm_inquire_pd_source_apdo</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="n">TCPM_POWER_CAP_APDO_TYPE_PPS</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cap_i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">apdo_cap</span><span class="p">);</span><span class="w"></span>
<span class="w">				  </span><span class="o">*</span><span class="w"> </span><span class="n">tcpm_dpm_pd_get_source_cap_ext</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cap_ext</span><span class="p">);</span><span class="w"> </span><span class="c1">//获取适配器供电能力 tcpm.c</span>
<span class="w">				</span><span class="o">*</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD</span><span class="p">)</span><span class="w"></span>
<span class="w">				  </span><span class="o">*</span><span class="w"> </span><span class="n">pd_cap</span><span class="p">.</span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">				  </span><span class="o">*</span><span class="w"> </span><span class="n">pd_cap</span><span class="p">.</span><span class="n">selected_cap_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">//首先初始化档位选为0档</span>
<span class="w">				  </span><span class="o">*</span><span class="w"> </span><span class="n">tcpm_get_remote_power_cap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pd_cap</span><span class="p">);</span><span class="w"> </span><span class="c1">//获取适配器cap档位 tcpm.c</span>
<span class="w">				    </span><span class="o">*</span><span class="w"> </span><span class="n">remote_cap</span><span class="o">-&gt;</span><span class="n">selected_cap_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_dev</span><span class="o">-&gt;</span><span class="n">pd_port</span><span class="p">.</span><span class="n">pe_data</span><span class="p">.</span><span class="n">remote_selected_cap</span><span class="p">;</span><span class="w"> </span><span class="c1">//获取远端档位 </span>
<span class="w">					</span><span class="o">*</span><span class="w"> </span><span class="n">remote_cap</span><span class="o">-&gt;</span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_dev</span><span class="o">-&gt;</span><span class="n">pd_port</span><span class="p">.</span><span class="n">pe_data</span><span class="p">.</span><span class="n">remote_src_cap</span><span class="p">.</span><span class="n">nr</span><span class="p">;</span><span class="w"></span>
<span class="w">					</span><span class="o">*</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">remote_cap</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">					  </span><span class="o">*</span><span class="w"> </span><span class="n">tcpm_extract_power_cap_val</span><span class="p">(</span><span class="n">tcpc_dev</span><span class="o">-&gt;</span><span class="n">pd_port</span><span class="p">.</span><span class="n">pe_data</span><span class="p">.</span><span class="n">remote_src_cap</span><span class="p">.</span><span class="n">pdos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span><span class="w"></span>
<span class="w">					    </span><span class="o">*</span><span class="w"> </span><span class="n">dpm_extract_pdo_info</span><span class="p">(</span><span class="n">pdo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span><span class="w"></span>
<span class="w">					  </span><span class="o">*</span><span class="w"> </span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">;</span><span class="w"></span>
<span class="w">					  </span><span class="o">*</span><span class="w"> </span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">min_mv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">vmin</span><span class="p">;</span><span class="w"></span>
<span class="w">					  </span><span class="o">*</span><span class="w"> </span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">max_mv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">vmax</span><span class="p">;</span><span class="w"></span>
<span class="w">		  </span><span class="o">*</span><span class="w"> </span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">selected_cap_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acap</span><span class="p">.</span><span class="n">selected_cap_idx</span><span class="p">;</span><span class="w"></span>
<span class="w">		  </span><span class="o">*</span><span class="w"> </span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acap</span><span class="p">.</span><span class="n">nr</span><span class="p">;</span><span class="w"> </span>
</pre></div>
</div>
<p>对应代码及打印如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>mtk_pd_hal.c:
int pd_hal_get_adapter_cap(struct chg_alg_device *alg, struct pd_power_cap *cap)
{
	struct mtk_pd *pd;
	struct pd_hal *hal;
	struct adapter_power_cap acap = {0};
	int i, ret;

	if (alg == NULL) {
		pr_notice(&quot;%s: alg is null\n&quot;, __func__);
		return -EINVAL;
	}

	pd = dev_get_drvdata(&amp;alg-&gt;dev);
	hal = chg_alg_dev_get_drv_hal_data(alg);

	ret = adapter_dev_get_cap(hal-&gt;adapter, MTK_PD, &amp;acap);
	cap-&gt;selected_cap_idx = acap.selected_cap_idx;
	cap-&gt;nr = acap.nr;
	cap-&gt;pdp = acap.pdp;
	for (i = 0; i &lt; 10; i++) {
		cap-&gt;pwr_limit[i] = acap.pwr_limit[i];
		cap-&gt;min_mv[i] = acap.min_mv[i];
		cap-&gt;max_mv[i] = acap.max_mv[i];
		cap-&gt;ma[i] = acap.ma[i];
		cap-&gt;maxwatt[i] = acap.maxwatt[i];
		cap-&gt;minwatt[i] = acap.minwatt[i];
		cap-&gt;type[i] = acap.type[i];
		cap-&gt;info[i] = acap.info[i];
	}
	return ret;
}

pd_get_cap打印：
05-27 14:28:04.016849 &lt;5&gt;[10054.677935]  (6)[304:charger_thread][pd_get_cap] nr:3 idx:0
05-27 14:28:04.016866 &lt;5&gt;[10054.677952]  (6)[304:charger_thread]adapter cap: nr:3
05-27 14:28:04.016886 &lt;5&gt;[10054.677972]  (6)[304:charger_thread][pd_get_cap]:0 mv:[5000,5000] mA:3000 type:0 0
05-27 14:28:04.016906 &lt;5&gt;[10054.677992]  (6)[304:charger_thread][pd_get_cap]:1 mv:[9000,9000] mA:2000 type:0 0
05-27 14:28:04.016926 &lt;5&gt;[10054.678012]  (6)[304:charger_thread][pd_get_cap]:2 mv:[12000,12000] mA:1500 type:0 0
05-27 14:28:04.016942 &lt;5&gt;[10054.678028]  (6)[304:charger_thread]pd cap: nr:3
05-27 14:28:04.016965 &lt;5&gt;[10054.678051]  (6)[304:charger_thread][pd_get_cap]:0 mv:[5000,5000] mA:3000 max:15000000 min:15000000 type:2 2
05-27 14:28:04.016987 &lt;5&gt;[10054.678073]  (6)[304:charger_thread][pd_get_cap]:1 mv:[9000,9000] mA:2000 max:18000000 min:18000000 type:2 2
05-27 14:28:04.017009 &lt;5&gt;[10054.678095]  (6)[304:charger_thread][pd_get_cap]:2 mv:[12000,12000] mA:1500 max:18000000 min:18000000 type:2 2
05-27 14:28:04.017028 &lt;5&gt;[10054.678114]  (6)[304:charger_thread][__mtk_pdc_init_table] nr:3 default:0
</pre></div>
</div>
<p>可以看到支持三个档位<code class="docutils literal notranslate"><span class="pre">5v/3a</span></code>、<code class="docutils literal notranslate"><span class="pre">9v/2a</span></code>、<code class="docutils literal notranslate"><span class="pre">12v/1,5a</span></code>，最大功率18w，最小功率15w，首先初始化档位选为0档。</p>
</section>
<section id="mtk-pdc-get-reset-idx-dts">
<h3>2.__mtk_pdc_get_reset_idx获取最大最小电压(dts指定)<a class="headerlink" href="#mtk-pdc-get-reset-idx-dts" title="此标题的永久链接"></a></h3>
<p>根据判断条件，貌似没啥用。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>probe:
if (of_property_read_u32(np, &quot;pd_vbus_low_bound&quot;, &amp;val) &gt;= 0) {
	pd-&gt;vbus_l = val / 1000;
} else {
	pd_err(&quot;use default pd_vbus_low_bound:%d\n&quot;,
		PD_VBUS_LOW_BOUND);
	pd-&gt;vbus_l = PD_VBUS_LOW_BOUND / 1000;
}

void __mtk_pdc_get_reset_idx(struct chg_alg_device *alg)
{
	struct mtk_pd *pd = dev_get_drvdata(&amp;alg-&gt;dev);
	struct pd_power_cap *cap;
	int i = 0;
	int idx = 0;

	cap = &amp;pd-&gt;cap;

	if (pd-&gt;pd_reset_idx == -1) {
		for (i = 0; i &lt; cap-&gt;nr; i++) {

			if (cap-&gt;min_mv[i] &lt; pd-&gt;vbus_l ||
				cap-&gt;max_mv[i] &lt; pd-&gt;vbus_l ||
				cap-&gt;min_mv[i] &gt; pd-&gt;vbus_l ||
				cap-&gt;max_mv[i] &gt; pd-&gt;vbus_l) {
				continue;
			}
			idx = i;
		}
		pd-&gt;pd_reset_idx = idx;
		pd_err(&quot;[%s]reset idx:%d vbus:%d %d\n&quot;, __func__,
			idx, cap-&gt;min_mv[idx], cap-&gt;max_mv[idx]);
	}
}

打印：
[__mtk_pdc_get_reset_idx]reset idx:0 vbus:5000 5000
</pre></div>
</div>
</section>
<section id="mtk-pdc-get-cap-max-watt">
<h3>3.__mtk_pdc_get_cap_max_watt获取最大功率<a class="headerlink" href="#mtk-pdc-get-cap-max-watt" title="此标题的永久链接"></a></h3>
<p>主要是根据dts中设置的最大电压来匹配档位，比如dts中设置的<code class="docutils literal notranslate"><span class="pre">pd_vbus_upper_bound</span></code>是9v，在<code class="docutils literal notranslate"><span class="pre">vbus_l</span></code>和<code class="docutils literal notranslate"><span class="pre">vbus_h</span></code>范围内选择最大功率，<code class="docutils literal notranslate"><span class="pre">pd_cap_max_watt</span></code>将选择9v档位，代码如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>void __mtk_pdc_get_cap_max_watt(struct chg_alg_device *alg)
{
	struct mtk_pd *pd = dev_get_drvdata(&amp;alg-&gt;dev);
	struct pd_power_cap *cap;
	int i = 0;
	int idx = 0;

	cap = &amp;pd-&gt;cap;

	if (pd-&gt;pd_cap_max_watt == -1) {
		for (i = 0; i &lt; cap-&gt;nr; i++) {
			if (cap-&gt;min_mv[i] &lt;= pd-&gt;vbus_h &amp;&amp;
				cap-&gt;min_mv[i] &gt;= pd-&gt;vbus_l &amp;&amp;
				cap-&gt;max_mv[i] &lt;= pd-&gt;vbus_h &amp;&amp;
				cap-&gt;max_mv[i] &gt;= pd-&gt;vbus_l) {

				if (cap-&gt;maxwatt[i] &gt; pd-&gt;pd_cap_max_watt) {
					pd-&gt;pd_cap_max_watt = cap-&gt;maxwatt[i];
					idx = i;
				}
				pd_err(&quot;%d %d %d %d %d %d\n&quot;,
					cap-&gt;min_mv[i],
					cap-&gt;max_mv[i],
					pd-&gt;vbus_h,
					pd-&gt;vbus_l,
					cap-&gt;maxwatt[i],
					pd-&gt;pd_cap_max_watt);
				continue;
			}
		}
		pd_err(&quot;[%s]idx:%d vbus:%d %d maxwatt:%d\n&quot;, __func__,
			idx, cap-&gt;min_mv[idx], cap-&gt;max_mv[idx],
			pd-&gt;pd_cap_max_watt);
	}
}

打印：
这里选的是9v2a档位。
05-27 14:28:04.017106 &lt;5&gt;[10054.678192]  (6)[304:charger_thread][__mtk_pdc_get_cap_max_watt]idx:1 vbus:9000 9000 maxwatt:18000000
</pre></div>
</div>
</section>
</section>
<section id="mtk-pdc-setup">
<h2>__mtk_pdc_setup函数<a class="headerlink" href="#mtk-pdc-setup" title="此标题的永久链接"></a></h2>
<p>有一点非常重要，如果pd选择的档位电压大于5v，需要关闭ovp，不然升不上去，程序流程如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">__mtk_pdc_setup</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">chg_alg_device</span><span class="w"> </span><span class="o">*</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-100</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mivr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">oldmivr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4600000</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">oldmA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3000000</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">force_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">chg_cnt</span><span class="p">,</span><span class="w"> </span><span class="n">is_chip_enabled</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">mtk_pd</span><span class="w"> </span><span class="o">*</span><span class="n">pd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pd_hal_get_mivr</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldmivr</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">oldmivr</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">			</span><span class="n">PD_VBUS_IR_DROP_THRESHOLD</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">force_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">		</span><span class="n">chg_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_hal_get_charger_cnt</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span><span class="w"> </span><span class="c1">//获取charger个数，目前只有1个，下面不跑</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chg_cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DUAL_CHARGERS_IN_SERIES</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHG2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CHG_MAX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">is_chip_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">						</span><span class="n">pd_hal_is_chip_enable</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_chip_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">					</span><span class="n">pd_hal_get_mivr</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldmivr</span><span class="p">);</span><span class="w"></span>

<span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">oldmivr</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="w">						</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PD_VBUS_IR_DROP_THRESHOLD</span><span class="w"> </span><span class="o">-</span><span class="w"></span>
<span class="w">						</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">slave_mivr_diff</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">						</span><span class="n">force_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">				</span><span class="p">}</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">force_update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">pd_hal_enable_vbus_ovp</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"> </span><span class="c1">//如果pd选择的档位电压大于5v，则关闭ovp报警</span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="n">pd_hal_enable_vbus_ovp</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">pd_hal_get_mivr</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldmivr</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">mivr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">min_charger_voltage</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">pd_hal_set_mivr</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">min_charger_voltage</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置mivr</span>

<span class="w">		</span><span class="n">pd_hal_get_input_current</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldmA</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">oldmA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldmA</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>

<span class="cp">#ifdef FIXME</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parallel_vbus</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg2_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parallel_vbus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">			</span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span><span class="w"></span>
<span class="w">			</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"></span>
<span class="w">			</span><span class="n">pd_hal_set_input_current</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd_hal_set_adapter_cap</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span><span class="w"></span>
<span class="w">		  </span><span class="o">*</span><span class="w"> </span><span class="n">adapter_dev_set_cap</span><span class="p">(</span><span class="n">hal</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">MTK_PD</span><span class="p">,</span><span class="w"> </span><span class="n">mV</span><span class="p">,</span><span class="w"> </span><span class="n">mA</span><span class="p">);</span><span class="w"> </span><span class="c1">//mtk_pd_hal.c</span>
<span class="w">		    </span><span class="o">*</span><span class="w"> </span><span class="n">pd_set_cap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">adapter_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">adapter_cap_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="c1">//mtk_pd_adapter.c //设置cap档位</span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//设置档位成功</span>
<span class="cp">#ifdef FIXME</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parallel_vbus</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">				</span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg2_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parallel_vbus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">				</span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span><span class="w"></span>
<span class="w">				</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"></span>
<span class="w">				</span><span class="n">pd_hal_set_input_current</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置档位电流</span>
<span class="w">				  </span><span class="o">*</span><span class="w"> </span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">hal</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"> </span><span class="n">ua</span><span class="p">);</span><span class="w"></span>
<span class="w">				    </span><span class="o">*</span><span class="w"> </span><span class="n">mt6370_set_aicr</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">charger_device</span><span class="w"> </span><span class="o">*</span><span class="n">chg_dev</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">uA</span><span class="p">)</span><span class="w"></span>
<span class="w">					  </span><span class="o">*</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__mt6370_set_aicr</span><span class="p">(</span><span class="n">chg_data</span><span class="p">,</span><span class="w"> </span><span class="n">uA</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span>

<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PD_VBUS_IR_DROP_THRESHOLD</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mivr</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="n">mivr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"></span>
<span class="w">					</span><span class="n">PD_VBUS_IR_DROP_THRESHOLD</span><span class="p">;</span><span class="w"></span>

<span class="w">			</span><span class="n">pd_hal_set_mivr</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"> </span><span class="n">mivr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置mivr</span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#ifdef FIXME</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parallel_vbus</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">				</span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">oldmA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg2_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">oldmA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parallel_vbus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">				</span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span><span class="w"></span>
<span class="w">				</span><span class="n">charger_dev_set_input_current</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chg1_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">oldmA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldmA</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"></span>
<span class="w">				</span><span class="n">pd_hal_set_input_current</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">oldmA</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>

<span class="w">			</span><span class="n">pd_hal_set_mivr</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">CHG1</span><span class="p">,</span><span class="w"> </span><span class="n">oldmivr</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">__mtk_pdc_get_idx</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_boost_idx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_buck_idx</span><span class="p">);</span><span class="w"> </span><span class="c1">//获取档位，重要</span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">pd_err</span><span class="p">(</span><span class="s">&quot;[%s]idx:%d:%d:%d:%d vbus:%d cur:%d ret:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_boost_idx</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_buck_idx</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<section id="mtk-pdc-get-idx">
<h3>1.__mtk_pdc_get_idx匹配最大档位<a class="headerlink" href="#mtk-pdc-get-idx" title="此标题的永久链接"></a></h3>
<p>如果是第一次设置档位，在<code class="docutils literal notranslate"><span class="pre">_pd_init_algo</span></code>函数中，初始化各种参数都为0，我们来看一下获取档位算法：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>static int _pd_init_algo(struct chg_alg_device *alg)
{
	pd-&gt;pdc_max_watt_setting = -1;

	pd-&gt;check_impedance = true;
	pd-&gt;pd_cap_max_watt = -1;
	pd-&gt;pd_idx = -1;
	pd-&gt;pd_reset_idx = -1;
	pd-&gt;pd_boost_idx = 0; //重要，为什么第一次设置5v3a就是这里
	pd-&gt;pd_buck_idx = 0;	
}

调用__mtk_pdc_get_idx(alg, idx,&amp;pd-&gt;pd_boost_idx, &amp;pd-&gt;pd_buck_idx);

int __mtk_pdc_get_idx(struct chg_alg_device *alg, int selected_idx,
	int *boost_idx, int *buck_idx)
{
	struct mtk_pd *pd = dev_get_drvdata(&amp;alg-&gt;dev);
	struct pd_power_cap *cap;
	int i = 0;
	int idx = 0;

	cap = &amp;pd-&gt;cap;
	idx = selected_idx;

	if (idx &lt; 0) { //不跑
		pd_err(&quot;[%s] invalid idx:%d\n&quot;, __func__, idx);
		*boost_idx = 0;
		*buck_idx = 0;
		return -1;
	}

05-27 14:28:09.065850 &lt;5&gt;[10059.726936]  (6)[304:charger_thread][pd_get_cap]:0 mv:[5000,5000] mA:3000 type:0 0
05-27 14:28:09.065924 &lt;5&gt;[10059.727010]  (6)[304:charger_thread][pd_get_cap]:1 mv:[9000,9000] mA:2000 type:0 0
05-27 14:28:09.065989 &lt;5&gt;[10059.727075]  (6)[304:charger_thread][pd_get_cap]:2 mv:[12000,12000] mA:1500 type:0 0
vbus_l = 5000
vbus_h = 9000

	/* get boost_idx */
	for (i = 0; i &lt; cap-&gt;nr; i++) {

		if (cap-&gt;min_mv[i] &lt; pd-&gt;vbus_l ||
			cap-&gt;max_mv[i] &lt; pd-&gt;vbus_l) {
			pd_err(&quot;min_mv error:%d %d %d\n&quot;,
					cap-&gt;min_mv[i],
					cap-&gt;max_mv[i],
					pd-&gt;vbus_l);
			continue;
		}

根据打印：[304:charger_thread]max_mv error:12000 12000 9000
可以得知此时i = 2 mv:[12000,12000] mA:1500，则直接continue不跑了，所以idx还是等于上次的i = 1
		if (cap-&gt;min_mv[i] &gt; pd-&gt;vbus_h ||
			cap-&gt;max_mv[i] &gt; pd-&gt;vbus_h) {
			pd_err(&quot;max_mv error:%d %d %d\n&quot;,
					cap-&gt;min_mv[i],
					cap-&gt;max_mv[i],
					pd-&gt;vbus_h);
			continue;
		}

		if (idx == selected_idx) {
			if (cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[idx]) //18w &gt; 15w
				idx = i;  // i = 1
		} else {
			if (cap-&gt;maxwatt[i] &lt; cap-&gt;maxwatt[idx] &amp;&amp;
				cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[selected_idx])
				idx = i;
		}
	}
	*boost_idx = idx;
	idx = selected_idx;

	/* get buck_idx */
	for (i = 0; i &lt; cap-&gt;nr; i++) {

		if (cap-&gt;min_mv[i] &lt; pd-&gt;vbus_l ||
			cap-&gt;max_mv[i] &lt; pd-&gt;vbus_l) {
			pd_err(&quot;min_mv error:%d %d %d\n&quot;,
					cap-&gt;min_mv[i],
					cap-&gt;max_mv[i],
					pd-&gt;vbus_l);
			continue;
		}

		if (cap-&gt;min_mv[i] &gt; pd-&gt;vbus_h ||
			cap-&gt;max_mv[i] &gt; pd-&gt;vbus_h) {
			pd_err(&quot;max_mv error:%d %d %d\n&quot;,
					cap-&gt;min_mv[i],
					cap-&gt;max_mv[i],
					pd-&gt;vbus_h);
			continue;
		}

		if (idx == selected_idx) {
			if (cap-&gt;maxwatt[i] &lt; cap-&gt;maxwatt[idx])
				idx = i;
		} else {
			if (cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[idx] &amp;&amp;
				cap-&gt;maxwatt[i] &lt; cap-&gt;maxwatt[selected_idx])
				idx = i;
		}
	}
	*buck_idx = idx;

	return 0;
}
</pre></div>
</div>
<p>上面可以得到最重要的参数<code class="docutils literal notranslate"><span class="pre">boost_idx</span> <span class="pre">=</span> <span class="pre">1</span></code>，这样为下一次循环升压做准备。</p>
</section>
<section id="pd-hal-set-adapter-cap">
<h3>2.pd_hal_set_adapter_cap设置适配器档位<a class="headerlink" href="#pd-hal-set-adapter-cap" title="此标题的永久链接"></a></h3>
<p>这里主要是请求档位信息给到适配器，软件逻辑如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">pd_hal_set_adapter_cap</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span><span class="w"> </span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">max_mv</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ma</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">adapter_dev_set_cap</span><span class="p">(</span><span class="n">hal</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">MTK_PD</span><span class="p">,</span><span class="w"> </span><span class="n">mV</span><span class="p">,</span><span class="w"> </span><span class="n">mA</span><span class="p">);</span><span class="w"> </span><span class="c1">//mtk_pd_hal.c</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">pd_set_cap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">adapter_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">adapter_cap_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="c1">//mtk_pd_adapter.c //设置cap档位</span>
<span class="w">	  </span><span class="o">*</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MTK_PD</span><span class="p">)</span><span class="w"> </span>
<span class="w">	    </span><span class="o">*</span><span class="w"> </span><span class="n">tcpm_dpm_pd_request</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="n">mV</span><span class="p">,</span><span class="n">mA</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="n">tcpm</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">tcpm_dpm_pd_request</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">tcpc_device</span><span class="w"> </span><span class="o">*</span><span class="n">tcpc</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">mv</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ma</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_dpm_event_cb_data</span><span class="w"> </span><span class="o">*</span><span class="n">cb_data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_dpm_event</span><span class="w"> </span><span class="n">tcp_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">event_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_DPM_EVT_REQUEST</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">tcp_dpm_data</span><span class="p">.</span><span class="n">pd_req</span><span class="p">.</span><span class="n">mv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mv</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">tcp_dpm_data</span><span class="p">.</span><span class="n">pd_req</span><span class="p">.</span><span class="n">ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">tcpm_put_tcp_dpm_event_cbk1</span><span class="p">(</span><span class="w"></span>
<span class="w">		</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tcp_event</span><span class="p">,</span><span class="w"> </span><span class="n">cb_data</span><span class="p">,</span><span class="w"> </span><span class="n">TCPM_BK_REQUEST_TOUT</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span><span class="w"> </span><span class="nc">TCP_DPM_EVT_ID</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_UNKONW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_PD_COMMAND</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_PR_SWAP_AS_SNK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_DPM_EVT_PD_COMMAND</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_PR_SWAP_AS_SRC</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DR_SWAP_AS_UFP</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DR_SWAP_AS_DFP</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_VCONN_SWAP_OFF</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_VCONN_SWAP_ON</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GOTOMIN</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_SOFTRESET</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_CABLE_SOFTRESET</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_SOURCE_CAP</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_SINK_CAP</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_REQUEST</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_REQUEST_EX</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_REQUEST_AGAIN</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_BIST_CM2</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_DUMMY</span><span class="p">,</span><span class="w">	</span><span class="cm">/* wakeup event thread */</span><span class="w"></span>

<span class="cp">#ifdef CONFIG_USB_PD_REV30</span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_PD30_COMMAND</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_SOURCE_CAP_EXT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_DPM_EVT_PD30_COMMAND</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_STATUS</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_FR_SWAP_AS_SINK</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_FR_SWAP_AS_SOURCE</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_COUNTRY_CODE</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_PPS_STATUS</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_ALERT</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_COUNTRY_INFO</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_BAT_CAP</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_BAT_STATUS</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_GET_MFRS_INFO</span><span class="p">,</span><span class="w"></span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_USB_PD_REV30 */</span><span class="cp"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_VDM_COMMAND</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DISCOVER_CABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_DPM_EVT_VDM_COMMAND</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DISCOVER_ID</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DISCOVER_SVIDS</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DISCOVER_MODES</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_ENTER_MODE</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_EXIT_MODE</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_ATTENTION</span><span class="p">,</span><span class="w"></span>

<span class="cp">#ifdef CONFIG_USB_PD_ALT_MODE</span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DP_ATTENTION</span><span class="p">,</span><span class="w"></span>
<span class="cp">#ifdef CONFIG_USB_PD_ALT_MODE_DFP</span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DP_STATUS_UPDATE</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_DP_CONFIG</span><span class="p">,</span><span class="w"></span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_USB_PD_ALT_MODE_DFP */</span><span class="cp"></span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_USB_PD_ALT_MODE */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_USB_PD_CUSTOM_VDM</span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_UVDM</span><span class="p">,</span><span class="w"></span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_USB_PD_CUSTOM_VDM */</span><span class="cp"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_IMMEDIATELY</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_HARD_RESET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_DPM_EVT_IMMEDIATELY</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">TCP_DPM_EVT_ERROR_RECOVERY</span><span class="p">,</span><span class="w"></span>

<span class="w">	</span><span class="n">TCP_DPM_EVT_NR</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="id10">
<h2>PD充电步骤<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>从现象来看，PD充电分为三个步骤：</p>
<ul>
<li><p>插入充电器，由于正在PD CC协商<code class="docutils literal notranslate"><span class="pre">ready</span> <span class="pre">PD</span> <span class="pre">algo</span></code>，首先配置的是Basic充电<code class="docutils literal notranslate"><span class="pre">5v2a</span></code>档位。</p></li>
<li><p>第一次配置PD档位，由于在<code class="docutils literal notranslate"><span class="pre">_pd_init_algo</span></code>函数中，满足条件<code class="docutils literal notranslate"><span class="pre">(now_max_watt</span> <span class="pre">&gt;=</span> <span class="pre">pd_max_watt)</span> <span class="pre">||</span> <span class="pre">chg1_mivr</span> <span class="pre">||</span> <span class="pre">chg2_mivr</span> <span class="pre">||</span> <span class="pre">(uisoc</span> <span class="pre">&lt;=</span> <span class="pre">pd-&gt;pd_stop_battery_soc)</span></code>，<code class="docutils literal notranslate"><span class="pre">*newidx</span> <span class="pre">=</span> <span class="pre">pd-&gt;pd_boost_idx;</span></code>，由于初始化<code class="docutils literal notranslate"><span class="pre">boost_idx</span></code>参数为0，第一次选的PD档位为<code class="docutils literal notranslate"><span class="pre">5v3a</span></code>。</p></li>
<li><p>当第一次调用<code class="docutils literal notranslate"><span class="pre">pd_hal_set_adapter_cap</span></code>设置完档位后，会调用<code class="docutils literal notranslate"><span class="pre">__mtk_pdc_get_idx</span></code>计算出最重要的参数<code class="docutils literal notranslate"><span class="pre">boost_idx</span> <span class="pre">=</span> <span class="pre">1</span></code>，下一次<code class="docutils literal notranslate"><span class="pre">pd_hal_set_adapter_cap</span></code>就会设置<code class="docutils literal notranslate"><span class="pre">9v2a</span></code>档位。</p></li>
</ul>
</li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>1.第一次计算5v3a档位：
05-27 14:28:04.063069 &lt;5&gt;[10054.724155]  (6)[304:charger_thread]pd_hal_get_uisoc:16 //满足boost条件，那idx = boost_idx  ，但是第一次boost_idx = 0
05-27 14:28:04.063089 &lt;5&gt;[10054.724175]  (6)[304:charger_thread][__mtk_pdc_get_setting]watt:12400000,9250000,7900000 up:1,0 vbus:4598000 ibus:1850, mivr:0,0 // up:1,0表示选择boost
05-27 14:28:04.063106 &lt;5&gt;[10054.724192]  (6)[304:charger_thread][__mtk_pdc_get_setting]vbus:9000:5000:5000 current:3000 idx:0 default_idx:0 //idx:0表示选择5v3a档位
05-27 14:28:04.063621 &lt;5&gt;[10054.724707]  (6)[304:charger_thread]PAX_CHG: [mtk_chg_enable_vbus_ovp] en:1 ovp:6500000 //打开ovp功能

2.第一次设置5v3a档位：
05-27 14:28:04.064504 &lt;5&gt;[10054.725590]  (6)[304:charger_thread][pd_set_cap] type:2 mV:5000 mA:3000
05-27 14:28:04.064839 &lt;6&gt;[10054.725925]  (4)[112:pd_dbg_info]///PD dbg info 84d
05-27 14:28:04.071508 &lt;5&gt;[10054.732594]  (4)[112:pd_dbg_info]&lt;10054.725&gt;TCPC-PE-EVT:tcp_event(request), 12

05-27 14:28:04.071508 &lt;5&gt;[10054.732594] &lt;10054.725&gt;TCPC-PE:PD-&gt; SNK_SEL_CAP

05-27 14:28:04.099470 &lt;6&gt;[10054.760556]  (4)[112:pd_dbg_info]///PD dbg info 104d
05-27 14:28:04.099509 &lt;5&gt;[10054.760595]  (4)[112:pd_dbg_info]&lt;10054.727&gt;TCPC-PE-EVT:good_crc

05-27 14:28:04.099509 &lt;5&gt;[10054.760595] &lt;10054.732&gt;TCPC-PE-EVT:accept

05-27 14:28:04.099509 &lt;5&gt;[10054.760595] &lt;10054.732&gt;TCPC-PE:PD-&gt; SNK_TRANS_SINK

05-27 14:28:04.230132 &lt;6&gt;[10054.891218]  (5)[25283:kworker/u16:5]tcpc_notifier_call: action:10
05-27 14:28:04.230177 &lt;6&gt;[10054.891263]  (4)[112:pd_dbg_info]///PD dbg info 66d
05-27 14:28:04.230195 &lt;5&gt;[10054.891281]  (4)[112:pd_dbg_info]&lt;10054.891&gt;TCPC-PE-EVT:ps_rdy

05-27 14:28:04.230195 &lt;5&gt;[10054.891281] &lt;10054.891&gt;TCPC-PE:PD-&gt; SNK_READY

05-27 14:28:04.230258 &lt;6&gt;[10054.891344]  (5)[25283:kworker/u16:5]pd_tcp_notifier_call sink vbus 5000mV 3000mA type(0x84)
05-27 14:28:04.230304 &lt;6&gt;[10054.891390]  (5)[25283:kworker/u16:5]mt6370_pmu_charger mt6370_pmu_charger: mt6370_enable_power_path: en = 1, pp_en = 1
05-27 14:28:04.230581 &lt;5&gt;[10054.891667]  (4)[304:charger_thread][pd_set_cap] type:2 mV:5000 mA:3000 ret:0


3.计算boost_idx = 1:
05-27 14:28:04.233842 &lt;5&gt;[10054.894928]  (5)[304:charger_thread]max_mv error:12000 12000 9000
05-27 14:28:04.233861 &lt;5&gt;[10054.894947]  (5)[304:charger_thread]max_mv error:12000 12000 9000
05-27 14:28:04.233880 &lt;5&gt;[10054.894966]  (5)[304:charger_thread][__mtk_pdc_setup]idx:-1:0:1:0 vbus:5000 cur:3000 ret:0 //idx:-1:0:1:0表示 boost_idx = 1

4.设置9v2a档位：
05-27 14:28:09.111745 &lt;5&gt;[10059.772831]  (6)[304:charger_thread]pd_hal_get_uisoc:16
05-27 14:28:09.111779 &lt;5&gt;[10059.772865]  (6)[304:charger_thread][__mtk_pdc_get_setting]watt:12400000,10250000,7900000 up:1,0 vbus:4560000 ibus:2050, mivr:1,0
05-27 14:28:09.111808 &lt;5&gt;[10059.772894]  (6)[304:charger_thread][__mtk_pdc_get_setting]vbus:9000:5000:9000 current:2000 idx:1 default_idx:0
05-27 14:28:09.112341 &lt;5&gt;[10059.773427]  (6)[304:charger_thread]PAX_CHG: [mtk_chg_enable_vbus_ovp] en:0 ovp:15000000 //关闭ovp

05-27 14:28:09.113642 &lt;5&gt;[10059.774728]  (6)[304:charger_thread]pd_hal_set_adapter_cap 9000 2000
05-27 14:28:09.113683 &lt;5&gt;[10059.774769]  (6)[304:charger_thread][pd_set_cap] type:2 mV:9000 mA:2000
05-27 14:28:09.114113 &lt;6&gt;[10059.775199]  (6)[112:pd_dbg_info]///PD dbg info 84d
05-27 14:28:09.114856 &lt;6&gt;[10059.775942]  (6)[243:irq/28-mt6370_p]mt6370_pmu_irq_handler
05-27 14:28:09.121375 &lt;6&gt;[10059.782461]  (6)[25283:kworker/u16:5]tcpc_notifier_call: action:10
05-27 14:28:09.121418 &lt;6&gt;[10059.782504]  (6)[25283:kworker/u16:5]pd_tcp_notifier_call sink vbus 5000mV 500mA type(0x86)
05-27 14:28:09.121457 &lt;6&gt;[10059.782543]  (6)[25283:kworker/u16:5]mt6370_pmu_charger mt6370_pmu_charger: mt6370_enable_power_path: en = 1, pp_en = 1
05-27 14:28:09.121599 &lt;5&gt;[10059.782685]  (6)[112:pd_dbg_info]&lt;10059.775&gt;TCPC-PE-EVT:tcp_event(request), 12

05-27 14:28:09.121599 &lt;5&gt;[10059.782685] &lt;10059.775&gt;TCPC-PE:PD-&gt; SNK_SEL_CAP

05-27 14:28:09.123122 &lt;6&gt;[10059.784208]  (4)[243:irq/28-mt6370_p]mt6370_pmu 5-0034: mt6370_pmu_irq_handler: handler irq_domain = (0, 6)
05-27 14:28:09.123290 &lt;6&gt;[10059.784376]  (4)[243:irq/28-mt6370_p]mt6370_pmu_charger mt6370_pmu_charger: mt6370_enable_irq: (chg_mivr) en = 0
05-27 14:28:09.123570 &lt;7&gt;[10059.784656] -(4)[243:irq/28-mt6370_p]mt6370_pmu 5-0034: mt6370_pmu_irq_disable: hwirq = 6, chg_mivr
05-27 14:28:09.147493 &lt;6&gt;[10059.808579]  (6)[112:pd_dbg_info]///PD dbg info 141d
05-27 14:28:09.147517 &lt;5&gt;[10059.808603]  (6)[112:pd_dbg_info]&lt;10059.778&gt;TCPC-PE-EVT:good_crc

05-27 14:28:09.147517 &lt;5&gt;[10059.808603] &lt;10059.782&gt;TCPC-PE-EVT:accept

05-27 14:28:09.147517 &lt;5&gt;[10059.808603] &lt;10059.782&gt;TCPC-PE:PD-&gt; SNK_TRANS_SINK

05-27 14:28:09.147517 &lt;5&gt;[10059.808603] &lt;10059.782&gt;TCPC-PE:VC_HI
05-27 14:28:09.147532 &lt;5&gt;[10059.808618]  (6)[112:pd_dbg_info]GHV_PROT: 1

05-27 14:28:09.280487 &lt;6&gt;[10059.941573]  (6)[112:pd_dbg_info]///PD dbg info 31d
05-27 14:28:09.280565 &lt;5&gt;[10059.941651]  (6)[112:pd_dbg_info]&lt;10059.941&gt;TCPC-PE-EVT:ps_rdy

05-27 14:28:09.280781 &lt;6&gt;[10059.941867]  (4)[25283:kworker/u16:5]tcpc_notifier_call: action:10
05-27 14:28:09.280811 &lt;6&gt;[10059.941897]  (4)[25283:kworker/u16:5]pd_tcp_notifier_call sink vbus 9000mV 2000mA type(0x84)
05-27 14:28:09.280864 &lt;6&gt;[10059.941950]  (4)[25283:kworker/u16:5]mt6370_pmu_charger mt6370_pmu_charger: mt6370_enable_power_path: en = 1, pp_en = 1
05-27 14:28:09.281394 &lt;5&gt;[10059.942480]  (4)[304:charger_thread][pd_set_cap] type:2 mV:9000 mA:2000 ret:0

可以看到这次选择的是9v2a：
05-27 14:28:09.282033 &lt;5&gt;[10059.943119]  (4)[304:charger_thread][__mtk_pdc_setup]idx:0:1:1:0 vbus:9000 cur:2000 ret:0
</pre></div>
</div>
</section>
<section id="id11">
<h2>PD充电图及配置<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h2>
<p>PD充电架构图大概如下：</p>
<p><img alt="0001_0006.png" src="../../../_images/0001_0006.png" /></p>
<p>PD状态逻辑图如下：</p>
<p><img alt="0001_0008.png" src="../../../_images/0001_0008.png" /></p>
<ul class="simple">
<li><p>状态集合：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enum</span> <span class="n">pd_state_enum</span> <span class="p">{</span>
	<span class="n">PD_HW_UNINIT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PD_HW_FAIL</span><span class="p">,</span>
	<span class="n">PD_HW_READY</span><span class="p">,</span>
	<span class="n">PD_TA_NOT_SUPPORT</span><span class="p">,</span>
	<span class="n">PD_RUN</span><span class="p">,</span>
	<span class="n">PD_TUNING</span><span class="p">,</span>
	<span class="n">PD_POSTCC</span><span class="p">,</span>
<span class="p">};</span>

<span class="o">/*</span>
 <span class="o">*</span> <span class="n">ALG_INIT_FAIL</span><span class="p">:</span> <span class="n">hw</span> <span class="n">init</span> <span class="n">fail</span>
 <span class="o">*</span> <span class="n">ALG_TA_NOT_SUPPORT</span><span class="p">:</span> <span class="n">TA</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">support</span>
 <span class="o">*</span> <span class="n">ALG_TA_CHECKING</span><span class="p">:</span> <span class="n">checking</span> <span class="n">TA</span>
 <span class="o">*</span> <span class="n">ALG_NOT_READY</span><span class="p">:</span> <span class="n">TA</span> <span class="n">support</span> <span class="o">&amp;</span> <span class="ow">not</span> <span class="n">meet</span> <span class="n">the</span> <span class="n">conditions</span>
 <span class="o">*</span> <span class="n">ALG_READY</span><span class="p">:</span> <span class="n">TA</span> <span class="n">support</span> <span class="o">&amp;</span> <span class="n">meet</span> <span class="n">the</span> <span class="n">conditions</span>
 <span class="o">*</span> <span class="n">ALG_RUNNING</span><span class="p">:</span> <span class="n">alg</span> <span class="ow">is</span> <span class="n">running</span>
 <span class="o">*</span> <span class="n">ALG_DONE</span><span class="p">:</span> <span class="n">alg</span> <span class="n">done</span>
 <span class="o">*/</span>
<span class="n">enum</span> <span class="n">chg_alg_state</span> <span class="p">{</span>
	<span class="n">ALG_INIT_FAIL</span><span class="p">,</span>
	<span class="n">ALG_TA_CHECKING</span><span class="p">,</span>
	<span class="n">ALG_TA_NOT_SUPPORT</span><span class="p">,</span>
	<span class="n">ALG_NOT_READY</span><span class="p">,</span>
	<span class="n">ALG_READY</span><span class="p">,</span>
	<span class="n">ALG_RUNNING</span><span class="p">,</span>
	<span class="n">ALG_DONE</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<section id="id12">
<h3>1.dts配置<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h3>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>pdc: pdc {
        compatible = &quot;mediatek,charger,pd&quot;;
        gauge = &lt;&amp;mtk_gauge&gt;;

        min_charger_voltage = &lt;4600000&gt;; //最小充电电压
        pd_vbus_low_bound = &lt;5000000&gt;; //最低电压
        pd_vbus_upper_bound = &lt;5000000&gt;;//最高电压
        vsys_watt = &lt;5000000&gt;;  
        ibus_err = &lt;14&gt;;

        pd_stop_battery_soc = &lt;80&gt;;

        /* single charger */
        sc_input_current = &lt;3200000&gt;;
        sc_charger_current = &lt;3000000&gt;;

        /* dual charger in series */
        dcs_input_current = &lt;3200000&gt;;
        dcs_chg1_charger_current = &lt;1500000&gt;;
        dcs_chg2_charger_current = &lt;1500000&gt;;

        /* dual charger */
        dual_polling_ieoc = &lt;450000&gt;;
        slave_mivr_diff = &lt;100000&gt;;
};

M8.dts:
&amp;pdc {
        /* single charger */
        sc_input_current = &lt;3000000&gt;;//适配器输入电流
        sc_charger_current = &lt;4000000&gt;; //电池端电流
        pd_stop_battery_soc = &lt;100&gt;; //PD停充电量
        pd_vbus_upper_bound = &lt;9000000&gt;; //PD上限电压9v
        dcs_chg1_charger_current = &lt;2000000&gt;;
        dcs_chg2_charger_current = &lt;2000000&gt;;

        DCS系列具有高精度输出电压以优化电池的充电。利用远程接口选件，可方便实现批量生产线上的充电过程的自动化。
};
</pre></div>
</div>
</section>
</section>
</section>
<section id="id13">
<h1>修改历程<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h1>
<section id="pd9v-2a12v-1-5a">
<h2>将PD充电从9v/2a提高到12v/1.5a<a class="headerlink" href="#pd9v-2a12v-1-5a" title="此标题的永久链接"></a></h2>
<p>由于两个档位的功率都是一样的，目前算法里需要在<code class="docutils literal notranslate"><span class="pre">__mtk_pdc_get_cap_max_watt获取最大功能</span></code>和<code class="docutils literal notranslate"><span class="pre">__mtk_pdc_get_idx匹配最大档位</span></code>两个接口上需要适配，dts里面档位信息需要增加，修改如下：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w">1.增加充电12V, 1.5A档位</span>
<span class="gd">--- a/kernel-4.19/arch/arm64/boot/dts/mediatek/mt6370_pd.dtsi</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/arch/arm64/boot/dts/mediatek/mt6370_pd.dtsi</span><span class="w"></span>
<span class="gu">@@ -48,6 +48,7 @@</span><span class="w"></span>
<span class="w"> </span>                        * Fixed 9V, 1A &lt;0x0002d064&gt;<span class="w"></span>
<span class="w"> </span>                        * Fixed 9V, 2A &lt;0x0002d0c8&gt;<span class="w"></span>
<span class="w"> </span>                        * Fixed 9V, 3A &lt;0x0002d12c&gt;<span class="w"></span>
<span class="gi">+                         * Fixed 12V, 1.5A &lt;0x0003c096&gt;</span><span class="w"></span>
<span class="w"> </span>                        * Variable 5-9V, 1A &lt;0x8642d064&gt;<span class="w"></span>
<span class="w"> </span>                        * Variable 5-9V, 2A &lt;0x8642d0c8&gt;<span class="w"></span>
<span class="w"> </span>                        * Variable 5-9V, 3A &lt;0x8642d12c&gt;<span class="w"></span>
<span class="gu">@@ -55,8 +56,8 @@</span><span class="w"></span>
<span class="w"> </span>                        */<span class="w"></span>
<span class="w"> </span>                       pd,source-pdo-size = &lt;1&gt;;<span class="w"></span>
<span class="w"> </span>                       pd,source-pdo-data = &lt;0x00019096&gt;; /* 5V, 1500 mA */<span class="w"></span>
<span class="gd">-                       pd,sink-pdo-size = &lt;1&gt;;</span><span class="w"></span>
<span class="gd">-                       pd,sink-pdo-data = &lt;0x000190c8&gt;;</span><span class="w"></span>
<span class="gi">+                       pd,sink-pdo-size = &lt;2&gt;;</span><span class="w"></span>
<span class="gi">+                       pd,sink-pdo-data = &lt;0x000190c8 0x0003c096&gt;;</span><span class="w"></span>

<span class="w">2.电压上限改为12v</span>
<span class="gd">--- a/kernel-4.19/arch/arm64/boot/dts/mediatek/M8.dts</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/arch/arm64/boot/dts/mediatek/M8.dts</span><span class="w"></span>
<span class="w"> </span>       sc_input_current = &lt;3000000&gt;;<span class="w"></span>
<span class="w"> </span>       sc_charger_current = &lt;4000000&gt;;<span class="w"></span>
<span class="w"> </span>       pd_stop_battery_soc = &lt;100&gt;;<span class="w"></span>
<span class="gd">-       pd_vbus_upper_bound = &lt;9000000&gt;;</span><span class="w"></span>
<span class="gi">+       pd_vbus_upper_bound = &lt;12000000&gt;;</span><span class="w"></span>
<span class="w"> </span>       dcs_chg1_charger_current = &lt;2000000&gt;;<span class="w"></span>
<span class="w"> </span>       dcs_chg2_charger_current = &lt;2000000&gt;;<span class="w"></span>

<span class="w">3.如果功率相同，选择电压高的。</span>
<span class="gd">--- a/kernel-4.19/drivers/power/supply/mtk_pd.c</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/power/supply/mtk_pd.c</span><span class="w"></span>
<span class="gu">@@ -244,6 +244,13 @@ void __mtk_pdc_get_cap_max_watt(struct chg_alg_device *alg)</span><span class="w"></span>
<span class="w"> </span>                                       pd-&gt;pd_cap_max_watt = cap-&gt;maxwatt[i];<span class="w"></span>
<span class="w"> </span>                                       idx = i;<span class="w"></span>
<span class="w"> </span>                               }<span class="w"></span>
<span class="gi">+                               /* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the low volt idx */</span><span class="w"></span>
<span class="gi">+                               if (cap-&gt;maxwatt[i] == pd-&gt;pd_cap_max_watt) {</span><span class="w"></span>
<span class="gi">+                                       if (cap-&gt;max_mv[i] &gt; cap-&gt;max_mv[idx])</span><span class="w"></span>
<span class="gi">+                                                       idx = i; //这里可有可无，因为idx是局部变量，都没传出去。</span><span class="w"></span>
<span class="gi">+                               }</span><span class="w"></span>
<span class="gi">+                               /* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the low volt idx */</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>                               pd_err(&quot;%d %d %d %d %d %d\n&quot;,<span class="w"></span>
<span class="w"> </span>                                       cap-&gt;min_mv[i],<span class="w"></span>
<span class="w"> </span>                                       cap-&gt;max_mv[i],<span class="w"></span>
<span class="gu">@@ -302,10 +309,27 @@ int __mtk_pdc_get_idx(struct chg_alg_device *alg, int selected_idx,</span><span class="w"></span>
<span class="w"> </span>               if (idx == selected_idx) {<span class="w"></span>
<span class="w"> </span>                       if (cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[idx])<span class="w"></span>
<span class="w"> </span>                               idx = i;<span class="w"></span>
<span class="gi">+                       /* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the high volt idx */</span><span class="w"></span>
<span class="gi">+                               if (cap-&gt;maxwatt[i] == pd-&gt;pd_cap_max_watt) {</span><span class="w"></span>
<span class="gi">+                                       if (cap-&gt;max_mv[i] &gt; cap-&gt;max_mv[idx])</span><span class="w"></span>
<span class="gi">+                                                       idx = i;</span><span class="w"></span>
<span class="gi">+                               }</span><span class="w"></span>
<span class="gi">+                               /* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the low volt idx */</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>                               pd_err(&quot;%d %d %d %d %d %d\n&quot;,<span class="w"></span>
<span class="w"> </span>                                       cap-&gt;min_mv[i],<span class="w"></span>
<span class="w"> </span>                                       cap-&gt;max_mv[i],<span class="w"></span>
<span class="gu">@@ -302,10 +309,27 @@ int __mtk_pdc_get_idx(struct chg_alg_device *alg, int selected_idx,</span><span class="w"></span>
<span class="w"> </span>               if (idx == selected_idx) {<span class="w"></span>
<span class="w"> </span>                       if (cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[idx])<span class="w"></span>
<span class="w"> </span>                               idx = i;<span class="w"></span>
<span class="gi">+                       /* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the high volt idx */</span><span class="w"></span>
<span class="gi">+                       else if (cap-&gt;maxwatt[i] == cap-&gt;maxwatt[idx]) {</span><span class="w"></span>
<span class="gi">+                               if (cap-&gt;max_mv[i] &gt; cap-&gt;max_mv[idx]) {</span><span class="w"></span>
<span class="gi">+                                               idx = i;</span><span class="w"></span>
<span class="gi">+                               }</span><span class="w"></span>
<span class="gi">+                       }</span><span class="w"></span>
<span class="gi">+                       /* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the high volt idx */</span><span class="w"></span>
<span class="w"> </span>               } else {<span class="w"></span>
<span class="w"> </span>                       if (cap-&gt;maxwatt[i] &lt; cap-&gt;maxwatt[idx] &amp;&amp;<span class="w"></span>
<span class="w"> </span>                               cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[selected_idx])<span class="w"></span>
<span class="w"> </span>                               idx = i;<span class="w"></span>
<span class="gi">+                       /* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the high volt idx */</span><span class="w"></span>
<span class="gi">+                       else {</span><span class="w"></span>
<span class="gi">+                               if (cap-&gt;maxwatt[i] == cap-&gt;maxwatt[idx] &amp;&amp; cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[selected_idx]) {</span><span class="w"></span>
<span class="gi">+                                       if (cap-&gt;max_mv[i] &gt; cap-&gt;max_mv[idx]) {</span><span class="w"></span>
<span class="gi">+                                                       idx = i;</span><span class="w"></span>
<span class="gi">+                                       }</span><span class="w"></span>
<span class="gi">+                               }</span><span class="w"></span>
<span class="gi">+                       }</span><span class="w"></span>
<span class="gi">+                       /* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/05/06, if maxwatt same, chose the high volt idx */</span><span class="w"></span>
<span class="w"> </span>               }<span class="w"></span>
<span class="w"> </span>       }<span class="w"></span>
<span class="w"> </span>       *boost_idx = idx;<span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>PD流程如下：</p></li>
</ul>
<p><img alt="0001_0009.png" src="../../../_images/0001_0009.png" /></p>
<p>打印如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>设置档位5v/3a:
&lt;5&gt;[   20.093990] .(7)[304:charger_thread][__mtk_pdc_get_setting]watt:14280000,12000000,7900000 up:1,0 vbus:11798000 ibus:1000, mivr:0,0 pd_stop_battery_soc:[100]
&lt;5&gt;[   20.093999] .(7)[304:charger_thread][__mtk_pdc_get_setting]vbus:12000:5000:5000 current:3000 idx:0 default_idx:2
&lt;5&gt;[   20.094202] .(7)[304:charger_thread]PAX_CHG: [mtk_chg_enable_vbus_ovp] en:1 ovp:6500000
&lt;5&gt;[   20.094307] .(7)[304:charger_thread]pd_hal_set_mivr: 0 4600000
&lt;6&gt;[   20.094321] .(7)[304:charger_thread]mt6370_pmu_charger mt6370_pmu_charger: __mt6370_set_mivr: mivr = 4600000 (0x07)
&lt;5&gt;[   20.094487] .(7)[304:charger_thread]pd_hal_set_adapter_cap 5000 3000
&lt;5&gt;[   20.094496] .(7)[304:charger_thread][pd_set_cap] type:2 mV:5000 mA:3000

设置档位12v/1.5a:
&lt;5&gt;[   25.195526] .(2)[304:charger_thread][__mtk_pdc_get_setting]watt:12400000,13000000,7900000 up:1,0 vbus:4569000 ibus:2600, mivr:0,0 pd_stop_battery_soc:[100]
&lt;5&gt;[   25.195533] .(2)[304:charger_thread][__mtk_pdc_get_setting]vbus:12000:5000:12000 current:1500 idx:2 default_idx:0
&lt;5&gt;[   25.195737] .(2)[304:charger_thread]PAX_CHG: [mtk_chg_enable_vbus_ovp] en:0 ovp:15000000
&lt;5&gt;[   25.195914] .(2)[304:charger_thread]pd_hal_set_mivr: 0 4600000
&lt;6&gt;[   25.195932] .(2)[304:charger_thread]mt6370_pmu_charger mt6370_pmu_charger: __mt6370_set_mivr: mivr = 4600000 (0x07)
&lt;5&gt;[   25.196337] .(2)[304:charger_thread]pd_hal_set_adapter_cap 12000 1500
&lt;5&gt;[   25.196347] .(2)[304:charger_thread][pd_set_cap] type:2 mV:12000 mA:1500
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../../../_downloads/c7a2f1026428255267f3e73958d74f06/0001_kernel_log_6__2022_0527_140241%E6%94%AF%E6%8C%8112v1.5a%E6%A1%A3%E4%BD%8D"><span class="xref download myst">0001_kernel_log_6__2022_0527_140241支持12v1.5a档位</span></a></p></li>
</ul>
</section>
<section id="usb-bc1-2">
<h2>优化usb唤醒速度，跳过bc1.2检测<a class="headerlink" href="#usb-bc1-2" title="此标题的永久链接"></a></h2>
<p>由于mtk平台bc1.2检测比较耗时，而插入usb时显示亮屏和充电状态，必须需要等待bc1.2完成，这也是正常的充电流程，如需加快亮屏状态，可以在未识别前先赋值online状态为1.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">这里读取节点是</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="k">class</span><span class="o">/</span><span class="n">power_supply</span><span class="o">/</span><span class="n">mt6370_pmu_charger</span><span class="o">/</span><span class="n">online</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">BatteryMonitor</span><span class="o">::</span><span class="n">updateValues</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">...</span><span class="n">省略</span><span class="p">...</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mChargerNames</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String8</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/online&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;************path1:%s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getIntField</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">path</span><span class="p">.</span><span class="n">appendFormat</span><span class="p">(</span><span class="s">&quot;%s/%s/type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">POWER_SUPPLY_SYSFS_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;************path2:%s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">switch</span><span class="p">(</span><span class="n">readPowerSupplyType</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_AC</span><span class="p">:</span><span class="w"></span>
<span class="w">                                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerVoltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChargerVoltage</span><span class="p">(</span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">                                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChargerCurrent</span><span class="p">(</span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerAcOnline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_USB</span><span class="p">:</span><span class="w"></span>
<span class="w">                                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerVoltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChargerVoltage</span><span class="p">(</span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">                                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChargerCurrent</span><span class="p">(</span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerUsbOnline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">ANDROID_POWER_SUPPLY_TYPE_WIRELESS</span><span class="p">:</span><span class="w"></span>
<span class="w">                                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerVoltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChargerVoltage</span><span class="p">(</span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">                                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getChargerCurrent</span><span class="p">(</span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerWirelessOnline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">                </span><span class="n">props</span><span class="p">.</span><span class="n">chargerUsbOnline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">KLOG_WARNING</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: Unknown power supply type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">mChargerNames</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">			</span><span class="p">...</span><span class="n">省略</span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>修改方案：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/system/core/healthd/BatteryMonitor.cpp</span><span class="w"></span>
<span class="gi">+++ b/system/core/healthd/BatteryMonitor.cpp</span><span class="w"></span>
<span class="gu">@@ -369,6 +369,7 @@ void BatteryMonitor::updateValues(void) {</span><span class="w"></span>
<span class="w"> </span>                props.chargerWirelessOnline = true;<span class="w"></span>
<span class="w"> </span>                break;<span class="w"></span>
<span class="w"> </span>            default:<span class="w"></span>
<span class="gi">+                props.chargerUsbOnline = true;</span><span class="w"></span>
<span class="w"> </span>                KLOG_WARNING(LOG_TAG, &quot;%s: Unknown power supply type\n&quot;,<span class="w"></span>
<span class="w"> </span>                             mChargerNames[i].string());<span class="w"></span>
<span class="w"> </span>            }<span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>