<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">README</a></li>
<li><a class="reference internal" href="#refers">refers</a></li>
<li><a class="reference internal" href="#kernel">kernel移植流程</a><ul>
<li><a class="reference internal" href="#dts-panel">1.dts Panel命令信息</a></li>
<li><a class="reference internal" href="#id1">2.屏幕物理数据</a><ul>
<li><a class="reference internal" href="#dsitiming">生成DSI的Timing</a></li>
<li><a class="reference internal" href="#id2">操作步骤</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">最终代码</a></li>
</ul>
</li>
<li><a class="reference internal" href="#xbl">XBL流程</a><ul>
<li><a class="reference internal" href="#id4">移植流程</a><ul>
<li><a class="reference internal" href="#panel-uefipanellist">1.增加panel，填写uefiPanelList配置</a></li>
<li><a class="reference internal" href="#id5">2.在XBL中添加新屏参数</a></li>
<li><a class="reference internal" href="#id6">3.添加定义</a></li>
<li><a class="reference internal" href="#id7">4.定义上下电时序</a></li>
<li><a class="reference internal" href="#fastbootpanel">5.增加fastboot模式下panel</a></li>
<li><a class="reference internal" href="#xml">6.指定xml地址</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">代码流程</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">调试</a><ul>
<li><a class="reference internal" href="#id10">1.无法获取xml文件</a></li>
<li><a class="reference internal" href="#id11">2.kernel调试</a></li>
<li><a class="reference internal" href="#esd">3.ESD检测功能</a><ul>
<li><a class="reference internal" href="#id12">代码流程</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13">4.xbl阶段增加寄存器</a></li>
<li><a class="reference internal" href="#id14">5.多屏兼容调试</a></li>
<li><a class="reference internal" href="#id15">休眠唤醒不亮屏(时序调试)</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>README</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="readme">
<h1>README<a class="headerlink" href="#readme" title="此标题的永久链接"></a></h1>
<p>高通平台qcm2290，屏驱IC:ILI7807S调试，特性1080x2560分辨率。</p>
</section>
<section id="refers">
<h1>refers<a class="headerlink" href="#refers" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><span class="xref myst">ILI7807S Data Sheet for all customer(V001)_20200108.pdf</span></p></li>
<li><p><span class="xref myst">移远提供patch</span></p></li>
<li><p><span class="xref myst">供应商提供初始化代码及porch</span></p></li>
<li><p><a class="reference external" href="https://www.cnblogs.com/schips/p/qualcomm_uefi_display_important_functions.html">高通Android UEFI中的LCD分析（2）：关键的函数</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/melody157398/article/details/115986401">SM7250(高通5G)平台LCD bringup</a></p></li>
<li><p><a class="reference external" href="https://www.cnblogs.com/schips/p/qualcomm_lcd_develop_faq.html">高通LCD开发常见问题&amp;分析 经典</a></p></li>
</ul>
</section>
<section id="kernel">
<h1>kernel移植流程<a class="headerlink" href="#kernel" title="此标题的永久链接"></a></h1>
<section id="dts-panel">
<h2>1.dts Panel命令信息<a class="headerlink" href="#dts-panel" title="此标题的永久链接"></a></h2>
<p>请参考：</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../../../_downloads/b257f617f5e7b234a2afaae49a37ef1e/Quectel_SC200E%E7%B3%BB%E5%88%97_Android12_%E6%98%BE%E7%A4%BA%E9%A9%B1%E5%8A%A8_%E5%BC%80%E5%8F%91%E6%8C%87%E5%AF%BC.doc"><span class="xref download myst">Quectel_SC200E系列_Android12_显示驱动_开发指导.doc</span></a></p></li>
</ul>
</section>
<section id="id1">
<h2>2.屏幕物理数据<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<p>Timing配置的示例如下图所示：</p>
<p><img alt="0001_0000.png" src="../../../_images/0001_00002.png" /></p>
<section id="dsitiming">
<h3>生成DSI的Timing<a class="headerlink" href="#dsitiming" title="此标题的永久链接"></a></h3>
<p>Panel需要在DSI PHY寄存器中为bitclk设置PHY值。80-NH713-1_DSI.zip压缩包（压缩文件在工具目录中可用）中的80-nh713-1_yj_dsi timing parameters user interactive spreadsheet.xlsm可用于自动计算timing值。</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../../../_downloads/00d959a3cc5dd0f264370fff8627f3b2/80-nh713-1_yj_dsi_timing_parameters_user_interactive_spreadsheet.xlsm"><span class="xref download myst">80-nh713-1_yj_dsi_timing_parameters_user_interactive_spreadsheet.xlsm</span></a></p></li>
</ul>
</section>
<section id="id2">
<h3>操作步骤<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h3>
<ol class="arabic simple">
<li><p>打开DSI和MDP寄存器表。将frame rate、lane numbers、panel resolution、porch和chip值输入到红线框定的区域。如下图所示:</p></li>
</ol>
<p><img alt="0001_0001.png" src="../../../_images/0001_00013.png" /></p>
<ol class="arabic simple" start="2">
<li><p>打开DSI PHY timing setting sheet页，先按ctrl + j清除，然后按ctrl + k重新生成。Check for T_CLK_ZERO值会变成VALID：</p></li>
</ol>
<p><img alt="0001_0002.png" src="../../../_images/0001_00024.png" /></p>
<ol class="arabic simple" start="3">
<li><p>打开DSI PHY 2.0.0 timing setting表，查看蓝色字段中与计算出的DSI相关时钟速率。如下图所示：</p></li>
</ol>
<p><img alt="0001_0003.png" src="../../../_images/0001_00034.png" /></p>
<ol class="arabic simple" start="4">
<li><p>使用从Excel工作表中获取的上述值更新面板XML文件<PanelTimings>。如下所示。值为从上述内容中复制。</p></li>
</ol>
<p><img alt="0001_0004.png" src="../../../_images/0001_00043.png" /></p>
</section>
</section>
<section id="id3">
<h2>最终代码<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>&amp;dsi_ft8006s_720p_video {
        qcom,dsi-select-clocks = &quot;mux_byte_clk0&quot;, &quot;mux_pixel_clk0&quot;;
        qcom,mdss-dsi-t-clk-post = &lt;0x0b&gt;; //60 fps
        qcom,mdss-dsi-t-clk-pre = &lt;0x22&gt;;
        qcom,panel-supply-entries = &lt;&amp;dsi_panel_pwr_supply&gt;;
        qcom,mdss-dsi-bl-pmic-control-type = &quot;bl_ctrl_pwm&quot;;
        pwms = &lt;&amp;pm2250_pwm3 0 0&gt;;
        qcom,bl-pmic-pwm-period-usecs = &lt;100&gt;;
        qcom,mdss-dsi-bl-min-level = &lt;1&gt;;
        qcom,mdss-dsi-bl-max-level = &lt;255&gt;;
        qcom,platform-te-gpio = &lt;&amp;tlmm 81 0&gt;;
        qcom,platform-reset-gpio = &lt;&amp;tlmm 82 0&gt;;

        qcom,mdss-dsi-display-timings {
                timing@0{
                        qcom,mdss-dsi-panel-phy-timings =
                        [
                         1f 10 05 06 03 02 04 0a //60 fps
                         1f 10 05 06 03 02 04 0a
                         1f 10 05 06 03 02 04 0a
                         1f 10 05 06 03 02 04 0a
                         1f 1c 05 06 03 02 04 0a
                        ];
                        qcom,display-topology = &lt;1 0 1&gt;;
                        qcom,default-topology-index = &lt;0&gt;;
                };
        };
};

/* Copyright (c) 2016-2018, The Linux Foundation. All rights reserved.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 and
 * only version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 */

&amp;mdss_mdp {
	dsi_ft8006s_720p_video: qcom,mdss_dsi_ft8006s_720p_video {
		qcom,mdss-dsi-panel-name =&quot;ft8006s video mode dsi panel without DSC&quot;;
		qcom,mdss-dsi-panel-type = &quot;dsi_video_mode&quot;;
		qcom,dsi-ctrl-num = &lt;0&gt;;
		qcom,dsi-phy-num = &lt;0&gt;;
		qcom,mdss-dsi-virtual-channel-id = &lt;0&gt;;
		qcom,mdss-dsi-stream = &lt;0&gt;;
		qcom,mdss-dsi-h-left-border = &lt;0&gt;;
		qcom,mdss-dsi-h-right-border = &lt;0&gt;;
		qcom,mdss-dsi-v-top-border = &lt;0&gt;;
		qcom,mdss-dsi-v-bottom-border = &lt;0&gt;;
		qcom,mdss-dsi-bpp = &lt;24&gt;;
		qcom,mdss-dsi-color-order = &quot;rgb_swap_rgb&quot;;
		qcom,mdss-dsi-underflow-color = &lt;0xff&gt;;
		qcom,mdss-dsi-border-color = &lt;0&gt;;
		qcom,mdss-dsi-h-sync-pulse = &lt;0&gt;;
		qcom,mdss-dsi-traffic-mode = &quot;non_burst_sync_event&quot;;
		qcom,mdss-dsi-lane-map = &quot;lane_map_0123&quot;;
		qcom,mdss-dsi-bllp-eof-power-mode;
		qcom,mdss-dsi-bllp-power-mode;
		qcom,mdss-dsi-tx-eot-append;
		qcom,mdss-dsi-lane-0-state;
		qcom,mdss-dsi-lane-1-state;
		qcom,mdss-dsi-lane-2-state;
		qcom,mdss-dsi-lane-3-state;
		qcom,mdss-dsi-dma-trigger = &quot;trigger_sw&quot;;
		qcom,mdss-dsi-mdp-trigger = &quot;none&quot;;
		qcom,mdss-dsi-lp11-init;
		qcom,mdss-dsi-bl-pmic-control-type = &quot;bl_ctrl_wled&quot;;
		qcom,mdss-dsi-bl-min-level = &lt;1&gt;;
		qcom,mdss-dsi-bl-max-level = &lt;4095&gt;;
		qcom,mdss-dsi-reset-sequence = &lt;1 10&gt;, &lt;0 10&gt;, &lt;1 10&gt;;
		qcom,mdss-dsi-te-pin-select = &lt;1&gt;;
		qcom,mdss-dsi-wr-mem-start = &lt;0x2c&gt;;
		qcom,mdss-dsi-wr-mem-continue = &lt;0x3c&gt;;
		qcom,mdss-dsi-te-dcs-command = &lt;1&gt;;
		qcom,mdss-dsi-te-check-enable;
		qcom,mdss-dsi-te-using-te-pin;
		qcom,mdss-dsi-display-timings {
			timing@0{
				qcom,mdss-dsi-panel-width = &lt;720&gt;;
				qcom,mdss-dsi-panel-height = &lt;1600&gt;;
				qcom,mdss-dsi-h-front-porch = &lt;24&gt;;
				qcom,mdss-dsi-h-back-porch = &lt;24&gt;;
				qcom,mdss-dsi-h-pulse-width = &lt;16&gt;;
				qcom,mdss-dsi-h-sync-skew = &lt;0&gt;;
				qcom,mdss-dsi-v-back-porch = &lt;110&gt;;
				qcom,mdss-dsi-v-front-porch = &lt;130&gt;;
				qcom,mdss-dsi-v-pulse-width = &lt;10&gt;;
				qcom,mdss-dsi-panel-framerate = &lt;60&gt;;
		qcom,mdss-dsi-on-command =[ 
		05 01 00 00 78 00 02 11 00
		05 01 00 00 14 00 02 29 00];
		qcom,mdss-dsi-off-command = [05 01 00 00 32 00 02 28 00
					05 01 00 00 78 00 02 10 00];
				qcom,mdss-dsi-on-command-state = &quot;dsi_lp_mode&quot;;
				qcom,mdss-dsi-off-command-state = &quot;dsi_hs_mode&quot;;
				qcom,mdss-dsi-h-sync-pulse = &lt;0&gt;;
			};
		};
	};
};
</pre></div>
</div>
</section>
</section>
<section id="xbl">
<h1>XBL流程<a class="headerlink" href="#xbl" title="此标题的永久链接"></a></h1>
<section id="id4">
<h2>移植流程<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<section id="panel-uefipanellist">
<h3>1.增加panel，填写uefiPanelList配置<a class="headerlink" href="#panel-uefipanellist" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/Library/MDPPlatformLib/MDPPlatformLib.c</span></code>:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">PlatformDSIDetectParams</span><span class="w"> </span><span class="n">uefiPanelList</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>

<span class="w">      </span><span class="n">MDPPLATFORM_PANEL_ILI7807S_1080P_VIDEO</span><span class="p">,</span><span class="w">                 </span><span class="c1">// eSelectedPanel</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>目前暂不支持读display id的方式兼容多个屏，只能存一个屏。</p>
</section>
<section id="id5">
<h3>2.在XBL中添加新屏参数<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BOOT.XF.4.1\boot_images\QcomPkg\Settings\Panel\Panel_ili7807s_1080p_video.xml</span></code>目录下保存所有屏参。</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;PanelName&gt;</span>ILI7807S_1080P<span class="nt">&lt;/PanelName&gt;</span>
<span class="nt">&lt;PanelDescription&gt;</span>ili7807s 1080p video mode dsi panel<span class="nt">&lt;/PanelDescription&gt;</span>
<span class="nt">&lt;Group</span> <span class="na">id=</span><span class="s">&quot;Active Timing&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;HorizontalActive&gt;</span>1080<span class="nt">&lt;/HorizontalActive&gt;</span>
 <span class="nt">&lt;HorizontalFrontPorch&gt;</span>22<span class="nt">&lt;/HorizontalFrontPorch&gt;</span>
 <span class="nt">&lt;HorizontalBackPorch&gt;</span>23<span class="nt">&lt;/HorizontalBackPorch&gt;</span>
 <span class="nt">&lt;HorizontalSyncPulse&gt;</span>4<span class="nt">&lt;/HorizontalSyncPulse&gt;</span>
 <span class="nt">&lt;HorizontalSyncSkew&gt;</span>0<span class="nt">&lt;/HorizontalSyncSkew&gt;</span>
 <span class="nt">&lt;HorizontalLeftBorder&gt;</span>0<span class="nt">&lt;/HorizontalLeftBorder&gt;</span>
 <span class="nt">&lt;HorizontalRightBorder&gt;</span>0<span class="nt">&lt;/HorizontalRightBorder&gt;</span>
 <span class="nt">&lt;VerticalActive&gt;</span>2408<span class="nt">&lt;/VerticalActive&gt;</span>
 <span class="nt">&lt;VerticalFrontPorch&gt;</span>12<span class="nt">&lt;/VerticalFrontPorch&gt;</span>
 <span class="nt">&lt;VerticalBackPorch&gt;</span>12<span class="nt">&lt;/VerticalBackPorch&gt;</span>
 <span class="nt">&lt;VerticalSyncPulse&gt;</span>2<span class="nt">&lt;/VerticalSyncPulse&gt;</span>
 <span class="nt">&lt;VerticalSyncSkew&gt;</span>0<span class="nt">&lt;/VerticalSyncSkew&gt;</span>
 <span class="nt">&lt;VerticalTopBorder&gt;</span>0<span class="nt">&lt;/VerticalTopBorder&gt;</span>
 <span class="nt">&lt;VerticalBottomBorder&gt;</span>0<span class="nt">&lt;/VerticalBottomBorder&gt;</span>
<span class="nt">&lt;/Group&gt;</span>
<span class="nt">&lt;Group</span> <span class="na">id=</span><span class="s">&quot;Display Interface&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;InterfaceType&gt;</span>8<span class="nt">&lt;/InterfaceType&gt;</span>
 <span class="nt">&lt;InterfaceColorFormat&gt;</span>3<span class="nt">&lt;/InterfaceColorFormat&gt;</span>
<span class="nt">&lt;/Group&gt;</span>
<span class="nt">&lt;Group</span> <span class="na">id=</span><span class="s">&quot;DSI Interface&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;DSIChannelId&gt;</span>1<span class="nt">&lt;/DSIChannelId&gt;</span>
 <span class="nt">&lt;DSIVirtualId&gt;</span>0<span class="nt">&lt;/DSIVirtualId&gt;</span>
 <span class="nt">&lt;DSIColorFormat&gt;</span>36<span class="nt">&lt;/DSIColorFormat&gt;</span>
 <span class="nt">&lt;DSITrafficMode&gt;</span>1<span class="nt">&lt;/DSITrafficMode&gt;</span>
 <span class="nt">&lt;DSILanes&gt;</span>4<span class="nt">&lt;/DSILanes&gt;</span>
 <span class="nt">&lt;DSILowPowerModeInBLLPEOF&gt;</span>True<span class="nt">&lt;/DSILowPowerModeInBLLPEOF&gt;</span>
 <span class="nt">&lt;DSILowPowerModeInBLLP&gt;</span>True<span class="nt">&lt;/DSILowPowerModeInBLLP&gt;</span>
 <span class="nt">&lt;DSIRefreshRate&gt;</span>0x280000<span class="nt">&lt;/DSIRefreshRate&gt;</span>
 <span class="nt">&lt;DSIDynamicRefreshRates&gt;</span>0x3B0000 0x3B4000 0x3B8000 0x3BC000 0x3C0000<span class="nt">&lt;/DSIDynamicRefreshRates&gt;</span>
 <span class="nt">&lt;DSICmdSwapInterface&gt;</span>False<span class="nt">&lt;/DSICmdSwapInterface&gt;</span>
 <span class="nt">&lt;DSICmdUsingTrigger&gt;</span>False<span class="nt">&lt;/DSICmdUsingTrigger&gt;</span>
 <span class="nt">&lt;DSIControllerMapping&gt;</span>
  00
 <span class="nt">&lt;/DSIControllerMapping&gt;</span>
<span class="nt">&lt;/Group&gt;</span>
<span class="nt">&lt;DSIInitSequence&gt;</span>

39 FF 78 07 01

39 00 41
39 01 50
39 02 00
39 03 5C
39 08 81
39 09 06
39 0a 70
39 0c 00
39 0e 51
39 31 02
39 32 07
39 33 07
39 34 07
39 35 07
39 36 07
39 37 07
39 38 36
39 39 35
39 3a 34
39 3b 30
39 3c 2F
39 3d 2E
39 3e 2C
39 3f 11
39 40 17
39 41 15
39 42 13
39 43 09
39 44 28
39 45 28
39 46 28
39 47 28
39 48 28
39 49 02
39 4a 07
39 4b 07
39 4c 07
39 4d 07
39 4e 07
39 4f 07
39 50 36
39 51 35
39 52 34
39 53 30
39 54 2F
39 55 2E
39 56 2C
39 57 10
39 58 16
39 59 14
39 5a 12
39 5b 08
39 5c 28
39 5d 28
39 5e 28
39 5f 28
39 60 28
39 61 02
39 62 07
39 63 07
39 64 07
39 65 07
39 66 07
39 67 07
39 68 36
39 69 35
39 6a 34
39 6b 30
39 6c 2F
39 6d 2E
39 6e 2C
39 6f 12
39 70 14
39 71 16
39 72 10
39 73 08
39 74 28
39 75 28
39 76 28
39 77 28
39 78 28
39 79 02
39 7a 07
39 7b 07
39 7c 07
39 7d 07
39 7e 07
39 7f 07
39 80 36
39 81 35
39 82 34
39 83 30
39 84 2F
39 85 2E
39 86 2C
39 87 13
39 88 15
39 89 17
39 8a 11
39 8b 09
39 8c 28
39 8d 28
39 8e 28
39 8f 28
39 90 28
39 A7 00
39 B2 00
39 B3 04
39 F0 2C
39 D1 12
39 D3 40
39 D4 04
39 D8 64
39 E6 22
39 D5 12
39 D9 85
39 E1 08
39 DA 01
39 DB 01
39 DC 08
39 DD 98

39 FF 78 07 11
39 38 00
39 39 4C

39 FF 78 07 02
39 01 55
39 02 09
39 40 01
39 41 00
39 42 0A
39 43 2E
39 1B 02
39 46 22
39 47 03
39 82 32
39 53 06
39 76 13
39 80 32
39 06 6D
39 08 00
39 0E 0E
39 0F 0C
39 24 16
39 4E C4

39 FF 78 07 12
39 48 00
39 49 00
39 4A 09
39 4B 2C
39 4E 06
39 52 13
39 53 22
39 C8 6D
39 C9 00
39 CA 0E
39 CB 0C
39 01 44
39 03 44

39 FF 78 07 04
39 B7 CF
39 B8 45
39 BA 74
39 BD 01

39 FF 78 07 05
39 1D 00
39 1E 87
39 1F 00
39 20 87
39 61 CB
39 72 75
39 74 41
39 76 70
39 7A 3C
39 7B 85
39 7C 85
39 C6 1B
39 56 FF
39 46 55
39 B5 55
39 3E 50
39 56 FF
39 FF 78 07 06
39 C0 68
39 C1 19
39 C3 06
39 13 13
39 12 BD

39 FF 78 07 07
39 03 20
39 11 16
39 12 00
39 29 00

39 FF 78 07 08
39 E0 00 00 20 52 00 93 C0 E3 15 19 42 80 25 B0 F7 2E 2A 65 A4 CB 3E FE 23 4E 3F 67 89 BA 0F D8 D9
39 E1 00 00 20 52 00 93 C0 E3 15 19 42 80 25 B0 F7 2E 2A 65 A4 CB 3E FE 23 4E 3F 67 89 BA 0F D8 D9

39 FF 78 07 0B
39 94 88
39 95 23
39 96 06
39 97 06
39 98 CB
39 99 CB
39 9A 46
39 9B D6
39 9C 05
39 9D 05
39 9E AB
39 9F AB
39 AA 12
39 AB E0
39 C6 88
39 C7 21
39 C8 06
39 C9 06
39 CA CB
39 CB CB
39 D8 06
39 D9 D7
39 DA 05
39 DB 05
39 DC AB
39 DD AB

39 FF 78 07 0C
39 40 22
39 41 3C
39 42 21
39 43 36
39 44 21
39 45 36
39 46 23
39 47 48
39 48 20
39 49 31
39 4A 21
39 4B 37
39 4C 22
39 4D 3F
39 4E 22
39 4F 3D
39 50 21
39 51 38
39 52 22
39 53 40
39 54 22
39 55 3E
39 56 22
39 57 43
39 58 21
39 59 39
39 5A 22
39 5B 41
39 5C 21
39 5D 35
39 5E 22
39 5F 45
39 60 21
39 61 33
39 62 22
39 63 3B
39 64 20
39 65 30
39 66 22
39 67 44
39 68 22
39 69 3A
39 6A 22
39 6B 42
39 6C 22
39 6D 46
39 6E 21
39 6F 32
39 70 21
39 71 34


39 80 20
39 81 3A
39 82 20
39 83 39
39 84 20
39 85 39
39 86 20
39 87 31
39 88 20
39 89 33
39 8A 20
39 8B 34
39 8C 20
39 8D 30
39 8E 21
39 8F 45
39 90 21
39 91 42
39 92 21
39 93 3F
39 94 21
39 95 40
39 96 21
39 97 47
39 98 20
39 99 3C
39 9A 21
39 9B 46
39 9C 21
39 9D 48
39 9E 21
39 9F 41
39 A0 21
39 A1 44
39 A2 20
39 A3 3D
39 A4 20
39 A5 36
39 A6 20
39 A7 38
39 A8 20
39 A9 3E
39 AA 20
39 AB 35
39 AC 20
39 AD 3B
39 AE 20
39 AF 32
39 B0 20
39 B1 37

39 FF 78 07 0E
39 00 A3
39 B9 CC
39 02 0F
39 04 06
39 13 04
39 41 14
39 42 02
39 43 14
39 44 82
39 40 03
39 45 0B
39 46 72
39 47 20
39 49 5B
39 B0 01
39 B1 68
39 C0 02
39 C2 68
39 C3 68
39 C4 68
39 C5 68
39 C6 68
39 C7 68
39 C8 68
39 C9 68
39 4D CF
39 50 00
39 4B 18
39 05 20
39 E0 01
39 E2 0A
39 E3 2E
39 E5 06

39 FF 78 07 1E
39 BD 02 
39 B1 11
39 61 17
39 63 17
39 60 0B
39 65 0B
39 66 0D
39 67 00
39 69 C9
39 6B 18
39 16 5E
39 1E 5E
39 1F 5E
39 6D BB
39 70 00
39 B4 28
39 B5 60
39 B6 8C
39 B7 1A
39 BA 00
39 20 00
39 22 09
39 23 2C
39 24 06
39 C9 02
39 C0 1F
39 C1 00
39 C2 1C
39 C3 1C
39 C4 1A
39 C7 00
	
39 FF 78 07 00
39 11 00
39 29 00 
39 35 00
05 11 00
ff 78
05 29 00
ff 05

<span class="nt">&lt;/DSIInitSequence&gt;</span>
<span class="nt">&lt;DSITermSequence&gt;</span>
 05 28
 FF 14
 05 10
 FF 78
<span class="nt">&lt;/DSITermSequence&gt;</span>
<span class="nt">&lt;Group</span> <span class="na">id=</span><span class="s">&#39;Backlight Configuration&#39;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;BacklightType&gt;</span>1<span class="nt">&lt;/BacklightType&gt;</span>
 <span class="nt">&lt;BacklightPmicControlType&gt;</span>2<span class="nt">&lt;/BacklightPmicControlType&gt;</span>
 <span class="nt">&lt;DisplayResetInfo&gt;</span>0 10 10000 10000 0<span class="nt">&lt;/DisplayResetInfo&gt;</span>
<span class="nt">&lt;/Group&gt;</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>3.添加定义<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BOOT.XF.4.1\boot_images\QcomPkg\Include\Library</span></code> MDPPlatformLib.h中定义了 <code class="docutils literal notranslate"><span class="pre">MDPPlatformPanelType</span></code>：</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/Include/Library/MDPPlatformLib.h</span><span class="w"></span>
<span class="gi">+++ b/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/Include/Library/MDPPlatformLib.h</span><span class="w"></span>
<span class="gu">@@ -108,20 +108,14 @@ typedef enum {</span><span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_BOE_AMOLED_FHD_DSC_CMD,               /* BOE AMOLED fhd plus cmd panel DSC mode single dsi */<span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_TRULY_RM69298_AMOLED_FHD_CMD,         /* Truly rm69298 amoled fhd cmd panel single dsi */<span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_TRULY_RM69298_AMOLED_FHD_VIDEO,       /* Truly rm69298 amoled fhd video panel single dsi*/<span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_TD4330_TRULY_FHD_CMD,                 /* td4330 cmd mode dsi truly panel (Nicobar) */</span><span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_TD4330_TRULY_FHD_VIDEO,               /* td4330 video mode dsi truly panel (Nicobar) */</span><span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_TD4330_V2_TRULY_FHD_CMD,              /* td4330 cmd mode dsi truly panel  */<span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_TD4330_V2_TRULY_FHD_VIDEO,            /* td4330 video mode dsi truly panel */<span class="w"></span>
<span class="gd">-  MDDPLATFORM_PANEL_NT36672_TRUKY_FHD_VIDEO,              /* nt36672 truly 9:21 video mode */</span><span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_NT36525_TRULY_HDPLUS_VIDEO,           /* nt36525 truly hdplus video mode */<span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_R66451_AMOLED_HDPLUS_CMD,                    /* r66451 hd plus 90hz cmd mode */</span><span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_R66451_AMOLED_HDPLUS_VIDEO,                          /* r66451 hd plus 90hz video mode */</span><span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_NT36672E_90HZ_FHD_PLUS_VIDEO,         /* nt36672e 90hz fhd plus video mode */</span><span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_NT36672E_120HZ_FHD_PLUS_VIDEO,        /* nt36672e 120hz fhd plus video mode */</span><span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_EXT_BRIDGE_1080P_VIDEO,               /* External bridge 1080p vid */</span><span class="w"></span>
<span class="gd">-  MDPPLATFORM_PANEL_ILI9881C_720P_VIDEO,                  /* ILI9881C lcd video mode panel */</span><span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_HX8394F_720P_VIDEO,<span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_ILI9881D_720P_VIDEO,<span class="w"></span>
<span class="gi">+  MDPPLATFORM_PANEL_ILI7807S_1080P_VIDEO, //30</span><span class="w"></span>
<span class="gi">+  MDPPLATFORM_PANEL_ILI9881C_720P_VIDEO,                  /* ILI9881C lcd video mode panel */</span><span class="w"></span>
<span class="gi">+  MDPPLATFORM_PANEL_EXT_BRIDGE_1080P_VIDEO,               /* External bridge 1080p vid */</span><span class="w"></span>
<span class="w"> </span>  MDPPLATFORM_PANEL_MAX<span class="w"></span>
<span class="w"> </span>} MDPPlatformPanelType;<span class="w"></span>
</pre></div>
</div>
<p>去掉一部分是因为该枚举数需要和上下电时序里的数组序号对应上，比如<code class="docutils literal notranslate"><span class="pre">MDPPLATFORM_PANEL_ILI7807S_1080P_VIDEO</span></code>是30，那<code class="docutils literal notranslate"><span class="pre">sMDPPlatformPanelFunction[MDPPLATFORM_PANEL_MAX]</span></code>中对应的序号也是30才对应得上，下面会讲。</p>
</section>
<section id="id7">
<h3>4.定义上下电时序<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BOOT.XF.4.1\boot_images\QcomPkg\SocPkg\AgattiPkg\Library\MDPPlatformLib</span></code>:</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/Library/MDPPlatformLib/MDPPlatformLibPanelConfig.h</span><span class="w"></span>
<span class="gi">+++ b/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/Library/MDPPlatformLib/MDPPlatformLibPanelConfig.h</span><span class="w"></span>
<span class="gu">@@ -208,6 +208,16 @@ MDPPlatformPanelFunctionTable sMDPPlatformPanelFunction[MDPPLATFORM_PANEL_MAX] =</span><span class="w"></span>
<span class="w"> </span>    Panel_Default_Peripheral_Power,                                       // pPanel_Peripheral_Power<span class="w"></span>
<span class="w"> </span>    Panel_Default_Brightness_Enable,                                  // pPanel_Brightness_Enable<span class="w"></span>
<span class="w"> </span>    Panel_Default_Brightness_Level                                        // pPanel_Brightness_Level<span class="w"></span>
<span class="gi">+  },</span><span class="w"></span>
<span class="gi">+   { /* Pax Panel */</span><span class="w"></span>
<span class="gi">+    MDPPLATFORM_PANEL_ILI7807S_1080P_VIDEO,                       // ePanelSelected</span><span class="w"></span>
<span class="gi">+    &quot;Panel_ili7807s_1080p_video.xml&quot;,                                 // pPanelXmlConfig</span><span class="w"></span>
<span class="gi">+    Panel_Default_PowerUp,                                                    // pPanel_PowerUp</span><span class="w"></span>
<span class="gi">+    Panel_Default_PowerDown,                                              // pPanel_PowerDown</span><span class="w"></span>
<span class="gi">+    Panel_Default_Reset,                                                      // pPanel_Reset</span><span class="w"></span>
<span class="gi">+    Panel_Default_Peripheral_Power,                                       // pPanel_Peripheral_Power</span><span class="w"></span>
<span class="gi">+    Panel_Default_Brightness_Enable,                                  // pPanel_Brightness_Enable</span><span class="w"></span>
<span class="gi">+    Panel_Default_Brightness_Level                                        // pPanel_Brightness_Level</span><span class="w"></span>
<span class="w"> </span>  },<span class="w"></span>
</pre></div>
</div>
</section>
<section id="fastbootpanel">
<h3>5.增加fastboot模式下panel<a class="headerlink" href="#fastbootpanel" title="此标题的永久链接"></a></h3>
<p>fastboot模式会选择<code class="docutils literal notranslate"><span class="pre">fastBootPanelList</span></code>中作为panel：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gu">@@ -197,6 +211,8 @@ const PanelDTInfoType fastBootPanelList[] =</span><span class="w"></span>
<span class="w"> </span>  PANEL_CREATE_ENTRY(&quot;hx8394f_720p_video&quot;,               MDPPLATFORM_PANEL_HX8394F_720P_VIDEO,         &quot;qcom,mdss_dsi_hx8394f_720p_video:&quot;,  DISP_INTF_DSI,  DISP_TOPOLOGY_CONFIG_NONE,  DISP_TIMING_CONFIG_N<span class="w"></span>
<span class="w">ONE,        PLL_OVERRIDE_NONE, DISP_MODE_SINGLE_DSI,                 DISP_MODE_SINGLE_DSI,                        DISP_MODE_SINGLE_DSI),</span>
<span class="w"> </span>  PANEL_CREATE_ENTRY(&quot;ili9881d_720p_video&quot;,             MDPPLATFORM_PANEL_ILI9881D_720P_VIDEO,         &quot;qcom,mdss_dsi_ili9881d_720p_video:&quot;,  DISP_INTF_DSI,  DISP_TOPOLOGY_CONFIG_NONE,  DISP_TIMING_CONFIG_<span class="w"></span>
<span class="w">NONE,    PLL_OVERRIDE_NONE, DISP_MODE_SINGLE_DSI,                 DISP_MODE_SINGLE_DSI,                    DISP_MODE_SINGLE_DSI),</span>

<span class="gi">+  PANEL_CREATE_ENTRY(&quot;ili7807S_1080p_video&quot;,            MDPPLATFORM_PANEL_ILI7807S_1080P_VIDEO,        &quot;qcom,mdss_dsi_ili7807S_1080p_video:&quot;,  DISP_INTF_DSI,  DISP_TOPOLOGY_CONFIG_NONE,  DISP_TIMING_CONFIG</span><span class="w"></span>
<span class="w">_NONE,    PLL_OVERRIDE_NONE, DISP_MODE_SINGLE_DSI,                DISP_MODE_SINGLE_DSI,                    DISP_MODE_SINGLE_DSI),</span>
<span class="gi">+</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="xml">
<h3>6.指定xml地址<a class="headerlink" href="#xml" title="此标题的永久链接"></a></h3>
<p>配置<code class="docutils literal notranslate"><span class="pre">Display</span> <span class="pre">panel</span> <span class="pre">configuration</span> <span class="pre">xml</span></code>时需要增加一个<code class="docutils literal notranslate"><span class="pre">Guid</span></code>，就是唯一标识，可以由以下工具生成：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.guidgenerator.com/online-guid-generator.aspx">Online GUID</a></p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/LAA/Core.fdf</span><span class="w"></span>
<span class="gi">+++ b/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/LAA/Core.fdf</span><span class="w"></span>
<span class="gu">@@ -444,6 +444,11 @@ FvNameGuid         = 631008B0-B2D1-410A-8B49-2C5C4D8ECC7E</span><span class="w"></span>
<span class="w"> </span>    SECTION UI = &quot;Panel_ili9881d_720p_video.xml&quot;<span class="w"></span>
<span class="w"> </span>    SECTION RAW = QcomPkg/Settings/Panel/Panel_ili9881d_720p_video.xml<span class="w"></span>
<span class="w"> </span>  }<span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+  FILE FREEFORM = b04153d9-84e9-4660-872c-47aed4572f2b {</span><span class="w"></span>
<span class="gi">+    SECTION UI = &quot;Panel_ili7807s_1080p_video.xml&quot;</span><span class="w"></span>
<span class="gi">+    SECTION RAW = QcomPkg/Settings/Panel/Panel_ili7807s_1080p_video.xml</span><span class="w"></span>
<span class="gi">+  }</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="id8">
<h2>代码流程<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h2>
<p>根据配置文件<code class="docutils literal notranslate"><span class="pre">QcomPkg/SocPkg/AgattiPkg/LAA/Core.fdf</span></code>增加了显示驱动，在fdf文件中包含所有的inf文件所在路径：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>  # Display/MDP DXE driver
  #
  INF QcomPkg/Drivers/DisplayDxe/DisplayDxe.inf

QcomPkg/Drivers/DisplayDxe/DisplayDxe.inf：
[Defines]
  INF_VERSION                    = 0x00010005
  BASE_NAME                      = DisplayDxe
  FILE_GUID                      = 4138022F-06C7-4f79-9C94-7E33B511A4E7
  MODULE_TYPE                    = DXE_DRIVER
  VERSION_STRING                 = 1.0
  ENTRY_POINT                    = DisplayDxeInitialize //定义入口函数
</pre></div>
</div>
<p>以下是MDP初始化屏的流程：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>* DisplayDxeInitialize //入口函数
  ├── MDPInit(MDP_InitParamsType *pMDPInitParams, uint32 uFlags) //Drivers/DisplayDxe/DisplayDxe.c
  │   └── MDPPlatformConfigure(MDP_DISPLAY_PRIMARY, MDPPLATFORM_CONFIG_GETPLATFORMINFO, &amp;sPlatformParams) //QcomPkg/SocPkg/DivarPkg/Library/MDPPlatformLib/MDPPlatformLib.c
  │       └── case MDPPLATFORM_CONFIG_GETPANELCONFIG: //上面函数第二个参数
  │           └── case MDP_DISPLAY_PRIMARY: //上面函数第一个参数
  │               ├── *pPanelList = &amp;uefiPanelList[0]; //这里写死只有一个屏，uefiPanelList里面就是指定屏的参数，包括id
  │               ├── if (MDP_STATUS_OK == DynamicDSIPanelDetection(&amp;sPlatformPanel, &amp;uPanelID, pPanelList, uPanelCnt) //根据pPanelList匹配屏的panel
  │               │   └── if (MDP_STATUS_OK == DSIDriver_MinimalInit()) //DSI驱动minimal初始化
  │               │       ├── if (MDP_STATUS_OK != DSIDriver_ConfigClockLane(uClkConfig))
  │               │       ├── if (MDP_STATUS_OK != DSIDriver_RemapLane(pPanelList[uPanelIndex].uLaneRemapOrder))
  │               │       ├── MDP_OSAL_MEMZERO(panelID, PLATFORM_PANEL_ID_MAX_COMMANDS); //清空panelID数组
  │               │       └── for(iCommandIndex = 0; iCommandIndex&lt;PLATFORM_PANEL_ID_MAX_COMMANDS; iCommandIndex++) //PLATFORM_PANEL_ID_MAX_COMMANDS = 3，也就是连续读三次，读到了即返回。
  │               │           ├── DSIDriver_Read(pPanelList[uPanelIndex].uCmdType,pPanelList[uPanelIndex].panelIdCommands[iCommandIndex].address,  //这里是uefiPanelList中读取display id的，貌似暂时没用
  │               │           ├── if (0 == CompareMem(readback, pPanelList[uPanelIndex].panelIdCommands[iCommandIndex].expectedReadback, readSize)) //比较读取到的id和uefiPanelList中expect值是否一致
  │               │           │   ├── panelID[iCommandIndex] = readback[0];// store the first byte of readback as panel ID
  │               │           │   └── bMatch = TRUE; // mark one panel ID matched
  │               │           └── pPlatformPanel-&gt;eSelectedPanel  = pPanelList[uPanelIndex].eSelectedPanel; //保存选取的panel
  │               ├── if (MDP_STATUS_OK != FindPanelIndex(&amp;sPlatformPanel))//需要重做映射 eSelectedPanle 到 uSelectedPanleIndex 以防检测到较新的 eSelectedPanel
  │               └── if(MDP_STATUS_OK != GetPanelXmlConfig(&amp;sPlatformPanel)) //获取xml文件
  │                   ├── pPlatformParams-&gt;sPlatformPanel.pPanelXMLConfig = (int8 *)dummy_xmldata; //如果获取不到赋值一个dummy空的panel
  │                   ├── else MDP_OSAL_MEMCPY(&amp;pPlatformParams-&gt;sPlatformPanel, &amp;sPlatformPanel, sizeof(MDPPlatformPanelInfo));//否则正常走这里，拷贝xml数据
  │                   └── Display_Utils_LoadFile(sMDPPlatformPanelFunction[pPlatformPanel-&gt;uSelectedPanelIndex].pPanelXml,
  │                       └── ReadFromFV(LogoFile, (void **)Buffer, &amp;BufferSizeN); //从logo文件中读取？ 
  └── MDPDetect(MDP_DISPLAY_PRIMARY, &amp;sDetectParams, 0x0) //Default reporting of primary display
      ├── case MDP_DISPLAY_PRIMARY:
      │   └── MDPDetectPanel(eDisplayId, pDisplayInfo) //Panel detection code, via XML, I2C or EDID
      │       └── pDisplayInfo-&gt;bDetected  = TRUE; //暂时不做分析
      └── Display_Utils_SetPanelConfiguration(eSelectedPanel); //Update ABL with selected panel info 
          └── UpdatePanelConfiguration(eSelected, pConfigStr);
              └── panelConfigOutput(pDisplayParams-&gt;sPrimary.psDTInfo, 1, pDisplayParams-&gt;sPrimary.eTopologyCfg, pDisplayParams-&gt;sPrimary.eTimingCfg, &amp;pStr);
                  └── if (primary)
                      ├── #define DISPLAY_CMDLINE_DSI_PRIMARY           &quot; msm_drm.dsi_display0=&quot;   // Panel config prefix
                      ├── LocalAsciiStrnCat(*ppStr, PANEL_CONFIG_STR_LEN_MAX, DISPLAY_CMDLINE_DSI_PRIMARY); // 设置display cmdline 重要
                      └── (*ppStr) += AsciiStrLen(DISPLAY_CMDLINE_DSI_PRIMARY);
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h1>调试<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h1>
<section id="id10">
<h2>1.无法获取xml文件<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<p>xbl按照文档操作增加新屏后机器获取不到panel，用的是dummy，打印如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>HW Wdog Setting from PCD : Disabled
PM0: 55,
Setvariable returned Success
DisplayDxe: Resolution 640x480 (1 intf)
MinidumpTADxe: Minidump TA loading not enabled.
Disp init wait [ 1736]
-----------------------------
Platform Init  [ 1779] BDS
UEFI Ver   : 5.0.220714.BOOT.XF.4.1-00343-KAMORTALAZ-1
Platform           : IDP
Chip Name          : QCM_AGATTI
Chip Ver           : 1.0
Chip Serial Number : 0xC54520C0
</pre></div>
</div>
<ul class="simple">
<li><p>开发板自带屏打印如下：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>addr:FFDB0C50 readback[0] = 0
addr:FFDB0C50 readback[1] = 0
Detected panel id:00980000 pPlatformPanel-&gt;eSelectedPanel = 30
wugn Detected panel id:00980000 pPlatformPanel-&gt;eSelectedPanel = 30 bMatch = 1
wugn test1 uPanelId = 9961472
Status = 0
DeStatus 0  pPlatformPanel-&gt;uSelectedPanelIndex = 30 xml = Pnlii81_2pvdoxlPnlii87_00_ie.mwugn test1 Copy the panel configurations
wugn test2 uPanelId = 9961472
wugn DisplayDxe: Resolution 720x1280 (1 intf) pPanelInfo-&gt;eSelectedPanel = 30
MinidumpTADxe: Minidump TA loading not enabled.
Disp init wait [ 2588]
</pre></div>
</div>
<p>添加打印,改成30也不行。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadFromFV</span><span class="p">(</span><span class="n">LogoFile</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">Buffer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BufferSizeN</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">Buffer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_LOAD_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="w">	  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	  </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Display_Utils_LoadFile: 44444.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">	  	</span><span class="p">}</span><span class="w"></span>
<span class="w">	  </span><span class="k">else</span><span class="w"></span>
<span class="w">	  	</span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Display_Utils_LoadFile: 555555.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">	  </span><span class="p">}</span><span class="w"></span>
<span class="w">	  </span><span class="k">if</span><span class="p">(</span><span class="n">Buffer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">	  </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Buffer is not null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">	  </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">*</span><span class="n">RetSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UINT32</span><span class="p">)</span><span class="w"> </span><span class="n">BufferSizeN</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>打印如下，说明ReadFromFV返回失败，不是buffer为空，具体不知道什么原因。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">addr</span><span class="p">:</span><span class="n">FFDB0C50</span> <span class="n">readback</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">addr</span><span class="p">:</span><span class="n">FFDB0C50</span> <span class="n">readback</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">wugn</span> <span class="n">Detected</span> <span class="n">panel</span> <span class="nb">id</span><span class="p">:</span><span class="mi">00000000</span> <span class="n">pPlatformPanel</span><span class="o">-&gt;</span><span class="n">eSelectedPanel</span> <span class="o">=</span> <span class="mi">30</span> <span class="n">bMatch</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Status</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">Display_Utils_LoadFile</span><span class="p">:</span> <span class="mf">44444.</span>
<span class="n">Buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">null</span>
<span class="n">Display_Utils_LoadFile</span> <span class="n">fail</span>
<span class="n">xml</span> <span class="o">=</span> <span class="n">Pnlh89f70_ie</span><span class="o">.</span><span class="n">mDeStatus</span> <span class="mi">5</span>  <span class="n">pPlatformPanel</span><span class="o">-&gt;</span><span class="n">uSelectedPanelIndex</span> <span class="o">=</span> <span class="mi">30</span> <span class="n">xml</span> <span class="o">=</span> <span class="n">Pnlii87_00_ie</span><span class="o">.</span><span class="n">mwugn</span> <span class="n">test1</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">panel</span> <span class="ow">not</span> <span class="n">ok</span> <span class="n">eSelectedPanel</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">wugn</span> <span class="n">test2</span> <span class="n">uPanelId</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">wugn</span> <span class="n">DisplayDxe</span><span class="p">:</span> <span class="n">Resolution</span> <span class="mi">640</span><span class="n">x480</span> <span class="p">(</span><span class="mi">1</span> <span class="n">intf</span><span class="p">)</span> <span class="n">pPanelInfo</span><span class="o">-&gt;</span><span class="n">eSelectedPanel</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>
</div>
<p>后面发现原装屏在<code class="docutils literal notranslate"><span class="pre">QcomPkg/SocPkg/AgattiPkg/LAA/Core.fdf</span></code>路径下配置了如下信息，新屏增加如下即可：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/LAA/Core.fdf</span><span class="w"></span>
<span class="gi">+++ b/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/LAA/Core.fdf</span><span class="w"></span>
<span class="gu">@@ -444,6 +444,11 @@ FvNameGuid         = 631008B0-B2D1-410A-8B49-2C5C4D8ECC7E</span><span class="w"></span>
<span class="w"> </span>    SECTION UI = &quot;Panel_ili9881d_720p_video.xml&quot;<span class="w"></span>
<span class="w"> </span>    SECTION RAW = QcomPkg/Settings/Panel/Panel_ili9881d_720p_video.xml<span class="w"></span>
<span class="w"> </span>  }<span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+  FILE FREEFORM = b04153d9-84e9-4660-872c-47aed4572f2b {</span><span class="w"></span>
<span class="gi">+    SECTION UI = &quot;Panel_ili7807s_1080p_video.xml&quot;</span><span class="w"></span>
<span class="gi">+    SECTION RAW = QcomPkg/Settings/Panel/Panel_ili7807s_1080p_video.xml</span><span class="w"></span>
<span class="gi">+  }</span><span class="w"></span>
</pre></div>
</div>
<p>成功打印如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>addr:FFDB2C50 readback[0] = 0
addr:FFDB2C50 readback[1] = 0
wugn Detected panel id:00000000 pPlatformPanel-&gt;eSelectedPanel = 31 bMatch = 0
Status = 0
DeStatus 0  pPlatformPanel-&gt;uSelectedPanelIndex = 31 xml = Pnlii87_00_ie.mwugn test1 Copy the panel configurati                                                                                               ons
wugn test2 uPanelId = 0
wugn DisplayDxe: Resolution 1080x2408 (1 intf) pPanelInfo-&gt;eSelectedPanel = 31
MinidumpTADxe: Minidump TA loading not enabled.
Disp init wait [ 1723]
input CTRL+C enter ALLPIN mode
</pre></div>
</div>
</section>
<section id="id11">
<h2>2.kernel调试<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h2>
<p>xbl调通了，kernel继续报错重启如下，没找到panel，没找到reset gpio引脚：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>[    5.302352] [drm:dsi_ctrl_dev_probe] [msm-dsi-info]: dsi-ctrl-0: Probe successful
[    5.310951] OF: graph: no port node found in /soc/qcom,dsi-display-primary
[    5.317957] [drm:dsi_panel_get] *ERROR* [msm-dsi-error]: [ili7807s video mode dsi panel without DSC] failed get reset gpio, rc=-2
[    5.329659] [drm:dsi_panel_get] *ERROR* [msm-dsi-error]: failed to parse panel gpios, rc=-2
[    5.338041] [drm:dsi_display_init] *ERROR* [msm-dsi-error]: failed to get panel, rc=-2
[    5.345987] [drm:dsi_display_init] *ERROR* [msm-dsi-error]: [(null)] failed to initialize resources, rc=-2
[    5.355688] [drm:dsi_display_init] *ERROR* [msm-dsi-error]: device init failed, rc=-2
[    5.363560] msm-dsi-display: probe of soc:qcom,dsi-display-primary failed with error -2

[   11.164824] [drm:msm_pdev_shutdown] *ERROR* invalid drm device node
[   11.171551] reboot: Restarting system with command &#39;userrequested,recovery&#39;
[   11.178566] Going down for restart now
</pre></div>
</div>
<p>dts里面检索一下ili9881d，按照ili9881d的dts全部重新配置 一遍：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>wugn@jcrj-tf-compile:a665x$ ack ili9881d
scuba-sde-display.dtsi
6:#include &quot;dsi-panel-ili9881d-720p-video.dtsi&quot;
145:&amp;dsi_ili9881d_720p_video {

dsi-panel-ili9881d-720p-video.dtsi
14:     dsi_ili9881d_720p_video: qcom,mdss_dsi_ili9881d_720p_video {
15:             qcom,mdss-dsi-panel-name =&quot;ili9881d video mode dsi panel without DSC&quot;;

scuba-iot-idp.dtsi
107:&amp;dsi_ili9881d_720p_video {
197:            panel = &lt;&amp;dsi_ili9881d_720p_video&gt;;
</pre></div>
</div>
<p>重新整合一下dts如下：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/UM.9.15/vendor/qcom/proprietary/devicetree-4.19/qcom/a665x/a665x-scuba-iot-idp-overlay.dts</span><span class="w"></span>
<span class="gi">+++ b/UM.9.15/vendor/qcom/proprietary/devicetree-4.19/qcom/a665x/a665x-scuba-iot-idp-overlay.dts</span><span class="w"></span>
<span class="gu">@@ -3,6 +3,7 @@</span><span class="w"></span>

<span class="w"> </span>#include &lt;dt-bindings/interrupt-controller/arm-gic.h&gt;<span class="w"></span>
<span class="w"> </span>#include &quot;scuba-iot-idp.dtsi&quot;<span class="w"></span>
<span class="gi">+#include &quot;dsi-panel-ili7807s-1080p-video.dtsi&quot;</span><span class="w"></span>

<span class="w"> </span>/ {<span class="w"></span>
<span class="w"> </span>       model = &quot;Qualcomm Technologies, Inc. Scuba IOT IDP&quot;;<span class="w"></span>
<span class="gu">@@ -314,4 +315,37 @@</span><span class="w"></span>
<span class="w"> </span>               otg-output-current-limit = &lt;2100&gt;;      /* Boost output current limit, Range 500-1500-2100-3000 ma */<span class="w"></span>
<span class="w"> </span>               irq-pin = &lt;&amp;tlmm 86 GPIO_ACTIVE_HIGH&gt;;<span class="w"></span>
<span class="w"> </span>       };<span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+&amp;sde_dsi {</span><span class="w"></span>
<span class="gi">+       qcom,dsi-default-panel = &lt;&amp;dsi_ili7807s_1080p_video&gt;;</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+&amp;dsi_ili7807s_1080p_video {</span><span class="w"></span>
<span class="gi">+       qcom,dsi-select-clocks = &quot;mux_byte_clk0&quot;, &quot;mux_pixel_clk0&quot;;</span><span class="w"></span>
<span class="gi">+       qcom,mdss-dsi-t-clk-post = &lt;0x0e&gt;; //60 fps</span><span class="w"></span>
<span class="gi">+       qcom,mdss-dsi-t-clk-pre = &lt;0x34&gt;;</span><span class="w"></span>
<span class="gi">+       qcom,panel-supply-entries = &lt;&amp;dsi_panel_pwr_supply&gt;;</span><span class="w"></span>
<span class="gi">+       qcom,mdss-dsi-bl-pmic-control-type = &quot;bl_ctrl_pwm&quot;;</span><span class="w"></span>
<span class="gi">+       pwms = &lt;&amp;pm2250_pwm3 0 0&gt;;</span><span class="w"></span>
<span class="gi">+       qcom,bl-pmic-pwm-period-usecs = &lt;100&gt;;</span><span class="w"></span>
<span class="gi">+       qcom,mdss-dsi-bl-min-level = &lt;1&gt;;</span><span class="w"></span>
<span class="gi">+       qcom,mdss-dsi-bl-max-level = &lt;255&gt;;</span><span class="w"></span>
<span class="gi">+       qcom,platform-te-gpio = &lt;&amp;tlmm 81 0&gt;;</span><span class="w"></span>
<span class="gi">+       qcom,platform-reset-gpio = &lt;&amp;tlmm 82 0&gt;;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+       qcom,mdss-dsi-display-timings {</span><span class="w"></span>
<span class="gi">+               timing@0{</span><span class="w"></span>
<span class="gi">+                       qcom,mdss-dsi-panel-phy-timings =</span><span class="w"></span>
<span class="gi">+                       [</span><span class="w"></span>
<span class="gi">+                        25 1e 08 0a 06 02 04 0a //60 fps</span><span class="w"></span>
<span class="gi">+                        25 1e 08 0a 06 02 04 0a</span><span class="w"></span>
<span class="gi">+                        25 1e 08 0a 06 02 04 0a</span><span class="w"></span>
<span class="gi">+                        25 1e 08 0a 06 02 04 0a</span><span class="w"></span>
<span class="gi">+                        21 1f 09 0a 06 02 04 0a</span><span class="w"></span>
<span class="gi">+                       ];</span><span class="w"></span>
<span class="gi">+                       qcom,display-topology = &lt;1 0 1&gt;;</span><span class="w"></span>
<span class="gi">+                       qcom,default-topology-index = &lt;0&gt;;</span><span class="w"></span>
<span class="gi">+               };</span><span class="w"></span>
<span class="gi">+       };</span><span class="w"></span>
<span class="w"> </span>};<span class="w"></span>
</pre></div>
</div>
</section>
<section id="esd">
<h2>3.ESD检测功能<a class="headerlink" href="#esd" title="此标题的永久链接"></a></h2>
<p>下面以 reg_read 方式对 esd 功能配置和代码实现流程进行分析Esd 配置在不同平台，配置会有些许差异在 Android9 平台配置需要配置如下参数：
qcom,esd-check-enabled;</p>
<ul class="simple">
<li><p>–&gt;打开 esd 检测开关
qcom,mdss-dsi-panel-status-check-mode = “reg_read”;</p></li>
<li><p>–&gt;选择 esd 控制方式
qcom,mdss-dsi-panel-status-command = [06 01 00 01 00 00 01 0a];</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>其中第一个参数 表示这行帧命令的类型
第七个参数 表示读取几个寄存器，有时一个参数判断域 导致 esd 机制不生效，这是需要多加几个寄存器，实现更严格的 esd 检测
第八个参数 表示读取的寄存器的地址
</pre></div>
</div>
<p>qcom,mdss-dsi-panel-status-command-state = “dsi_hs_mode”;</p>
<ul class="simple">
<li><p>esd 状态检测模式</p>
<ul>
<li><p>D-PHY 的物理层支持 HS(High Speed)和 LP(Low Power)两种工作模式</p></li>
<li><p>HS 模式：低压查分信号 功耗大 高速率（80M -1Gbps） 信号幅值（100mv-300mv）</p></li>
<li><p>LP 模式：单端信号 功耗小，速率低（&lt; 10Mbps) 信号幅值（0-1.2V）</p></li>
</ul>
</li>
<li><p>qcom,mdss-dsi-panel-status-value = &lt;0x9c&gt;;
预设的值，用来和寄存器读取的值进行比较， 判断当前 LCD 状态是否正常</p></li>
<li><p>qcom,mdss-dsi-panel-status-read-length = &lt;1&gt;;
读取长度</p></li>
<li><p>Android10 平台区别于 Android9 需要修改如下参数</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qcom</span><span class="p">,</span><span class="n">mdss</span><span class="o">-</span><span class="n">dsi</span><span class="o">-</span><span class="n">panel</span><span class="o">-</span><span class="n">status</span><span class="o">-</span><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="mi">06</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">01</span> <span class="mi">05</span> <span class="mi">00</span> <span class="mi">01</span> <span class="mi">0</span><span class="n">a</span><span class="p">];</span>
<span class="n">qcom</span><span class="p">,</span><span class="n">mdss</span><span class="o">-</span><span class="n">dsi</span><span class="o">-</span><span class="n">panel</span><span class="o">-</span><span class="n">status</span><span class="o">-</span><span class="n">command</span><span class="o">-</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;dsi_lp_mode&quot;</span>
</pre></div>
</div>
<section id="id12">
<h3>代码流程<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>在 dtsi 中配置 qcom,mdss-dsi-panel-status-check-mode = “reg_read”;</p>
<ul>
<li><p>mdss_check_dsi_ctrl_status() ——&gt;&gt;&gt;&gt;中断函数，通过设置中断，几秒检测一次 esd的状态， ESD 检测线程唤醒时间不建议修改，过于频繁的唤醒 ESD 线程，会增加系统负荷，2s-5s 是内部考量后较为合理的时间选择，建议保持</p></li>
<li><p>mdss_dsi_reg_status_check –&gt;&gt;&gt;&gt;
mdss_dsi_read_status 读取 esd 的寄存器状态，判断是否能通过 mdss-dsi-panel-statuscommand 命令读到寄存器的值——&gt;&gt;&gt;&gt;</p></li>
<li><p>rc=mdss_dsi_cmdlist_put(ctrl,&amp;cmdreq);–判断当前寄存器状态，如果不对，再判断是否触发同步等待原因</p></li>
<li><p>ret= ctrl-&gt;cmdlist_commit(ctrl,0);</p></li>
<li><p>mdss_dsi_cmdlist_commit(ctrl_pdata,1);</p></li>
<li><p>—&gt;&gt;&gt;&gt; ret = mdss_dsi_cmdlist_rx(ctrl, req);判断当前函数命令的帧类型是否正确（目前常用的帧类型有 04 06 14 24）</p></li>
<li><p>—&gt;&gt;&gt;&gt;len = mdss_dsi_cmds_rx(ctrl, req-&gt;cmds, req-&gt;rlen,(req-&gt;flags &amp; CMD_REQ_DMA_TPG));</p></li>
<li><p>—&gt;&gt;&gt;&gt;mdss_dsi_gen_read_status 比较寄存器状态，可以在该函数中添加以下打印来读取屏参寄存器</p></li>
<li><p>pr_info(“%s:LCD esd check status vaule = %x\n”,<strong>func</strong>,ctrl_pdata-&gt;status_buf.data[0]);</p></li>
</ul>
</li>
</ul>
<p>调试代码时可以添加如下更加详细的 patch 进行分析代码流程逻辑，看 esd 状态是卡在哪个流程函数中。</p>
</section>
</section>
<section id="id13">
<h2>4.xbl阶段增加寄存器<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h2>
<p>供应商提供如下寄存器：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>//Stop reload
        SSD_SEND(0x41,0x5A);
 
//SPI Not LoadFinish
        SSD_SEND(0x41,0x5A,0x24);
        SSD_SEND(0x90,0x5A);
//VCOM
        SSD_SEND(0x41,0x5A,0x03);
        SSD_SEND(0x80,0xd0,0x00);
//SPI FINISH
        SSD_SEND(0x42,0x24);
        SSD_SEND(0x90,0x00);
//Blank select 2F 
        SSD_SEND(0x41,0x5A,0x2F);
        SSD_SEND(0x19,0x01);
//INT CANCEL
        SSD_SEND(0x4C,0x03);
DCS_Short_Write_NP(0x11);
Delay (120);
DCS_Short_Write_NP(0x29);
Delay(50);
</pre></div>
</div>
<ul class="simple">
<li><p>修改：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>&lt;DSIInitSequence&gt;
39 41 5A
39 41 5A 24
39 90 5A
39 41 5A 03
39 80 D0 00
39 42 24
39 90 00
39 41 5A 2F
39 19 01
39 4C 03
05 11 00
ff 78
05 29 00
ff 05

&lt;/DSIInitSequence&gt;
</pre></div>
</div>
</section>
<section id="id14">
<h2>5.多屏兼容调试<a class="headerlink" href="#id14" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>目前是只读到了DA并且匹配上了，其他的都是0：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>FindPanelIndex: Panel Id=29 found
uPanelIndex: 0 address:000000DA readback[0]:00000033
iCommandIndex: 0 bMatch OK readback:00000033 expectedReadback:00000033
uPanelIndex: 0 address:000000DB readback[1]:00000000
iCommandIndex: 1 bMatch OK readback:00000000 expectedReadback:00000000
uPanelIndex: 0 address:000000DC readback[2]:00000000
iCommandIndex: 2 bMatch OK readback:00000000 expectedReadback:00000000
Detected panel id:00000023
Detected panel id:00000023 pPlatformPanel-&gt;eSelectedPanel = 35 bMatch = 1
FindPanelIndex: Panel Id=29 found
</pre></div>
</div>
<ul class="simple">
<li><p>使用dump register功能dump出来确实又有写入：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x00D8</span>   <span class="mh">0x00000000</span> <span class="mh">0x00000000</span> <span class="mh">0x00000033</span> <span class="mh">0x000000CD</span>
<span class="mh">0x00DC</span>   <span class="mh">0x00000004</span> <span class="mh">0x00000000</span> <span class="mh">0x00000000</span> <span class="mh">0x00000000</span>
</pre></div>
</div>
<p>代码中只要读到一个寄存器匹配上就直接跳出了，修改需要3个寄存器同时满足匹配才算match ok：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/Library/MDPPlatformLib/MDPPlatformLib.c</span><span class="w"></span>
<span class="gi">+++ b/A665x_Unpacking_Tool/BOOT.XF.4.1/boot_images/QcomPkg/SocPkg/AgattiPkg/Library/MDPPlatformLib/MDPPlatformLib.c</span><span class="w"></span>
<span class="gu">@@ -178,40 +178,38 @@ static PlatformDSIDetectParams uefiPanelList[] = {</span><span class="w"></span>
<span class="w"> </span>      0                                                      // uFlags<span class="w"></span>
<span class="w"> </span>    },<span class="w"></span>
<span class="w"> </span>    //[M92xx]modified by tfl for tfl for LCD bringup  20221108 --end<span class="w"></span>
<span class="gd">-  */  {</span><span class="w"></span>
<span class="gd">-      0x06,                                                  // uCmdType</span><span class="w"></span>
<span class="gd">-      0x05,                                                  // total number of retry on failures</span><span class="w"></span>
<span class="gi">+    {</span><span class="w"></span>
<span class="gi">+    0x06,                                                                                               // uCmdType</span><span class="w"></span>
<span class="gi">+    0x05,                                                                                               // total number of retry on failures</span><span class="w"></span>
<span class="w"> </span>      {<span class="w"></span>
<span class="gd">-       {{0xDA, 0x00},                                                                           // address to read ID1</span><span class="w"></span>
<span class="gd">-       {0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}         // expected readback</span><span class="w"></span>
<span class="gd">-       }</span><span class="w"></span>
<span class="gd">-      },</span><span class="w"></span>
<span class="gd">-      0,                                                     // Lane remap order {0, 1, 2, 3}</span><span class="w"></span>
<span class="gd">-      NULL,                     // psPanelCfg (panel configuration)</span><span class="w"></span>
<span class="gd">-      0,             // uPanelCfgSize</span><span class="w"></span>
<span class="gd">-      MDPPLATFORM_PANEL_ILI9881D_720P_VIDEO,                 // eSelectedPanel</span><span class="w"></span>
<span class="gd">-      0                                                      // uFlags</span><span class="w"></span>
<span class="gi">+        {{0xDA, 0x00},                                       // address to read ID1</span><span class="w"></span>
<span class="gi">+          {0x2E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}     // expected readback</span><span class="w"></span>
<span class="gi">+        },</span><span class="w"></span>
<span class="gi">+        {{0xDB, 0x00},                                       // address to read ID2</span><span class="w"></span>
<span class="gi">+          {0xB9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}     // expected readback</span><span class="w"></span>
<span class="gi">+        },</span><span class="w"></span>
<span class="gi">+        {{0xDC, 0x00},                                       // address to read ID3</span><span class="w"></span>
<span class="gi">+          {0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}     // expected readback</span><span class="w"></span>
<span class="gi">+        }</span><span class="w"></span>
<span class="gi">+     },</span><span class="w"></span>
<span class="gi">+      0,                                                                                                        // Lane remap order {0, 1, 2, 3}</span><span class="w"></span>
<span class="gi">+      NULL,                                    // psPanelCfg (panel configuration)</span><span class="w"></span>
<span class="gi">+      0,                        // uPanelCfgSize</span><span class="w"></span>
<span class="gi">+      MDPPLATFORM_PANEL_ILI7807S_1080P_VIDEO,                            // eSelectedPanel</span><span class="w"></span>
<span class="gi">+      0                                                                                                         // uFlags</span><span class="w"></span>
<span class="w"> </span>    },<span class="w"></span>

<span class="gu">@@ -433,6 +421,7 @@ static MDP_Status DynamicDSIPanelDetection(MDPPlatformPanelInfo *pPlatformPanel,</span><span class="w"></span>
<span class="w"> </span>      uint8     readback[DSI_READ_READBACK_SIZE];<span class="w"></span>
<span class="w"> </span>      uint32    readSize                          = sizeof(readback);<span class="w"></span>
<span class="w"> </span>      int       iCommandIndex                     = 0;<span class="w"></span>
<span class="gi">+      int       id_num                     = 0;</span><span class="w"></span>
<span class="w"> </span>      uint32    uClkConfig                        = (MDPPLATFORM_PANEL_DETECT_FLAG_CLOCK_FORCEHS &amp;<span class="w"></span>
<span class="w"> </span>                                                     pPanelList[uPanelIndex].uFlags);<span class="w"></span>

<span class="gu">@@ -463,6 +452,7 @@ static MDP_Status DynamicDSIPanelDetection(MDPPlatformPanelInfo *pPlatformPanel,</span><span class="w"></span>

<span class="w"> </span>      // clear the panel ID<span class="w"></span>
<span class="w"> </span>      MDP_OSAL_MEMZERO(panelID, PLATFORM_PANEL_ID_MAX_COMMANDS);<span class="w"></span>
<span class="gi">+      id_num = 0;</span><span class="w"></span>

<span class="w"> </span>      // for each possible panel ID read<span class="w"></span>
<span class="w"> </span>      for(iCommandIndex = 0; iCommandIndex&lt;PLATFORM_PANEL_ID_MAX_COMMANDS; iCommandIndex++)<span class="w"></span>
<span class="gu">@@ -489,10 +479,9 @@ static MDP_Status DynamicDSIPanelDetection(MDPPlatformPanelInfo *pPlatformPanel,</span><span class="w"></span>
<span class="w"> </span>                                  sizeof(pPanelList[uPanelIndex].panelIdCommands[iCommandIndex].address),<span class="w"></span>
<span class="w"> </span>                                  readback,<span class="w"></span>
<span class="w"> </span>                                  &amp;readSize);<span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="w"> </span>                 DEBUG((EFI_D_ERROR, &quot;address:%08x readback[%d]:%08x\n&quot;,<span class="w"></span>
<span class="w"> </span>            pPanelList[uPanelIndex].panelIdCommands[iCommandIndex].address[0],<span class="w"></span>
<span class="gd">-            iCommandIndex, readback[iCommandIndex]));</span><span class="w"></span>
<span class="gi">+            iCommandIndex, readback[0]));</span><span class="w"></span>

<span class="w"> </span>          uRetryCount++;<span class="w"></span>
<span class="w"> </span>        } while((uRetryCount &lt; pPanelList[uPanelIndex].uTotalRetry) &amp;&amp;<span class="w"></span>
<span class="gu">@@ -507,19 +496,24 @@ static MDP_Status DynamicDSIPanelDetection(MDPPlatformPanelInfo *pPlatformPanel,</span><span class="w"></span>
<span class="w"> </span>          {<span class="w"></span>
<span class="w"> </span>            //panelID[iCommandIndex] = readback[0];    // store the first byte of readback as panel ID<span class="w"></span>
<span class="w"> </span>            bMatch                 = TRUE;                       // mark one panel ID matched<span class="w"></span>
<span class="gi">+           id_num++;</span><span class="w"></span>
<span class="w"> </span>                       DEBUG((EFI_D_ERROR, &quot;bMatch OK\n&quot;));<span class="w"></span>
<span class="gd">-                 }</span><span class="w"></span>
<span class="gi">+         }</span><span class="w"></span>
<span class="gi">+         else</span><span class="w"></span>
<span class="gi">+         {</span><span class="w"></span>
<span class="gi">+            id_num = 0;</span><span class="w"></span>
<span class="gi">+         }</span><span class="w"></span>
<span class="w"> </span>        }<span class="w"></span>

<span class="w"> </span>        // if any panel ID is not matched, then go to detect next panel in the list<span class="w"></span>
<span class="gd">-        if(FALSE == bMatch)</span><span class="w"></span>
<span class="gi">+        if(id_num == 3)</span><span class="w"></span>
<span class="w"> </span>        {<span class="w"></span>
<span class="w"> </span>          break;<span class="w"></span>
<span class="w"> </span>        }<span class="w"></span>
<span class="w"> </span>      }<span class="w"></span>

<span class="w"> </span>      // if all panel IDs are matched for a specific panel, store settings and stop<span class="w"></span>
<span class="gd">-      if(TRUE == bMatch)</span><span class="w"></span>
<span class="gi">+      if(TRUE == bMatch &amp;&amp; id_num == 3)</span><span class="w"></span>
<span class="w"> </span>      {<span class="w"></span>
</pre></div>
</div>
</section>
<section id="id15">
<h2>休眠唤醒不亮屏(时序调试)<a class="headerlink" href="#id15" title="此标题的永久链接"></a></h2>
<p>在调试FR8720M屏的时候发现休眠唤醒会花屏，查看datasheet如下，第一张是上下电，第二张是唤醒休眠：</p>
<p><img alt="0001_0005.png" src="../../../_images/0001_00056.png" /></p>
<ul class="simple">
<li><p>我们测试的唤醒时序如下：</p></li>
</ul>
<p><img alt="0001_0006.png" src="../../../_images/0001_00064.png" /></p>
<ul class="simple">
<li></li>
</ul>
</section>
</section>


           </div>
         <div class="articleComments">
               <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>