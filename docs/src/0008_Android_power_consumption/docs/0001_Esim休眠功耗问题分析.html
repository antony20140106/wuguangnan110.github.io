<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a><ul>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">调试</a></li>
<li><a class="reference internal" href="#at">AT指令解释</a></li>
<li><a class="reference internal" href="#id4">问题描述</a></li>
<li><a class="reference internal" href="#id5">初步结论</a></li>
<li><a class="reference internal" href="#mtk">MTK分析结论</a></li>
<li><a class="reference internal" href="#id6">测试</a><ul>
<li><a class="reference internal" href="#modem360s">1.modem扫描全部改为360s</a></li>
<li><a class="reference internal" href="#id7">2.前三次时间缩短</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">测试结论</a></li>
<li><a class="reference internal" href="#id9">实测</a></li>
<li><a class="reference internal" href="#id10">软件修改方案</a><ul>
<li><a class="reference internal" href="#modem-at">1.增加modem AT指令</a><ul>
<li><a class="reference internal" href="#id11">1.软件架构</a></li>
<li><a class="reference internal" href="#id12">2.具体软件修改</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13">2.手动AT指令</a></li>
<li><a class="reference internal" href="#modem-nv">3.修改modem nv</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14">为什么会被识别为白卡</a></li>
<li><a class="reference internal" href="#id15">最后方案</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>Esim休眠功耗大问题分析。</p>
<section id="id2">
<h2>参考<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://online.mediatek.com/FAQ#/SW/FAQ19628">[FAQ19628] [SIM]怎样判别是否为“白卡”（测试卡）</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>“白卡”中有些文件内容会有一些特殊规定用于标识“白卡”的身份:
A：MCC-MNC = 001-01
B：EF_AD文件中的 ms_operation 的值为0x80/0x81/0x02/0x04
我们在读取EF_AD的时候会将之前读出的MCC/MNC满足情况一并做“白卡”判断，判断条件的关系有A&amp;&amp;B和A||B两种，判断条件的关系在test_sim_relation()中定义，若需要修改判断关系（&amp;&amp;或者||）直接修改此函数的return值即可，返回0对应||、返回1对应&amp;&amp;；
判断结果存放在SIM的全局context中（this_sim-&gt;is_test_sim），客户可调用is_test_sim()接口获得判断结果，参数为想获得信息的SIM编号：0x00/0x01/0x02/0x03分别对应SIM1、SIM2、SIM3、SIM4。
 
1、其中ms_operation==0x80/0x81/0x02/0x04 分别代表什么含义呢？
参考spec 3GPP TS 31.102 ：EFAD (Administrative data)
This EF contains information concerning the mode of operation according to the type of USIM, such as normal (to be used by PLMN subscribers for 3G operations), type approval (to allow specific use of the ME during type approval procedures of e.g. the radio equipment), cell testing (to allow testing of a cell before commercial use of this cell), manufacturer specific (to allow the ME manufacturer to perform specific proprietary auto-test in its ME during e.g. maintenance phases).

MS operation mode
Contents: mode of operation for the MS
Coding: Initial value
- normal operation &#39;00&#39;
- type approval operations &#39;80&#39;
- normal operation + specific facilities &#39;01&#39;
- type approval operations + specific facilities &#39;81&#39;
- maintenance (off line) &#39;02&#39;
- cell test operation &#39;04&#39;
 
2、MCC-MNC = 001-01 ，此条规则参考自哪个spec呢？
参考的spec：3GPP TS 51.010
Definition of default values for SIM Application Toolkit testing
EFIMSI (International Mobile Subscriber Identity)
Logically:
Length: 8 bytes
IMSI: 001 01 0123456789
</pre></div>
</div>
</section>
<section id="id3">
<h2>调试<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>如何判断是否是白卡(test sim):</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.AP端可以获取对应SIM卡的属性值进行判断，0表示普通SIM卡，1表示测试卡。

&quot;gsm.sim.ril.testsim&quot;,    --- 卡1
&quot;gsm.sim.ril.testsim.2&quot;, --- 卡2
&quot;gsm.sim.ril.testsim.3&quot;, --- 卡3
&quot;gsm.sim.ril.testsim.4&quot;, --- 卡4

2.AT+ETESTSIM?指令查询
0 normal sim
1 test sim

AT+ETESTSIM?
+ETESTSIM: 0
OK

3.ELT log分析：
Type	Index	Time	Local Time	Module	TraceType	Message	Comment	Time Differences
PS	48686	63289	19:25:53:181	SIM		SELECT:FILE_U_AD_IDX =&gt; 90 00		
PS	48687	63290	19:25:53:181	SIM		sim_al_read_binary()		
PS	48689	63290	19:25:53:181	SIM		SIM_READ_BINARY : length: 5		
PS	48690	63290	19:25:53:181	SIM		APDU_tx 0: 00 B0 00 00 04 F2 F2 F2 F2 4B F2 F2 F2 F2 3A 20		
PS	48952	63411	19:25:53:181	SIM		SIM_CACHE_FILE_AD_IDX [0]: length: 4		
PS	48953	63412	19:25:53:181	SIM		ADM_WDATA 0: 00 00 00 02 FF FF F2 F2 F2 F2 F2 F2 F2 F2 49 44		
PS	48956	63412	19:25:53:181	SIM		APDU_rx 0: 00 00 00 02 F2 F2 F2 F2 F2 F2 F2 F2 F2 F2 4E 43		
PS	48957	63412	19:25:53:181	SIM		SIM: SIM_CMD_SUCCESS		
PS	48958	63412	19:25:53:181	SIM		READ BINARY  offset: 0 length: 4 =&gt; 90 00		
PS	51839	64250	19:25:53:381	SIM		[SIM] Normal sim 1		
PS	51840	64251	19:25:53:381	SIM		[SIM] not Test SIM, normal SIM inserted		
SYS	115558	291119	19:26:07:764	NIL		[AT_RX p56,ch6]AT+ETESTSIM?		
SYS	115572	291129	19:26:07:764	NIL		[ATCI_AT_R_0 s11]+ETESTSIM: 0
</pre></div>
</div>
</section>
<section id="at">
<h2>AT指令解释<a class="headerlink" href="#at" title="此标题的永久链接"></a></h2>
<p><img alt="0001_ETESTSIM.png" src="../../../_images/0001_ETESTSIMnote.png" /></p>
<p><img alt="0001_ETESTSIM.png" src="../../../_images/0001_ETESTSIM.png" /></p>
</section>
<section id="id4">
<h2>问题描述<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>1.esim上电休眠，待机15分钟平均功耗为63.68ma：</p></li>
</ul>
<p><img alt="0001_.png" src="../../../_images/0001_idle.png" /></p>
<ul class="simple">
<li><p>2.esim下电休眠，待机15分钟平均功耗为14.31ma：</p></li>
</ul>
<p><img alt="0001_esim.png" src="../../../_images/0001_esimclose.png" /></p>
</section>
<section id="id5">
<h2>初步结论<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h2>
<p>机功耗异常原因主要是欧亚版本esim在上电后，没有做低功耗模式，系统不断搜网造成。</p>
</section>
<section id="mtk">
<h2>MTK分析结论<a class="headerlink" href="#mtk" title="此标题的永久链接"></a></h2>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w">Dear Customer,</span>

<span class="w">贵司的期望行为是  手机插卡灭屏的情况下的功耗 要保持和 手机没插卡的功耗一致。</span>
<span class="w">	实际结果是   手机插卡灭屏的情况下的功耗比较大，导致续航时间短。 主要原因是手机插卡灭屏的情况下 modem仍然处于激活驻网状态，导致手机整体功耗比较高。</span>
<span class="w">	而手机没插SIM卡时候 modem不处于驻网状态功耗较低。、</span>
<span class="gd">-&gt; 现在是MTK modem侧回复，两种场景无法等同，因为既然有卡信息，在radio on的情况下，就会进行搜网以进行快速恢复正常服务或限制服务状态，以实际搜网结果为准。而不插卡的时候，modem也会进行搜网，以获取限制服务时，可以进行紧急电话。</span><span class="w"></span>
<span class="w">两种情况都不会停止搜网，除非radio off。针对测试来看，当前搜不到网络进行recovery search，可以进行period of timer的客制化修改，可以定义每一次fullband的间隔时间，以降低功耗。</span>

<span class="w">Type	Index	Time	Local Time	Module	TraceType	Message	Comment	Time Differences</span>
<span class="w">PS	17441	2257969546	09:27:56:034	EVAL - NWSEL		MSG_ID_NWSEL_EVAL_PLMN_SEARCH_CNF		</span>
<span class="w">PS	17442	2257969547	09:27:56:034	NWSEL		[NWSEL][PLMN Search CNF] result: PLMN_NOT_FOUND, rat: RAT_LTE, scan_type: FULL_BAND, multi_selected_plmn[0]: 000000		</span>
<span class="w">PS	67644	2258082994	09:28:03:488	NWSEL		NWSEL_RECOVERY_TIMER_ID Timer expires when current is action NWSEL_COMM_NO_ACTION		</span>
<span class="w">PS	193534	2258812133	09:28:50:139	NWSEL		NWSEL_RECOVERY_TIMER_ID Timer starts, period = 10 seconds		</span>
<span class="w">PS	197247	2258968384	09:29:00:153	NWSEL		NWSEL_RECOVERY_TIMER_ID Timer expires when current is action NWSEL_COMM_NO_ACTION		</span>

<span class="w">客制化：</span>

<span class="w">/mcu/custom/service/nvram/nas_nvram_def.c</span>

<span class="w">经过确认要在nv里做客制化</span>

<span class="gd">-       以底下為例: 1~6次的fullband間隔為20s, 7~12次的fullband間隔為30s, ...</span><span class="w"></span>

<span class="gd">-        </span><span class="w"></span>

<span class="gd">-      in nas_nvram_def.c</span><span class="w"></span>

<span class="gd">-      NV ID: NVRAM_EF_NWSEL_DATA_LID</span><span class="w"></span>

<span class="gd">-       </span><span class="w"></span>

<span class="gd">-       #ifdef __SGLTE__</span><span class="w"></span>

<span class="gd">-           0xC8,  /*1, 180s, give the enough timer to sniffer @CMCC case 4.3.3/4.1.3*/</span><span class="w"></span>

<span class="gd">-       #else</span><span class="w"></span>

<span class="gd">-           0xC8,  /*1, 20s*/</span><span class="w"></span>

<span class="gd">-       #endif</span><span class="w"></span>

<span class="gd">-           0xC8,  /*2, 20s*/</span><span class="w"></span>

<span class="gd">-       #ifdef __NWSEL_QUICK_SEARCH_FOR_ROAMING__ </span><span class="w"></span>

<span class="gd">-           0xC8,  /*3, 20s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*4, 20s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*5, 20s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*6, 20s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*7, 30s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*8, 30s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*9, 30s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*10, 30s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*11, 30s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*12, 30s*/</span><span class="w"></span>

<span class="gd">-           0xC8,  /*13, 60s*/</span><span class="w"></span>


<span class="gd">-           0xC8,  /*14, 60s*/</span><span class="w"></span>

<span class="w">改完nas_nvram_def.c後記得要在nas_nvram_def.h將#define  NVRAM_EF_NWSEL_DATA_LID_VERNO 加1</span>


<span class="w">Brs,</span>
<span class="w">MediaTek Support</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2>测试<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h2>
<section id="modem360s">
<h3>1.modem扫描全部改为360s<a class="headerlink" href="#modem360s" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>1.使用<code class="docutils literal notranslate"><span class="pre">ETESTSIM=0</span></code>测试结果如下：</p></li>
</ul>
<p><img alt="0001_ETEST0.png" src="../../../_images/0001_ETEST0.png" /></p>
<ul class="simple">
<li><p>2.使用<code class="docutils literal notranslate"><span class="pre">ETESTSIM=1</span></code>测试结果如下：</p></li>
</ul>
<p><img alt="0001_etest1.png" src="../../../_images/0001_etest1.png" /></p>
</section>
<section id="id7">
<h3>2.前三次时间缩短<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>1.扫描周期280s左右。</p></li>
</ul>
<p><img alt="0001_280s.png" src="../../../_images/0001_280s.png" /></p>
</section>
</section>
<section id="id8">
<h2>测试结论<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>1.其实上面的图都已经是real sim了，扫描周期修改，都有效。</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">sim</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">sim</span><span class="w"></span>

<span class="n">AT</span><span class="o">+</span><span class="n">ETESTSIM</span><span class="o">?</span><span class="w"></span>
<span class="o">+</span><span class="n">ETESTSIM</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">OK</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>2.而且设置<code class="docutils literal notranslate"><span class="pre">ETESTSIM</span></code>的AT指令如下,设置完后不是立即生效的，需要重启并用AT指令查询。</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">AT</span><span class="o">+</span><span class="n">ETESTSIM</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Treats</span><span class="w"> </span><span class="n">TestSIM</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">TestSIM</span><span class="w"></span>
<span class="n">AT</span><span class="o">+</span><span class="n">ETESTSIM</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Treats</span><span class="w"> </span><span class="n">TestSIM</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">Normal</span><span class="w"> </span><span class="n">SIM</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id9">
<h2>实测<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>1.当ETESTSIM为1时，也就是识别为TEST SIM，扫描周期是10s，无法修改，如下图：</p></li>
</ul>
<p><img alt="0001_ESM1.png" src="../../../_images/0001_ESM1.png" /></p>
<ul class="simple">
<li><p>2.当被识别成normal sim时，扫描周期使用<code class="docutils literal notranslate"><span class="pre">NVRAM_EF_NWSEL_DATA_LID</span></code>NV里的扫描周期，可修改，如下：</p></li>
</ul>
<p><img alt="0001_280s.png" src="../../../_images/0001_280s.png" /></p>
</section>
<section id="id10">
<h2>软件修改方案<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>我们这个是esim卡，是被modem识别成白卡(TEST SIM)了，而TEST SIM使用的10s recovery timer,也就是扫描周期为10s固定的，无法修改，需要将当前卡强制设置为real SIM，有以下几种方法。</p></li>
</ul>
<section id="modem-at">
<h3>1.增加modem AT指令<a class="headerlink" href="#modem-at" title="此标题的永久链接"></a></h3>
<section id="id11">
<h4>1.软件架构<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h4>
<ul class="simple">
<li><p>1.<code class="docutils literal notranslate"><span class="pre">telcore/client/RilOemClient.cpp</span></code>:Ril接收端<code class="docutils literal notranslate"><span class="pre">RilClient</span></code>程序流程如下：</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">RilClient</span><span class="p">::</span><span class="n">RilClient</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">identity</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">socketName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">activityThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateActivityThread</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">activityThread</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="s">&quot;StateThread&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="n">RilClient</span><span class="p">::</span><span class="n">StateActivityThread</span><span class="p">::</span><span class="n">threadLoop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="n">跑线程收发socket通信</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">client</span><span class="o">-&gt;</span><span class="n">clientStateCallback</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="k">switch</span><span class="p">(</span><span class="n">clientState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">CLIENT_ACTIVE</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">handleStateActive</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="o">*</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handleSpecialRequestWithArgs</span><span class="p">(</span><span class="n">number</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="o">*</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SYSTOOL&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="o">*</span><span class="w"> </span><span class="n">executeSystool</span><span class="p">(</span><span class="n">orgArgs</span><span class="p">);</span><span class="w"> </span><span class="n">解析systool指令</span><span class="w"></span>
<span class="w">               </span><span class="o">*</span><span class="w"> </span><span class="n">subCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="o">-&gt;</span><span class="n">atTokNextstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span><span class="w">  </span><span class="n">AT</span><span class="w"> </span><span class="n">cmd命令</span><span class="w"></span>
<span class="w">               </span><span class="o">*</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">subCmd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AT+ETESTSIM=&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">判断AT指令</span><span class="w"></span>
<span class="w">                 </span><span class="o">*</span><span class="w"> </span><span class="n">rfx_enqueue_request_message_client</span><span class="p">(</span><span class="n">RFX_MSG_REQUEST_WRITE_ESIMMODE</span><span class="p">,(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">imeiOrBarcode</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">imeiOrBarcode</span><span class="p">),</span><span class="w"> </span><span class="n">pRI</span><span class="p">,(</span><span class="n">RIL_SOCKET_ID</span><span class="p">)</span><span class="w"> </span><span class="n">mainSlotId</span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
<ul class="simple">
<li><p>2.systool发送socket端流程如下<code class="docutils literal notranslate"><span class="pre">paxdroid/system/core/bootinit/modemtool.cpp</span></code>：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[]){</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[]){</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="n">write_esim_mode</span><span class="p">(</span><span class="n">ESIM_MODEM</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">gISystoolServiceV1_0</span><span class="o">-&gt;</span><span class="n">setSystemConfig</span><span class="p">(</span><span class="n">ConfigType</span><span class="o">::</span><span class="n">ESIM_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>调用到systool interface接口如下<code class="docutils literal notranslate"><span class="pre">paxdroid/hardware/interfaces/systool/1.0/default/SystoolServer.cpp</span></code>：</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">Return</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="w">  </span><span class="n">SystoolServer</span><span class="o">::</span><span class="n">setSystemConfig</span><span class="p">(</span><span class="n">ConfigType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">hidl_vec</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">ConfigType</span><span class="o">::</span><span class="no">ESIM_MODE</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">set_esim_mode</span><span class="p">(</span><span class="n">mDevice</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">());</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">set_esim_mode</span></code>接口实现如下<code class="docutils literal notranslate"><span class="pre">paxdroid/system/core/systool/systool.c</span></code>：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">systool_m_open</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">hw_module_t</span><span class="o">*</span><span class="w"> </span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__unused</span><span class="w"> </span><span class="o">*</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_esim_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">systool_set_esim_mode</span><span class="p">;</span><span class="w"></span>

<span class="kt">int32_t</span><span class="w"> </span><span class="nf">systool_set_esim_mode</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">systool_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="n">SOCKET_RECV_LEN</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">ALOGD</span><span class="p">(</span><span class="s">&quot;set esim_mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SYSTOOL,AT+ETESTSIM=,%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ALOGD</span><span class="p">(</span><span class="s">&quot;cmd = %s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_ril</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="w">  </span><span class="c1">//socket发送</span>
<span class="w">    </span><span class="n">ALOGD</span><span class="p">(</span><span class="s">&quot;ret = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>打印如下：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>01-11 14:35:52.584  1050  1123 I RilClient: initialize: commandFd is 107
01-11 14:35:52.584  1050  1123 I RilOemClient: systool line = SYSTOOL,AT+ETESTSIM=,0, cmd:SYSTOOL, subCmd:AT+ETESTSIM=, slotId:0, targetSim: 0, imeiOrBarcode:0 arg : (null)
01-11 14:35:52.584  1050  1123 I RilOemClient: arg : (null)
01-11 14:35:52.585  1050  1123 I RilClient: start listen on fd: 26, socket name: rild-oem
01-11 14:35:52.585  1050  1075 E RmcOemHandler: requestWriteEsimMode Enter: AT+ETESTSIM=0
01-11 14:35:52.585  1050  1075 I AT      : [0] AT&gt; AT+ETESTSIM=0 (RIL_CMD_READER_1 tid:504162471104)
</pre></div>
</div>
<p>最后发现这个是modem定制的AT指令才能用，太坑了。</p>
</section>
<section id="id12">
<h4>2.具体软件修改<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h4>
<ul class="simple">
<li><p>1.systool修改如下：</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/paxdroid/device/rc_file/M8/init.mt6762_common_M8.rc b/paxdroid/device/rc_file/M8/init.mt6762_common_M8.rc</span><span class="w"></span>
<span class="gh">index 328f33b18b8..ba4b862c26d 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/device/rc_file/M8/init.mt6762_common_M8.rc</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/device/rc_file/M8/init.mt6762_common_M8.rc</span><span class="w"></span>
<span class="gu">@@ -17,7 +17,7 @@ on fs</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>on property:sys.boot_completed=1<span class="w"></span>
<span class="w"> </span>    write /sys/class/pax/pax_gpios/value 0x00<span class="w"></span>
<span class="gd">-    start modemtool</span><span class="w"></span>
<span class="gi">+    #start modemtool</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>on property:sys.ttychange=1<span class="w"></span>
<span class="w"> </span>    symlink ${pax.ctrl.currentport} /dev/ttyPos0<span class="w"></span>
<span class="gh">diff --git a/paxdroid/hardware/interfaces/current.txt b/paxdroid/hardware/interfaces/current.txt</span><span class="w"></span>
<span class="gh">index 500bf66d3a8..5be77a24bd0 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/hardware/interfaces/current.txt</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/hardware/interfaces/current.txt</span><span class="w"></span>
<span class="gu">@@ -4,5 +4,5 @@ b5772891d23d223dab8525ce603ae743c9d2aa0c1e4d7ff487c370af15b32865 paxdroid.hardwa</span><span class="w"></span>
<span class="w"> </span>f05b057688945efaab1200df9b74d9b976636fe41c016536e65d87214cc3ab89 paxdroid.hardware.hello@1.1::IHello<span class="w"></span>
<span class="w"> </span>72d5e633f2c89901e98846565128af1417b95e7a535ae70b28c0fa867dc9b703 paxdroid.hardware.paxservice@1.0::types<span class="w"></span>
<span class="w"> </span>ef8f92fc658f5d4300d3b0ded236eab80231f863466b42c2af6c772e175735fd paxdroid.hardware.paxservice@1.0::IPaxApiService<span class="w"></span>
<span class="gd">-1be06fcf4df534ec501fe828cd84a8dbe29f9ff4461102fc1939081aea85e4e0 paxdroid.hardware.systool@1.0::types</span><span class="w"></span>
<span class="gi">+65dccade01e58ff0bb3549de868a97c37dd1a5e5a568832f0dbce91d0e62be19 paxdroid.hardware.systool@1.0::types</span><span class="w"></span>
<span class="w"> </span>1a18b6bd90b3a3bb52f738742f7c8c61fa334487244f80a4009f252d28a89bb5 paxdroid.hardware.systool@1.0::ISystoolServer<span class="w"></span>
<span class="gh">diff --git a/paxdroid/hardware/interfaces/systool/1.0/default/SystoolServer.cpp b/paxdroid/hardware/interfaces/systool/1.0/default/SystoolServer.cpp</span><span class="w"></span>
<span class="gh">index 0118deabe59..39dbd32d528 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/hardware/interfaces/systool/1.0/default/SystoolServer.cpp</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/hardware/interfaces/systool/1.0/default/SystoolServer.cpp</span><span class="w"></span>
<span class="gu">@@ -61,6 +61,9 @@ Return&lt;int32_t&gt;  SystoolServer::setSystemConfig(ConfigType type, const hidl_vec&lt;</span><span class="w"></span>
<span class="w"> </span>        case ConfigType::SERIALNO:<span class="w"></span>
<span class="w"> </span>             res = mDevice-&gt;set_serialNo(mDevice, (const unsigned char*)value.data());<span class="w"></span>
<span class="w"> </span>             break;<span class="w"></span>
<span class="gi">+		case ConfigType::ESIM_MODE:</span><span class="w"></span>
<span class="gi">+			 res = mDevice-&gt;set_esim_mode(mDevice, (const unsigned char*)value.data());</span><span class="w"></span>
<span class="gi">+			 break;</span><span class="w"></span>
<span class="w"> </span>        default:<span class="w"></span>
<span class="w"> </span>             break;<span class="w"></span>
<span class="w"> </span>    }<span class="w"></span>
<span class="gh">diff --git a/paxdroid/hardware/interfaces/systool/1.0/types.hal b/paxdroid/hardware/interfaces/systool/1.0/types.hal</span><span class="w"></span>
<span class="gh">index 9e1e83b1f3d..e349574580b 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/hardware/interfaces/systool/1.0/types.hal</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/hardware/interfaces/systool/1.0/types.hal</span><span class="w"></span>
<span class="gu">@@ -9,4 +9,5 @@ enum ConfigType : uint32_t {</span><span class="w"></span>
<span class="w"> </span>    SYSVER,<span class="w"></span>
<span class="w"> </span>    DEVICEINFO,<span class="w"></span>
<span class="w"> </span>    MODEM_VERSION,<span class="w"></span>
<span class="gi">+    ESIM_MODE,</span><span class="w"></span>
<span class="w"> </span>};<span class="w"></span>
<span class="gh">diff --git a/paxdroid/hardware/libhardware/include/hardware/systool.h b/paxdroid/hardware/libhardware/include/hardware/systool.h</span><span class="w"></span>
<span class="gh">index d93eb3a1783..4a86b3a211f 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/hardware/libhardware/include/hardware/systool.h</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/hardware/libhardware/include/hardware/systool.h</span><span class="w"></span>
<span class="gu">@@ -71,6 +71,7 @@ typedef struct systool_device {</span><span class="w"></span>
<span class="w"> </span>    int32_t (*get_device_info)(struct systool_device *dev, unsigned char *result);<span class="w"></span>
<span class="w"> </span>    int32_t (*exec_shell_cmd)(struct systool_device *dev, const char *cmd, int32_t pid, int32_t uid);<span class="w"></span>
<span class="w"> </span>    int32_t (*get_modem_version)(struct systool_device *dev, unsigned char *result);<span class="w"></span>
<span class="gi">+    int32_t (*set_esim_mode)(struct systool_device *dev, const unsigned char *value);</span><span class="w"></span>
<span class="w"> </span>}systool_device_t;<span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>
<span class="gh">diff --git a/paxdroid/hardware/libhardware/modules/systool/systool.c b/paxdroid/hardware/libhardware/modules/systool/systool.c</span><span class="w"></span>
<span class="gh">index 171612de393..bbdf8c52725 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/hardware/libhardware/modules/systool/systool.c</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/hardware/libhardware/modules/systool/systool.c</span><span class="w"></span>
<span class="gu">@@ -1217,6 +1217,18 @@ int32_t systool_get_modem_version(struct systool_device *dev, unsigned char *res</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>}<span class="w"></span>
<span class="w"> </span>
<span class="gi">+int32_t systool_set_esim_mode(struct systool_device *dev, const unsigned char *value) {</span><span class="w"></span>
<span class="gi">+    char buf[SOCKET_RECV_LEN] = {0};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    ALOGD(&quot;set esim_mode %s\n&quot;,value);</span><span class="w"></span>
<span class="gi">+	sprintf(buf, &quot;SYSTOOL,AT+ETESTSIM=,%s&quot;, value);</span><span class="w"></span>
<span class="gi">+    ALOGD(&quot;cmd = %s \n&quot;, buf);</span><span class="w"></span>
<span class="gi">+    int32_t ret = send_to_ril(buf);</span><span class="w"></span>
<span class="gi">+    ALOGD(&quot;ret = %d \n&quot;, ret);</span><span class="w"></span>
<span class="gi">+    return ret;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>extern int serverExecShellCmd(char *cmd, int callingPid, int callingUid);<span class="w"></span>
<span class="w"> </span>int32_t systool_exec_shell_cmd(struct systool_device *dev, const char *cmd, int32_t pid, int32_t uid) {<span class="w"></span>
<span class="w"> </span>    ALOGD(&quot;pid=%d, uid=%d\n&quot;, pid, uid);<span class="w"></span>
<span class="gu">@@ -1255,6 +1267,7 @@ static int systool_m_open(const hw_module_t* module, const char __unused *id,</span><span class="w"></span>
<span class="w"> </span>    dev-&gt;get_device_info = systool_get_device_info;<span class="w"></span>
<span class="w"> </span>    dev-&gt;exec_shell_cmd = systool_exec_shell_cmd;<span class="w"></span>
<span class="w"> </span>    dev-&gt;get_modem_version = systool_get_modem_version;<span class="w"></span>
<span class="gi">+    dev-&gt;set_esim_mode = systool_set_esim_mode;</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>    *device = (hw_device_t*) dev;<span class="w"></span>
<span class="w"> </span>    return 0;<span class="w"></span>
<span class="gh">diff --git a/paxdroid/system/core/bootinit/modemtool.cpp b/paxdroid/system/core/bootinit/modemtool.cpp</span><span class="w"></span>
<span class="gh">index 284df917fd0..cd002248eb2 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/system/core/bootinit/modemtool.cpp</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/system/core/bootinit/modemtool.cpp</span><span class="w"></span>
<span class="gu">@@ -80,7 +80,6 @@ int write_nvram_imei(int index, char *value) {</span><span class="w"></span>
<span class="w"> </span>    return result;<span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="w"> </span>
<span class="gd">-</span><span class="w"></span>
<span class="w"> </span>/**<span class="w"></span>
<span class="w"> </span> * set the 15 digit of the imei<span class="w"></span>
<span class="w"> </span> * [get_IMEI_checkDigit description]<span class="w"></span>
<span class="gu">@@ -187,10 +186,32 @@ int check_imei(){</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>}<span class="w"></span>
<span class="w"> </span>
<span class="gi">+int write_esim_mode(char *value) {</span><span class="w"></span>
<span class="gi">+    int result = -1;</span><span class="w"></span>
<span class="gi">+    char buf[IMEI_LEN + 5] = {0};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    sprintf(buf, &quot;%s&quot;, value);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    ALOGD(&quot;value = %s, len=%zu \n&quot;, buf, strlen(buf));</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    if (getSystoolService() == nullptr) {</span><span class="w"></span>
<span class="gi">+        ALOGE(&quot;systoll service is null&quot;);</span><span class="w"></span>
<span class="gi">+        return result;</span><span class="w"></span>
<span class="gi">+    }</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    hidl_vec&lt;uint8_t&gt; vec;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    vec.setToExternal(const_cast&lt;uint8_t *&gt;((uint8_t *)buf), strlen(buf));</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    result = gISystoolServiceV1_0-&gt;setSystemConfig(ConfigType::ESIM_MODE, vec);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    return result;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>int main(int argc, char *argv[]){<span class="w"></span>
<span class="w"> </span>    int result = -1;<span class="w"></span>
<span class="w"> </span>    char info[MODEM_VERSION_LENGTH + 1] = {0};<span class="w"></span>
<span class="gi">+	char ESIM_MODEM[] = &quot;0&quot;;</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>    ALOGD(&quot;modem tool start&quot;);<span class="w"></span>
<span class="w"> </span>    init_tp_version();<span class="w"></span>
<span class="gu">@@ -207,6 +228,9 @@ int main(int argc, char *argv[]){</span><span class="w"></span>
<span class="w"> </span>                       }<span class="w"></span>
<span class="w"> </span>                   };<span class="w"></span>
<span class="w"> </span>    gISystoolServiceV1_0-&gt;getSystemConfig(ConfigType::MODEM_VERSION, MODEM_VERSION_LENGTH, hidl_cb);<span class="w"></span>
<span class="gi">+    //[NEW FEATURE]-BEGIN by wugangnan@paxsz.com 2022-01-07, for Treats ESIM same as Normal SIM,Reduce scan frequency.</span><span class="w"></span>
<span class="gi">+    //write_esim_mode(ESIM_MODEM);</span><span class="w"></span>
<span class="gi">+    //[NEW FEATURE]-END by wugangnan@paxsz.com 2022-01-07, for Treats ESIM same as Normal SIM,Reduce scan frequency.</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>    printf(&quot;%s&quot;, info);<span class="w"></span>
<span class="w"> </span>    ALOGD(&quot;modem tool info is %s&quot;,info);<span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>2.ril层修改如下：</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/base/RfxIdToMsgIdUtils.cpp b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/base/RfxIdToMsgIdUtils.cpp</span><span class="w"></span>
<span class="gh">index c3ac244495d..9958a505bb8 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/base/RfxIdToMsgIdUtils.cpp</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/base/RfxIdToMsgIdUtils.cpp</span><span class="w"></span>
<span class="gu">@@ -2179,6 +2179,7 @@ int RfxIdToMsgIdUtils::msgIdToId(int msgId) {</span><span class="w"></span>
<span class="w"> </span>        case RFX_MSG_REQUEST_READ_BARCODE:<span class="w"></span>
<span class="w"> </span>        case RFX_MSG_REQUEST_WRITE_BARCODE:<span class="w"></span>
<span class="w"> </span>        case RFX_MSG_REQUEST_READ_MODEMVERISON:<span class="w"></span>
<span class="gi">+        case RFX_MSG_REQUEST_WRITE_ESIMMODE:</span><span class="w"></span>
<span class="w"> </span>            return RIL_UNSOL_OEM_HOOK_RAW;<span class="w"></span>
<span class="w"> </span>        //[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>        ///M: Video ringtone event indication<span class="w"></span>
<span class="gh">diff --git a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/include/RfxOemMessageId.h b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/include/RfxOemMessageId.h</span><span class="w"></span>
<span class="gh">index 3c414c6c266..8ff0905378c 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/include/RfxOemMessageId.h</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/framework/include/RfxOemMessageId.h</span><span class="w"></span>
<span class="gu">@@ -85,7 +85,8 @@ RFX_MSG_ID_EXPN(RFX_MSG_REQUEST_WRITE_IMEI)</span><span class="w"></span>
<span class="w"> </span>RFX_MSG_ID_EXPN(RFX_MSG_REQUEST_READ_BARCODE)<span class="w"></span>
<span class="w"> </span>RFX_MSG_ID_EXPN(RFX_MSG_REQUEST_WRITE_BARCODE)<span class="w"></span>
<span class="w"> </span>RFX_MSG_ID_EXPN(RFX_MSG_REQUEST_READ_MODEMVERISON)<span class="w"></span>
<span class="gi">+RFX_MSG_ID_EXPN(RFX_MSG_REQUEST_WRITE_ESIMMODE)</span><span class="w"></span>
<span class="w"> </span>//[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>RFX_MSG_ID_EXPN(RFX_MSG_REQUEST_SET_MODEM_CONFIG)<span class="w"></span>
<span class="w"> </span>RFX_MSG_ID_EXPN(RFX_MSG_EVENT_OEM_RAW_URC)<span class="w"></span>
<span class="gd">-#endif</span><span class="w"></span>
<span class="w">\ No newline at end of file</span>
<span class="gi">+#endif</span><span class="w"></span>
<span class="gh">diff --git a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.cpp b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.cpp</span><span class="w"></span>
<span class="gh">index 8d08bb0165d..5d2083aa2c1 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.cpp</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.cpp</span><span class="w"></span>
<span class="gu">@@ -115,6 +115,8 @@ RFX_REGISTER_DATA_TO_REQUEST_ID(RfxStringData, RfxIntsData,</span><span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_WRITE_BARCODE);<span class="w"></span>
<span class="w"> </span>RFX_REGISTER_DATA_TO_REQUEST_ID(RfxStringData, RfxStringData,<span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_READ_MODEMVERISON);<span class="w"></span>
<span class="gi">+RFX_REGISTER_DATA_TO_REQUEST_ID(RfxStringData, RfxStringData,</span><span class="w"></span>
<span class="gi">+        RFX_MSG_REQUEST_WRITE_ESIMMODE);</span><span class="w"></span>
<span class="w"> </span>//[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>RFX_REGISTER_DATA_TO_REQUEST_ID(RfxIntsData, RfxVoidData,<span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_SET_MODEM_CONFIG);<span class="w"></span>
<span class="gu">@@ -150,6 +152,7 @@ RmcOemRequestHandler::RmcOemRequestHandler(int slot_id, int channel_id) :</span><span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_READ_BARCODE,<span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_WRITE_BARCODE,<span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_READ_MODEMVERISON,<span class="w"></span>
<span class="gi">+	RFX_MSG_REQUEST_WRITE_ESIMMODE,</span><span class="w"></span>
<span class="w"> </span>        //[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_SET_MODEM_CONFIG,<span class="w"></span>
<span class="w"> </span>    };<span class="w"></span>
<span class="gu">@@ -279,7 +282,9 @@ void RmcOemRequestHandler::onHandleRequest(const sp&lt;RfxMclMessage&gt;&amp; msg) {</span><span class="w"></span>
<span class="w"> </span>        case RFX_MSG_REQUEST_READ_MODEMVERISON:<span class="w"></span>
<span class="w"> </span>            requestReadModemVersion(msg);<span class="w"></span>
<span class="w"> </span>            break;<span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gi">+        case RFX_MSG_REQUEST_WRITE_ESIMMODE:</span><span class="w"></span>
<span class="gi">+            requestWriteEsimMode(msg);</span><span class="w"></span>
<span class="gi">+            break;</span><span class="w"></span>
<span class="w"> </span>        //[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>        case RFX_MSG_REQUEST_SET_MODEM_CONFIG:<span class="w"></span>
<span class="w"> </span>            requestSetModemConfig(msg);<span class="w"></span>
<span class="gu">@@ -2132,6 +2137,26 @@ void RmcOemRequestHandler::requestReadModemVersion(const sp&lt;RfxMclMessage&gt;&amp; msg)</span><span class="w"></span>
<span class="w"> </span>    responseToTelCore(responseMsg);<span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="w"> </span>
<span class="gi">+void RmcOemRequestHandler::requestWriteEsimMode(const sp&lt;RfxMclMessage&gt;&amp; msg){</span><span class="w"></span>
<span class="gi">+    int err = 0;</span><span class="w"></span>
<span class="gi">+    sp&lt;RfxMclMessage&gt; responseMsg;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	char* esim_mode = (char*)(msg-&gt;getData()-&gt;getData());</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    RFX_LOG_E(RFX_LOG_TAG, &quot;requestWriteEsimMode Enter: AT+ETESTSIM=%s&quot;,esim_mode);</span><span class="w"></span>
<span class="gi">+    sp&lt;RfxAtResponse&gt; atResponse = atSendCommand(String8::format(&quot;AT+ETESTSIM=%s&quot;,esim_mode));</span><span class="w"></span>
<span class="gi">+    // check at cmd result, consider default as success</span><span class="w"></span>
<span class="gi">+    if (atResponse-&gt;getError() != 0 || atResponse-&gt;getSuccess() != 1) {</span><span class="w"></span>
<span class="gi">+        logE(RFX_LOG_TAG, &quot;requestWriteEsimMode:  failed&quot;);</span><span class="w"></span>
<span class="gi">+        responseMsg = RfxMclMessage::obtainResponse(RIL_E_GENERIC_FAILURE,</span><span class="w"></span>
<span class="gi">+                RfxVoidData(), msg);</span><span class="w"></span>
<span class="gi">+    } else {</span><span class="w"></span>
<span class="gi">+        responseMsg = RfxMclMessage::obtainResponse(RIL_E_SUCCESS,</span><span class="w"></span>
<span class="gi">+                RfxVoidData(), msg);</span><span class="w"></span>
<span class="gi">+    }</span><span class="w"></span>
<span class="gi">+    responseToTelCore(responseMsg);</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>void RmcOemRequestHandler::requestWriteImei(const sp&lt;RfxMclMessage&gt;&amp; msg) {<span class="w"></span>
<span class="w"> </span>    int err = 0;<span class="w"></span>
<span class="w"> </span>    sp&lt;RfxMclMessage&gt; responseMsg;<span class="w"></span>
<span class="gh">diff --git a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.h b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.h</span><span class="w"></span>
<span class="gh">index db9925e3035..adc8222acf7 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.h</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/mdcomm/oem/RmcOemRequestHandler.h</span><span class="w"></span>
<span class="gu">@@ -121,6 +121,8 @@ class RmcOemRequestHandler : public RfxBaseHandler {</span><span class="w"></span>
<span class="w"> </span>        void requestWriteBarcode(const sp&lt;RfxMclMessage&gt;&amp; msg);<span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>        void requestReadModemVersion(const sp&lt;RfxMclMessage&gt;&amp; msg);<span class="w"></span>
<span class="gi">+ </span><span class="w"></span>
<span class="gi">+        void requestWriteEsimMode(const sp&lt;RfxMclMessage&gt;&amp; msg);</span><span class="w"></span>
<span class="w"> </span>        //[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>        void requestSetModemConfig(const sp&lt;RfxMclMessage&gt;&amp; msg);<span class="w"></span>
<span class="w"> </span>
<span class="gh">diff --git a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/client/RilOemClient.cpp b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/client/RilOemClient.cpp</span><span class="w"></span>
<span class="gh">index efba0ddd57a..5ae8cc2a865 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/client/RilOemClient.cpp</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/client/RilOemClient.cpp</span><span class="w"></span>
<span class="gu">@@ -174,7 +174,7 @@ void RilOemClient::requestComplete(RIL_Token token, RIL_Errno e, const void *res</span><span class="w"></span>
<span class="w"> </span>    }<span class="w"></span>
<span class="w"> </span>    //[FEATURE]-Add-BEGIN by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>    else if (RFX_MSG_REQUEST_READ_IMEI == info-&gt;request || RFX_MSG_REQUEST_READ_BARCODE == info-&gt;request<span class="w"></span>
<span class="gd">-            || RFX_MSG_REQUEST_READ_MODEMVERISON == info-&gt;request) {</span><span class="w"></span>
<span class="gi">+            || RFX_MSG_REQUEST_READ_MODEMVERISON == info-&gt;request || RFX_MSG_REQUEST_WRITE_ESIMMODE == info-&gt;request) {</span><span class="w"></span>
<span class="w"> </span>        String8 strResult;<span class="w"></span>
<span class="w"> </span>        RFX_LOG_I(RFX_LOG_TAG, &quot;request for READ imei or barcode returned&quot;);<span class="w"></span>
<span class="w"> </span>
<span class="gu">@@ -812,7 +812,11 @@ void RilOemClient::executeSystool(char *arg) {</span><span class="w"></span>
<span class="w"> </span>         rfx_enqueue_request_message_client(RFX_MSG_REQUEST_READ_MODEMVERISON,<span class="w"></span>
<span class="w"> </span>            NULL, 0, pRI,<span class="w"></span>
<span class="w"> </span>            (RIL_SOCKET_ID) mainSlotId);<span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gi">+    } else if(strcmp(subCmd, &quot;AT+ETESTSIM=&quot;) == 0){</span><span class="w"></span>
<span class="gi">+         pRI-&gt;request = RFX_MSG_REQUEST_WRITE_ESIMMODE;</span><span class="w"></span>
<span class="gi">+         rfx_enqueue_request_message_client(RFX_MSG_REQUEST_WRITE_ESIMMODE,</span><span class="w"></span>
<span class="gi">+            (void *) imeiOrBarcode, strlen(imeiOrBarcode), pRI,</span><span class="w"></span>
<span class="gi">+            (RIL_SOCKET_ID) mainSlotId);</span><span class="w"></span>
<span class="w"> </span>    }<span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>    delete line;<span class="w"></span>
<span class="gh">diff --git a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/oem/RtcOemController.cpp b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/oem/RtcOemController.cpp</span><span class="w"></span>
<span class="gh">index 379abaec5ca..65edf979cc3 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/oem/RtcOemController.cpp</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/hardware/ril/fusion/mtk-ril/telcore/oem/RtcOemController.cpp</span><span class="w"></span>
<span class="gu">@@ -92,7 +92,8 @@ void RtcOemController::onInit() {</span><span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_READ_BARCODE,<span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_WRITE_BARCODE,<span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_READ_MODEMVERISON,<span class="w"></span>
<span class="gd">-        //[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool</span><span class="w"></span>
<span class="gi">+        RFX_MSG_REQUEST_WRITE_ESIMMODE,</span><span class="w"></span>
<span class="gi">+	//[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool</span><span class="w"></span>
<span class="w"> </span>        RFX_MSG_REQUEST_SET_MODEM_CONFIG,<span class="w"></span>
<span class="w"> </span>    };<span class="w"></span>
<span class="w"> </span>
<span class="gu">@@ -132,6 +133,7 @@ bool RtcOemController::onCheckIfRejectMessage(const sp&lt;RfxMessage&gt;&amp; message,</span><span class="w"></span>
<span class="w"> </span>            || message-&gt;getId() == RFX_MSG_REQUEST_READ_BARCODE<span class="w"></span>
<span class="w"> </span>            || message-&gt;getId() == RFX_MSG_REQUEST_WRITE_BARCODE<span class="w"></span>
<span class="w"> </span>            || message-&gt;getId() == RFX_MSG_REQUEST_READ_MODEMVERISON<span class="w"></span>
<span class="gi">+            || message-&gt;getId() == RFX_MSG_REQUEST_WRITE_ESIMMODE</span><span class="w"></span>
<span class="w"> </span>            //[FEATURE]-Add-END by (zengzp@paxsz.com), 2020/6/15,for add at command for systool<span class="w"></span>
<span class="w"> </span>            || message-&gt;getId() == RFX_MSG_REQUEST_SET_MODEM_CONFIG<span class="w"></span>
<span class="w"> </span>            )) {<span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="id13">
<h3>2.手动AT指令<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>MTK建议如下,但是该方法需要下AT cmd后重启才生效，比较麻烦。</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w">需要下AT cmd后重启才生效。</span>
<span class="w">1) 测试时，下AT cmd给modem AT+ETESTSIM=2,1 。</span>

<span class="w">2) 在mak file里 __MTK_INTERNAL_ENG_USER__ is enabled 。</span>


<span class="gd">--- a/paxmodem/mcu/common/interface/service/nvram/nas_nvram_def.h</span><span class="w"></span>

<span class="gi">+++ b/paxmodem/mcu/common/interface/service/nvram/nas_nvram_def.h</span><span class="w"></span>

<span class="gu">@@ -123,7 +123,7 @@ typedef enum</span><span class="w"></span>

<span class="w"> </span>}nvram_lid_nas_enum;<span class="w"></span>

<span class="w"> </span>// VERNO<span class="w"></span>

<span class="gd">-#define  NVRAM_EF_NWSEL_DATA_LID_VERNO &quot;005&quot;</span><span class="w"></span>

<span class="gi">+#define  NVRAM_EF_NWSEL_DATA_LID_VERNO &quot;006&quot;</span><span class="w"></span>


<span class="gd">--- a/paxmodem/mcu/make/projects/TK_MD_BASIC(LWTG_6177M_R3_6762).mak</span><span class="w"></span>
<span class="gi">+++ b/paxmodem/mcu/make/projects/TK_MD_BASIC(LWTG_6177M_R3_6762).mak</span><span class="w"></span>
<span class="gu">@@ -2250,7 +2250,7 @@ COM_DEFS_FOR_MT6762_LTE_MT6177M = MT6177M_RF MT6177M_LTE_RF</span><span class="w"></span>
<span class="w"> </span># *************************************************************************<span class="w"></span>

<span class="w"> </span>CUSTOM_OPTION += __SIM_SUPPORT_NO_DEBOUNCE__<span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gi">+CUSTOM_OPTION += __MTK_INTERNAL_ENG_USER__</span><span class="w"></span>


<span class="gd">--- a/paxmodem/mcu/make/common/rule_def/common_def.mak</span><span class="w"></span>
<span class="gi">+++ b/paxmodem/mcu/make/common/rule_def/common_def.mak</span><span class="w"></span>
<span class="gu">@@ -2666,7 +2666,7 @@ ifdef MT6177M_RFCCA_SUPPORT</span><span class="w"></span>
<span class="w"> </span>  endif<span class="w"></span>
<span class="w"> </span>endif<span class="w"></span>

<span class="gd">-ifeq ($(filter REL_CR_%,$(strip $(RELEASE_PACKAGE))),)</span><span class="w"></span>
<span class="gi">+ifneq ($(filter REL_CR_%,$(strip $(RELEASE_PACKAGE))),)</span><span class="w"></span>
<span class="w"> </span>  COM_DEFS += __MTK_INTERNAL_ENG_USER__<span class="w"></span>
<span class="w"> </span>  ifeq ($(filter __MTK_INTERNAL_ENG_USER__,$(COM_DEFS)),)<span class="w"></span>

<span class="gd">--- a/paxmodem/mcu/pcore/custom/service/nvram/nas_nvram_def.c</span><span class="w"></span>
<span class="gi">+++ b/paxmodem/mcu/pcore/custom/service/nvram/nas_nvram_def.c</span><span class="w"></span>
<span class="gu">@@ -202,21 +202,21 @@ nvram_ef_nwsel_data_struct const COMMON_NVRAM_EF_NWSEL_DATA_DEFAULT[] =</span><span class="w"></span>
<span class="w"> </span>    0x3C   /*19, 60s*/<span class="w"></span>
<span class="w"> </span>#else<span class="w"></span>
<span class="w"> </span>    0x3C,  /*3, 60s*/<span class="w"></span>
<span class="gd">-    0x3C,  /*4, 60s*/</span><span class="w"></span>
<span class="gd">-    0x3C,  /*5, 60s*/</span><span class="w"></span>
<span class="gd">-    0x3C,  /*6, 60s*/</span><span class="w"></span>
<span class="gd">-    0x5A,  /*7, 90s*/</span><span class="w"></span>
<span class="gd">-    0x5A,  /*8, 90s*/</span><span class="w"></span>
<span class="gd">-    0x5A,  /*9, 90s*/</span><span class="w"></span>
<span class="gd">-    0x5A,  /*10, 90s*/</span><span class="w"></span>
<span class="gd">-    0x5A,  /*11, 90s*/</span><span class="w"></span>
<span class="gd">-    0x5A,  /*12, 90s*/</span><span class="w"></span>
<span class="gd">-    0xB4,  /*13, 180s*/</span><span class="w"></span>
<span class="gd">-    0xB4,  /*14, 180s*/</span><span class="w"></span>
<span class="gd">-    0xB4,  /*15, 180s*/</span><span class="w"></span>
<span class="gd">-    0xB4,  /*16, 180s*/</span><span class="w"></span>
<span class="gd">-    0xB4,  /*17, 180s*/</span><span class="w"></span>
<span class="gd">-    0xB4,  /*18, 180s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*4, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*5, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*6, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*7, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*8, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*9, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*10, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*11, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*12, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*13, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*14, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*15, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*16, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*17, 360s*/</span><span class="w"></span>
<span class="gi">+    0x168,  /*18, 360s*/</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="modem-nv">
<h3>3.修改modem nv<a class="headerlink" href="#modem-nv" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>我发现下AT cmd的实际情况也就是修改了NVRAM_EF_TEST_SIM_LID这个NV的值。</p></li>
</ul>
<p>所以我尝试直接将NVRAM_EF_TEST_SIM_LID修改为normal SIM ，发现也是可行的，修改方法如下：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/paxmodem/mcu/pcore/custom/service/nvram/sim_nvram_def.c</span><span class="w"></span>
<span class="gi">+++ b/paxmodem/mcu/pcore/custom/service/nvram/sim_nvram_def.c</span><span class="w"></span>
<span class="gu">@@ -106,6 +106,9 @@</span><span class="w"></span>
<span class="w"> </span>#include &quot;sim_nvram_editor.h&quot;<span class="w"></span>

<span class="w"> </span>// Default Values<span class="w"></span>
<span class="gi">+// [FEATURE]-MOD-BEGIN by wugangnan 2022-01-11, Treats TestSIM same as Normal SIM</span><span class="w"></span>
<span class="gi">+kal_uint8 const NVRAM_EF_PAX_TEST_SIM_DEFAULT[] = { 0x01 };</span><span class="w"></span>
<span class="gi">+// [FEATURE]-MOD-END by wugangnan 2022-01-11, Treats TestSIM same as Normal SIM</span><span class="w"></span>

<span class="w"> </span>// LID Declaration<span class="w"></span>
<span class="w"> </span>ltable_entry_struct logical_data_item_table_sim[] =<span class="w"></span>
<span class="gu">@@ -124,7 +127,10 @@ ltable_entry_struct logical_data_item_table_sim[] =</span><span class="w"></span>
<span class="w"> </span>        NVRAM_EF_TEST_SIM_LID,<span class="w"></span>
<span class="w"> </span>        NVRAM_EF_TEST_SIM_TOTAL,<span class="w"></span>
<span class="w"> </span>        NVRAM_EF_TEST_SIM_SIZE,<span class="w"></span>
<span class="gd">-        NVRAM_NORMAL(NVRAM_EF_ZERO_DEFAULT),</span><span class="w"></span>
<span class="gi">+               // [FEATURE]-MOD-BEGIN by wugangnan 2022-01-11, Treats TestSIM same as Normal SIM</span><span class="w"></span>
<span class="gi">+        //NVRAM_NORMAL(NVRAM_EF_ZERO_DEFAULT),</span><span class="w"></span>
<span class="gi">+               NVRAM_NORMAL(NVRAM_EF_PAX_TEST_SIM_DEFAULT),</span><span class="w"></span>
<span class="gi">+               // [FEATURE]-MOD-END by wugangnan 2022-01-11, Treats TestSIM same as Normal SIM</span><span class="w"></span>
<span class="w"> </span>        NVRAM_CATEGORY_USER,<span class="w"></span>
<span class="w"> </span>        NVRAM_ATTR_AVERAGE,<span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>1.修改后查询nv值</p></li>
</ul>
<p><img alt="0001_TEST_SIM.png" src="../../../_images/0001_TEST_SIM.png" /></p>
<ul class="simple">
<li><p>2.修改后测试，发现扫描周期修改有效，使用的是<code class="docutils literal notranslate"><span class="pre">COMMON_NVRAM_EF_NWSEL_DATA_DEFAULT</span></code>扫描周期。</p></li>
</ul>
<p><img alt="0001_nv.png" src="../../../_images/0001_nv.png" /></p>
<ul class="simple">
<li><p>3.测试1小时平均功耗在18ma左右：</p></li>
</ul>
<p><img alt="0001_1.png" src="../../../_images/0001_onetime.png" /></p>
</section>
</section>
<section id="id14">
<h2>为什么会被识别为白卡<a class="headerlink" href="#id14" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>运营商回复：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1.Sim卡里有一个dummy profile，对应的mccmnc 应该是00101，所以上层可能是认为test profile。

2.如果modem不能支持空eSIM，那这个dummy profile 就需要保留。建议你们在商用时候如果识别到是这个dummy profile状态就上报空卡。
</pre></div>
</div>
</section>
<section id="id15">
<h2>最后方案<a class="headerlink" href="#id15" title="此标题的永久链接"></a></h2>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>扫描周期</p></th>
<th class="head"><p>修改前</p></th>
<th class="head"><p>修改后</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>20s</p></td>
<td><p>20s</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>20s</p></td>
<td><p>20s</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>60s</p></td>
<td><p>60s</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>60s</p></td>
<td><p>60s</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>60s</p></td>
<td><p>60s</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>60s</p></td>
<td><p>60s</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>90s</p></td>
<td><p>90s</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>90s</p></td>
<td><p>90s</p></td>
</tr>
<tr class="row-even"><td><p>9</p></td>
<td><p>90s</p></td>
<td><p>90s</p></td>
</tr>
<tr class="row-odd"><td><p>10</p></td>
<td><p>90s</p></td>
<td><p>90s</p></td>
</tr>
<tr class="row-even"><td><p>11</p></td>
<td><p>90s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-odd"><td><p>12</p></td>
<td><p>90s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-even"><td><p>13</p></td>
<td><p>180s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-odd"><td><p>14</p></td>
<td><p>180s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-even"><td><p>15</p></td>
<td><p>180s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-odd"><td><p>16</p></td>
<td><p>180s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-even"><td><p>17</p></td>
<td><p>180s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-odd"><td><p>18</p></td>
<td><p>180s</p></td>
<td><p>360s</p></td>
</tr>
<tr class="row-even"><td><p>19</p></td>
<td><p>180s</p></td>
<td><p>360s</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>100分钟功耗数据，总平均功耗维持在21.69ma</p></li>
</ul>
<p><img alt="0001_3.png" src="../../../_images/0001_cons.png" /></p>
<ul class="simple">
<li><p>前10次扫网，周期比较短，平均功耗在49.73ma</p></li>
</ul>
<p><img alt="0001_2.png" src="../../../_images/0001_ten.png" /></p>
<ul class="simple">
<li><p>后续扫网，周期保持在6分钟一次，平均功耗在17.86ma</p></li>
</ul>
<p><img alt="0001_4.png" src="../../../_images/0001_late.png" /></p>
</section>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>