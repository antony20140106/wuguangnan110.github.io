<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">README</a></li>
<li><a class="reference internal" href="#refer">refer</a></li>
<li><a class="reference internal" href="#xbli2c">XBL打开I2C配置</a></li>
<li><a class="reference internal" href="#i2c-guid">I2c Guid定义</a></li>
<li><a class="reference internal" href="#abl-i2c">ABL I2C驱动文件</a></li>
<li><a class="reference internal" href="#id1">调试</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>README</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="readme">
<h1>README<a class="headerlink" href="#readme" title="此标题的永久链接"></a></h1>
<p>ABL阶段有时需要读取某些i2c设备状态，但默认没有i2c驱动，需要添加。</p>
</section>
<section id="refer">
<h1>refer<a class="headerlink" href="#refer" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><span class="xref myst">xblabl_i2c</span></p></li>
<li><p><a class="reference download internal" download="" href="../../../_downloads/ce34beb8a616bb9f65e11fd8c3d98cfe/xbl%E4%B8%8Eabl%E4%B8%AD%E4%BD%BF%E7%94%A8i2c.docx"><span class="xref download myst">xbl与abl中使用i2c.docx</span></a></p></li>
</ul>
</section>
<section id="xbli2c">
<h1>XBL打开I2C配置<a class="headerlink" href="#xbli2c" title="此标题的永久链接"></a></h1>
<p>要在abl中使用i2c，首先需要在xbl中打开i2c，要确认需要打开哪一路i2c，可以在kernel dtsi中确认信息，以guage i2c举例，配置如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>scuba-qupv3.dtsi:
        qupv3_se0_i2c: i2c@4a80000 {
                compatible = &quot;qcom,i2c-geni&quot;;
                reg = &lt;0x4a80000 0x4000&gt;;
                #address-cells = &lt;1&gt;;
                #size-cells = &lt;0&gt;;
                interrupts = &lt;GIC_SPI 327 IRQ_TYPE_LEVEL_HIGH&gt;;
                clock-names = &quot;se-clk&quot;, &quot;m-ahb&quot;, &quot;s-ahb&quot;;
                clocks = &lt;&amp;gcc GCC_QUPV3_WRAP0_S0_CLK&gt;,
                        &lt;&amp;gcc GCC_QUPV3_WRAP_0_M_AHB_CLK&gt;,
                        &lt;&amp;gcc GCC_QUPV3_WRAP_0_S_AHB_CLK&gt;;
                pinctrl-names = &quot;default&quot;, &quot;sleep&quot;;
                pinctrl-0 = &lt;&amp;qupv3_se0_i2c_active&gt;;
                pinctrl-1 = &lt;&amp;qupv3_se0_i2c_sleep&gt;;
                dmas = &lt;&amp;gpi_dma0 0 0 3 64 0&gt;,
                        &lt;&amp;gpi_dma0 1 0 3 64 0&gt;;
                dma-names = &quot;tx&quot;, &quot;rx&quot;;
                qcom,wrapper-core = &lt;&amp;qupv3_0&gt;;
                status = &quot;disabled&quot;;
        };
</pre></div>
</div>
<p>确认信息后，在<code class="docutils literal notranslate"><span class="pre">XBL\boot_images\QcomPkg\SocPkg\AgattiPkg\Settings\I2C\core\i2c_devcfg.c</span></code>文件中进行对照:</p>
<p><img alt="0008_0000.png" src="../../../_images/0008_00001.png" /></p>
<ul class="simple">
<li><p>一是对照gpio，二是对照core_offset，三是明确i2c_device_config_0X, 如果对应，则打开相应的宏，修改如下：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="c1">//[FEATURE]-BEGIN by (xxx@xxxxx.com), 2022/09/08 for Detect battery presence during ABL phase</span>
<span class="cp">#define ENABLE_QUP_00 </span><span class="c1">//battery</span>
<span class="c1">//[FEATURE]-END by (xxx@xxxxx.com), 2022/09/08 for Detect battery presence during ABL phase</span>
</pre></div>
</div>
<ul class="simple">
<li><p>二需要打开<code class="docutils literal notranslate"><span class="pre">i2c_devcfg.xml</span></code>文件中的<code class="docutils literal notranslate"><span class="pre">i2c_device_config_01</span></code>配置：</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="o">&lt;</span><span class="n">device</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;/dev/i2c1&quot;</span><span class="o">&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="o">&lt;</span><span class="n">props</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;config&quot;</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;DALPROP_ATTR_TYPE_STRUCT_PTR&quot;</span><span class="o">&gt;</span><span class="w">   </span><span class="n">i2c_device_config_01</span><span class="w">  </span><span class="o">&lt;/</span><span class="n">props</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="o">&lt;/</span><span class="n">device</span><span class="o">&gt;</span><span class="w"></span>
</pre></div>
</div>
<p>这样打开之后，i2c配置就会打开编译，通过protocol open i2c的时候才不会报错。
（注意：core_index = 1与下文I2C_INSTANCE_001要对应得上才能open i2c）</p>
</section>
<section id="i2c-guid">
<h1>I2c Guid定义<a class="headerlink" href="#i2c-guid" title="此标题的永久链接"></a></h1>
<p>abl中使用i2c，需要在dec文件定义将i2c的Guid定义，同时在dsc文件包含i2cLib.inf进行驱动编译，修改如下：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dec b/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dec</span><span class="w"></span>
<span class="gh">index a2ea95fd6e7..b085854dce9 100755</span><span class="w"></span>
<span class="gd">--- a/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dec</span><span class="w"></span>
<span class="gi">+++ b/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dec</span><span class="w"></span>
<span class="gu">@@ -148,7 +148,7 @@</span><span class="w"></span>
<span class="w"> </span>  gEfiHSerialIoProtocolGuid =          { 0xfc344439, 0xafa5, 0x4707, { 0xb0, 0xcc, 0x7a, 0xc2, 0xca, 0xcb, 0x89, 0x9b }}<span class="w"></span>

<span class="w"> </span>  gEfiTLMMProtocolGuid =                { 0xad9aec18, 0x7bf0, 0x4809, { 0x9e, 0x96, 0x30, 0x12, 0x30, 0x9f, 0x3d, 0xf7 } }<span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gi">+  gQcomI2CProtocolGuid =                { 0xb27ae8b1, 0x3e10, 0x4d07, { 0xab, 0x5c, 0xeb, 0x9a, 0x6d, 0xc6, 0xfa, 0x8f } }</span><span class="w"></span>

<span class="w"> </span>[PcdsFixedAtBuild.common]<span class="w"></span>
<span class="w"> </span>  # LinuxLoaderCommon<span class="w"></span>
<span class="gh">diff --git a/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dsc b/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dsc</span><span class="w"></span>
<span class="gh">index a1d84c16cf0..1d4cfff546f 100755</span><span class="w"></span>
<span class="gd">--- a/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dsc</span><span class="w"></span>
<span class="gi">+++ b/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/QcomModulePkg.dsc</span><span class="w"></span>
<span class="gu">@@ -78,6 +78,7 @@</span><span class="w"></span>
<span class="w"> </span>  UefiDriverEntryPoint|MdePkg/Library/UefiDriverEntryPoint/UefiDriverEntryPoint.inf<span class="w"></span>
<span class="w"> </span>  PerformanceLib|MdeModulePkg/Library/DxePerformanceLib/DxePerformanceLib.inf<span class="w"></span>
<span class="w"> </span>  AvbLib|QcomModulePkg/Library/avb/AvbLib.inf<span class="w"></span>
<span class="gi">+  I2cLib|QcomModulePkg/Library/I2cLib/I2cLib.inf</span><span class="w"></span>
</pre></div>
</div>
<p>注意：abl中的Guid要与xbl中的一致，PATH：boot_images/QcomPkg/QcomPkg.dec</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">gQcomI2CProtocolGuid</span><span class="w"> </span><span class="o">=</span><span class="w">                </span><span class="p">{</span><span class="w"> </span><span class="mh">0xb27ae8b1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3e10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d07</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0xab</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xeb</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6d</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8f</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>如果需要使用<code class="docutils literal notranslate"><span class="pre">gQcomI2CProtocolGuid</span></code>，那么需要在<code class="docutils literal notranslate"><span class="pre">.inf</span></code>文件中的[Protocols]中声明，比如下面ABL中使用：</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/Application/LinuxLoader/LinuxLoader.inf</span><span class="w"></span>
<span class="gi">+++ b/UM.9.15/bootable/bootloader/edk2/QcomModulePkg/Application/LinuxLoader/LinuxLoader.inf</span><span class="w"></span>
<span class="gu">@@ -63,6 +63,7 @@</span><span class="w"></span>
<span class="w"> </span>       UbsanLib<span class="w"></span>
<span class="w"> </span>       xxxxxLib<span class="w"></span>
<span class="w"> </span>       UartCoreLib<span class="w"></span>
<span class="gi">+       I2cLib</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="abl-i2c">
<h1>ABL I2C驱动文件<a class="headerlink" href="#abl-i2c" title="此标题的永久链接"></a></h1>
<p>驱动文件如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>wugn@jcrj-tf-compile:I2cLib$ tree
.
├── com_dtypes.h
├── DebugLib.h
├── EFII2C.h
├── EFIPmicGpio.h
├── EFIPmicVreg.h
├── EFITlmm.h
├── i2c_api.h
├── I2CApiLib.lib
├── i2c.c
├── i2c.h
├── I2cLib.inf
├── xxxxx_battery.c
├── xxxxx_battery.h
└── QcomLib.h
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">QcomModulePkg/Library/I2cLib/i2c.c</span></code>:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/************************************************************************************</span>
<span class="cm">*</span>
<span class="cm">*    DESCRIPTION:Copyright(c) 2007-2010 Xiamen Yealink Network Technology Co,.Ltd</span>
<span class="cm">*</span>
<span class="cm">*    AUTHOR:xxx</span>
<span class="cm">*</span>
<span class="cm">*    HISTORY:</span>
<span class="cm">*</span>
<span class="cm">*    DATE:2021-06-23 19:57:53</span>
<span class="cm">*</span>
<span class="cm">*************************************************************************************/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Uefi.h&gt;</span><span class="cp"></span>
<span class="c1">//#include &lt;Library/PcdLib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Library/UefiLib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Library/UefiApplicationEntryPoint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Library/UefiBootServicesTableLib.h&gt;</span><span class="cp"></span>
<span class="c1">//#include &lt;Library/TestInterface.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;EFIPmicVreg.h&quot;</span><span class="cp"></span>
<span class="c1">//#include &lt;Protocol/EFII2C.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;EFITlmm.h&quot;</span><span class="cp"></span>
<span class="c1">//#include &lt;Protocol/EFIPmicGpio.h&gt;</span>
<span class="c1">//#include &lt;Library/QcomLib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DebugLib.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;i2c.h&quot;</span><span class="cp"></span>

<span class="n">EFI_QCOM_I2C_PROTOCOL</span><span class="w"> </span><span class="o">*</span><span class="n">efiQcomI2cProtocol</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">I2cDeviceHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">EFI_HANDLE</span><span class="w"> </span><span class="o">*</span><span class="n">pHandles</span><span class="p">;</span><span class="w"></span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">linuxc_i2c_read_16bit_reg</span><span class="p">(</span><span class="n">uint8</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="n">uint16</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">uint32</span><span class="w"> </span><span class="n">bRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">getdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">i2c_status</span><span class="w"> </span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_SUCCESS</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>

<span class="w">   </span><span class="n">i2c_slave_config</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	   </span><span class="p">.</span><span class="n">bus_frequency_khz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"></span>
<span class="w">	   </span><span class="p">.</span><span class="n">slave_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">	   </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C</span><span class="p">,</span><span class="w"></span>
<span class="w">	   </span><span class="p">.</span><span class="n">slave_max_clock_stretch_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"></span>
<span class="w">	   </span><span class="p">.</span><span class="n">core_configuration1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">	   </span><span class="p">.</span><span class="n">core_configuration2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">gBS</span><span class="o">-&gt;</span><span class="n">Stall</span><span class="p">(</span><span class="mi">600000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efiQcomI2cProtocol</span><span class="o">-&gt;</span><span class="n">read</span><span class="w"> </span><span class="p">(</span><span class="n">I2cDeviceHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bRead</span><span class="p">,</span><span class="w"> </span><span class="mi">2500</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">getdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">getdata</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">getdata</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">	</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">I2C_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i2cstatus</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Read addr:0x%X error i2cstatus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="n">i2cstatus</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">	  </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Read rdbuf[0]= 0x%X , rdbuf[1] = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rdbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span><span class="w"></span>
<span class="w">	  </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Read addr:0x%X succ, getdata = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="n">getdata</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getdata</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">linuxc_i2c_write_16bit_reg</span><span class="p">(</span><span class="n">uint8</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="w"> </span><span class="n">uint16</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reg_data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">uint32</span><span class="w"> </span><span class="n">bWrote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">i2c_status</span><span class="w"> </span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_SUCCESS</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">wdbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">	</span><span class="n">wdbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">)(</span><span class="n">reg_data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">wdbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">)((</span><span class="n">reg_data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wdbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">reg_data</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="n">i2c_slave_config</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="p">.</span><span class="n">bus_frequency_khz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="p">.</span><span class="n">slave_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="p">.</span><span class="n">slave_max_clock_stretch_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="p">.</span><span class="n">core_configuration1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="p">.</span><span class="n">core_configuration2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>

<span class="w">	</span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efiQcomI2cProtocol</span><span class="o">-&gt;</span><span class="n">write</span><span class="w"> </span><span class="p">(</span><span class="n">I2cDeviceHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">wdbuf</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bWrote</span><span class="p">,</span><span class="w"> </span><span class="mi">2500</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">I2C_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i2cstatus</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; Write addr:0x%X data:0x%X error,i2cstatus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">reg_data</span><span class="p">,</span><span class="n">i2cstatus</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">	  </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; Write addr:0x%X data:0x%X succ,bWrote = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">reg_data</span><span class="p">,</span><span class="n">bWrote</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">bWrote</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">linuxc_i2c_read_8bit_reg</span><span class="p">(</span><span class="n">uint8</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="n">uint8</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">uint32</span><span class="w"> </span><span class="n">bRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">getdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">i2c_status</span><span class="w"> </span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_SUCCESS</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>

<span class="w">	</span><span class="n">i2c_slave_config</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">bus_frequency_khz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">slave_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">slave_max_clock_stretch_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">core_configuration1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">core_configuration2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">gBS</span><span class="o">-&gt;</span><span class="n">Stall</span><span class="p">(</span><span class="mi">600000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efiQcomI2cProtocol</span><span class="o">-&gt;</span><span class="n">read</span><span class="w"> </span><span class="p">(</span><span class="n">I2cDeviceHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bRead</span><span class="p">,</span><span class="w"> </span><span class="mi">2500</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">getdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">I2C_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i2cstatus</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Read addr:0x%X error i2cstatus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="n">i2cstatus</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">	  </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Read addr:0x%X succ, getdata = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="n">getdata</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getdata</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">linuxc_i2c_write_8bit_reg</span><span class="p">(</span><span class="n">uint8</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reg_data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">uint32</span><span class="w"> </span><span class="n">bWrote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">i2c_status</span><span class="w"> </span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_SUCCESS</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">wdbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">	</span><span class="n">wdbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">)(</span><span class="n">reg_data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">i2c_slave_config</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">bus_frequency_khz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">slave_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slaveAddress</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">slave_max_clock_stretch_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">core_configuration1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">core_configuration2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>

<span class="w">	</span><span class="n">i2cstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efiQcomI2cProtocol</span><span class="o">-&gt;</span><span class="n">write</span><span class="w"> </span><span class="p">(</span><span class="n">I2cDeviceHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">wdbuf</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bWrote</span><span class="p">,</span><span class="w"> </span><span class="mi">2500</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">I2C_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i2cstatus</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">	  </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; Write addr:0x%X data:0x%X error,i2cstatus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">reg_data</span><span class="p">,</span><span class="n">i2cstatus</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">else</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">	  </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; Write addr:0x%X data:0x%X succ,bWrote = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">reg_data</span><span class="p">,</span><span class="n">bWrote</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">bWrote</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">EFI_STATUS</span><span class="w"> </span><span class="nf">i2c_init</span><span class="p">(</span><span class="n">i2c_instance</span><span class="w"> </span><span class="n">I2C_INSTANCE</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//EFI_QCOM_I2C_PROTOCOL *efiQcomI2cProtocol;</span>
<span class="w">    </span><span class="c1">//void *I2cDeviceHandle;</span>
<span class="w">	</span><span class="c1">//EFI_HANDLE *pHandles;</span>
<span class="w">    </span><span class="n">UINTN</span><span class="w"> </span><span class="n">HandleCnt</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">EFI_STATUS</span><span class="w"> </span><span class="n">efiStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_DEVICE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">i2c_status</span><span class="w"> </span><span class="n">i2cStatus</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**找出支持gQcomI2CProtocolGuid的所有设备**/</span><span class="w"></span>
<span class="w">    </span><span class="n">efiStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gBS</span><span class="o">-&gt;</span><span class="n">LocateHandleBuffer</span><span class="w"> </span><span class="p">(</span><span class="n">ByProtocol</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="o">&amp;</span><span class="n">gQcomI2CProtocolGuid</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="o">&amp;</span><span class="n">HandleCnt</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="o">&amp;</span><span class="n">pHandles</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">efiStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EFI_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="c1">// Print(L&quot;LocateHandleBuffer error %r\r\n&quot;, efiStatus);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">I2C_EXIT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">efiStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gBS</span><span class="o">-&gt;</span><span class="n">HandleProtocol</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                                      </span><span class="n">pHandles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"></span>
<span class="w">                                      </span><span class="o">&amp;</span><span class="n">gQcomI2CProtocolGuid</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="p">(</span><span class="n">VOID</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">efiQcomI2cProtocol</span><span class="w"></span>
<span class="w">                                      </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">efiStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EFI_SUCCESS</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Print(L&quot;handel EFI_SERIAL_IO_PROTOCOL[0] error %r\r\n&quot;, efiStatus);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">I2C_EXIT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">i2cStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efiQcomI2cProtocol</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">I2C_INSTANCE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I2cDeviceHandle</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">i2cStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">I2C_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Print(L&quot;I2c open error %d\r\n&quot;, i2cStatus);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">I2C_EXIT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="nl">I2C_EXIT</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pHandles</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">gBS</span><span class="o">-&gt;</span><span class="n">FreePool</span><span class="p">(</span><span class="n">pHandles</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">efiStatus</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id1">
<h1>调试<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>增加i2c读取接口如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">battery_is_exist</span><span class="p">(</span><span class="n">VOID</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">linuxc_i2c_write_16bit_reg</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span><span class="mh">0x0001</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linuxc_i2c_read_16bit_reg</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x40</span><span class="p">);</span><span class="c1">//gauge中存id的寄存器地址</span>
<span class="w">	</span><span class="n">DEBUG</span><span class="p">((</span><span class="n">EFI_D_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bq27z746 get dev type:0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">));</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BQ27Z746_DeviceType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>打印如下：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span> Write addr:0x3E data:0x1 succ,bWrote = 0x2
Read rdbuf[0]= 0x46 , rdbuf[1] = 0x17
Read addr:0x40 succ, getdata = 0x1746
bq27z746 get dev type:0x1746
</pre></div>
</div>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>