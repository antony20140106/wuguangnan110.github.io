<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">数字耳机和模拟耳机</a></li>
<li><a class="reference internal" href="#typec-cc">typec cc识别原理</a></li>
<li><a class="reference internal" href="#typec">typec耳机方案</a></li>
<li><a class="reference internal" href="#sw5480">SW5480特性</a></li>
<li><a class="reference internal" href="#id4">寄存器表</a></li>
<li><a class="reference internal" href="#id5">参考代码</a></li>
<li><a class="reference internal" href="#id6">打印</a></li>
<li><a class="reference internal" href="#fsa4480">高通自带fsa4480分析</a></li>
<li><a class="reference internal" href="#id7"># SW5480驱动分析</a></li>
<li><a class="reference internal" href="#audio-jack">驱动如何上报audio jack</a></li>
<li><a class="reference internal" href="#id8">中断上报流程</a></li>
<li><a class="reference internal" href="#ncno">耳机NC、NO类型确认</a></li>
<li><a class="reference internal" href="#id9">驱动上报键值</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>qcom qcm2290 TypeC 耳机功能调试过程。</p>
</section>
<section id="id2">
<h1>参考<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../../../_downloads/3517b82deb6c240e26ebbebf72e76e74/ASW5480-DS-EN-V1.2-202108.pdf"><span class="xref download myst">ASW5480-DS-EN-V1.2-202108.pdf</span></a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/Guet_Kite/article/details/117529642">ALSA子系统（十七）——支持Type-C耳机驱动</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/qq_40662854/article/details/100052318">typec耳机知识介绍-数字耳机，模拟耳机</a></p></li>
<li><p><a class="reference download internal" download="" href="../../../_downloads/2586884805319494e1f7061889b9e1e9/ASW5480%E7%9C%BC%E5%9B%BE%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A-20210727.PDF"><span class="xref download myst">ASW5480眼图测试报告-20210727.PDF</span></a></p></li>
</ul>
</section>
<section id="id3">
<h1>数字耳机和模拟耳机<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<p>typec耳机(中图)可能是模拟耳机也可能是数字耳机，以耳机内有没有芯片进行判别。数字耳机包含一个usb声卡+DAC&amp;&amp;ADC+amp+模拟耳机，当数字耳机接入到手机(otg)或者电脑后，手机或者电脑识别到了usb设备，并创建相应的声卡后，数字音频信号通过usb传输到数字耳机后，数字耳机通过DAC转换并放大信号，就可以听到声音了，这也是usb声卡的原理。</p>
<p>手机中模拟和数字耳机的差异：</p>
<p><img alt="0006_0000.png" src="../../../_images/0006_00001.png" /></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DAC :Digital to analog converter数字模拟转换器
AMP:放大器
</pre></div>
</div>
<p>kernel打开数字耳机支持需要打开宏<code class="docutils literal notranslate"><span class="pre">CONFIG_SND_USB_AUDIO</span></code>。</p>
</section>
<section id="typec-cc">
<h1>typec cc识别原理<a class="headerlink" href="#typec-cc" title="此标题的永久链接"></a></h1>
<p>请参考以下文档音频设备章节：</p>
<ul class="simple">
<li><p><span class="xref myst">0001_TypeC基础知识.md</span></p></li>
<li><p>ASW5480芯片一般是从电池取电， 终端在开机或关机状态下芯片均需要处于正常工作状态。</p></li>
<li><p>芯片默认加电后工作在USB模式， 如需要切换到音频模式， 需要CPU通过I2C协议来配置寄存器切换开关通道。</p></li>
<li><p>当耳机插入后， 会把CC1和CC2拉低(CC=VCONN=GND=0V)， 这时表示耳机插入， CPU发送指令把开关切换到音频通道。</p></li>
<li><p>如下图所示：</p></li>
</ul>
<p><img alt="0006_0007.png" src="../../../_images/0006_0007.png" /></p>
</section>
<section id="typec">
<h1>typec耳机方案<a class="headerlink" href="#typec" title="此标题的永久链接"></a></h1>
<p>电路板设计有一个耳机自动切换ic(模拟耳机的左右声道接在usb+、usb-,因此需要切换开光，如DIO3202A, vbus电平为高，芯片切换到usb通路,vbus电平为低，切换到耳机通路),数字耳机接入耳机后，typec逻辑芯片检测到从设备，cpu上的usb切换到主模式，并提供5v(vbus)给从设备供电，完成相应的数字信号传输。</p>
<p><img alt="0006_0001.png" src="../../../_images/0006_00011.png" /></p>
<p>目前A665x项目使用的是asw5480切换芯片，硬件原理如下：</p>
<p><img alt="0006_0003.png" src="../../../_images/0006_0003.png" /></p>
<p>CC_IN可以不经过ASW5480这颗芯片，直接连接到主控基带芯片即可，CC1和CC2的逻辑都是通过主控基带芯片来完成判断的,ASW5480这颗芯片是受控端，它只是个开关，开关的开启关闭和切换到哪一个通道是通过基带的主控通过I2C发送寄存器来实现的。</p>
<ul class="simple">
<li><p>USB硬件通路:DN_L to DN switch ON、DP_R to DP switch ON</p></li>
<li><p>耳机硬件通路: DN_L to L switch ON、DP_R to R switch ON</p></li>
</ul>
<p>下图为手机或平板设备使用耳机时的应用场景：</p>
<p><img alt="0006_0012.png" src="../../../_images/0006_0012.png" /></p>
</section>
<section id="sw5480">
<h1>SW5480特性<a class="headerlink" href="#sw5480" title="此标题的永久链接"></a></h1>
<p><img alt="0006_0006.png" src="../../../_images/0006_0006.png" /></p>
<p>注意，该IC有耳机插入后自动检测并配置耳机模式功能，所以正反插不用管，芯片自动配置通道。</p>
<p><img alt="0006_0009.png" src="../../../_images/0006_0009.png" /></p>
<ul class="simple">
<li><p>特性：</p></li>
</ul>
<p><img alt="0006_0013.png" src="../../../_images/0006_0013.png" /></p>
</section>
<section id="id4">
<h1>寄存器表<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>device id</p></li>
</ul>
<p><img alt="0006_0004.png" src="../../../_images/0006_0004.png" /></p>
<ul class="simple">
<li><p>SWITCH SELECT</p></li>
</ul>
<p><img alt="0006_0005.png" src="../../../_images/0006_0005.png" /></p>
</section>
<section id="id5">
<h1>参考代码<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../../../_downloads/59f0f345aae5e4f3621b8c494660807f/asw5480.c"><span class="xref download myst">asw5480.c</span></a></p></li>
</ul>
</section>
<section id="id6">
<h1>打印<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h1>
<p>插入typec耳机有打印如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>[Tue Aug  2 23:54:33 2022] xxx-pd-manager soc:xxx_pd_manager: pd_tcp_notifier_call Audio plug in
[  537.098158] init: Control message: Could not find &#39;android.hardware.soundtrigger@2.0::ISoundTriggerHw/default&#39; for ctl.interface_start from pid: 407 (/system/bin/hwservicemanager)
[  539.104856] init: Control message: Could not find &#39;android.hardware.soundtrigger@2.0::ISoundTriggerHw/default&#39; for ctl.interface_start from pid: 407 (/system/bin/hwservicemanager)
[  540.105379] init: Control message: Could not find &#39;android.hardware.soundtrigger@2.0::ISoundTriggerHw/default&#39; for ctl.interface_start from pid: 407 (/system/bin/hwservicemanager)
[  541.106552] init: Control message: Could not find &#39;android.hardware.soundtrigger@2.0::ISoundTriggerHw/default&#39; for ctl.interface_start from pid: 407 (/system/bin/hwservicemanager)
[  542.109764] init: Control message: Could not find &#39;android.hardware.soundtrigger@2.0::ISoundTriggerHw/default&#39; for ctl.interface_start from pid: 407 (/system/bin/hwservicemanager)
[  542.344424] xxx-pd-manager soc:xxx_pd_manager: pd_tcp_notifier_call event = 14
[Tue Aug  2 23:55:39 2022] xxx-pd-manager soc:xxx_pd_manager: pd_tcp_notifier_call Audio plug out
</pre></div>
</div>
</section>
<section id="fsa4480">
<h1>高通自带fsa4480分析<a class="headerlink" href="#fsa4480" title="此标题的永久链接"></a></h1>
<p>高通自带fsa4480应用如下，和SW5480差不多，也具备自动检测耳机及切换功能。</p>
<p><img alt="0006_0008.png" src="../../../_images/0006_0008.png" /></p>
<p>看一下程序流程：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>* fsa4480_probe
  ├── fsa_priv-&gt;usb_psy = power_supply_get_by_name(&quot;usb&quot;);
  ├── fsa_priv-&gt;regmap = devm_regmap_init_i2c(i2c, &amp;fsa4480_regmap_config); //采用regmap控制i2c
  ├── fsa4480_update_reg_defaults(fsa_priv-&gt;regmap); //将默认fsa_reg_i2c_defaults寄存器数据写入
  ├── fsa_priv-&gt;psy_nb.notifier_call = fsa4480_usbc_event_changed; //处理typec audio拔插信息
  ├── rc = power_supply_reg_notifier(&amp;fsa_priv-&gt;psy_nb); //注册接收psy(typec)消息通知
  └── INIT_WORK(&amp;fsa_priv-&gt;usbc_analog_work,fsa4480_usbc_analog_work_fn); //usb分析工作队列
</pre></div>
</div>
<ul class="simple">
<li><p>寄存器默认配置如下：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FSA4480_SWITCH_SETTINGS 0x04</span>
<span class="cp">#define FSA4480_SWITCH_CONTROL  0x05</span>
<span class="cp">#define FSA4480_SWITCH_STATUS1  0x07</span>
<span class="cp">#define FSA4480_SLOW_L          0x08</span>
<span class="cp">#define FSA4480_SLOW_R          0x09</span>
<span class="cp">#define FSA4480_SLOW_MIC        0x0A</span>
<span class="cp">#define FSA4480_SLOW_SENSE      0x0B</span>
<span class="cp">#define FSA4480_SLOW_GND        0x0C</span>
<span class="cp">#define FSA4480_DELAY_L_R       0x0D</span>
<span class="cp">#define FSA4480_DELAY_L_MIC     0x0E</span>
<span class="cp">#define FSA4480_DELAY_L_SENSE   0x0F</span>
<span class="cp">#define FSA4480_DELAY_L_AGND    0x10</span>
<span class="cp">#define FSA4480_RESET           0x1E</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fsa4480_reg_val</span><span class="w"> </span><span class="n">fsa_reg_i2c_defaults</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_SLOW_L</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_SLOW_R</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_SLOW_MIC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_SLOW_SENSE</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_SLOW_GND</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_DELAY_L_R</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_DELAY_L_MIC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_DELAY_L_SENSE</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_DELAY_L_AGND</span><span class="p">,</span><span class="w"> </span><span class="mh">0x09</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">FSA4480_SWITCH_SETTINGS</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="p">},</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>工作逻辑：当监听到psy typec audio拔插事件后，启动工作<code class="docutils literal notranslate"><span class="pre">usbc_analog_work</span></code>队列进行配置：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fsa4480_usbc_event_changed</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="n">nb</span><span class="p">,</span><span class="w"></span>
<span class="w">				      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">evt</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="w"> </span><span class="nc">power_supply_propval</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">fsa4480_priv</span><span class="w"> </span><span class="o">*</span><span class="n">fsa_priv</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">			</span><span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fsa4480_priv</span><span class="p">,</span><span class="w"> </span><span class="n">psy_nb</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fsa_priv</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">struct</span><span class="w"> </span><span class="nc">power_supply</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">				</span><span class="n">evt</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PSY_EVENT_PROP_CHANGED</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">power_supply_get_property</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">POWER_SUPPLY_PROP_TYPEC_MODE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: Unable to read USB TYPEC_MODE: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: USB change event received, supply mode %d, usbc mode %d, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span><span class="n">intval</span><span class="p">,</span><span class="w"> </span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">usbc_mode</span><span class="p">.</span><span class="n">counter</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">POWER_SUPPLY_TYPEC_SINK_AUDIO_ADAPTER</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">POWER_SUPPLY_TYPEC_SINK_AUDIO_ADAPTER</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">POWER_SUPPLY_TYPEC_NONE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">usbc_mode</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="cm">/* filter notifications received before 过滤两次相同的通知 */</span><span class="w"></span>
<span class="w">		</span><span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">usbc_mode</span><span class="p">),</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span><span class="n">intval</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: queueing usbc_analog_work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">pm_stay_awake</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">queue_work</span><span class="p">(</span><span class="n">system_freezable_wq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">usbc_analog_work</span><span class="p">);</span><span class="w"> </span><span class="c1">//启动工作usbc_analog_work队列进行配置</span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fsa4480_usbc_analog_work_fn</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="o">*</span><span class="n">work</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">fsa4480_priv</span><span class="w"> </span><span class="o">*</span><span class="n">fsa_priv</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">		</span><span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fsa4480_priv</span><span class="p">,</span><span class="w"> </span><span class="n">usbc_analog_work</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fsa_priv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: fsa container invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">fsa4480_usbc_analog_setup_switches</span><span class="p">(</span><span class="n">fsa_priv</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">pm_relax</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fsa4480_usbc_analog_setup_switches</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">fsa4480_priv</span><span class="w"> </span><span class="o">*</span><span class="n">fsa_priv</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="w"> </span><span class="nc">power_supply_propval</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fsa_priv</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">notification_lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* get latest mode again within locked context */</span><span class="w"></span>
<span class="w">	</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">power_supply_get_property</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">usb_psy</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">POWER_SUPPLY_PROP_TYPEC_MODE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: Unable to read USB TYPEC_MODE: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">rc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: setting GPIOs active = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span><span class="n">intval</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">POWER_SUPPLY_TYPEC_NONE</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* add all modes FSA should notify for in here */</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">POWER_SUPPLY_TYPEC_SINK_AUDIO_ADAPTER</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* activate switches */</span><span class="w"></span>
<span class="w">		</span><span class="n">fsa4480_usbc_update_settings</span><span class="p">(</span><span class="n">fsa_priv</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9F</span><span class="p">);</span><span class="w"> </span><span class="c1">//reg:05 -&gt; val:00 reg:04 -&gt; val:9F</span>

<span class="w">		</span><span class="cm">/* notify call chain on event */</span><span class="w"></span>
<span class="w">		</span><span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">fsa4480_notifier</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">mode</span><span class="p">.</span><span class="n">intval</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">POWER_SUPPLY_TYPEC_NONE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* notify call chain on event */</span><span class="w"></span>
<span class="w">		</span><span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">fsa4480_notifier</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">POWER_SUPPLY_TYPEC_NONE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="cm">/* deactivate switches */</span><span class="w"></span>
<span class="w">		</span><span class="n">fsa4480_usbc_update_settings</span><span class="p">(</span><span class="n">fsa_priv</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="p">);</span><span class="w"> </span><span class="c1">//reg:05 -&gt; val:18 reg:04 -&gt; val:98</span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* ignore other usb connection modes */</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="nl">done</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">notification_lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fsa4480_usbc_update_settings</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">fsa4480_priv</span><span class="w"> </span><span class="o">*</span><span class="n">fsa_priv</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">u32</span><span class="w"> </span><span class="n">switch_control</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">switch_enable</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: regmap invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">regmap_write</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span><span class="w"> </span><span class="n">FSA4480_SWITCH_SETTINGS</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// reg:04 -&gt; val:08  Device Enable</span>
<span class="w">	</span><span class="n">regmap_write</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span><span class="w"> </span><span class="n">FSA4480_SWITCH_CONTROL</span><span class="p">,</span><span class="w"> </span><span class="n">switch_control</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* FSA4480 chip hardware requirement */</span><span class="w"></span>
<span class="w">	</span><span class="n">usleep_range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">regmap_write</span><span class="p">(</span><span class="n">fsa_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span><span class="w"> </span><span class="n">FSA4480_SWITCH_SETTINGS</span><span class="p">,</span><span class="w"> </span><span class="n">switch_enable</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>两条逻辑如下，可以看到主要是切换usb/audio通道和使能Sense/MIC/AGND切换，具体切换到哪条线路，芯片内部自动切：</p>
<ul class="simple">
<li><p>audio plug in: reg:05 -&gt; val:00 reg:04 -&gt; val:9F</p>
<ul>
<li><p>DP_R to R switch ON</p></li>
<li><p>DP_L to L switch ON</p></li>
<li><p>Sense to GSBUx switches enable</p></li>
<li><p>MIC to SBUx switches enable</p></li>
<li><p>AGND to SBUx switches enable</p></li>
</ul>
</li>
<li><p>audio plug out: reg:05 -&gt; val:18 reg:04 -&gt; val:98</p>
<ul>
<li><p>DP_R to DP switch ON</p></li>
<li><p>DP_L to DN switch ON</p></li>
<li><p>Sense,GSBU1 and GSBU2 will be high−Z fof positive input</p></li>
<li><p>MIC will be high−Z for positive input</p></li>
<li><p>AGND will be high−Z for positive input</p></li>
</ul>
</li>
</ul>
</section>
<section id="id7">
<h1># SW5480驱动分析<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h1>
<p>V03增加了mic/AGND/Sense引脚，主要是增加了mic录音功能，功能和寄存器基本上和fsa4480一样，唯一不同的是多了一步耳机检测使能：</p>
<p><img alt="0006_0011.png" src="../../../_images/0006_0011.png" />
<img alt="0006_0014.png" src="../../../_images/0006_0014.png" /></p>
</section>
<section id="audio-jack">
<h1>驱动如何上报audio jack<a class="headerlink" href="#audio-jack" title="此标题的永久链接"></a></h1>
<p>首先typec检测到耳机插入，然后通知audio驱动进行上报，具体如何上报，我们先看一下流程：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UM.9.15/vendor/qcom/opensource/audio-kernel/asoc/codecs/bolero/bolero-cdc.c</span></code>:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>* bolero_ssr_enable
  └── bolero_cdc_notifier_call(priv, BOLERO_WCD_EVT_SSR_UP);
      └── rouleur_event_notify //asoc/codecs/rouleur/rouleur.c 收获到通知
          └── rouleur_mbhc_hs_detect(component, mbhc-&gt;mbhc_cfg);//asoc/codecs/rouleur/rouleur-mbhc.c
              └── wcd_mbhc_start(&amp;rouleur_mbhc-&gt;wcd_mbhc, mbhc_cfg); //asoc/codecs/wcd-mbhc-v2.c
                  ├── mbhc-&gt;fsa_nb.notifier_call = wcd_mbhc_usbc_ana_event_handler; //这个是9200 fsa4480的通知回调
                  │   └──  wcd_mbhc_usbc_ana_event_handler(struct notifier_block *nb
                  │       └── if (mode == POWER_SUPPLY_TYPEC_SINK_AUDIO_ADAPTER)
                  │           ├── mbhc-&gt;mbhc_cb-&gt;clk_setup(mbhc-&gt;component, true);
                  │           └──  WCD_MBHC_REG_UPDATE_BITS(WCD_MBHC_L_DET_EN, 1); /* insertion detected, enable L_DET_EN */
                  ├── rc = fsa4480_reg_notifier(&amp;mbhc-&gt;fsa_nb, mbhc-&gt;fsa_np); //调用fsa4480-i2c.c驱动中的接口
                  ├── mbhc-&gt;hp_det_nb.notifier_call = hp_det_nc; //这个是6650的typec通知回调
                  ├── if (!dev_notify_register_client(card-&gt;dev, &amp;mbhc-&gt;hp_det_nb)) //注册回调接收typec插入拔出通知
                  │   └── hp_det_nc(struct notifier_block *self, unsigned long event, void *data)
                  │       ├── mbhc-&gt;mbhc_cb-&gt;clk_setup(mbhc-&gt;component, true); //打开相关时钟
                  │       ├── WCD_MBHC_REG_UPDATE_BITS(WCD_MBHC_L_DET_EN, 1);/* insertion detected, enable L_DET_EN */
                  │       └── wcd_mbhc_swch_irq_handler(mbhc);
                  │           └── wcd_mbhc_report_plug(mbhc, 0, jack_type);
                  │               ├── wcd_mbhc_jack_report(mbhc, &amp;mbhc-&gt;button_jack, 0,mbhc-&gt;buttons_pressed); //上报按键
                  │               └── wcd_mbhc_jack_report(mbhc, &amp;mbhc-&gt;headset_jack,(mbhc-&gt;hph_status | SND_JACK_MECHANICAL),
                  │                   └── snd_soc_jack_report(jack, status, mask);
                  └── rc = wcd_mbhc_initialise(mbhc); //耳机检测相关 0:NC(normally-closed) 1:NO(normally-open)
                      ├── WCD_MBHC_REG_UPDATE_BITS(WCD_MBHC_HPHL_PLUG_TYPE, mbhc-&gt;hphl_swh);
                      └── WCD_MBHC_REG_UPDATE_BITS(WCD_MBHC_GND_PLUG_TYPE, mbhc-&gt;gnd_swh);
</pre></div>
</div>
</section>
<section id="id8">
<h1>中断上报流程<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h1>
<p>有个疑问，为什么<code class="docutils literal notranslate"><span class="pre">wcd_mbhc_usbc_ana_event_handler</span></code>回调中没有去上报键值，原因是由中断处理了，具体看一下是哪些中断，通过<code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/proc/interrupts</span></code>：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="mi">261</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">rouleur</span><span class="w"></span>
<span class="mi">262</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">HPHR</span><span class="w"> </span><span class="n">PDM</span><span class="w"> </span><span class="n">WD</span><span class="w"> </span><span class="n">INT</span><span class="w"></span>
<span class="mi">263</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">  </span><span class="mi">13</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">HPHL</span><span class="w"> </span><span class="n">PDM</span><span class="w"> </span><span class="n">WD</span><span class="w"> </span><span class="n">INT</span><span class="w"></span>
<span class="mi">264</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">4</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">mbhc</span><span class="w"> </span><span class="n">sw</span><span class="w"> </span><span class="n">intr</span><span class="w"> </span><span class="c1">//耳机插入检测</span>
<span class="mi">265</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">Button</span><span class="w"> </span><span class="n">Press</span><span class="w"> </span><span class="n">detect</span><span class="w"></span>
<span class="mi">266</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">Button</span><span class="w"> </span><span class="n">Release</span><span class="w"> </span><span class="n">detect</span><span class="w"></span>
<span class="mi">267</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">3</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">Elect</span><span class="w"> </span><span class="n">Insert</span><span class="w"></span>
<span class="mi">268</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">2</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">Elect</span><span class="w"> </span><span class="n">Remove</span><span class="w"></span>
<span class="mi">269</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">7</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">HPH_L</span><span class="w"> </span><span class="n">OCP</span><span class="w"> </span><span class="n">detect</span><span class="w"></span>
<span class="mi">270</span><span class="o">:</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">          </span><span class="mi">0</span><span class="w">   </span><span class="n">rouleur</span><span class="w">   </span><span class="mi">5</span><span class="w"> </span><span class="n">Edge</span><span class="w">      </span><span class="n">HPH_R</span><span class="w"> </span><span class="n">OCP</span><span class="w"> </span><span class="n">detect</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">asoc/codecs/rouleur/rouleur.c</span></code>中断注册如下：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="w"> </span><span class="n">rouleur_soc_codec_probe</span><span class="w"> </span><span class="c1">//{ .compatible = &quot;qcom,rouleur-codec&quot; , .data = &quot;rouleur&quot; },</span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">rouleur_mbhc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">mbhc</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="p">);</span><span class="w"> </span><span class="c1">//asoc/codecs/rouleur/rouleur-mbhc.c</span>
<span class="w">    </span><span class="o">*</span><span class="w">  </span><span class="n">wcd_mbhc_init</span><span class="p">(</span><span class="n">wcd_mbhc</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mbhc_cb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">intr_ids</span><span class="p">,</span><span class="w"> </span><span class="n">wcd_mbhc_registers</span><span class="p">,</span><span class="w"> </span><span class="n">ROULEUR_ZDET_SUPPORTED</span><span class="p">);</span><span class="w"> </span><span class="c1">//asoc/codecs/wcd-mbhc-v2.c</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">hph_switch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;qcom,msm-mbhc-hphl-swh&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">gnd_switch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;qcom,msm-mbhc-gnd-swh&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//在wcd_mbhc_initialise进行配置</span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span><span class="w"> </span><span class="n">hph_switch</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hph_swh</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span><span class="w"> </span><span class="n">gnd_switch</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gnd_swh</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">mbhc_cb</span><span class="o">-&gt;</span><span class="n">request_irq</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">intr_ids</span><span class="o">-&gt;</span><span class="n">mbhc_sw_intr</span><span class="p">,</span><span class="n">wcd_mbhc_mech_plug_detect_irq</span><span class="p">,</span><span class="s">&quot;mbhc sw intr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="w"> </span><span class="n">rouleur_mbhc_request_irq</span><span class="w">  </span><span class="c1">//asoc/codecs/rouleur/rouleur-mbhc.c</span>
<span class="w">          </span><span class="o">*</span><span class="w"> </span><span class="n">wcd_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w"> </span><span class="c1">//asoc/codecs/wcd-irq.c</span>
<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="n">wcd_map_irq</span><span class="p">(</span><span class="n">irq_info</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="w"> </span><span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">IRQF_ONESHOT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">mbhc_cb</span><span class="o">-&gt;</span><span class="n">request_irq</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">intr_ids</span><span class="o">-&gt;</span><span class="n">mbhc_btn_press_intr</span><span class="p">,</span><span class="w"> </span><span class="n">wcd_mbhc_btn_press_handler</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Button Press detect&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">mbhc_cb</span><span class="o">-&gt;</span><span class="n">request_irq</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">intr_ids</span><span class="o">-&gt;</span><span class="n">mbhc_btn_release_intr</span><span class="p">,</span><span class="w"> </span><span class="n">wcd_mbhc_release_handler</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Button Release detect&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">mbhc_cb</span><span class="o">-&gt;</span><span class="n">request_irq</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">intr_ids</span><span class="o">-&gt;</span><span class="n">mbhc_hs_ins_intr</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="o">-&gt;</span><span class="n">mbhc_fn</span><span class="o">-&gt;</span><span class="n">wcd_mbhc_hs_ins_irq</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Elect Insert&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mbhc</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>参考</p></li>
<li><p><a class="reference external" href="http://www.manongjc.com/detail/27-pnriikehmuooerg.html">Audio 耳机 （四）MBHC耳机插拔检测流程</a></p></li>
</ul>
<p>codec通过检测硬件监控MBHC hsdet引脚上的电压，并在耳机插入或拔出插头时向中断控制器生成中断（更新寄存器）。</p>
<p>对于NC型插孔，未插入插头时，连接器的HS-DET和HPH-L引脚短接在一起，从而在MBHC_HSDET引脚上产生逻辑低电压。
将插头完全插入插孔后，断开连接器的HS-DET和HPH-L引脚，内部电流源将MBHC hsdet引脚上的电压拉高至1.8 V，并翻转比较器输出以触发中断信号。
拔出插头后，MBHC_HSDET引脚上的电压下降，导致比较器的输出逻辑改变，并向中断控制器生成中断信号。
对于NO型插孔，MBHC hsdet引脚上的电压与NC型插孔壳体相反。</p>
<p><img alt="0006_0015.png" src="../../../_images/0006_0015.png" /></p>
<ul class="simple">
<li><p>中断配置过程：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * struct regmap_irq - Description of an IRQ for the generic regmap irq_chip.</span>
<span class="cm"> *</span>
<span class="cm"> * @reg_offset: Offset of the status/mask register within the bank</span>
<span class="cm"> * @mask:       Mask used to flag/control the register.</span>
<span class="cm"> * @type_reg_offset: Offset register for the irq type setting.</span>
<span class="cm"> * @type_rising_mask: Mask bit to configure RISING type irq.</span>
<span class="cm"> * @type_falling_mask: Mask bit to configure FALLING type irq.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">regmap_irq</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reg_offset</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">type_reg_offset</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">type_rising_mask</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">type_falling_mask</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cp">#define REGMAP_IRQ_REG(_irq, _off, _mask)       \</span>
<span class="cp">    [_irq] = { .reg_offset = (_off), .mask = (_mask) }</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">regmap_irq</span><span class="w"> </span><span class="n">ROULEUR_IRQs</span><span class="p">[</span><span class="n">ROULEUR_NUM_IRQS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_MBHC_BUTTON_PRESS_DET</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_MBHC_BUTTON_RELEASE_DET</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_MBHC_ELECT_INS_REM_DET</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_MBHC_ELECT_INS_REM_LEG_DET</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_MBHC_SW_DET</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHR_OCP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHR_CNP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHL_OCP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHL_CNP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_EAR_CNP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_EAR_OCP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_LO_CNP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_LO_OCP_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHL_PDM_WD_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHR_PDM_WD_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHL_SURGE_DET_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">REGMAP_IRQ_REG</span><span class="p">(</span><span class="n">ROULEUR_IRQ_HPHR_SURGE_DET_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">),</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">regmap_irq_chip</span><span class="w"> </span><span class="n">rouleur_regmap_irq_chip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rouleur&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">irqs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROULEUR_IRQs</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">num_irqs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ROULEUR_IRQs</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">num_regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">status_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROULEUR_DIG_SWR_INTR_STATUS_0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">mask_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROULEUR_DIG_SWR_INTR_MASK_0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">ack_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROULEUR_DIG_SWR_INTR_CLEAR_0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">use_ack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">type_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROULEUR_DIG_SWR_INTR_LEVEL_0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">runtime_pm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">handle_post_irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rouleur_handle_post_irq</span><span class="p">,</span><span class="c1">//handle_post_irq: Driver specific callback to handle interrupt from device</span>
<span class="w">    </span><span class="p">.</span><span class="n">irq_drv_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">rouleur_handle_post_irq</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="c1">//中断处理函数</span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rouleur_priv</span><span class="w"> </span><span class="o">*</span><span class="n">rouleur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">status1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">status2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">status3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">regmap_read</span><span class="p">(</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span><span class="w"> </span><span class="n">ROULEUR_DIG_SWR_INTR_STATUS_0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">regmap_read</span><span class="p">(</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span><span class="w"> </span><span class="n">ROULEUR_DIG_SWR_INTR_STATUS_1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">regmap_read</span><span class="p">(</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span><span class="w"> </span><span class="n">ROULEUR_DIG_SWR_INTR_STATUS_2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status3</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">tx_swr_dev</span><span class="o">-&gt;</span><span class="n">slave_irq_pending</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="n">status1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">status2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">status3</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IRQ_HANDLED</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">rouleur_bind</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Set all interupts as edge triggered */</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rouleur_regmap_irq_chip</span><span class="p">.</span><span class="n">num_regs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">regmap_write</span><span class="p">(</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="p">(</span><span class="n">ROULEUR_DIG_SWR_INTR_LEVEL_0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">rouleur_regmap_irq_chip</span><span class="p">.</span><span class="n">irq_drv_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rouleur</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">wcd_regmap_irq_chip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rouleur_regmap_irq_chip</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">codec_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rouleur&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">regmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wcd_irq_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rouleur</span><span class="o">-&gt;</span><span class="n">virq</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>dts中断定义：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">rx_macro</span><span class="p">:</span> <span class="n">rx</span><span class="o">-</span><span class="n">macro</span><span class="o">@</span><span class="mi">0</span><span class="n">a600000</span> <span class="p">{</span>
        <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;qcom,rx-macro&quot;</span><span class="p">;</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0a600000</span> <span class="mh">0x0</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">clock</span><span class="o">-</span><span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;rx_core_clk&quot;</span><span class="p">,</span> <span class="s2">&quot;rx_npl_clk&quot;</span><span class="p">;</span>
        <span class="n">clocks</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">clock_audio_rx_1</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
             <span class="o">&lt;&amp;</span><span class="n">clock_audio_rx_2</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">qcom</span><span class="p">,</span><span class="n">rx</span><span class="o">-</span><span class="n">swr</span><span class="o">-</span><span class="n">gpios</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">rx_swr_gpios</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">swr1</span><span class="p">:</span> <span class="n">rx_swr_master</span> <span class="p">{</span>
            <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;qcom,swr-mstr&quot;</span><span class="p">;</span>
            <span class="n">interrupts</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="mi">297</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
            <span class="n">interrupt</span><span class="o">-</span><span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;swr_master_irq&quot;</span><span class="p">;</span>
            <span class="n">qcom</span><span class="p">,</span><span class="n">swr</span><span class="o">-</span><span class="n">num</span><span class="o">-</span><span class="n">ports</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">;</span>
            <span class="n">qcom</span><span class="p">,</span><span class="n">disable</span><span class="o">-</span><span class="n">div2</span><span class="o">-</span><span class="n">clk</span><span class="o">-</span><span class="n">switch</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
            <span class="n">qcom</span><span class="p">,</span><span class="n">swr</span><span class="o">-</span><span class="n">port</span><span class="o">-</span><span class="n">mapping</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">1</span> <span class="n">HPH_L</span> <span class="mh">0x1</span><span class="o">&gt;</span><span class="p">,</span>
                <span class="o">&lt;</span><span class="mi">1</span> <span class="n">HPH_R</span> <span class="mh">0x2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">2</span> <span class="n">CLSH</span> <span class="mh">0x1</span><span class="o">&gt;</span><span class="p">,</span>
                <span class="o">&lt;</span><span class="mi">3</span> <span class="n">COMP_L</span> <span class="mh">0x1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">3</span> <span class="n">COMP_R</span> <span class="mh">0x2</span><span class="o">&gt;</span><span class="p">,</span>
                <span class="o">&lt;</span><span class="mi">4</span> <span class="n">LO</span> <span class="mh">0x1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">5</span> <span class="n">DSD_L</span> <span class="mh">0x1</span><span class="o">&gt;</span><span class="p">,</span>
                <span class="o">&lt;</span><span class="mi">5</span> <span class="n">DSD_R</span> <span class="mh">0x2</span><span class="o">&gt;</span><span class="p">;</span>
            <span class="n">qcom</span><span class="p">,</span><span class="n">swr</span><span class="o">-</span><span class="n">num</span><span class="o">-</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
            <span class="n">qcom</span><span class="p">,</span><span class="n">swr</span><span class="o">-</span><span class="n">clock</span><span class="o">-</span><span class="n">stop</span><span class="o">-</span><span class="n">mode0</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
            <span class="n">rouleur_rx_slave</span><span class="p">:</span> <span class="n">rouleur</span><span class="o">-</span><span class="n">rx</span><span class="o">-</span><span class="n">slave</span> <span class="p">{</span>
                <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;qcom,rouleur-slave&quot;</span><span class="p">;</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0C</span> <span class="mh">0x01170224</span><span class="o">&gt;</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">};</span>
    <span class="p">};</span>

</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">interrupts</span> <span class="pre">=</span> <span class="pre">&lt;0</span> <span class="pre">297</span> <span class="pre">IRQ_TYPE_LEVEL_HIGH&gt;;</span></code>表示用系统的297号中断。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">soc/swr-mstr-ctrl.c</span></code>其中中断标志<code class="docutils literal notranslate"><span class="pre">slave_irq_pending</span></code>是通过<code class="docutils literal notranslate"><span class="pre">rouleur</span></code>驱动<code class="docutils literal notranslate"><span class="pre">rouleur_handle_post_irq</span></code>设置的，再根据handle_nested_irq寻找<code class="docutils literal notranslate"><span class="pre">irq</span> <span class="pre">id</span></code>找到对应的中断处理函数:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">swrm_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">reg_irq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">reg_irq</span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">swr_mstr_interrupt</span><span class="p">,</span><span class="w"> </span><span class="n">swrm</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">SWR_IRQ_REGISTER</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: IRQ register failed ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err_irq_fail</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//我感觉应该是走的这里，因为dts里面定义了swr_master_irq</span>
<span class="w">        </span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;swr_master_irq&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dev_err</span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s() error getting irq hdle: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err_irq_fail</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">swr_mstr_interrupt_v2</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">IRQF_TRIGGER_RISING</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IRQF_ONESHOT</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="s">&quot;swr_master_irq&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">swrm</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dev_err</span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: Failed to request irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err_irq_fail</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">//中断处理函数</span>
<span class="k">static</span><span class="w"> </span><span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">swr_mstr_interrupt_v2</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="nl">handle_irq</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SWRM_INTERRUPT_MAX</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intr_sts_masked</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SWRM_INTERRUPT_STATUS_SLAVE_PEND_IRQ</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: Trigger irq to slave device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swr_master_read</span><span class="p">(</span><span class="n">swrm</span><span class="p">,</span><span class="w"> </span><span class="n">SWRM_MCP_SLV_STATUS</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swrm_find_alert_slave</span><span class="p">(</span><span class="n">swrm</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">devnum</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">dev_err_ratelimited</span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="s">&quot;%s: no slave alert found.spurious interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">swrm_cmd_fifo_rd_cmd</span><span class="p">(</span><span class="n">swrm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">devnum</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">SWRS_SCP_INT_STATUS_CLEAR_1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">swrm_cmd_fifo_wr_cmd</span><span class="p">(</span><span class="n">swrm</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4</span><span class="p">,</span><span class="w"> </span><span class="n">devnum</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">SWRS_SCP_INT_STATUS_CLEAR_1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">swrm_cmd_fifo_wr_cmd</span><span class="p">(</span><span class="n">swrm</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="n">devnum</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">SWRS_SCP_INT_STATUS_CLEAR_1</span><span class="p">);</span><span class="w"></span>


<span class="w">            </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">swr_dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mstr</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span><span class="w"> </span><span class="n">dev_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swr_dev</span><span class="o">-&gt;</span><span class="n">dev_num</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">devnum</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swr_dev</span><span class="o">-&gt;</span><span class="n">slave_irq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">swr_dev</span><span class="o">-&gt;</span><span class="n">slave_irq_pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="n">handle_nested_irq</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">irq_find_mapping</span><span class="p">(</span><span class="w"></span>
<span class="w">                            </span><span class="n">swr_dev</span><span class="o">-&gt;</span><span class="n">slave_irq</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">swr_dev</span><span class="o">-&gt;</span><span class="n">slave_irq_pending</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">intr_sts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">swr_master_read</span><span class="p">(</span><span class="n">swrm</span><span class="p">,</span><span class="w"> </span><span class="n">SWRM_INTERRUPT_STATUS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">intr_sts_masked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intr_sts</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intr_sts_masked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">swrm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s: new interrupt received 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">intr_sts_masked</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">handle_irq</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="ncno">
<h1>耳机NC、NO类型确认<a class="headerlink" href="#ncno" title="此标题的永久链接"></a></h1>
<p>耳机检测相关 0:NC(normally-closed) 1:NO(normally-open)</p>
<ul class="simple">
<li><p>参考</p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/hb9312z/article/details/86063963">高通音频MBHC耳机系统软件相关配置归纳</a></p></li>
<li><p><a class="reference external" href="https://www.cnblogs.com/linhaostudy/p/8260813.html">NC和NO、耳机美标和欧标的区别</a></p></li>
<li><p>这里涉及dts中的耳机配置：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="p">&amp;</span>scuba_snd <span class="o">{</span>
    qcom,model <span class="o">=</span> <span class="s2">&quot;bengal-scubaidp_AW1SPK-snd-card&quot;</span><span class="p">;</span>
    qcom,msm-mbhc-hphl-swh <span class="o">=</span> &lt;<span class="m">0</span>&gt;<span class="p">;</span>
    qcom,msm-mbhc-gnd-swh <span class="o">=</span> &lt;<span class="m">0</span>&gt;<span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<p>根据硬件原理图，确认HS-DET和HPG-L引脚的连接状态，未插入时断开的则时NO,未插入时连接的则是NC，目前6650配置是的0。
具体原理如下：</p>
<p><img alt="0006_0010.png" src="../../../_images/0006_0010.png" /></p>
</section>
<section id="id9">
<h1>驱动上报键值<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sound/soc/soc-jack.c</span></code>kernel中重点看一下<code class="docutils literal notranslate"><span class="pre">snd_soc_jack_report</span></code>函数:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * snd_soc_jack_report - Report the current status for a jack</span>
<span class="cm"> *</span>
<span class="cm"> * @jack:   the jack</span>
<span class="cm"> * @status: a bitmask of enum snd_jack_type values that are currently detected.</span>
<span class="cm"> * @mask:   a bitmask of enum snd_jack_type values that being reported.</span>
<span class="cm"> *</span>
<span class="cm"> * If configured using snd_soc_jack_add_pins() then the associated</span>
<span class="cm"> * DAPM pins will be enabled or disabled as appropriate and DAPM</span>
<span class="cm"> * synchronised.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: This function uses mutexes and should be called from a</span>
<span class="cm"> * context which can sleep (such as a workqueue).</span>
<span class="cm"> */</span><span class="w"></span>
<span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">snd_soc_jack_report</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">snd_soc_jack</span><span class="w"> </span><span class="o">*</span><span class="n">jack</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">snd_soc_dapm_context</span><span class="w"> </span><span class="o">*</span><span class="n">dapm</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">snd_soc_jack_pin</span><span class="w"> </span><span class="o">*</span><span class="n">pin</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">enable</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">jack</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">trace_snd_soc_jack_report</span><span class="p">(</span><span class="n">jack</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">dapm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dapm</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">mask</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">trace_snd_soc_jack_notify</span><span class="p">(</span><span class="n">jack</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">pins</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">invert</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">enable</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">snd_soc_dapm_enable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span><span class="w"> </span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">snd_soc_dapm_disable_pin</span><span class="p">(</span><span class="n">dapm</span><span class="p">,</span><span class="w"> </span><span class="n">pin</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* we need to sync for this case only */</span><span class="w"></span>
<span class="w">        </span><span class="n">sync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Report before the DAPM sync to help users updating micbias status */</span><span class="w"></span>
<span class="w">    </span><span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">,</span><span class="w"> </span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">jack</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sync</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">snd_soc_dapm_sync</span><span class="p">(</span><span class="n">dapm</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">snd_jack_report</span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">jack</span><span class="p">,</span><span class="w"> </span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">snd_soc_jack_report</span><span class="p">);</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * snd_jack_report - Report the current status of a jack</span>
<span class="cm"> *</span>
<span class="cm"> * @jack:   The jack to report status for</span>
<span class="cm"> * @status: The current status of the jack</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">snd_jack_report</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">snd_jack</span><span class="w"> </span><span class="o">*</span><span class="n">jack</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">snd_jack_kctl</span><span class="w"> </span><span class="o">*</span><span class="n">jack_kctl</span><span class="p">;</span><span class="w"></span>
<span class="cp">#ifdef CONFIG_SND_JACK_INPUT_DEV</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">jack</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">jack_kctl</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">kctl_list</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">snd_kctl_jack_report</span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span><span class="w"> </span><span class="n">jack_kctl</span><span class="o">-&gt;</span><span class="n">kctl</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">jack_kctl</span><span class="o">-&gt;</span><span class="n">mask_bits</span><span class="p">);</span><span class="w"></span>
<span class="cp">#ifdef CONFIG_SND_JACK_INPUT_DEV</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">testbit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SND_JACK_BTN_0</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">testbit</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">input_report_key</span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span><span class="w"> </span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"></span>
<span class="w">                     </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">testbit</span><span class="p">);</span><span class="w"> </span><span class="c1">//重点，上报键值</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">jack_switch_types</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">testbit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">testbit</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">input_report_switch</span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">jack_switch_types</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"></span>
<span class="w">                        </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">testbit</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">input_sync</span><span class="p">(</span><span class="n">jack</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SND_JACK_INPUT_DEV */</span><span class="cp"></span>
<span class="p">}</span><span class="w"></span>

</pre></div>
</div>
</section>


           </div>
         <div class="articleComments">
               <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>