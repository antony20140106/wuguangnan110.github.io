<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a></li>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">涉及文件</a></li>
<li><a class="reference internal" href="#typec-class-driver-api">Typec Class Driver API</a></li>
<li><a class="reference internal" href="#id4">驱动程序分析</a></li>
<li><a class="reference internal" href="#typec">typec注册过程</a></li>
<li><a class="reference internal" href="#id5">问题</a><ul>
<li><a class="reference internal" href="#data-swaptcpm-dpm-pd-data-swapclasstypec-set-data-role">1.设置data_swap接口tcpm_dpm_pd_data_swap和class中typec_set_data_role区别</a></li>
<li><a class="reference internal" href="#power-roledata-rolevconn-source">2.用户空间如何操作power_role、data_role、vconn_source等功能</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pr-swap">PR_SWAP操作实验</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h1>
<p>研究一下typec底层接口及port注册流程。</p>
</section>
<section id="id2">
<h1>参考<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h1>
<p>typec class用于以统一的方式向用户空间描述系统中的 USB Type-C 端口。该类旨在提供除了用户空间接口实现之外的任何其他内容，希望它可以在尽可能多的平台上使用。 这些平台预计会在课程中注册它们拥有的每个 USB Type-C 端口。在正常情况下，注册将由 USB Type-C 或 PD PHY 驱动程序完成，但它可能是 UCSI 等固件接口的驱动程序、USB PD 控制器的驱动程序，甚至是 Thunderbolt3 控制器的驱动程序。本文档将使用类注册 USB Type-C 端口的组件视为“端口驱动程序”。 除了显示功能之外，当端口驱动程序能够支持这些功能时，该类还提供对ports, partners和电缆插头的角色和替代模式的用户空间控制。 该类为本文档中描述的端口驱动程序提供了一个 API。属性在 Documentation/ABI/testing/sysfs-class-typec 中描述。
Typec Class Driver API：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://dri.freedesktop.org/docs/drm/driver-api/usb/typec.html">USB Type-C connector class</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/mosha_2018/article/details/105668555">Sysfs_notify唤醒调用epoll的用户面进程</a></p></li>
</ul>
</section>
<section id="id3">
<h1>涉及文件<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h1>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>CONFIG_TYPEC=y
CONFIG_USB_PD_POLICY=y
CONFIG_QPNP_USB_PDPHY=y

pd/Makefile
7:obj-$(CONFIG_QPNP_USB_PDPHY)  += qpnp-pdphy.o
.compatible	 = &quot;qcom,qpnp-pdphy&quot;,dts中没有


pd/Makefile
6:obj-$(CONFIG_USB_PD_POLICY)   += policy_engine.o
这个是提供接口的，根据如下，判断也没加进来：
pd/policy_engine.c
4694: * usbpd_create - Create a new instance of USB PD protocol/policy engine
4703:struct usbpd *usbpd_create(struct device *parent)
4899:EXPORT_SYMBOL(usbpd_create);

pd/usbpd.h
14:struct usbpd *usbpd_create(struct device *parent);
17:static inline struct usbpd *usbpd_create(struct device *parent)

pd/qpnp-pdphy.c
867:    /* usbpd_create() could call back to us, so have __pdphy ready */
870:    pdphy-&gt;usbpd = usbpd_create(&amp;pdev-&gt;dev);
872:            dev_err(&amp;pdev-&gt;dev, &quot;usbpd_create failed: %ld\n&quot;,



typec/Makefile
obj-$(CONFIG_TYPEC)             += typec.o
typec-y                         := class.o mux.o bus.o
obj-$(CONFIG_TYPEC)             += altmodes/
</pre></div>
</div>
</section>
<section id="typec-class-driver-api">
<h1>Typec Class Driver API<a class="headerlink" href="#typec-class-driver-api" title="Permalink to this heading"></a></h1>
<p>目前class.c文件提供了很多API供驱动使用，这些接口用法在参考中有写，如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">271</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_altmode_register_notifier</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">281</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_altmode_unregister_notifier</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">311</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_altmode_update_active</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">331</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_altmode2port</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">565</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_unregister_altmode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">626</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_partner_set_identity</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">646</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_partner_register_altmode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">694</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_register_partner</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">707</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_unregister_partner</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">743</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_plug_register_altmode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">785</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_register_plug</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">798</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_unregister_plug</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">863</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_cable_set_identity</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">911</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_register_cable</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">924</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_unregister_cable</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1322</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_set_data_role</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1340</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_set_pwr_role</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1359</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_set_vconn_role</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1401</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_set_pwr_opmode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1416</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_find_port_power_role</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1430</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_find_power_role</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1445</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_find_port_data_role</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1472</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_set_orientation</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1484</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_get_orientation</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1498</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_set_mode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1531</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_port_register_altmode</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1629</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_register_port</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">行</span><span class="w"> </span><span class="mi">1642</span><span class="o">:</span><span class="w"> </span><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_unregister_port</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id4">
<h1>驱动程序分析<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p>class.c驱动中创建了type和typec_mux两个设备，其中typec_mux为空没有实际内容。</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>A6650:/sys/class/typec # ls
port0  port0-partner  port1

static int __init typec_init(void)
{
	int ret;

	ret = bus_register(&amp;typec_bus);
	if (ret)
		return ret;

	ret = class_register(&amp;typec_mux_class);
	if (ret)
		goto err_unregister_bus;

	typec_class = class_create(THIS_MODULE, &quot;typec&quot;);
	if (IS_ERR(typec_class)) {
		ret = PTR_ERR(typec_class);
		goto err_unregister_mux_class;
	}

	return 0;

err_unregister_mux_class:
	class_unregister(&amp;typec_mux_class);

err_unregister_bus:
	bus_unregister(&amp;typec_bus);

	return ret;
}
subsys_initcall(typec_init);

static void __exit typec_exit(void)
{
	class_destroy(typec_class);
	ida_destroy(&amp;typec_index_ida);
	bus_unregister(&amp;typec_bus);
	class_unregister(&amp;typec_mux_class);
}
module_exit(typec_exit);
</pre></div>
</div>
<ul class="simple">
<li><p>sys节点可供调试如下：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>console:/sys/class/typec/port0 # ls
data_role  power_operation_mode  supported_accessory_modes    vconn_source
device     power_role            uevent
port_type  preferred_role        usb_power_delivery_revision
power      subsystem             usb_typec_revision
</pre></div>
</div>
</section>
<section id="typec">
<h1>typec注册过程<a class="headerlink" href="#typec" title="Permalink to this heading"></a></h1>
<p>这几个接口主要是支持/sys/class/typec/port0下power_role、data_role、vconn_source等功能，我们可以采用echo节点的方式进行验证，这几个函数仅供用户空间使用。真正的power_role、data_role主动控制都是在typec PD驱动中完成。
另外注意<code class="docutils literal notranslate"><span class="pre">typec_register_port</span></code>注册函数需要typec设备驱动注册完成后才能进行，否则会报错，执行顺序如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_dev_get_by_name</span><span class="p">(</span><span class="s">&quot;type_c_port0&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s get tcpc dev fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">probe_cnt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PROBE_CNT_MAX</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">err_get_tcpc_dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typec_init</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s init typec fail(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">probe_cnt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PROBE_CNT_MAX</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">err_init_typec</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">drivers/misc/pax/power/paxpd-charger-manager.c</span></code>:</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">tcpc_typec_try_role</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_capability</span><span class="w"> </span><span class="o">*</span><span class="n">cap</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">role</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_UNKNOWN</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s role = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_NO_PREFERRED_ROLE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_DRP</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_SINK</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_TRY_SNK</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_SOURCE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_TRY_SRC</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">tcpm_typec_change_role_postpone</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="n">typec_role</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">tcpc_typec_dr_set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_capability</span><span class="w"> </span><span class="o">*</span><span class="n">cap</span><span class="p">,</span><span class="w"></span>
<span class="w">			     </span><span class="k">enum</span><span class="w"> </span><span class="nc">typec_data_role</span><span class="w"> </span><span class="n">role</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_inquire_pd_data_role</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s role = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_HOST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PD_ROLE_UFP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">data_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_ROLE_DFP</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_DEVICE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PD_ROLE_DFP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">data_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_ROLE_UFP</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s invalid role</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">do_swap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_dpm_pd_data_swap</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="n">data_role</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TCPM_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s data role swap fail(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					   </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">tcpc_typec_pr_set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_capability</span><span class="w"> </span><span class="o">*</span><span class="n">cap</span><span class="p">,</span><span class="w"></span>
<span class="w">			     </span><span class="k">enum</span><span class="w"> </span><span class="nc">typec_role</span><span class="w"> </span><span class="n">role</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">power_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_inquire_pd_power_role</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s role = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_SOURCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">power_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PD_ROLE_SINK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">power_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_ROLE_SOURCE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_SINK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">power_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PD_ROLE_SOURCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">power_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_ROLE_SINK</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s invalid role</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">do_swap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_dpm_pd_power_swap</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="n">power_role</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TCPM_ERROR_NO_PD_CONNECTED</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_typec_role_swap</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TCPM_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s power role swap fail(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					   </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">tcpc_typec_vconn_set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_capability</span><span class="w"> </span><span class="o">*</span><span class="n">cap</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="k">enum</span><span class="w"> </span><span class="nc">typec_role</span><span class="w"> </span><span class="n">role</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">vconn_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_inquire_pd_vconn_role</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s role = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_SOURCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vconn_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PD_ROLE_VCONN_OFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">vconn_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_ROLE_VCONN_ON</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_SINK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vconn_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PD_ROLE_VCONN_ON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">do_swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">vconn_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_ROLE_VCONN_OFF</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s invalid role</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">do_swap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_dpm_pd_vconn_swap</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="n">vconn_role</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TCPM_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s vconn role swap fail(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					   </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">tcpc_typec_port_type_set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_capability</span><span class="w"> </span><span class="o">*</span><span class="n">cap</span><span class="p">,</span><span class="w"></span>
<span class="w">				    </span><span class="k">enum</span><span class="w"> </span><span class="nc">typec_port_type</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">as_sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_typec_is_act_as_sink_role</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_UNKNOWN</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s type = %d, as_sink = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			    </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">as_sink</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_PORT_SNK</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">as_sink</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_PORT_SRC</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">as_sink</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_PORT_DRP</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">prefer_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_SOURCE</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_TRY_SRC</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">prefer_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_SINK</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_TRY_SNK</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_ROLE_DRP</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">tcpm_typec_change_role</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="n">typec_role</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">tcpm_typec_role_swap</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">typec_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">typec_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_inquire_typec_role</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_PORT_DRP</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_PORT_DRD</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0120</span><span class="p">;</span><span class="w"> </span><span class="c1">//对应节点usb_typec_revision</span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">pd_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0300</span><span class="p">;</span><span class="w"> </span><span class="c1">//对应usb_power_delivery_revision节点</span>
<span class="w">	</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">typec_role</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_ROLE_SRC</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_ROLE_TRY_SRC</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">prefer_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_SOURCE</span><span class="p">;</span><span class="w"> </span><span class="c1">//对应节点preferred_role</span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_ROLE_SNK</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TYPEC_ROLE_TRY_SNK</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">prefer_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_SINK</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">		</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">prefer_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPEC_NO_PREFERRED_ROLE</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="c1">//这几个接口主要是支持/sys/class/typec/port0下power_role、data_role、vconn_source等功能操作。</span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">try_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_typec_try_role</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">dr_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_typec_dr_set</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">pr_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_typec_pr_set</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">vconn_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_typec_vconn_set</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">port_type_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpc_typec_port_type_set</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typec_register_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_port</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s typec register port fail(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				   </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">partner_desc</span><span class="p">.</span><span class="n">identity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">partner_identity</span><span class="p">;</span><span class="w"></span>
<span class="nl">out</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">pax_charger_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typec_init</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s init typec fail(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">probe_cnt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PROBE_CNT_MAX</span><span class="p">)</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"></span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">err_init_typec</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id5">
<h1>问题<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h1>
<section id="data-swaptcpm-dpm-pd-data-swapclasstypec-set-data-role">
<h2>1.设置data_swap接口tcpm_dpm_pd_data_swap和class中typec_set_data_role区别<a class="headerlink" href="#data-swaptcpm-dpm-pd-data-swapclasstypec-set-data-role" title="Permalink to this heading"></a></h2>
<p>按照我的理解，tcpm_dpm_pd_data_swap接口是直接操作typec芯片，typec_set_data_role是通过sysfs_notify通知typec芯片去做。
上面的想法不对，因为我发现A800能实现data_swap和power_swap，并没有调用typec_set_data_role或者typec_set_power_role接口，那这两个接口应该就是给用户空间获取状态的，并没有实际作用。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">tcpm_dpm_pd_data_swap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">tcpc_device</span><span class="w"> </span><span class="o">*</span><span class="n">tcpc</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_dpm_event_cb_data</span><span class="w"> </span><span class="o">*</span><span class="n">cb_data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_dpm_event</span><span class="w"> </span><span class="n">tcp_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">event_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_DPM_EVT_DR_SWAP_AS_UFP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">role</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">tcpm_put_tcp_dpm_event_cbk1</span><span class="p">(</span><span class="w"></span>
<span class="w">		</span><span class="n">tcpc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tcp_event</span><span class="p">,</span><span class="w"> </span><span class="n">cb_data</span><span class="p">,</span><span class="w"> </span><span class="n">TCPM_BK_PD_CMD_TOUT</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">typec_set_data_role</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_port</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">typec_data_role</span><span class="w"> </span><span class="n">role</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">data_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">role</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">data_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">role</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;data_role&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">KOBJ_CHANGE</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">typec_set_data_role</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="power-roledata-rolevconn-source">
<h2>2.用户空间如何操作power_role、data_role、vconn_source等功能<a class="headerlink" href="#power-roledata-rolevconn-source" title="Permalink to this heading"></a></h2>
<p>操作power_role节点是在<code class="docutils literal notranslate"><span class="pre">/sys/class/typec/port0/power_role</span></code>，可以看到操作条件需要注册时设置了pd_revision，设置了pr_set接口，且目前pwr_opmode是支持TYPEC_PWR_MODE_PD的，这三个条件满足了才会调用pr_set接口：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">power_role_store</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="k">struct</span><span class="w"> </span><span class="nc">device_attribute</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_port</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_typec_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">pd_revision</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;USB Power Delivery not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">pr_set</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;power role swapping not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">pwr_opmode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TYPEC_PWR_MODE_PD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;partner unable to swap power role</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EIO</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysfs_match_string</span><span class="p">(</span><span class="n">typec_roles</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_type_lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TYPEC_PORT_DRP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;port type fixed at </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">			     </span><span class="n">typec_port_power_roles</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">]);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">unlock_and_ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pr_set = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">pr_set</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">unlock_and_ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="nl">unlock_and_ret</span><span class="p">:</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_type_lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">power_role_show</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">			       </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_attribute</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">typec_port</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_typec_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_PORT_DRP</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="o">-&gt;</span><span class="n">pwr_role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TYPEC_SOURCE</span><span class="w"> </span><span class="o">?</span><span class="w"></span>
<span class="w">			       </span><span class="s">&quot;[source] sink&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;source [sink]&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">typec_roles</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">pwr_role</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">DEVICE_ATTR_RW</span><span class="p">(</span><span class="n">power_role</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>pd_revision和pwr_opmode设置分别在typec_init和pd_tcp_notifier_call中设置，其中<code class="docutils literal notranslate"><span class="pre">TYPEC_PWR_MODE_PD</span></code>表示支持PD协议才能进行power role swap：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">typec_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_caps</span><span class="p">.</span><span class="n">pd_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0300</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">pd_tcp_notifier_call</span><span class="p">(...)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="no">TCP_NOTIFY_PD_STATE</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s pd state = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				    </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">noti</span><span class="o">-&gt;</span><span class="n">pd_state</span><span class="p">.</span><span class="n">connected</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">noti</span><span class="o">-&gt;</span><span class="n">pd_state</span><span class="p">.</span><span class="n">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_NONE</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_HARD_RESET</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_TYPEC_ONLY_SNK</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">pd_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PD_CONNECT_PE_READY_SNK</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_PE_READY_SNK</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_PE_READY_SNK_PD30</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_PE_READY_SNK_APDO</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcpm_inquire_dpm_flags</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">tcpc</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DPM_FLAGS_PARTNER_USB_SUSPEND</span><span class="w"> </span><span class="o">?</span><span class="w"></span>
<span class="w">				     </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">smblib_set_prop</span><span class="p">(</span><span class="n">POWER_SUPPLY_PROP_PD_USB_SUSPEND_SUPPORTED</span><span class="p">,</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_PE_READY_SRC</span><span class="p">:</span><span class="w"></span>
<span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">PD_CONNECT_PE_READY_SRC_PD30</span><span class="p">:</span><span class="w"></span>
<span class="w">			</span><span class="cm">/* update chg-&gt;pd_active */</span><span class="w"></span>
<span class="w">			</span><span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">noti</span><span class="o">-&gt;</span><span class="n">pd_state</span><span class="p">.</span><span class="n">connected</span><span class="w"> </span><span class="o">==</span><span class="w"></span>
<span class="w">				     </span><span class="n">PD_CONNECT_PE_READY_SNK_APDO</span><span class="w"> </span><span class="o">?</span><span class="w"></span>
<span class="w">				     </span><span class="nl">POWER_SUPPLY_PD_PPS_ACTIVE</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">				     </span><span class="n">POWER_SUPPLY_PD_ACTIVE</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">smblib_set_prop</span><span class="p">(</span><span class="n">POWER_SUPPLY_PROP_PD_ACTIVE</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">pd_sink_set_vol_and_cur</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">sink_mv_old</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">sink_ma_old</span><span class="p">,</span><span class="w"></span>
<span class="w">						</span><span class="n">TCP_VBUS_CTRL_PD_STANDBY</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="n">typec_set_pwr_opmode</span><span class="p">(</span><span class="n">g_info</span><span class="o">-&gt;</span><span class="n">typec_port</span><span class="p">,</span><span class="w"></span>
<span class="w">					     </span><span class="n">TYPEC_PWR_MODE_PD</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="pr-swap">
<h1>PR_SWAP操作实验<a class="headerlink" href="#pr-swap" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p>实验条件：</p>
<ul>
<li><p>1.两台机器都支持PD协议。</p></li>
</ul>
</li>
<li><p>用A6650和M50机器做实验，已知A6650配置的<code class="docutils literal notranslate"><span class="pre">tcpc,role_def</span></code>属性是<code class="docutils literal notranslate"><span class="pre">DRP</span></code>，M50配置的是<code class="docutils literal notranslate"><span class="pre">Try.SNK</span></code>，当两台机器插入，默认A6650给M50充电。</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="nl">A6650</span><span class="p">:</span><span class="w"></span>
<span class="n">tcpc</span><span class="p">,</span><span class="n">role_def</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 0: SNK Only, 1: SRC Only, 2: DRP, */</span><span class="w"></span>
<span class="w">						</span><span class="cm">/* 3: Try.SRC, 4: Try.SNK */</span><span class="w"></span>

<span class="nl">M50</span><span class="p">:</span><span class="w"></span>
<span class="cm">/* 0: SNK Only, 1: SRC Only, 2: DRP, 3: Try.SRC, 4: Try.SNK */</span><span class="w"></span>
<span class="n">mt</span><span class="o">-</span><span class="n">tcpc</span><span class="p">,</span><span class="n">role_def</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p><img alt="0009_0000.png" src="../../../_images/0009_00001.png" /></p>
<ul class="simple">
<li><p>查看当前A6650的power_role是source：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>console:/sys/class/typec/port0 <span class="c1"># cat power_role</span>
<span class="o">[</span>source<span class="o">]</span> sink
</pre></div>
</div>
<ul class="simple">
<li><p>执行命令<code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">sink</span> <span class="pre">&gt;</span> <span class="pre">power_role</span></code>，将调用pr_set接口，也就是<code class="docutils literal notranslate"><span class="pre">tcpc_typec_pr_set</span></code>设置PD的power_role成功，目前charger bc1.2识别不成功，没执行plug in，也就是没打开充电，可能要特殊处理。</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>console:/sys/class/typec/port0 <span class="c1"># echo sink &gt; power_role</span>
<span class="o">[</span> <span class="m">4356</span>.132704<span class="o">]</span> <span class="nv">typec_roles1</span> <span class="o">=</span> sink
<span class="o">[</span> <span class="m">4356</span>.132704<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.137499<span class="o">]</span> <span class="nv">typec_roles2</span> <span class="o">=</span> sink
<span class="o">[</span> <span class="m">4356</span>.137499<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.142462<span class="o">]</span> <span class="nv">typec_roles3</span> <span class="o">=</span> sink
<span class="o">[</span> <span class="m">4356</span>.142462<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.147321<span class="o">]</span> <span class="nv">typec_roles4</span> <span class="o">=</span> sink
<span class="o">[</span> <span class="m">4356</span>.147321<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.151974<span class="o">]</span> <span class="nv">pr_set</span> <span class="o">=</span> <span class="m">0</span>
<span class="o">[</span> <span class="m">4356</span>.154531<span class="o">]</span> charger soc:charger: tcpc_typec_pr_set <span class="nv">role</span> <span class="o">=</span> <span class="m">0</span>
<span class="o">[</span> <span class="m">4356</span>.212175<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> SOURCE_VBUS
<span class="o">[</span> <span class="m">4356</span>.217309<span class="o">]</span> pd_tcp_notifier_call <span class="nb">source</span> vbus 0mV
<span class="o">[</span> <span class="m">4356</span>.222080<span class="o">]</span> pd_tcp_notifier_call - <span class="nb">source</span> vbus 0v output
<span class="o">[</span> <span class="m">4356</span>.227778<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> EXT_DISCHARGE
<span class="o">[</span> <span class="m">4356</span>.253923<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> EXT_DISCHARGE
<span class="o">[</span> <span class="m">4356</span>.259183<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> TYPEC_STATE
<span class="o">[</span> <span class="m">4356</span>.264495<span class="o">]</span> tcpc_notifier_call, <span class="nv">old_state</span> <span class="o">=</span> ATTACHED_SRC, <span class="nv">new_state</span> <span class="o">=</span> ATTACHED_SNK
<span class="o">[</span> <span class="m">4356</span>.272212<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> PR_SWAP
<span class="o">[</span> <span class="m">4356</span>.276902<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:122 <span class="m">10</span>
<span class="o">[</span> <span class="m">4356</span>.282704<span class="o">]</span> PAX_CHG: pd_status:10
<span class="o">[</span> <span class="m">4356</span>.286060<span class="o">]</span> PAX_CHG: _wake_up_charger:
<span class="o">[</span> <span class="m">4356</span>.289989<span class="o">]</span> PAX_CHG: pax_is_charger_on <span class="nv">chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span> <span class="nv">last_chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.348486<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> SINK_VBUS
<span class="o">[</span> <span class="m">4356</span>.353340<span class="o">]</span> charger soc:charger: pd_tcp_notifier_call sink vbus 5000mV 1500mA type<span class="o">(</span>0x84<span class="o">)</span>
<span class="o">[</span> <span class="m">4356</span>.362059<span class="o">]</span> pd_tcp_notifier_call - sink vbus
<span class="o">[</span> <span class="m">4356</span>.366392<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:8 <span class="m">5000000</span>
<span class="o">[</span> <span class="m">4356</span>.372191<span class="o">]</span> PAX_CHG: _wake_up_charger:
<span class="o">[</span> <span class="m">4356</span>.375978<span class="o">]</span> psy_charger_get_property: <span class="m">18</span> callbacks suppressed
<span class="o">[</span> <span class="m">4356</span>.375980<span class="o">]</span> PAX_CHG: pax_is_charger_on <span class="nv">chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span> <span class="nv">last_chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.375987<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:144 <span class="m">5000000</span>
<span class="o">[</span> <span class="m">4356</span>.395839<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:143 <span class="m">5000000</span>
<span class="o">[</span> <span class="m">4356</span>.401789<span class="o">]</span> PAX_CHG: <span class="nb">set</span> pd_charging_voltage_max:5000 mv
<span class="o">[</span> <span class="m">4356</span>.401793<span class="o">]</span> PAX_CHG: _wake_up_charger:
<span class="o">[</span> <span class="m">4356</span>.401816<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:124 <span class="m">1500000</span>
console:/sys/cla<span class="o">[</span> <span class="m">4356</span>.401820<span class="o">]</span> PAss/typec/port0 <span class="c1">#[ [ 4356.401835] pd_tcp_notifier_call event = SINK_VBUS</span>
<span class="o">[</span> <span class="m">4356</span>.401843<span class="o">]</span> charger soc:charger: pd_tcp_notifier_call sink vbus 5000mV 1500mA type<span class="o">(</span>0x01<span class="o">)</span>
<span class="o">[</span> <span class="m">4356</span>.401858<span class="o">]</span> PAX_CHG: pax_is_charger_on <span class="nv">chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span> <span class="nv">last_chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.473391<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> SINK_VBUS
<span class="o">[</span> <span class="m">4356</span>.540881<span class="o">]</span> charger soc:charger: pd_tcp_notifier_call sink vbus 5000mV 3000mA type<span class="o">(</span>0x01<span class="o">)</span>
<span class="o">[</span> <span class="m">4356</span>.540883<span class="o">]</span> pd_tcp_notifier_call - sink vbus
<span class="o">[</span> <span class="m">4356</span>.540890<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:8 <span class="m">5000000</span>
<span class="o">[</span> <span class="m">4356</span>.540894<span class="o">]</span> PAX_CHG: _wake_up_charger:
<span class="o">[</span> <span class="m">4356</span>.553486<span class="o">]</span> PAX_CHG: pax_is_charger_on <span class="nv">chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span> <span class="nv">last_chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.649145<span class="o">]</span> pd_tcp_notifier_call <span class="nv">event</span> <span class="o">=</span> PD_STATE
<span class="o">[</span> <span class="m">4356</span>.653910<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:125 <span class="m">0</span>
<span class="o">[</span> <span class="m">4356</span>.653915<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:122 <span class="m">1</span>
<span class="o">[</span> <span class="m">4356</span>.665111<span class="o">]</span> PAX_CHG: pd_status:1
<span class="o">[</span> <span class="m">4356</span>.668456<span class="o">]</span> PAX_CHG: _wake_up_charger:
<span class="o">[</span> <span class="m">4356</span>.672334<span class="o">]</span> PAX_CHG: psy_charger_set_property: prop:124 <span class="m">3000000</span>
<span class="o">[</span> <span class="m">4356</span>.672430<span class="o">]</span> PAX_CHG: pax_is_charger_on <span class="nv">chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span> <span class="nv">last_chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span>
<span class="o">[</span> <span class="m">4356</span>.678376<span class="o">]</span> PAX_CHG: <span class="nb">set</span> pd_charging_current_max:3000 ma
<span class="o">[</span> <span class="m">4356</span>.692167<span class="o">]</span> PAX_CHG: _wake_up_charger:
<span class="o">[</span> <span class="m">4356</span>.696517<span class="o">]</span> PAX_CHG: pax_is_charger_on <span class="nv">chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span> <span class="nv">last_chr_type</span> <span class="o">=</span> <span class="o">[</span>Unknown<span class="o">]</span>
<span class="o">[</span> <span class="m">4359</span>.159246<span class="o">]</span> Battery: <span class="o">[</span> status:Not charging, health:Good, present:1, tech:Li-ion, capcity:86,cap_rm:4427 mah, vol:4059 mv, temp:34, curr:-380 ma, ui_soc:86, notify_code: <span class="m">0</span> <span class="o">]</span>
<span class="o">[</span> <span class="m">4359</span>.182007<span class="o">]</span> healthd: battery <span class="nv">l</span><span class="o">=</span><span class="m">86</span> <span class="nv">v</span><span class="o">=</span><span class="m">4059</span> <span class="nv">t</span><span class="o">=</span><span class="m">34</span>.0 <span class="nv">h</span><span class="o">=</span><span class="m">2</span> <span class="nv">st</span><span class="o">=</span><span class="m">4</span> <span class="nv">c</span><span class="o">=</span>-380000 <span class="nv">fc</span><span class="o">=</span><span class="m">5192000</span> <span class="nv">cc</span><span class="o">=</span><span class="m">13</span> <span class="nv">chg</span><span class="o">=</span>u
<span class="o">[</span> <span class="m">4359</span>.328212<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span><span class="m">1660277727</span>.639:126<span class="o">)</span>: avc: denied <span class="o">{</span> <span class="nb">read</span> <span class="o">}</span> <span class="k">for</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;Binder:478_2&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;wakeup41&quot;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&quot;sysfs&quot;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">45514</span> <span class="nv">scontext</span><span class="o">=</span>u:r:system_suspend:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:vendor_sysfs_battery_supply:s0 <span class="nv">tclass</span><span class="o">=</span>dir <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
<span class="o">[</span> <span class="m">4359</span>.351346<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span><span class="m">1660277727</span>.643:127<span class="o">)</span>: avc: denied <span class="o">{</span> <span class="nb">read</span> <span class="o">}</span> <span class="k">for</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;Binder:478_2&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;wakeup31&quot;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&quot;sysfs&quot;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">44775</span> <span class="nv">scontext</span><span class="o">=</span>u:r:system_suspend:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:vendor_sysfs_usb_supply:s0 <span class="nv">tclass</span><span class="o">=</span>dir <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
<span class="o">[</span> <span class="m">4359</span>.419138<span class="o">]</span> ext_spk_switch_put: <span class="nb">set</span> Ext_Spk_Switch val <span class="m">1</span>
<span class="o">[</span> <span class="m">4359</span>.439102<span class="o">]</span> msm_pcm_chmap_ctl_put: substream ref_count:0 invalid
<span class="o">[</span> <span class="m">4359</span>.470597<span class="o">]</span> send_afe_cal_type: No cal sent <span class="k">for</span> cal_index <span class="m">0</span>, <span class="nv">port_id</span> <span class="o">=</span> 0xb030! ret -22
</pre></div>
</div>
<ul class="simple">
<li><p>我用命令<code class="docutils literal notranslate"><span class="pre">i2cset</span> <span class="pre">-f</span> <span class="pre">-y</span> <span class="pre">0</span> <span class="pre">0x3f</span> <span class="pre">0x09</span> <span class="pre">0x53</span> <span class="pre">b</span></code>，手动打开充电，可以看到电池电流是往里充的：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>console:/sys/class/chg_info/mp2721 <span class="c1"># i2cset -f -y 0 0x3f 0x09 0x53 b</span>
console:/sys/class/chg_info/mp2721 <span class="c1"># [ 4604.069683] psy_charger_get_property: 2 callbacks suppressed</span>
<span class="o">[</span> <span class="m">4604</span>.093187<span class="o">]</span> healthd: battery <span class="nv">l</span><span class="o">=</span><span class="m">85</span> <span class="nv">v</span><span class="o">=</span><span class="m">4093</span> <span class="nv">t</span><span class="o">=</span><span class="m">34</span>.0 <span class="nv">h</span><span class="o">=</span><span class="m">2</span> <span class="nv">st</span><span class="o">=</span><span class="m">2</span> <span class="nv">c</span><span class="o">=</span>-67000 <span class="nv">fc</span><span class="o">=</span><span class="m">5192000</span> <span class="nv">cc</span><span class="o">=</span><span class="m">13</span> <span class="nv">chg</span><span class="o">=</span>
<span class="o">[</span> <span class="m">4719</span>.615904<span class="o">]</span> Battery: <span class="o">[</span> status:Charging, health:Good, present:1, tech:Li-ion, capcity:85,cap_rm:4410 mah, vol:4108 mv, temp:34, curr:64 ma, ui_soc:85, notify_code: <span class="m">0</span> <span class="o">]</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, wugn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>