<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a><ul>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">界面</a><ul>
<li><a class="reference internal" href="#id4">1.设置界面</a></li>
<li><a class="reference internal" href="#id5">2.功能界面</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">软件实现</a><ul>
<li><a class="reference internal" href="#settings">1、新增Settings全局变量</a></li>
<li><a class="reference internal" href="#settingsswitchpreference">2、新增Settings界面自定义SwitchPreference样式</a></li>
<li><a class="reference internal" href="#view">3.新增口袋模式view</a></li>
<li><a class="reference internal" href="#phonewindowmanager">3.PhoneWindowManager增加具体功能实现</a></li>
<li><a class="reference internal" href="#id7">4.整体程序流程</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h1>
<p>本文主要讲解口袋模式功能实现。</p>
<section id="id2">
<h2>参考<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/weixin_38363123/article/details/80110712?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.no_search_link&amp;spm=1001.2101.3001.4242">MT6763 N1 防误触模式的实现</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/weixin_30596343/article/details/99801833?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.no_search_link&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=3">Android中BroadCastReceiver使用-IntentFilter（整理）</a></p></li>
</ul>
</section>
<section id="id3">
<h2>界面<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[Summary]:
        1.口袋模式说明:当触发双击唤醒或power键解锁操作，根据距离传感器检测的
        数据判断为口袋，即弹出提示界面，用户无法进行点击，可通过音量减按键强行退出。
        2.打开开关:setting-system-gestures-Pocket mode。

[Test Plan]:
        1.打开Pocket mode开关，锁屏，将手机置于口袋，按power键或者双击唤醒，观察屏幕是否提示口袋模式已激活，
        检查此时是否可操作屏幕。
</pre></div>
</div>
<section id="id4">
<h3>1.设置界面<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h3>
<p><img alt="0001_pocket_mode.png" src="../../../_images/0001_pocket_mode.png" /></p>
</section>
<section id="id5">
<h3>2.功能界面<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<p><img alt="0001_function_view.png" src="../../../_images/0001_function_view.png" /></p>
</section>
</section>
<section id="id6">
<h2>软件实现<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h2>
<section id="settings">
<h3>1、新增Settings全局变量<a class="headerlink" href="#settings" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>1.新增setting string变量：</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/frameworks/base/core/java/android/provider/Settings.java</span><span class="w"></span>
<span class="gi">+++ b/frameworks/base/core/java/android/provider/Settings.java</span><span class="w"></span>
<span class="gu">@@ -3055,6 +3055,8 @@ public final class Settings {</span><span class="w"></span>
<span class="w"> </span>        private static final ContentProviderHolder sProviderHolder =<span class="w"></span>
<span class="w"> </span>                new ContentProviderHolder(CONTENT_URI);<span class="w"></span>
<span class="w"> </span>
<span class="gi">+		public static final String POCKET_TOUCH_DISABLE = &quot;pocket_touch_disable&quot;;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>        @UnsupportedAppUsage<span class="w"></span>
<span class="w"> </span>        private static final NameValueCache sNameValueCache = new NameValueCache(<span class="w"></span>
<span class="w"> </span>                CONTENT_URI,<span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>2.make update-api 后，自动更新此文件，检查确认正确后，跟代码一起提交即可。</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/frameworks/base/api/current.txt</span><span class="w"></span>
<span class="gi">+++ b/frameworks/base/api/current.txt</span><span class="w"></span>
<span class="gu">@@ -40815,6 +40815,7 @@ package android.provider {</span><span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String PARENTAL_CONTROL_ENABLED = &quot;parental_control_enabled&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String PARENTAL_CONTROL_LAST_UPDATE = &quot;parental_control_last_update&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String PARENTAL_CONTROL_REDIRECT_URL = &quot;parental_control_redirect_url&quot;;<span class="w"></span>
<span class="gi">+    field public static final String POCKET_TOUCH_DISABLE = &quot;pocket_touch_disable&quot;;</span><span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String RADIO_BLUETOOTH = &quot;bluetooth&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String RADIO_CELL = &quot;cell&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String RADIO_NFC = &quot;nfc&quot;;<span class="w"></span>

<span class="gd">--- a/frameworks/base/non-updatable-api/current.txt</span><span class="w"></span>
<span class="gi">+++ b/frameworks/base/non-updatable-api/current.txt</span><span class="w"></span>
<span class="gu">@@ -38983,6 +38983,7 @@ package android.provider {</span><span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String PARENTAL_CONTROL_ENABLED = &quot;parental_control_enabled&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String PARENTAL_CONTROL_LAST_UPDATE = &quot;parental_control_last_update&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String PARENTAL_CONTROL_REDIRECT_URL = &quot;parental_control_redirect_url&quot;;<span class="w"></span>
<span class="gi">+    field public static final String POCKET_TOUCH_DISABLE = &quot;pocket_touch_disable&quot;;</span><span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String RADIO_BLUETOOTH = &quot;bluetooth&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String RADIO_CELL = &quot;cell&quot;;<span class="w"></span>
<span class="w"> </span>    field @Deprecated public static final String RADIO_NFC = &quot;nfc&quot;;<span class="w"></span>
</pre></div>
</div>
</section>
<section id="settingsswitchpreference">
<h3>2、新增Settings界面自定义SwitchPreference样式<a class="headerlink" href="#settingsswitchpreference" title="Permalink to this heading"></a></h3>
<p><img alt="0001_pocket_mode.png" src="../../../_images/0001_pocket_mode.png" /></p>
<ul class="simple">
<li><p>1.新建SwitchPreference样式</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/values-zh-rCN/strings.xml</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/values-zh-rCN/strings.xml</span><span class="w"></span>
<span class="gu">@@ -4965,8 +4965,13 @@</span><span class="w"></span>
<span class="w"> </span>    &lt;string name = &quot;selet_chargemode&quot;&gt;选择充电模式&lt;/string&gt;<span class="w"></span>
<span class="w"> </span>    &lt;!-- [FEATURE]-Add-END by (qumy@paxsz.com), 2021/05/08 for add chargemode --&gt;<span class="w"></span>
<span class="w"> </span>
<span class="gd">-        &lt;!-- DoubleTapScreen setting title [CHAR LIMIT=NONE] --&gt;</span><span class="w"></span>
<span class="gi">+    &lt;!-- DoubleTapScreen setting title [CHAR LIMIT=NONE] --&gt;</span><span class="w"></span>
<span class="w"> </span>    &lt;string name=&quot;double_tap_awake_name&quot;&gt; 双击唤醒&lt;/string&gt;<span class="w"></span>
<span class="w"> </span>    &lt;!-- DoubleTapScreen setting summary [CHAR LIMIT=NONE] --&gt;<span class="w"></span>
<span class="gd">-    &lt;string name=&quot;double_tap_awake_summary&quot;&gt; 双击唤醒状态&lt;/string&gt;</span><span class="w"></span>
<span class="gi">+    &lt;string name=&quot;double_tap_awake_summary&quot;&gt;锁屏状态下的双击唤醒功能&lt;/string&gt;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	&lt;!-- PocketMode setting title [CHAR LIMIT=NONE] --&gt;</span><span class="w"></span>
<span class="gi">+    &lt;string name=&quot;pocket_mode_name&quot;&gt;口袋模式&lt;/string&gt;</span><span class="w"></span>
<span class="gi">+     &lt;!-- PocketMode setting summary [CHAR LIMIT=NONE] --&gt;</span><span class="w"></span>
<span class="gi">+    &lt;string name=&quot;pocket_mode_summary&quot;&gt;利用距离感应器，防止手机在口袋中由于挤压或织物滑动引起的误操作&lt;/string&gt;</span><span class="w"></span>
<span class="w"> </span>&lt;/resources&gt;<span class="w"></span>
<span class="gh">diff --git a/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/values/strings.xml b/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/values/strings.xml</span><span class="w"></span>
<span class="gh">index 978ad3c222a..1e78456d57c 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/values/strings.xml</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/values/strings.xml</span><span class="w"></span>
<span class="gu">@@ -12147,11 +12147,16 @@</span><span class="w"></span>
<span class="w"> </span>    &lt;string name=&quot;cards_passes_setting_subtitle&quot;&gt;To access things like your payment methods and boarding passes, press and hold the Power button.&lt;/string&gt;<span class="w"></span>
<span class="w"> </span>
<span class="w"> </span> 	&lt;!-- DoubleTapScreen setting title [CHAR LIMIT=NONE] --&gt;<span class="w"></span>
<span class="gd">-    &lt;string name=&quot;double_tap_awake_name&quot;&gt;Double Tap Screen&lt;/string&gt;</span><span class="w"></span>
<span class="gi">+    &lt;string name=&quot;double_tap_awake_name&quot;&gt;Double tap screen&lt;/string&gt;</span><span class="w"></span>
<span class="w"> </span>    <span class="w"></span>
<span class="w"> </span>     &lt;!-- DoubleTapScreen setting summary [CHAR LIMIT=NONE] --&gt;<span class="w"></span>
<span class="gd">-    &lt;string name=&quot;double_tap_awake_summary&quot;&gt;Double Tap Screen status&lt;/string&gt;</span><span class="w"></span>
<span class="gi">+    &lt;string name=&quot;double_tap_awake_summary&quot;&gt;Double-tap wake-up function in locked screen state&lt;/string&gt;</span><span class="w"></span>
<span class="w"> </span>
<span class="gi">+     &lt;!-- PocketMode setting title [CHAR LIMIT=NONE] --&gt;</span><span class="w"></span>
<span class="gi">+    &lt;string name=&quot;pocket_mode_name&quot;&gt;Pocket mode&lt;/string&gt;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+     &lt;!-- PocketMode setting summary [CHAR LIMIT=NONE] --&gt;</span><span class="w"></span>
<span class="gi">+    &lt;string name=&quot;pocket_mode_summary&quot;&gt;Use a distance sensor to prevent misoperation of the tablet in the pocket due to squeezing or fabric sliding.&lt;/string&gt;</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>    &lt;!-- Title for RTT setting. [CHAR LIMIT=NONE] --&gt;<span class="w"></span>
<span class="w"> </span>    &lt;string name=&quot;rtt_settings_title&quot;&gt;&lt;/string&gt;<span class="w"></span>
<span class="gh">diff --git a/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/xml/gestures.xml b/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/xml/gestures.xml</span><span class="w"></span>
<span class="gh">index 3f3404630c1..5a9145595e5 100755</span><span class="w"></span>
<span class="gd">--- a/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/xml/gestures.xml</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/packages/apps/MtkSettings/res/xml/gestures.xml</span><span class="w"></span>
<span class="gu">@@ -92,4 +92,11 @@</span><span class="w"></span>
<span class="w"> </span>        android:summary=&quot;@string/double_tap_awake_summary&quot;<span class="w"></span>
<span class="w"> </span>        settings:searchable=&quot;true&quot;<span class="w"></span>
<span class="w"> </span>        settings:controller=&quot;com.android.settings.gestures.PaxDoubleTapAwakeGesturePreferenceController&quot; /&gt;<span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    &lt;SwitchPreference</span><span class="w"></span>
<span class="gi">+        android:key=&quot;pocket_mode&quot;</span><span class="w"></span>
<span class="gi">+        android:title=&quot;@string/pocket_mode_name&quot;</span><span class="w"></span>
<span class="gi">+        android:summary=&quot;@string/pocket_mode_summary&quot;</span><span class="w"></span>
<span class="gi">+        settings:searchable=&quot;true&quot;</span><span class="w"></span>
<span class="gi">+        settings:controller=&quot;com.android.settings.gestures.PaxPocketModePreferenceController&quot; /&gt;</span><span class="w"></span>
<span class="w"> </span>&lt;/PreferenceScreen&gt;<span class="w"></span>

<span class="gd">--- a/vendor/mediatek/proprietary/packages/apps/MtkSettings/src/com/android/settings/gestures/GesturesSettingPreferenceController.java</span><span class="w"></span>
<span class="gi">+++ b/vendor/mediatek/proprietary/packages/apps/MtkSettings/src/com/android/settings/gestures/GesturesSettingPreferenceController.java</span><span class="w"></span>
<span class="gu">@@ -82,6 +82,7 @@ public class GesturesSettingPreferenceController extends BasePreferenceControlle</span><span class="w"></span>
<span class="w"> </span>                .setConfig(ambientDisplayConfiguration));<span class="w"></span>
<span class="w"> </span>        controllers.add(new PreventRingingParentPreferenceController(context, FAKE_PREF_KEY));<span class="w"></span>
<span class="w"> </span>		controllers.add(new PaxDoubleTapAwakeGesturePreferenceController(context));<span class="w"></span>
<span class="gi">+		controllers.add(new PaxPocketModePreferenceController(context));</span><span class="w"></span>
<span class="w"> </span>        return controllers;<span class="w"></span>
<span class="w"> </span>    }<span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>2.新增Settings界面Controller，这里点击界面开关<code class="docutils literal notranslate"><span class="pre">Pocket</span> <span class="pre">mode</span></code>后，将设置全局变量<code class="docutils literal notranslate"><span class="pre">Settings.System.POCKET_TOUCH_DISABLE</span></code>的值为1或者0，例子如下：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>PAYTABLETM8:/ # dumpsys settings | grep pocket_touch_disable
_id:30 name:pocket_touch_disable pkg:android value:1 default:1 defaultSystemSet:true

PAYTABLETM8:/ # dumpsys settings | grep pocket_touch_disable
_id:77 name:pocket_touch_disable pkg:com.android.settings value:0 default:0 defaultSystemSet:true
1970-01-06 19:19:28 update pocket_touch_disable
</pre></div>
</div>
<ul class="simple">
<li><p>代码如下：</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2016 The Android Open Source Project</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="cm"> * you may not use this file except in compliance with the License.</span>
<span class="cm"> * You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="cm"> * See the License for the specific language governing permissions and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.android.settings.gestures</span><span class="p">;</span><span class="w"></span>


<span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.provider.Settings</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">androidx.preference.Preference</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">androidx.preference.SwitchPreference</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.android.settingslib.Utils</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.android.settings.core.BasePreferenceController</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.os.SystemProperties</span><span class="p">;</span><span class="w"></span>


<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PaxPocketModePreferenceController</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BasePreferenceController</span><span class="w"></span>
<span class="w">	</span><span class="kd">implements</span><span class="w"> </span><span class="n">Preference</span><span class="p">.</span><span class="na">OnPreferenceChangeListener</span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KEY_POCKET_MODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pocket_mode&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PaxPocketModePreferenceController&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PaxPocketModePreferenceController</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">KEY_POCKET_MODE</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&quot;start&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getPreferenceKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">KEY_POCKET_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateState</span><span class="p">(</span><span class="n">Preference</span><span class="w"> </span><span class="n">preference</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	 </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&quot;updateState&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">preference</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">SwitchPreference</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">SwitchPreference</span><span class="p">)</span><span class="w"> </span><span class="n">preference</span><span class="p">).</span><span class="na">setChecked</span><span class="p">(</span><span class="n">isProximityScreenEnabled</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">	  </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isProximityScreenEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Settings</span><span class="p">.</span><span class="na">System</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="n">mContext</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="n">Settings</span><span class="p">.</span><span class="na">System</span><span class="p">.</span><span class="na">POCKET_TOUCH_DISABLE</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">	  </span><span class="p">}</span><span class="w"></span>


<span class="w">     </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">onPreferenceChange</span><span class="p">(</span><span class="n">Preference</span><span class="w"> </span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&quot;onPreferenceChange&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">powerEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Boolean</span><span class="p">)</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&quot;onPreferenceChange powerEnabled = &quot;</span><span class="o">+</span><span class="n">powerEnabled</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">powerEnabled</span><span class="p">){</span><span class="w"></span>
<span class="w">				</span><span class="n">Settings</span><span class="p">.</span><span class="na">System</span><span class="p">.</span><span class="na">putInt</span><span class="p">(</span><span class="n">mContext</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">(),</span><span class="w"></span>
<span class="w">			</span><span class="n">Settings</span><span class="p">.</span><span class="na">System</span><span class="p">.</span><span class="na">POCKET_TOUCH_DISABLE</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">				</span><span class="n">Settings</span><span class="p">.</span><span class="na">System</span><span class="p">.</span><span class="na">putInt</span><span class="p">(</span><span class="n">mContext</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">(),</span><span class="w"></span>
<span class="w">			</span><span class="n">Settings</span><span class="p">.</span><span class="na">System</span><span class="p">.</span><span class="na">POCKET_TOUCH_DISABLE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getAvailabilityStatus</span><span class="p">(){</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVAILABLE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>3.开关默认值设定，首先创建一个int型资源，比如下面就是默认打开。</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/paxdroid/frameworks/base/core/res/res/values/config.xml</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/frameworks/base/core/res/res/values/config.xml</span><span class="w"></span>
<span class="gu">@@ -41,5 +41,8 @@</span><span class="w"></span>
<span class="w"> </span>    &lt;!-- paxsz@ 2019.10.17 def control device reboot every 24 hours --&gt;<span class="w"></span>
<span class="w"> </span>    &lt;integer name=&quot;def_reboot_every_24_hours&quot; translatable=&quot;false&quot;&gt;0&lt;/integer&gt;<span class="w"></span>

<span class="gi">+    &lt;!-- defualt pocket mode value --&gt;</span><span class="w"></span>
<span class="gi">+    &lt;integer name=&quot;def_pax_pocket_mode_enabled&quot;&gt;1&lt;/integer&gt;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>    &lt;string name=&quot;def_use_pax_theme&quot; translatable=&quot;false&quot;&gt;TRUE&lt;/string&gt;<span class="w"></span>
<span class="w"> </span>&lt;/resources&gt;<span class="w"></span>
<span class="gh">diff --git a/paxdroid/frameworks/base/core/res/res/values/symbols.xml b/paxdroid/frameworks/base/core/res/res/values/symbols.xml</span><span class="w"></span>
<span class="gh">index 2bb5409d957..5945d534847 100755</span><span class="w"></span>
<span class="gd">--- a/paxdroid/frameworks/base/core/res/res/values/symbols.xml</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/frameworks/base/core/res/res/values/symbols.xml</span><span class="w"></span>
<span class="gu">@@ -38,4 +38,6 @@</span><span class="w"></span>

<span class="w"> </span>    &lt;java-symbol type=&quot;string&quot; name=&quot;def_use_pax_theme&quot; /&gt;<span class="w"></span>

<span class="gi">+    &lt;java-symbol type=&quot;integer&quot; name=&quot;def_pax_pocket_mode_enabled&quot; /&gt;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">paxdroid/frameworks/base/core/java/android/provider/PaxSettings.java</span></code>然后load该资源，并初始化<code class="docutils literal notranslate"><span class="pre">Settings.System.POCKET_TOUCH_DISABLE</span></code>变量值:</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/paxdroid/frameworks/base/core/java/android/provider/PaxSettings.java</span><span class="w"></span>
<span class="gi">+++ b/paxdroid/frameworks/base/core/java/android/provider/PaxSettings.java</span><span class="w"></span>
<span class="gu">@@ -207,7 +207,10 @@ public final class PaxSettings {</span><span class="w"></span>
<span class="w"> </span>                loadStringSetting(stmt, PaxSettings.System.USE_PAX_THEME,<span class="w"></span>
<span class="w"> </span>                        R.string.def_use_pax_theme);<span class="w"></span>
<span class="w"> </span>                //[FEATURE]-Add-END<span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gi">+                //[FEATURE]-Add-BEGIN by (wugangnan@paxsz.com), 2021/12/07,for default pocket mode enabled</span><span class="w"></span>
<span class="gi">+                loadIntegerSetting(stmt, Settings.System.POCKET_TOUCH_DISABLE,</span><span class="w"></span>
<span class="gi">+                    R.integer.def_pax_pocket_mode_enabled);</span><span class="w"></span>
<span class="gi">+                //[FEATURE]-Add-END</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="view">
<h3>3.新增口袋模式view<a class="headerlink" href="#view" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>1.新建一个view。</p></li>
</ul>
<p><img alt="0001_function_view.png" src="../../../_images/0001_function_view.png" /></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/frameworks/base/core/res/res/layout/pocket_touch_disable.xml b/frameworks/base/core/res/res/layout/pocket_touch_disable.xml</span><span class="w"></span>
<span class="w">new file mode 100755</span>
<span class="gh">index 00000000000..7a9af472af4</span><span class="w"></span>
<span class="gd">--- /dev/null</span><span class="w"></span>
<span class="gi">+++ b/frameworks/base/core/res/res/layout/pocket_touch_disable.xml</span><span class="w"></span>
<span class="gu">@@ -0,0 +1,43 @@</span><span class="w"></span>
<span class="gi">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="w"></span>
<span class="gi">+&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_width=&quot;match_parent&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_height=&quot;2160px&quot;</span><span class="w"></span>
<span class="gi">+    android:background=&quot;#cc000000&quot;</span><span class="w"></span>
<span class="gi">+    android:orientation=&quot;vertical&quot;&gt;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    &lt;TextView</span><span class="w"></span>
<span class="gi">+    android:layout_marginTop=&quot;360px&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_width=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_height=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_gravity=&quot;center_horizontal&quot;</span><span class="w"></span>
<span class="gi">+    android:text=&quot;@string/oos_ptd_title&quot;</span><span class="w"></span>
<span class="gi">+    android:textColor=&quot;#4cffffff&quot;</span><span class="w"></span>
<span class="gi">+    android:textSize=&quot;48px&quot; /&gt;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    &lt;TextView</span><span class="w"></span>
<span class="gi">+    android:layout_width=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_height=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:paddingTop=&quot;80px&quot;</span><span class="w"></span>
<span class="gi">+    android:text=&quot;@string/oos_ptd_exit_mode&quot;</span><span class="w"></span>
<span class="gi">+    android:textColor=&quot;#4cffffff&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_marginLeft=&quot;100px&quot;</span><span class="w"></span>
<span class="gi">+    android:textSize=&quot;36px&quot; /&gt;</span><span class="w"></span>
<span class="gi">+    &lt;TextView</span><span class="w"></span>
<span class="gi">+    android:layout_width=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_height=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:paddingTop=&quot;26px&quot;</span><span class="w"></span>
<span class="gi">+    android:textSize=&quot;30px&quot;</span><span class="w"></span>
<span class="gi">+    android:textColor=&quot;#4cffffff&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_marginLeft=&quot;100px&quot;</span><span class="w"></span>
<span class="gi">+    android:text=&quot;@string/oos_ptd_notice1&quot;</span><span class="w"></span>
<span class="gi">+    /&gt;</span><span class="w"></span>
<span class="gi">+   &lt;TextView</span><span class="w"></span>
<span class="gi">+    android:layout_width=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_height=&quot;wrap_content&quot;</span><span class="w"></span>
<span class="gi">+    android:paddingTop=&quot;26px&quot;</span><span class="w"></span>
<span class="gi">+    android:textSize=&quot;30px&quot;</span><span class="w"></span>
<span class="gi">+    android:textColor=&quot;#4cffffff&quot;</span><span class="w"></span>
<span class="gi">+    android:layout_marginLeft=&quot;100px&quot;</span><span class="w"></span>
<span class="gi">+    android:text=&quot;@string/oos_ptd_notice2&quot;</span><span class="w"></span>
<span class="gi">+    android:lineSpacingExtra=&quot;26px&quot;/&gt;</span><span class="w"></span>
<span class="gi">+&lt;/LinearLayout&gt;</span><span class="w"></span>

<span class="w">增加layout</span>
<span class="gd">--- a/frameworks/base/core/res/res/values/symbols.xml</span><span class="w"></span>
<span class="gi">+++ b/frameworks/base/core/res/res/values/symbols.xml</span><span class="w"></span>
<span class="gu">@@ -4052,4 +4052,5 @@</span><span class="w"></span>
<span class="w"> </span>  &lt;java-symbol type=&quot;string&quot; name=&quot;config_pdp_reject_multi_conn_to_same_pdn_not_allowed&quot; /&gt;<span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>  &lt;java-symbol type=&quot;array&quot; name=&quot;config_notificationMsgPkgsAllowedAsConvos&quot; /&gt;<span class="w"></span>
<span class="gi">+  &lt;java-symbol type=&quot;layout&quot; name=&quot;pocket_touch_disable&quot; /&gt;</span><span class="w"></span>
<span class="w"> </span>&lt;/resources&gt;<span class="w"></span>
</pre></div>
</div>
</section>
<section id="phonewindowmanager">
<h3>3.PhoneWindowManager增加具体功能实现<a class="headerlink" href="#phonewindowmanager" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>1.增加sensor类。</p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java</span><span class="w"></span>
<span class="gi">+++ b/frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java</span><span class="w"></span>
<span class="gu">@@ -233,6 +233,17 @@ import java.util.List;</span><span class="w"></span>
<span class="w"> </span>import android.content.ComponentName;<span class="w"></span>
<span class="w"> </span>import java.util.Queue;<span class="w"></span>
<span class="w"> </span>import java.util.concurrent.LinkedBlockingQueue;<span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+//[NEW FEATURE]-BEGIN by wugangnan@paxsz.com 2021-10-02, for Pocket mode</span><span class="w"></span>
<span class="gi">+import android.hardware.Sensor;</span><span class="w"></span>
<span class="gi">+import android.hardware.SensorEvent;</span><span class="w"></span>
<span class="gi">+import android.hardware.SensorEventListener;</span><span class="w"></span>
<span class="gi">+import android.hardware.SensorManager;</span><span class="w"></span>
<span class="gi">+import android.graphics.PixelFormat;</span><span class="w"></span>
<span class="gi">+import android.view.Gravity;</span><span class="w"></span>
<span class="gi">+//[NEW FEATURE]-END by wugangnan@paxsz.com 2021-10-02, for Pocket mode</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>2.增加各种接口，解释如下：</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>	//[NEW FEATURE]-BEGIN by wugangnan@paxsz.com 2021-10-02, for Pocket mode
	private static final long ALS_PS_DELAY = 1000;

	private boolean mProximitySensorEnabled;
	private boolean mProximityScreenShown;
	private long mScreenOnTime;

	private SensorManager mSensorManager;
	private Sensor mProximitySensor;
	private View mProximityView;
	private WindowManager.LayoutParams mProximityParams;

        1.读取Settings.System.POCKET_TOUCH_DISABLE变量，判断设置开关是否打开
	boolean isProximityScreenEnabled() {   
		Log.i(TAG, &quot;isProximityScreenEnabled.&quot;);
		return Settings.System.getInt(mContext.getContentResolver(),
				Settings.System.POCKET_TOUCH_DISABLE,
				0) == 1;
	}

        2.传参ture，注册距离传感器监听，否则注销和隐藏口袋模式界面。
	private void setProximitySensorEnabled(boolean enable) {
		Log.i(TAG, &quot;setProximitySensorEnabled.&quot; + enable);
		if (enable) {
			if (!mProximitySensorEnabled) {
				mProximitySensorEnabled = true;
				mSensorManager.registerListener(mProximitySensorListener, mProximitySensor,
						SensorManager.SENSOR_DELAY_UI, mHandler);
				mScreenOnTime = SystemClock.uptimeMillis();
			}
		} else {
			if (mProximitySensorEnabled) {
				mProximitySensorEnabled = false;
				hideProximityScreen();
				mSensorManager.unregisterListener(mProximitySensorListener);
			}
		}
	}

        3.显示口袋模式界面
	private void showProximityScreen() {
		Log.i(TAG, &quot;showProximityScreen.&quot; + mProximityScreenShown);
		if (!mProximityScreenShown) {
			if (mProximityView == null) {
				mProximityView = View.inflate(mContext,
						com.android.internal.R.layout.pocket_touch_disable, null);
				mProximityView.setSystemUiVisibility(View.STATUS_BAR_DISABLE_EXPAND);
				mProximityView.setFocusable(true);
				mProximityView.setFocusableInTouchMode(true);
				View.OnKeyListener listener = new View.OnKeyListener() {
					public boolean onKey(View v, int keyCode, KeyEvent event) {
						// capture all key event
						return true;
					}
				};
				mProximityView.setOnKeyListener(listener);

				mProximityParams = new WindowManager.LayoutParams(
						WindowManager.LayoutParams.MATCH_PARENT,
						WindowManager.LayoutParams.MATCH_PARENT);
				mProximityParams.type = WindowManager.LayoutParams.TYPE_BOOT_PROGRESS;
				mProximityParams.flags = WindowManager.LayoutParams.FLAG_FULLSCREEN
					| WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN | WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;


				mProximityParams.format = PixelFormat.TRANSLUCENT;
				mProximityParams.gravity = Gravity.END | Gravity.TOP;
				mProximityParams.setTitle(&quot;PTD view&quot;);
				//mProximityParams.x = getResources().getDisplayMetrics().widthPixels/2;
				//mProximityParams.y = 100;
			}
			WindowManager wm = (WindowManager) mContext.getSystemService(Context.WINDOW_SERVICE);
			wm.addView(mProximityView, mProximityParams);

			mProximityScreenShown = true;
			mHandler.removeCallbacks(mPsRunnable);
		}
	}

        4.隐藏口袋模式界面
	private void hideProximityScreen() {
		Log.i(TAG, &quot;hideProximityScreen.&quot;);
		if (mProximityScreenShown) {
			WindowManager wm = (WindowManager) mContext.getSystemService(Context.WINDOW_SERVICE);
			wm.removeView(mProximityView);
			mProximityView = null;
			mProximityParams = null;
			mProximityScreenShown = false;
		}
	}

        5.Runnable定时器，亮屏后延时1s启动，也就是说口袋模式有效时间为亮屏后1s。
	public Runnable mPsRunnable = new Runnable() {
		@Override
			public void run() {
				setProximitySensorEnabled(false);
			}
	};

        6.距离传感器监听函数，检测到手靠近则激活口袋模式
	private final SensorEventListener mProximitySensorListener = new SensorEventListener() {
		 @Override
			 public void onSensorChanged(SensorEvent event) {
				 boolean isNear = event.values[0] == 0.0f;
				 long time = SystemClock.uptimeMillis();

				 Log.i(TAG, &quot;mProximitySensorListener.&quot; + mProximityScreenShown);
				 if (!mProximityScreenShown) {
					 if (isNear) {
						 showProximityScreen();
					 }
				 } else {
					 if (!isNear) {
						 setProximitySensorEnabled(false);
					 }
				 }
			 }

		 @Override
			 public void onAccuracyChanged(Sensor sensor, int accuracy) {
				 // Not used.
			 }
	};

        7.激活口袋模式后，音量减按下则隐藏画面，注销监听。
	private void ProximityScreenVolumeDownKeyTriggered(){
		if (mScreenshotChordVolumeDownKeyTriggered &amp;&amp; !mA11yShortcutChordVolumeUpKeyTriggered) {
			if (mProximityScreenShown) {
				setProximitySensorEnabled(false);
			}
		}
	}
	//[NEW FEATURE]-END by wugangnan@paxsz.com 2021-10-02, for Pocket mode
</pre></div>
</div>
<ul class="simple">
<li><p>2.新增sensor监听</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>@Override
public void init(Context context, IWindowManager windowManager,
        WindowManagerFuncs windowManagerFuncs) {
                1.获取ProximitySensor实时数据。
                //[NEW FEATURE]-BEGIN by wugangnan@paxsz.com 2021-10-02, for Pocket mode read the value of the distance sensor
                mSensorManager = (SensorManager) context.getSystemService(Context.SENSOR_SERVICE);
                mProximitySensor = mSensorManager.getDefaultSensor(Sensor.TYPE_PROXIMITY);
                //[NEW FEATURE]-END by wugangnan@paxsz.com 2021-10-02, for Pocket mode read the value of the distance sensor

                2.注册一个广播接收器
                //[NEW FEATURE]-BEGIN by wugangnan@paxsz.com 2021-10-02, for Pocket mode register a broadcast when screen is on or off
                IntentFilter turningOnScreenfilter = new IntentFilter(); 
                turningOnScreenfilter.addAction(Intent.ACTION_SCREEN_OFF); //为BroadcastReceiver指定action，使之用于接收同action的广播
                turningOnScreenfilter.addAction(Intent.ACTION_SCREEN_ON);
                context.registerReceiver(mBatInfoReceiver, turningOnScreenfilter);
		 //[NEW FEATURE]-END by wugangnan@paxsz.com 2021-10-02, for Pocket mode register a broadcast when screen is on or off
        }

重写广播onReceive方法，监听亮灭屏：
//[NEW FEATURE]-BEGIN by wugangnan@paxsz.com 2021-10-02, for Pocket mode receive broadcast when screen is on or off
    BroadcastReceiver mBatInfoReceiver = new BroadcastReceiver() {
        @Override
            public void onReceive(final Context context, final Intent intent) {
                final String action = intent.getAction();
                1.亮屏时，首先判断开关是否打开。
                if(Intent.ACTION_SCREEN_ON.equals(action)){
                    if (isProximityScreenEnabled()) {
                        setProximitySensorEnabled(true);  2.注册距离传感器监听
                        mHandler.postDelayed(mPsRunnable, ALS_PS_DELAY); 3.延时1秒后调用此Runnable对象
                    }
                }else if(Intent.ACTION_SCREEN_OFF.equals(action)){
                    if (isProximityScreenEnabled()) setProximitySensorEnabled(false);

                }
            }
	};
	//[NEW FEATURE]-END by wugangnan@paxsz.com 2021-10-02, for Pocket mode receive broadcast when screen is on or off
</pre></div>
</div>
<ul class="simple">
<li><p>3.增加音量减按键退出功能</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>private void ProximityScreenVolumeDownKeyTriggered(){
        if (mScreenshotChordVolumeDownKeyTriggered &amp;&amp; !mA11yShortcutChordVolumeUpKeyTriggered) {
                if (mProximityScreenShown) {
                        setProximitySensorEnabled(false); 音量减按下则隐藏画面，注销监听。
                }
        }
}

    @Override
    public int interceptKeyBeforeQueueing(KeyEvent event, int policyFlags) {

        // Handle special keys.
        switch (keyCode) {
          case KeyEvent.KEYCODE_VOLUME_MUTE: {
                if (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) {
                    if (down) {
                        // Any activity on the vol down button stops the ringer toggle shortcut
                        cancelPendingRingerToggleChordAction();

                        if (interactive &amp;&amp; !mScreenshotChordVolumeDownKeyTriggered
                                &amp;&amp; (event.getFlags() &amp; KeyEvent.FLAG_FALLBACK) == 0) {
                            mScreenshotChordVolumeDownKeyTriggered = true;
                            mScreenshotChordVolumeDownKeyTime = event.getDownTime();
                            mScreenshotChordVolumeDownKeyConsumed = false;
                            //[NEW FEATURE]-BEGIN by wugangnan@paxsz.com 2021-10-02, for Pocket mode
                            ProximityScreenVolumeDownKeyTriggered();
                            //[NEW FEATURE]-END by wugangnan@paxsz.com 2021-10-02, for Pocket mode
                            cancelPendingPowerKeyAction();
                            interceptScreenshotChord();
                            interceptAccessibilityShortcutChord();
                        }
        }
    }
</pre></div>
</div>
</section>
<section id="id7">
<h3>4.整体程序流程<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>软件流程如下：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>* context.registerReceiver(mBatInfoReceiver, turningOnScreenfilter);  注册亮灭屏广播监听
  ├── onReceive(final Context context, final Intent intent) { 重写onReceive方法
  ├── if(Intent.ACTION_SCREEN_ON.equals(action)){   亮屏
  ├── if (isProximityScreenEnabled()) {  判断设置开关是否打开
  ├── setProximitySensorEnabled(true);  注册距离传感器监听
  │   └── mProximitySensorListener = new SensorEventListener() 距离传感器监听
  │       ├── isNear = event.values[0] == 0.0f; 读取距离数据
  │       └── if (!mProximityScreenShown) { //未显示口袋模式界面
  │           ├── if (isNear) { 触发近距
  │           │   └── showProximityScreen(); 显示口袋模式界面
  │           │       ├── mProximityScreenShown = true; 设置显示flag为ture
  │           │       └── mHandler.removeCallbacks(mPsRunnable); 关闭定时器
  │           └── if (!isNear) { 
  │               └── setProximitySensorEnabled(false); 注销距感监听
  │                   ├── mSensorManager.unregisterListener(mProximitySensorListener); 注销距感监听
  │                   └── hideProximityScreen(); 隐藏口袋模式界面
  └── else if(Intent.ACTION_SCREEN_OFF.equals(action)){  灭屏
      └── if (isProximityScreenEnabled())
          └── setProximitySensorEnabled(false);   注销距感监听，隐藏口袋模式界面
</pre></div>
</div>
<ul class="simple">
<li><p>流程图如下：</p></li>
</ul>
<p><img alt="0001_.png" src="../../../_images/0001_pocket.png" /></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, wugn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>