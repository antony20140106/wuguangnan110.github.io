<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概述</a><ul>
<li><a class="reference internal" href="#id2">参考</a></li>
<li><a class="reference internal" href="#id3">补丁</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概述</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概述<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p>MTK TypeC 耳机补丁，拿别人提交的过来分析。</p>
<section id="id2">
<h2>参考<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/mike8825/article/details/112062132">mtk平台typec模拟耳机补丁</a></p></li>
<li><p><a class="reference external" href="https://yunzhi.github.io/headset_knowledge">Android 耳机驱动知识</a></p></li>
</ul>
</section>
<section id="id3">
<h2>补丁<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h2>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w">From 7a3c41dd0bf70e28dd58a987c3980d337a725d82 Mon Sep 17 00:00:00 2001</span>
<span class="w">From: zhangwj &lt;zhangwj@paxsz.com&gt;</span>
<span class="w">Date: Mon, 26 Jul 2021 13:44:59 +0800</span>
<span class="w">Subject: [PATCH] =?UTF-8?q?[Title]:=20M8=E5=A2=9E=E5=8A=A0typec=E8=80=B3?=</span>
<span class="w"> </span>=?UTF-8?q?=E6=9C=BA=E6=94=AF=E6=8C=81(=E5=85=BC=E5=AE=B93.5mm=E8=80=B3?=<span class="w"></span>
<span class="w"> </span>=?UTF-8?q?=E6=9C=BA)?=<span class="w"></span>
<span class="w">MIME-Version: 1.0</span>
<span class="w">Content-Type: text/plain; charset=UTF-8</span>
<span class="w">Content-Transfer-Encoding: 8bit</span>

<span class="w">[Summary]: M8增加typec耳机支持(兼容3.5mm耳机，不能同时插)</span>

<span class="w">[Test Plan]: NO</span>

<span class="w">[Module]: 请选择net/system/api/sp/other</span>

<span class="w">[Model]: M8</span>

<span class="w">[author]: zhangwj@paxsz.com</span>

<span class="w">[date]: 2021-07-26</span>
<span class="gd">---</span><span class="w"></span>
<span class="w"> </span>.../k62v1_64_pax/BoardConfig.mk               |   3 +-<span class="w"></span>
<span class="w"> </span>.../arch/arm64/boot/dts/mediatek/M8.dts       |   6 +<span class="w"></span>
<span class="w"> </span>.../arch/arm64/boot/dts/mediatek/mt6765.dts   |   4 +<span class="w"></span>
<span class="w"> </span>.../configs/k62v1_64_pax_debug_defconfig      |   2 +<span class="w"></span>
<span class="w"> </span>.../arch/arm64/configs/k62v1_64_pax_defconfig |   2 +<span class="w"></span>
<span class="w"> </span>.../misc/mediatek/typec/tcpc/rt_pd_manager.c  |  25 ++<span class="w"></span>
<span class="w"> </span>kernel-4.19/drivers/misc/pax/Kconfig          |   3 +-<span class="w"></span>
<span class="w"> </span>kernel-4.19/drivers/misc/pax/Makefile         |   5 +-<span class="w"></span>
<span class="w"> </span>.../drivers/misc/pax/audio_switch/Kconfig     |   4 +<span class="w"></span>
<span class="w"> </span>.../drivers/misc/pax/audio_switch/Makefile    |   3 +<span class="w"></span>
<span class="w"> </span>.../pax/audio_switch/typec_audio_switch.c     | 236 ++++++++++++++++++<span class="w"></span>
<span class="w"> </span>kernel-4.19/sound/soc/codecs/mt6357-accdet.c  |  55 ++++<span class="w"></span>
<span class="w"> </span>12 files changed, 344 insertions(+), 4 deletions(-)<span class="w"></span>
<span class="w"> </span>mode change 100644 =&gt; 100755 kernel-4.19/drivers/misc/mediatek/typec/tcpc/rt_pd_manager.c<span class="w"></span>
<span class="w"> </span>create mode 100755 kernel-4.19/drivers/misc/pax/audio_switch/Kconfig<span class="w"></span>
<span class="w"> </span>create mode 100755 kernel-4.19/drivers/misc/pax/audio_switch/Makefile<span class="w"></span>
<span class="w"> </span>create mode 100755 kernel-4.19/drivers/misc/pax/audio_switch/typec_audio_switch.c<span class="w"></span>
<span class="w"> </span>mode change 100644 =&gt; 100755 kernel-4.19/sound/soc/codecs/mt6357-accdet.c<span class="w"></span>

<span class="gh">diff --git a/device/mediateksample/k62v1_64_pax/BoardConfig.mk b/device/mediateksample/k62v1_64_pax/BoardConfig.mk</span><span class="w"></span>
<span class="gh">index ac83324dabc..4c8ab82af52 100755</span><span class="w"></span>
<span class="gd">--- a/device/mediateksample/k62v1_64_pax/BoardConfig.mk</span><span class="w"></span>
<span class="gi">+++ b/device/mediateksample/k62v1_64_pax/BoardConfig.mk</span><span class="w"></span>
<span class="gu">@@ -48,8 +48,7 @@ BOARD_FLASH_BLOCK_SIZE := 4096</span><span class="w"></span>
<span class="w"> </span>KERNEL_OUT ?= $(OUT_DIR)/target/project/$(TARGET_DEVICE)/obj/KERNEL_OBJ<span class="w"></span>
<span class="w"> </span># in-tree kernel modules installed to vendor<span class="w"></span>
<span class="w"> </span># For Common<span class="w"></span>
<span class="gd">-BOARD_VENDOR_KERNEL_MODULES += $(KERNEL_OUT)/sound/soc/codecs/mt6357-accdet.ko \</span><span class="w"></span>
<span class="gd">-			       $(KERNEL_OUT)/kernel/trace/trace_mmstat.ko \</span><span class="w"></span>
<span class="gi">+BOARD_VENDOR_KERNEL_MODULES += $(KERNEL_OUT)/kernel/trace/trace_mmstat.ko</span><span class="w"></span>
<span class="w"> </span># For Camera<span class="w"></span>
<span class="w"> </span>BOARD_VENDOR_KERNEL_MODULES +=<span class="w"></span>
<span class="w"> </span># For Wifi<span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/arch/arm64/boot/dts/mediatek/M8.dts b/kernel-4.19/arch/arm64/boot/dts/mediatek/M8.dts</span><span class="w"></span>
<span class="gh">index 077320514b8..df558fae089 100755</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/arch/arm64/boot/dts/mediatek/M8.dts</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/arch/arm64/boot/dts/mediatek/M8.dts</span><span class="w"></span>
<span class="gu">@@ -716,6 +716,12 @@</span><span class="w"></span>
<span class="w"> </span>	status = &quot;okay&quot;;<span class="w"></span>
<span class="w"> </span>};<span class="w"></span>
<span class="w"> </span>
<span class="gi">+&amp;pax_typec_audio_switch {</span><span class="w"></span>
<span class="gi">+	audio-sel-gpio = &lt;&amp;pio 166 0&gt;;</span><span class="w"></span>
<span class="gi">+	audio-sel-level = &lt;1&gt;;</span><span class="w"></span>
<span class="gi">+	mic-sel-gpio = &lt;&amp;pio 178 0&gt;;</span><span class="w"></span>
<span class="gi">+	status = &quot;okay&quot;;</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>#include &quot;mediatek/mt6370_m8.dtsi&quot;<span class="w"></span>
<span class="w"> </span>#include &quot;mediatek/mt6370_pd_m8.dtsi&quot;<span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/arch/arm64/boot/dts/mediatek/mt6765.dts b/kernel-4.19/arch/arm64/boot/dts/mediatek/mt6765.dts</span><span class="w"></span>
<span class="gh">index 33538eb5a7f..4d6d5f2b598 100755</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/arch/arm64/boot/dts/mediatek/mt6765.dts</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/arch/arm64/boot/dts/mediatek/mt6765.dts</span><span class="w"></span>
<span class="gu">@@ -3856,6 +3856,10 @@ firmware_class.path=/vendor/firmware&quot;;</span><span class="w"></span>
<span class="w"> </span>	pax_usb_switch:pax_usb_switch {<span class="w"></span>
<span class="w"> </span>		compatible = &quot;pax,usb_switch&quot;;<span class="w"></span>
<span class="w"> </span>	};<span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	pax_typec_audio_switch:pax_typec_audio_switch {</span><span class="w"></span>
<span class="gi">+		compatible = &quot;pax,typec_audio_switch&quot;;</span><span class="w"></span>
<span class="gi">+	};</span><span class="w"></span>
<span class="w"> </span>};<span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>/*betterlife finger add */<span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/arch/arm64/configs/k62v1_64_pax_debug_defconfig b/kernel-4.19/arch/arm64/configs/k62v1_64_pax_debug_defconfig</span><span class="w"></span>
<span class="gh">index d596b658c71..80e931ddca2 100755</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/arch/arm64/configs/k62v1_64_pax_debug_defconfig</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/arch/arm64/configs/k62v1_64_pax_debug_defconfig</span><span class="w"></span>
<span class="gu">@@ -531,3 +531,5 @@ CONFIG_TRUSTKERNEL_TEE_FP_SUPPORT=y</span><span class="w"></span>
<span class="w"> </span>CONFIG_PAX_CAM_REGULATOR_SUPPORT=y<span class="w"></span>
<span class="w"> </span>CONFIG_SND_SOC_AW87XXX=y<span class="w"></span>
<span class="w"> </span>CONFIG_PAX_USB_SWITCH=y<span class="w"></span>
<span class="gi">+CONFIG_SND_SOC_MT6357_ACCDET=y</span><span class="w"></span>
<span class="gi">+CONFIG_PAX_TYPEC_AUDIO_SWITCH=y</span><span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/arch/arm64/configs/k62v1_64_pax_defconfig b/kernel-4.19/arch/arm64/configs/k62v1_64_pax_defconfig</span><span class="w"></span>
<span class="gh">index c0646ff0671..47ed390baf7 100755</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/arch/arm64/configs/k62v1_64_pax_defconfig</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/arch/arm64/configs/k62v1_64_pax_defconfig</span><span class="w"></span>
<span class="gu">@@ -509,3 +509,5 @@ CONFIG_TRUSTKERNEL_TEE_FP_SUPPORT=y</span><span class="w"></span>
<span class="w"> </span>CONFIG_PAX_CAM_REGULATOR_SUPPORT=y<span class="w"></span>
<span class="w"> </span>CONFIG_SND_SOC_AW87XXX=y<span class="w"></span>
<span class="w"> </span>CONFIG_PAX_USB_SWITCH=y<span class="w"></span>
<span class="gi">+CONFIG_SND_SOC_MT6357_ACCDET=y</span><span class="w"></span>
<span class="gi">+CONFIG_PAX_TYPEC_AUDIO_SWITCH=y</span><span class="w"></span>
<span class="w">\ No newline at end of file</span>
<span class="gh">diff --git a/kernel-4.19/drivers/misc/mediatek/typec/tcpc/rt_pd_manager.c b/kernel-4.19/drivers/misc/mediatek/typec/tcpc/rt_pd_manager.c</span><span class="w"></span>
<span class="w">old mode 100644</span>
<span class="w">new mode 100755</span>
<span class="gh">index 21d141bbf78..a118bdf9fb2</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/drivers/misc/mediatek/typec/tcpc/rt_pd_manager.c</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/misc/mediatek/typec/tcpc/rt_pd_manager.c</span><span class="w"></span>
<span class="gu">@@ -53,6 +53,15 @@ void __attribute__((weak)) usb_dpdm_pulldown(bool enable)</span><span class="w"></span>
<span class="w"> </span>	pr_notice(&quot;%s is not defined\n&quot;, __func__);<span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="w"> </span>
<span class="gi">+/* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+#ifdef CONFIG_PAX_TYPEC_AUDIO_SWITCH</span><span class="w"></span>
<span class="gi">+extern int pax_switch_select_audio(int sel);</span><span class="w"></span>
<span class="gi">+#endif</span><span class="w"></span>
<span class="gi">+#ifdef CONFIG_SND_SOC_MT6357_ACCDET</span><span class="w"></span>
<span class="gi">+extern void typec_headphone_plug_handler(int state);</span><span class="w"></span>
<span class="gi">+#endif</span><span class="w"></span>
<span class="gi">+/* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>static int pd_tcp_notifier_call(struct notifier_block *nb,<span class="w"></span>
<span class="w"> </span>				unsigned long event, void *data)<span class="w"></span>
<span class="w"> </span>{<span class="w"></span>
<span class="gu">@@ -92,10 +101,26 @@ static int pd_tcp_notifier_call(struct notifier_block *nb,</span><span class="w"></span>
<span class="w"> </span>			noti-&gt;typec_state.new_state == TYPEC_ATTACHED_AUDIO) {<span class="w"></span>
<span class="w"> </span>			/* AUDIO plug in */<span class="w"></span>
<span class="w"> </span>			pr_info(&quot;%s audio plug in\n&quot;, __func__);<span class="w"></span>
<span class="gi">+			/* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+			#ifdef CONFIG_PAX_TYPEC_AUDIO_SWITCH</span><span class="w"></span>
<span class="gi">+			pax_switch_select_audio(1);</span><span class="w"></span>
<span class="gi">+			#endif</span><span class="w"></span>
<span class="gi">+			#ifdef CONFIG_SND_SOC_MT6357_ACCDET</span><span class="w"></span>
<span class="gi">+			typec_headphone_plug_handler(1);</span><span class="w"></span>
<span class="gi">+			#endif</span><span class="w"></span>
<span class="gi">+			/* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="w"> </span>		} else if (noti-&gt;typec_state.old_state == TYPEC_ATTACHED_AUDIO<span class="w"></span>
<span class="w"> </span>			&amp;&amp; noti-&gt;typec_state.new_state == TYPEC_UNATTACHED) {<span class="w"></span>
<span class="w"> </span>			/* AUDIO plug out */<span class="w"></span>
<span class="w"> </span>			pr_info(&quot;%s audio plug out\n&quot;, __func__);<span class="w"></span>
<span class="gi">+			/* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+			#ifdef CONFIG_PAX_TYPEC_AUDIO_SWITCH</span><span class="w"></span>
<span class="gi">+			pax_switch_select_audio(0);</span><span class="w"></span>
<span class="gi">+			#endif</span><span class="w"></span>
<span class="gi">+			#ifdef CONFIG_SND_SOC_MT6357_ACCDET</span><span class="w"></span>
<span class="gi">+			typec_headphone_plug_handler(0);</span><span class="w"></span>
<span class="gi">+			#endif</span><span class="w"></span>
<span class="gi">+			/* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="w"> </span>		}<span class="w"></span>
<span class="w"> </span>		break;<span class="w"></span>
<span class="w"> </span>	case TCP_NOTIFY_PD_STATE:<span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/drivers/misc/pax/Kconfig b/kernel-4.19/drivers/misc/pax/Kconfig</span><span class="w"></span>
<span class="gh">index fddfbdd2b0d..c7766c4f322 100755</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/drivers/misc/pax/Kconfig</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/misc/pax/Kconfig</span><span class="w"></span>
<span class="gu">@@ -6,4 +6,5 @@ config PAX_DRV_SUPPORT</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>source &quot;drivers/misc/pax/gpio/Kconfig&quot;<span class="w"></span>
<span class="w"> </span>source &quot;drivers/misc/pax/cam_regu/Kconfig&quot;<span class="w"></span>
<span class="gd">-source &quot;drivers/misc/pax/usb_switch/Kconfig&quot;</span><span class="w"></span>
<span class="w">\ No newline at end of file</span>
<span class="gi">+source &quot;drivers/misc/pax/usb_switch/Kconfig&quot;</span><span class="w"></span>
<span class="gi">+source &quot;drivers/misc/pax/audio_switch/Kconfig&quot;</span><span class="w"></span>
<span class="w">\ No newline at end of file</span>
<span class="gh">diff --git a/kernel-4.19/drivers/misc/pax/Makefile b/kernel-4.19/drivers/misc/pax/Makefile</span><span class="w"></span>
<span class="gh">index c74ca859888..26b5ceb6426 100755</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/drivers/misc/pax/Makefile</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/misc/pax/Makefile</span><span class="w"></span>
<span class="gu">@@ -10,4 +10,7 @@ obj-$(CONFIG_PAX_GPIOS_CONTROL)  += gpio/</span><span class="w"></span>
<span class="w"> </span># camera module regulator control<span class="w"></span>
<span class="w"> </span>obj-$(CONFIG_PAX_CAM_REGULATOR_SUPPORT)  += cam_regu/<span class="w"></span>
<span class="w"> </span># pax usb switch<span class="w"></span>
<span class="gd">-obj-$(CONFIG_PAX_USB_SWITCH) += usb_switch/</span><span class="w"></span>
<span class="w">\ No newline at end of file</span>
<span class="gi">+obj-$(CONFIG_PAX_USB_SWITCH) += usb_switch/</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+# pax typec/audio switch</span><span class="w"></span>
<span class="gi">+obj-$(CONFIG_PAX_TYPEC_AUDIO_SWITCH) += audio_switch/</span><span class="w"></span>
<span class="w">\ No newline at end of file</span>
<span class="gh">diff --git a/kernel-4.19/drivers/misc/pax/audio_switch/Kconfig b/kernel-4.19/drivers/misc/pax/audio_switch/Kconfig</span><span class="w"></span>
<span class="w">new file mode 100755</span>
<span class="gh">index 00000000000..6cf0f2b8e44</span><span class="w"></span>
<span class="gd">--- /dev/null</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/misc/pax/audio_switch/Kconfig</span><span class="w"></span>
<span class="gu">@@ -0,0 +1,4 @@</span><span class="w"></span>
<span class="gi">+config PAX_TYPEC_AUDIO_SWITCH</span><span class="w"></span>
<span class="gi">+	tristate &quot;pax typec audio switch control&quot;</span><span class="w"></span>
<span class="gi">+	depends on PAX_DRV_SUPPORT</span><span class="w"></span>
<span class="gi">+	default n</span><span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/drivers/misc/pax/audio_switch/Makefile b/kernel-4.19/drivers/misc/pax/audio_switch/Makefile</span><span class="w"></span>
<span class="w">new file mode 100755</span>
<span class="gh">index 00000000000..adfc0934aa7</span><span class="w"></span>
<span class="gd">--- /dev/null</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/misc/pax/audio_switch/Makefile</span><span class="w"></span>
<span class="gu">@@ -0,0 +1,3 @@</span><span class="w"></span>
<span class="gi">+obj-y += typec_audio_switch.o</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+#ccflags-y += -Wno-unused-function</span><span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/drivers/misc/pax/audio_switch/typec_audio_switch.c b/kernel-4.19/drivers/misc/pax/audio_switch/typec_audio_switch.c</span><span class="w"></span>
<span class="w">new file mode 100755</span>
<span class="gh">index 00000000000..345f1c31919</span><span class="w"></span>
<span class="gd">--- /dev/null</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/drivers/misc/pax/audio_switch/typec_audio_switch.c</span><span class="w"></span>
<span class="gu">@@ -0,0 +1,236 @@</span><span class="w"></span>
<span class="gi">+#include &lt;linux/init.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/module.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/kernel.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/device.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/platform_device.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/types.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/sys.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/sysfs.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/sched.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/delay.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/workqueue.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/uaccess.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/of.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/of_gpio.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/gpio.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/spinlock.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/pm_wakeup.h&gt;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+enum {</span><span class="w"></span>
<span class="gi">+	SWITCH_SEL_USB = 0,</span><span class="w"></span>
<span class="gi">+	SWITCH_SEL_AUDIO = 1,</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+enum {</span><span class="w"></span>
<span class="gi">+	MIC_SWITCH_SEL_MIN = 0,</span><span class="w"></span>
<span class="gi">+	MIC_SWITCH_SEL_0 = MIC_SWITCH_SEL_MIN,</span><span class="w"></span>
<span class="gi">+	MIC_SWITCH_SEL_1 = 1,</span><span class="w"></span>
<span class="gi">+	MIC_SWITCH_SEL_MAX = MIC_SWITCH_SEL_1,</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+struct typec_audio_switch_data {</span><span class="w"></span>
<span class="gi">+	struct class *pax_class;</span><span class="w"></span>
<span class="gi">+	struct device *dev;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	struct mutex lock;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	int audio_sel_gpio;</span><span class="w"></span>
<span class="gi">+	int audio_sel_gpio_level;</span><span class="w"></span>
<span class="gi">+	int audio_cur_sel;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	int mic_sel_gpio;</span><span class="w"></span>
<span class="gi">+	int mic_cur_sel;</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static struct typec_audio_switch_data *gp_audio_switch;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+extern struct class *g_class_pax;</span><span class="w"></span>
<span class="gi">+extern const char *cmdline_get_value(const char *key);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int switch_init(struct typec_audio_switch_data *data, struct device_node *np)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	int ret;</span><span class="w"></span>
<span class="gi">+	unsigned int value;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	/* dmdp / hprhpl select */</span><span class="w"></span>
<span class="gi">+	data-&gt;audio_sel_gpio = of_get_named_gpio(np, &quot;audio-sel-gpio&quot;, 0);</span><span class="w"></span>
<span class="gi">+	ret = gpio_request(data-&gt;audio_sel_gpio, &quot;audio_sel_gpio&quot;);</span><span class="w"></span>
<span class="gi">+	if (ret &lt; 0) {</span><span class="w"></span>
<span class="gi">+		pr_err(&quot;%s error: failed to request audio_sel_gpio%d (ret = %d)\n&quot;,</span><span class="w"></span>
<span class="gi">+					__func__, data-&gt;audio_sel_gpio, ret);</span><span class="w"></span>
<span class="gi">+		return -1;</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+	of_property_read_u32(np, &quot;audio-sel-level&quot;, &amp;value);</span><span class="w"></span>
<span class="gi">+	data-&gt;audio_sel_gpio_level = value;</span><span class="w"></span>
<span class="gi">+	data-&gt;audio_cur_sel = SWITCH_SEL_USB;</span><span class="w"></span>
<span class="gi">+	gpio_direction_output(data-&gt;audio_sel_gpio, !data-&gt;audio_sel_gpio_level);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	/* mic&amp;gnd path select */</span><span class="w"></span>
<span class="gi">+	data-&gt;mic_sel_gpio = of_get_named_gpio(np, &quot;mic-sel-gpio&quot;, 0);</span><span class="w"></span>
<span class="gi">+	ret = gpio_request(data-&gt;mic_sel_gpio, &quot;mic_sel_gpio&quot;);</span><span class="w"></span>
<span class="gi">+	if (ret &lt; 0) {</span><span class="w"></span>
<span class="gi">+		pr_err(&quot;%s error: failed to request mic_sel_gpio%d (ret = %d)\n&quot;,</span><span class="w"></span>
<span class="gi">+					__func__, data-&gt;mic_sel_gpio, ret);</span><span class="w"></span>
<span class="gi">+		//return -1;</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+	data-&gt;mic_cur_sel = MIC_SWITCH_SEL_1;</span><span class="w"></span>
<span class="gi">+	gpio_direction_output(data-&gt;mic_sel_gpio, (data-&gt;mic_cur_sel ? 1 : 0));</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	return ret;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int typec_audio_swtich_probe(struct platform_device *pdev)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	int ret = 0;</span><span class="w"></span>
<span class="gi">+	struct typec_audio_switch_data *data;</span><span class="w"></span>
<span class="gi">+	struct device_node *np = pdev-&gt;dev.of_node;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	pr_info(&quot;%s\n&quot;, __func__);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	data = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(struct typec_audio_switch_data), GFP_KERNEL);</span><span class="w"></span>
<span class="gi">+	if (!data) {</span><span class="w"></span>
<span class="gi">+		pr_err(&quot;%s, alloc fail\n&quot;, __func__);</span><span class="w"></span>
<span class="gi">+		return -ENOMEM;</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	/* resource */</span><span class="w"></span>
<span class="gi">+	switch_init(data, np);</span><span class="w"></span>
<span class="gi">+	if (ret) {</span><span class="w"></span>
<span class="gi">+		goto req_res_fail;</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	if (g_class_pax != NULL) {</span><span class="w"></span>
<span class="gi">+		data-&gt;pax_class = g_class_pax;</span><span class="w"></span>
<span class="gi">+	} else {</span><span class="w"></span>
<span class="gi">+		data-&gt;pax_class = class_create(THIS_MODULE, &quot;pax&quot;);</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	mutex_init(&amp;data-&gt;lock);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	/* creat sysfs for debug /sys/devices/platform/pax_usb_switch/pax/usb_switch */</span><span class="w"></span>
<span class="gi">+	data-&gt;dev = device_create(data-&gt;pax_class, &amp;pdev-&gt;dev, 0, NULL, &quot;usb_audio_switch&quot;);</span><span class="w"></span>
<span class="gi">+	platform_set_drvdata(pdev, data);</span><span class="w"></span>
<span class="gi">+    </span><span class="w"></span>
<span class="gi">+	gp_audio_switch = data;</span><span class="w"></span>
<span class="gi">+	return 0;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+req_res_fail:</span><span class="w"></span>
<span class="gi">+	devm_kfree(&amp;pdev-&gt;dev, data);</span><span class="w"></span>
<span class="gi">+	return ret;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int typec_audio_swtich_remove(struct platform_device *pdev)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	struct typec_audio_switch_data *data = platform_get_drvdata(pdev);</span><span class="w"></span>
<span class="gi">+	</span><span class="w"></span>
<span class="gi">+	if (data) {</span><span class="w"></span>
<span class="gi">+		gpio_free(data-&gt;audio_sel_gpio);</span><span class="w"></span>
<span class="gi">+		mutex_destroy(&amp;data-&gt;lock);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+		devm_kfree(&amp;pdev-&gt;dev, data);</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	return 0;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+int pax_switch_select_audio(int sel)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	if (gp_audio_switch) {</span><span class="w"></span>
<span class="gi">+		if (gp_audio_switch-&gt;audio_cur_sel != sel) {</span><span class="w"></span>
<span class="gi">+			gp_audio_switch-&gt;audio_cur_sel = ((sel == SWITCH_SEL_USB) ? SWITCH_SEL_USB : SWITCH_SEL_AUDIO);</span><span class="w"></span>
<span class="gi">+			if (gp_audio_switch-&gt;audio_cur_sel == SWITCH_SEL_AUDIO) {</span><span class="w"></span>
<span class="gi">+				gpio_direction_output(gp_audio_switch-&gt;audio_sel_gpio, gp_audio_switch-&gt;audio_sel_gpio_level);</span><span class="w"></span>
<span class="gi">+			} else {</span><span class="w"></span>
<span class="gi">+				gpio_direction_output(gp_audio_switch-&gt;audio_sel_gpio, !gp_audio_switch-&gt;audio_sel_gpio_level);</span><span class="w"></span>
<span class="gi">+			}</span><span class="w"></span>
<span class="gi">+		}</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	return 0;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+EXPORT_SYMBOL(pax_switch_select_audio);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+int pax_switch_change_mic_sel_path(void)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	int sel;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	if (gp_audio_switch) {</span><span class="w"></span>
<span class="gi">+		sel = gp_audio_switch-&gt;mic_cur_sel;</span><span class="w"></span>
<span class="gi">+		if (++sel &gt; MIC_SWITCH_SEL_MAX) {</span><span class="w"></span>
<span class="gi">+			sel = MIC_SWITCH_SEL_MIN;</span><span class="w"></span>
<span class="gi">+		}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+		gp_audio_switch-&gt;mic_cur_sel = sel;</span><span class="w"></span>
<span class="gi">+		gpio_direction_output(gp_audio_switch-&gt;mic_sel_gpio, (sel ? 1 : 0));</span><span class="w"></span>
<span class="gi">+		pr_info(&quot;%s, mic sel: %d\n&quot;, __func__, sel);</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	return 0;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+EXPORT_SYMBOL(pax_switch_change_mic_sel_path);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static const struct of_device_id audio_switch_of_match[] = {</span><span class="w"></span>
<span class="gi">+	{ .compatible = &quot;pax,typec_audio_switch&quot; },</span><span class="w"></span>
<span class="gi">+	{},</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+MODULE_DEVICE_TABLE(of, audio_switch_of_match);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int typec_audio_switch_suspend(struct device *dev)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	pr_err(&quot;==%s\n&quot;, __func__);</span><span class="w"></span>
<span class="gi">+	return 0;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int typec_audio_switch_resume(struct device *dev)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	pr_err(&quot;==%s\n&quot;, __func__);</span><span class="w"></span>
<span class="gi">+	return 0;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static void typec_audio_switch_shutdown(struct platform_device *pdev)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	pr_err(&quot;==%s\n&quot;, __func__);</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static const struct dev_pm_ops typec_audio_swtich_pm_ops = {</span><span class="w"></span>
<span class="gi">+	.suspend = typec_audio_switch_suspend,</span><span class="w"></span>
<span class="gi">+	.resume = typec_audio_switch_resume,</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static struct platform_driver typec_audio_switch_driver = {</span><span class="w"></span>
<span class="gi">+	.probe = typec_audio_swtich_probe,</span><span class="w"></span>
<span class="gi">+	.remove = typec_audio_swtich_remove,</span><span class="w"></span>
<span class="gi">+	.driver = {</span><span class="w"></span>
<span class="gi">+		.name = &quot;pax_typec_audio_switch&quot;,</span><span class="w"></span>
<span class="gi">+		.of_match_table = audio_switch_of_match,</span><span class="w"></span>
<span class="gi">+		.pm = &amp;typec_audio_swtich_pm_ops,</span><span class="w"></span>
<span class="gi">+	},</span><span class="w"></span>
<span class="gi">+	.shutdown = typec_audio_switch_shutdown,</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int __init pax_typec_audio_switch_init(void)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	return platform_driver_register(&amp;typec_audio_switch_driver);</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static void __exit pax_typec_audio_switch_exit(void)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	platform_driver_unregister(&amp;typec_audio_switch_driver);</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+//module_init(pax_typec_audio_switch_init);</span><span class="w"></span>
<span class="gi">+late_initcall(pax_typec_audio_switch_init);</span><span class="w"></span>
<span class="gi">+module_exit(pax_typec_audio_switch_exit);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+MODULE_LICENSE(&quot;GPL&quot;);</span><span class="w"></span>
<span class="gi">+MODULE_AUTHOR(&quot;PAX&quot;);</span><span class="w"></span>
<span class="gi">+MODULE_DESCRIPTION(&quot;pax usb switch&quot;);</span><span class="w"></span>
<span class="gh">diff --git a/kernel-4.19/sound/soc/codecs/mt6357-accdet.c b/kernel-4.19/sound/soc/codecs/mt6357-accdet.c</span><span class="w"></span>
<span class="w">old mode 100644</span>
<span class="w">new mode 100755</span>
<span class="gh">index b01d249ed35..ebc43697b4b</span><span class="w"></span>
<span class="gd">--- a/kernel-4.19/sound/soc/codecs/mt6357-accdet.c</span><span class="w"></span>
<span class="gi">+++ b/kernel-4.19/sound/soc/codecs/mt6357-accdet.c</span><span class="w"></span>
<span class="gu">@@ -161,6 +161,12 @@ static struct snd_soc_jack_pin accdet_jack_pins[] = {</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>static struct platform_driver accdet_driver;<span class="w"></span>
<span class="w"> </span>
<span class="gi">+/* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+static int g_typec_headphone_plug = 0;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+extern int pax_switch_change_mic_sel_path(void);</span><span class="w"></span>
<span class="gi">+/* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>static atomic_t accdet_first;<span class="w"></span>
<span class="w"> </span>#define ACCDET_INIT_WAIT_TIMER (10 * HZ)<span class="w"></span>
<span class="w"> </span>static struct timer_list accdet_init_timer;<span class="w"></span>
<span class="gu">@@ -1201,12 +1207,18 @@ void accdet_set_debounce(int state, unsigned int debounce)</span><span class="w"></span>
<span class="w"> </span>static inline void check_cable_type(void)<span class="w"></span>
<span class="w"> </span>{<span class="w"></span>
<span class="w"> </span>	u32 cur_AB = 0;<span class="w"></span>
<span class="gi">+	u32 vol;</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>	cur_AB = accdet_read(ACCDET_MEM_IN_ADDR) &gt;&gt; ACCDET_STATE_MEM_IN_OFFSET;<span class="w"></span>
<span class="w"> </span>		cur_AB = cur_AB &amp; ACCDET_STATE_AB_MASK;<span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>	accdet-&gt;button_status = 0;<span class="w"></span>
<span class="w"> </span>
<span class="gi">+	/* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+	pr_info(&quot;%s, accdet_status=%d, cur_AB=%d, eint_sync_flag=%d, auxadc=%d\n&quot;, </span><span class="w"></span>
<span class="gi">+		__func__, accdet-&gt;accdet_status, cur_AB, accdet-&gt;eint_sync_flag, accdet_get_auxadc());</span><span class="w"></span>
<span class="gi">+	/* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>	switch (accdet-&gt;accdet_status) {<span class="w"></span>
<span class="w"> </span>	case PLUG_OUT:<span class="w"></span>
<span class="w"> </span>		if (cur_AB == ACCDET_STATE_AB_00) {<span class="w"></span>
<span class="gu">@@ -1214,6 +1226,20 @@ static inline void check_cable_type(void)</span><span class="w"></span>
<span class="w"> </span>			if (accdet-&gt;eint_sync_flag) {<span class="w"></span>
<span class="w"> </span>				accdet-&gt;cable_type = HEADSET_NO_MIC;<span class="w"></span>
<span class="w"> </span>				accdet-&gt;accdet_status = HOOK_SWITCH;<span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+				/* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+				if (g_typec_headphone_plug) {</span><span class="w"></span>
<span class="gi">+					pax_switch_change_mic_sel_path();</span><span class="w"></span>
<span class="gi">+					mdelay(2);</span><span class="w"></span>
<span class="gi">+					vol = accdet_get_auxadc();</span><span class="w"></span>
<span class="gi">+					if (vol &gt;= 600) {</span><span class="w"></span>
<span class="gi">+						accdet-&gt;accdet_status = MIC_BIAS;</span><span class="w"></span>
<span class="gi">+						accdet-&gt;cable_type = HEADSET_MIC;</span><span class="w"></span>
<span class="gi">+						accdet_set_debounce(accdet_state011,</span><span class="w"></span>
<span class="gi">+								cust_pwm_deb-&gt;debounce3 * 30);</span><span class="w"></span>
<span class="gi">+					}</span><span class="w"></span>
<span class="gi">+				}</span><span class="w"></span>
<span class="gi">+				/* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="w"> </span>			} else<span class="w"></span>
<span class="w"> </span>				pr_notice(&quot;accdet hp has been plug-out\n&quot;);<span class="w"></span>
<span class="w"> </span>			mutex_unlock(&amp;accdet-&gt;res_lock);<span class="w"></span>
<span class="gu">@@ -1652,6 +1678,35 @@ static inline int ext_eint_setup(struct platform_device *platform_device)</span><span class="w"></span>
<span class="w"> </span>	return 0;<span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="w"> </span>
<span class="gi">+/* [FEATURE] Add-BEGIN by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+void typec_headphone_plug_handler(int state)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	pr_info(&quot;typec headpnone plug: %d\n&quot;, state);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	if (accdet != NULL) {</span><span class="w"></span>
<span class="gi">+		if (accdet-&gt;cur_eint_state == EINT_PLUG_IN &amp;&amp; !g_typec_headphone_plug) {</span><span class="w"></span>
<span class="gi">+			pr_info(&quot;wired headset already plugin\n&quot;);</span><span class="w"></span>
<span class="gi">+			return;</span><span class="w"></span>
<span class="gi">+		}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+		accdet_clear_bit(ACCDET_EINT0_EN_ADDR, ACCDET_EINT0_EN_SFT);</span><span class="w"></span>
<span class="gi">+		mdelay(2);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+		g_typec_headphone_plug = state;</span><span class="w"></span>
<span class="gi">+		if (state == 1) {</span><span class="w"></span>
<span class="gi">+			accdet-&gt;cur_eint_state = EINT_PLUG_IN;</span><span class="w"></span>
<span class="gi">+			mod_timer(&amp;micbias_timer,jiffies + MICBIAS_DISABLE_TIMER);</span><span class="w"></span>
<span class="gi">+		} else {</span><span class="w"></span>
<span class="gi">+			accdet-&gt;cur_eint_state = EINT_PLUG_OUT;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+			accdet_update_bit(ACCDET_EINT0_EN_ADDR, ACCDET_EINT0_EN_SFT);</span><span class="w"></span>
<span class="gi">+		}</span><span class="w"></span>
<span class="gi">+		queue_work(accdet-&gt;eint_workqueue, &amp;accdet-&gt;eint_work);</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+EXPORT_SYMBOL(typec_headphone_plug_handler);</span><span class="w"></span>
<span class="gi">+/* [FEATURE] Add-END by (zhangwj@paxsz.com), 2021/07/21 */</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>static int accdet_get_dts_data(void)<span class="w"></span>
<span class="w"> </span>{<span class="w"></span>
<span class="w"> </span>	int ret = 0;<span class="w"></span>
<span class="gd">-- </span><span class="w"></span>
<span class="w">2.17.1</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, wugn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>