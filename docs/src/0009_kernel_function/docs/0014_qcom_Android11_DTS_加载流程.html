<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">README</a></li>
<li><a class="reference internal" href="#id1">参考</a></li>
<li><a class="reference internal" href="#id2">前言</a></li>
<li><a class="reference internal" href="#dt">DT相关的专有名词</a></li>
<li><a class="reference internal" href="#id3">摘要</a></li>
<li><a class="reference internal" href="#bootloader-dt">Bootloader 加载DT的基本流程</a><ul>
<li><a class="reference internal" href="#id4">编译阶段</a></li>
<li><a class="reference internal" href="#dtb">dtb分区</a></li>
<li><a class="reference internal" href="#id5">运行</a></li>
</ul>
</li>
<li><a class="reference internal" href="#qcm2290dts">实际案例QCM2290平台DTS的编译完整流程</a><ul>
<li><a class="reference internal" href="#main-dt-overlay-dt">Main DT 和 Overlay DT的构建</a></li>
<li><a class="reference internal" href="#main-dt">Main DT构建流程</a></li>
<li><a class="reference internal" href="#overlay-dt">Overlay DT构建</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bootloaderdtbdtbo">bootloader中如何加载dtb和dtbo</a></li>
<li><a class="reference internal" href="#kerneldt">kernel中是如何使用获取到合并后的DT</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>README</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="readme">
<h1>README<a class="headerlink" href="#readme" title="此标题的永久链接"></a></h1>
<p>mt6762平台dts加载流程分析。</p>
</section>
<section id="id1">
<h1>参考<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/love131452098/article/details/124912174">【Device Tree】Android DTS 加载流程</a></p></li>
</ul>
</section>
<section id="id2">
<h1>前言<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<p>在之前的文章中已经对设备树的基本概念作了讲解, 操作系统（例如在 Android 中使用的 Linux 内核）会使用 DT 来支持 Android 设备使用的各种硬件配置。硬件供应商(ODM)会提供自己的 DT 源文件，接下来 Linux 会将这些文件编译到引导加载程序使用的设备树 Blob (DTB) 文件中。</p>
<p>Android在原有的DT基础上增加了设备树叠加层的处理方式。进一步的对于芯片产品的DT和开发者(ODM/OEM/产品开发者)的DT做了解耦。</p>
<p>设备树叠加层 (DTO) 可让主要的(ODM)设备树 Blob (DTB) 叠加在Soc设备树上。使用 DTO 的引导加载程序可以维护系统芯片 (SoC) DT，并动态叠加针对特定设备(ODM)的 DT，从而向树中添加节点并对现有树中的属性进行更改。
本篇文章主要讲述如下内容:</p>
<ul class="simple">
<li><p>DT的专有名词</p></li>
<li><p>Bootloader 加载DT的基本流程</p></li>
<li><p>Android 下DTO的实现以及原理</p></li>
<li><p>实际案例-MT8167 平台DTS的加载完整流程</p></li>
</ul>
</section>
<section id="dt">
<h1>DT相关的专有名词<a class="headerlink" href="#dt" title="此标题的永久链接"></a></h1>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>名词</p></th>
<th class="head"><p>解释</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DT</p></td>
<td><p>Device Tree</p></td>
</tr>
<tr class="row-odd"><td><p>DTB</p></td>
<td><p>Device Tree Blob</p></td>
</tr>
<tr class="row-even"><td><p>DTBO</p></td>
<td><p>Device Tree Blob for Overlay</p></td>
</tr>
<tr class="row-odd"><td><p>DTC</p></td>
<td><p>Device Tree Compiler</p></td>
</tr>
<tr class="row-even"><td><p>DTO</p></td>
<td><p>Device Tree Overlay</p></td>
</tr>
<tr class="row-odd"><td><p>DTS</p></td>
<td><p>Device Tree Source</p></td>
</tr>
<tr class="row-even"><td><p>FDT</p></td>
<td><p>Flattened Device Tree, a binary format contained in a .dtb blob file</p></td>
</tr>
<tr class="row-odd"><td><p>Dts</p></td>
<td><p>DTS即Device Tree Source，是一个文本形式的文件，用于描述硬件信息。一般都是固定信息，无法变更，无法overlay。</p></td>
</tr>
<tr class="row-even"><td><p>Dtsi</p></td>
<td><p>可以理解为dts的公共部分，添加、变更非常灵活。Dtsi包含在dts中。</p></td>
</tr>
<tr class="row-odd"><td><p>Dtb</p></td>
<td><p>Dtb编译出来的二进制</p></td>
</tr>
<tr class="row-even"><td><p>Dtbo</p></td>
<td><p>Overlay编译出来的二进制</p></td>
</tr>
<tr class="row-odd"><td><p>dtbo-base</p></td>
<td><p>指定overlay是以哪个dtb为base来覆盖的。</p></td>
</tr>
<tr class="row-even"><td><p>Node</p></td>
<td><p>树的节点</p></td>
</tr>
<tr class="row-odd"><td><p>Property</p></td>
<td><p>属性</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id3">
<h1>摘要<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>dtb在</p></li>
</ul>
</section>
<section id="bootloader-dt">
<h1>Bootloader 加载DT的基本流程<a class="headerlink" href="#bootloader-dt" title="此标题的永久链接"></a></h1>
<p><img alt="0014_0000.png" src="../../../_images/0014_00001.png" /></p>
<p>如上图所示，系统加载DT主要包含: DTS源文件编译, .dtb分区以及对应镜像文件生成, bootloader运行将.dtb 分区的文件加载到内存中, 将对应的内存地址通过寄存器传递到kernel。</p>
<p>在支持DTO的Android下, DT 是由以下两个部分组成:</p>
<ul class="simple">
<li><p>Main DT, 主要是Soc-only的部分以及默认的系统配置，例如cpu配置/内存相关配置等，soc的供应商提供, 本文所用的MT8167 那么这个Main DT就是由MTK提供的.（a6650-scuba-iot.dts）</p></li>
<li><p>Overlay DT, 该Soc所对应的产品需要的特定配置, 主要是由ODM/OEM提供，这里可以理解为开发者自己定义(当然目前在MT8167上MTK也提供了基本的Oerlay DT基本模板)(a6650-scuba-iot-idp-overlay.dts)</p></li>
</ul>
<section id="id4">
<h2>编译阶段<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>通过dtc(device tree compiler)将Main DT dts源文件编译为.dtb文件.</p></li>
<li><p>通过dtc(device tree compiler)将Overlay DT的dts源文件编译为后缀名为.dtbo的文件.</p></li>
</ul>
<p>这里需要注意的是, .dtb和.dtbo 的文件格式是相同的都是FDT. 后缀名不同只是为了区分.</p>
</section>
<section id="dtb">
<h2>dtb分区<a class="headerlink" href="#dtb" title="此标题的永久链接"></a></h2>
<p><img alt="0014_0001.png" src="../../../_images/0014_00011.png" /></p>
<p>在MT8167这一平台上是将dtbo划分为了独立的分区, 具体的分析在实际案例章节会详细说明.</p>
</section>
<section id="id5">
<h2>运行<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h2>
<p><img alt="0014_0002.png" src="../../../_images/0014_0002.png" /></p>
<ul class="simple">
<li><p>在bootloader中将.dtb文件读取到内存中</p></li>
<li><p>在bootloader中将.dtbo文件从dtbo分区(emmc指定分区)读取到内存中.</p></li>
<li><p>将.dtb 和 .dtbo 合并</p></li>
<li><p>在bootloader跳转启动kernel时，将该内存地址通过寄存器传递给到kernel</p></li>
</ul>
<p>关于这个环节的详细流程在实际案例章节会详细说明，如：</p>
<ul class="simple">
<li><p><span class="xref myst">0003_多机型DTB兼容方案.md</span></p></li>
</ul>
</section>
</section>
<section id="qcm2290dts">
<h1>实际案例QCM2290平台DTS的编译完整流程<a class="headerlink" href="#qcm2290dts" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>QCM2290平台的Main DT和Overlay DT一览
截取了QCM2290平台Main DT的部分内容, 关于Main DT 和 Oerlay DT 在上一章节”Bootloader 加载DT的基本流程”已描述.</p></li>
</ol>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">a6650-scuba-iot.dts</span></code>:</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>/dts-v1/<span class="p">;</span>

<span class="c1">#include &quot;scuba-iot.dtsi&quot;</span>

/ <span class="o">{</span>
	<span class="nv">model</span> <span class="o">=</span> <span class="s2">&quot;Qualcomm Technologies, Inc. Scuba IOT SoC&quot;</span><span class="p">;</span>
	<span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;qcom,scuba-iot&quot;</span><span class="p">;</span>
	qcom,board-id <span class="o">=</span> &lt;<span class="m">0</span> <span class="m">0</span>&gt;<span class="p">;</span>

	soc <span class="o">{</span>
		pax_board_info <span class="o">{</span>
			<span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;pax,board_info&quot;</span><span class="p">;</span>
			pax,main_board <span class="o">=</span> <span class="s2">&quot;V01&quot;</span><span class="p">;</span>
			pax,port_board <span class="o">=</span> <span class="s2">&quot;V01&quot;</span><span class="p">;</span>
			pax,terminal_name <span class="o">=</span> <span class="s2">&quot;A6650&quot;</span><span class="p">;</span>
		<span class="o">}</span><span class="p">;</span>
	<span class="o">}</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<p>基于上述截取的部分内容可以看到，针对QCM2290平台+Android Main DT由一个文件构成,makefile如下：</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="cp">ifeq ($(CONFIG_BUILD_ARM64_DT_OVERLAY),y)</span>
<span class="nv">dts-dirs</span> <span class="o">+=</span> a6650
<span class="nv">dts-dirs</span> <span class="o">+=</span> m9200
<span class="cp">endif</span>

<span class="cp">ifeq ($(CONFIG_BUILD_ARM64_DT_OVERLAY),y)</span>
<span class="nv">dtbo-$(CONFIG_ARCH_SCUBA)</span> <span class="o">+=</span> a6650-scuba-iot-idp-overlay.dtbo
<span class="nv">a6650-scuba-iot-idp-overlay.dtbo-base</span> <span class="o">:=</span> a6650-scuba-iot.dtb //指定a6650-scuba-iot-idp-overlay.dtbo的dtb
<span class="cp">endif</span>
<span class="nv">always</span>		<span class="o">:=</span> <span class="k">$(</span>dtb-y<span class="k">)</span>
<span class="nv">subdir-y</span>	<span class="o">:=</span> <span class="k">$(</span>dts-dirs<span class="k">)</span>

<span class="nv">clean-files</span>	<span class="o">:=</span> *.dtb *.dtbo
</pre></div>
</div>
<ul class="simple">
<li><p>继续看Overlay DT,<code class="docutils literal notranslate"><span class="pre">a6650-scuba-iot-idp-overlay.dts</span></code>:</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>/dts-v1/<span class="p">;</span>
/plugin/<span class="p">;</span>

<span class="c1">#include &lt;dt-bindings/interrupt-controller/arm-gic.h&gt;</span>
<span class="c1">#include &quot;scuba-iot-idp.dtsi&quot;</span>

/ <span class="o">{</span>
	<span class="nv">model</span> <span class="o">=</span> <span class="s2">&quot;Qualcomm Technologies, Inc. Scuba IOT IDP&quot;</span><span class="p">;</span>
	<span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;qcom,scuba-idp&quot;</span>, <span class="s2">&quot;qcom,scuba-iot&quot;</span>, <span class="s2">&quot;qcom,idp&quot;</span><span class="p">;</span>
	qcom,msm-id <span class="o">=</span> &lt;<span class="m">473</span> 0x10000&gt;, &lt;<span class="m">474</span> 0x10000&gt;<span class="p">;</span>
	qcom,board-id <span class="o">=</span> &lt;<span class="m">34</span> <span class="m">0</span>&gt;<span class="p">;</span>

	soc <span class="o">{</span>
		pax_board_info <span class="o">{</span>
			<span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;pax,board_info&quot;</span><span class="p">;</span>
			pax,main_board <span class="o">=</span> <span class="s2">&quot;V01&quot;</span><span class="p">;</span>
			pax,port_board <span class="o">=</span> <span class="s2">&quot;V01&quot;</span><span class="p">;</span>
			pax,terminal_name <span class="o">=</span> <span class="s2">&quot;A6650&quot;</span><span class="p">;</span>
		<span class="o">}</span><span class="p">;</span>
	<span class="o">}</span><span class="p">;</span>

<span class="o">}</span><span class="p">;</span>

<span class="p">&amp;</span>soc <span class="o">{</span>
//<span class="o">[</span>FEATURE<span class="o">]</span>-Add-begin by wugangnan@paxsz.com, <span class="m">2022</span>/07/06, <span class="k">for</span> charger and type-c driver
	rt_pd_manager:rt_pd_manager <span class="o">{</span>
		<span class="nv">compatible</span> <span class="o">=</span> <span class="s2">&quot;richtek,rt-pd-manager&quot;</span><span class="p">;</span>
	<span class="o">}</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

<span class="p">&amp;</span>pm2250_charger <span class="o">{</span>
	qcom,batteryless-platform<span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<p>这里需要注意的是，在a6650-scuba-iot-idp-overlay.dts中&amp;符号在dts语法中是引用的意思，这里暂时可以理解为:</p>
<section id="main-dt-overlay-dt">
<h2>Main DT 和 Overlay DT的构建<a class="headerlink" href="#main-dt-overlay-dt" title="此标题的永久链接"></a></h2>
<p>在分析之前提前揭晓下答案:</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>Main DT
    -&gt; a6650-scuba-iot.dts
       -&gt; DTC - a6650-scuba-iot.dtb  
          -&gt; CAT a6650-scuba-iot.dtb &amp;&amp; zImage &gt; zImage-dtb中
也就是Main DT最终会包含在boot.img中


Overlay DT
    -&gt; a6650-scuba-iot-idp-overlay.dts
        -&gt; DTC - a6650-scuba-iot-idp-overlay.dtb
            -&gt; mkimage a6650-scuba-iot-idp-overlay.dtb -&gt; dtbo.img
也就是Overlay DT最终会包含在odmdtbo.img,作为独立的分区文件写入设备的指定分区
</pre></div>
</div>
<p>可知dtb/dtbo生成目录为<code class="docutils literal notranslate"><span class="pre">out/target/product/bengal/obj/kernel/msm-4.19/arch/arm64/boot/dts/vendor/qcom/</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>wugn@jcrj-tf-compile:qcom$ tree
.
├── a6650
│   ├── a6650-scuba-iot.dtb
│   ├── a6650-scuba-iot-idp-overlay.dtbo
│   └── modules.order
├── a6650-scuba-iot.dtb
├── a7000-scuba-iot.dtb
├── bengal-1gb.dtb
├── bengal-2gb.dtb
├── bengal.dtb
├── bengal-iot-2gb.dtb
├── bengal-iot.dtb
├── bengalp.dtb
├── bengalp-iot-2gb.dtb
├── bengalp-iot.dtb
├── khaje.dtb
├── m9200
│   ├── m9200-scuba-iot.dtb
│   ├── m9200-scuba-iot-idp-overlay.dtbo
│   └── modules.order
├── m9200-scuba-iot.dtb
├── modules.order
├── scuba-2gb.dtb
├── scuba.dtb
├── scuba-iot-2gb.dtb
├── scuba-iot.dtb
├── scubap.dtb
├── scubap-iot.dtb
├── scubap-iot-idp-2gb.dtb
└── scubap-iot-idp.dtb
</pre></div>
</div>
</section>
<section id="main-dt">
<h2>Main DT构建流程<a class="headerlink" href="#main-dt" title="此标题的永久链接"></a></h2>
<p>相关文件以及路径:</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span># 源文件 
kernel/msm-4.19/arch/arm64/boot/dts/vendor/qcom/a6650/a6650-scuba-iot.dts

# 相关Makefile
kernel/msm-4.19/arch/arm64/boot/Makefile
kernel/msm-4.19/scripts/Makefile.lib   
</pre></div>
</div>
<p>下面来看下具体的构建过程,在<code class="docutils literal notranslate"><span class="pre">arm64/boot/Makefile</span></code>中有如下相关代码:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 一般在kernel的配置文件apollo_defconfig中将CONFIG_BUILD_ARM64_APPENDED_DTB_IMAGE_NAMES 定义为了a6650-scuba-iot</span>
<span class="c1"># 我们没定义，使用dtb-y的，我们在Makefile文件里有添加</span>
<span class="c1">#a6650/Makefile</span>
<span class="c1">#6:always                := $(dtb-y)</span>
<span class="c1"># 也就是这里DTB_NAMES := a6650-scuba-iot</span>

DTB_NAMES :<span class="o">=</span> <span class="k">$(</span>subst $<span class="se">\&quot;</span>,,<span class="k">$(</span>CONFIG_BUILD_ARM64_APPENDED_DTB_IMAGE_NAMES<span class="k">))</span>
ifneq <span class="o">(</span><span class="k">$(</span>DTB_NAMES<span class="k">)</span>,<span class="o">)</span>
DTB_LIST :<span class="o">=</span> <span class="k">$(</span>addsuffix .dtb,<span class="k">$(</span>DTB_NAMES<span class="k">))</span>
<span class="k">else</span>
DTB_LIST :<span class="o">=</span> <span class="k">$(</span>dtb-y<span class="k">)</span>
endif
DTB_OBJS :<span class="o">=</span> <span class="k">$(</span>shell find <span class="k">$(</span>obj<span class="k">)</span>/dts/ -name <span class="se">\*</span>.dtb<span class="k">)</span>

<span class="c1"># Kernel源码目录: Documentation/kbuild/makefiles.txt -&gt; --- 6.7 Commands useful for building a boot image if_changed</span>
<span class="k">$(</span>obj<span class="k">)</span>/Image.gz-dtb: <span class="k">$(</span>obj<span class="k">)</span>/Image.gz <span class="k">$(</span>DTB_OBJS<span class="k">)</span> FORCE
	<span class="k">$(</span>call if_changed,cat<span class="k">)</span>
</pre></div>
</div>
<p>如上图所截取的部分Makfile, 在构建Image.gz-dtb时, 首先会构建Image 和 $(DTB_OBJS)-a6650-scuba-iot.dtb。在构建构建生成Image和a6650-scuba-iot.dtb会调自定义的cat指令将a6650-scuba-iot.dtb追加到zImage尾部.</p>
<p>以上描述了Main DT的构建以及如何追加到zImage.</p>
</section>
<section id="overlay-dt">
<h2>Overlay DT构建<a class="headerlink" href="#overlay-dt" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>相关文件以及路径:</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 源文件 </span>
kernel/msm-4.19/arch/arm64/boot/dts/vendor/qcom/a6650/a6650-scuba-iot-idp-overlay.dts

<span class="c1"># Makefile</span>
kernel/msm-4.19/arch/arm64/boot/qcom/dts/Makefile
scripts/drvgen/drvgen.mk
kernel/msm-4.19/arch/arm64/boot/Makefile
</pre></div>
</div>
<p>下面来看下具体的构建过程,在<code class="docutils literal notranslate"><span class="pre">arch/arm64/Makefile</span></code>有如下代码:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">boot</span> <span class="o">:=</span> arch/arm64/boot

<span class="c"># 当make 目标zImage-dtb时，会先构建以赖的dtbs，然后是$(DTB_OVERLAY_IMAGE_TAGERT)</span>
<span class="nf">zImage-dtb</span><span class="o">:</span> <span class="n">vmlinux</span> <span class="n">scripts</span> <span class="n">dtbs</span> <span class="k">$(</span><span class="nv">DTB_OVERLAY_IMAGE_TAGERT</span><span class="k">)</span>
  <span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span><span class="k">$(</span>boot<span class="k">)</span> <span class="nv">MACHINE</span><span class="o">=</span><span class="k">$(</span>MACHINE<span class="k">)</span> <span class="k">$(</span>boot<span class="k">)</span>/<span class="nv">$@</span>
  
<span class="c"># 构建dtbs</span>
<span class="nf">dtbs</span><span class="o">:</span> <span class="n">prepare</span> <span class="n">scripts</span>
<span class="c">  # 通过debug以及上下文分析得知如下编译指令是:</span>
<span class="c">  # make arch/arm/boot/dts</span>
<span class="c">  # 也就是会执行arch/arm/boot/dts/下的Makefile</span>
  <span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span><span class="k">$(</span>boot<span class="k">)</span>/dts
</pre></div>
</div>
<p>继续执行<code class="docutils literal notranslate"><span class="pre">kernel/msm-4.19/arch/arm64/boot/dts/</span></code>下的Makefile:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="cp">ifeq ($(strip $(CONFIG_BUILD_ARM_DTB_OVERLAY_IMAGE)), y)</span>
<span class="nv">DTB_LIST</span> <span class="o">+=</span> <span class="k">$(</span>addsuffix .dtb, <span class="k">$(</span>subst $<span class="se">\&quot;</span>,,<span class="k">$(</span>CONFIG_BUILD_ARM_DTB_OVERLAY_IMAGE_NAMES<span class="k">)))</span>
<span class="cp">endif</span>

<span class="nv">targets</span> <span class="o">+=</span> <span class="k">$(</span>DTB_LIST<span class="k">)</span>

<span class="c"># kernel/msm-4.19/arch/arm/boot/dts/Makefile</span>
<span class="c"># CONFIG_BUILD_ARM_DTB_OVERLAY_IMAGE是在arch/arm/configs/xxxdefconfig中定义的，在我这个案例中为CONFIG_BUILD_ARM_DTB_OVERLAY_IMAGE_NAMES没定义，定义了dtb-y</span>
<span class="nv">DTB_NAMES</span> <span class="o">:=</span> <span class="k">$(</span>subst $<span class="se">\&quot;</span>,,<span class="k">$(</span>CONFIG_BUILD_ARM_APPENDED_DTB_IMAGE_NAMES<span class="k">))</span>
<span class="cp">ifneq ($(DTB_NAMES),)</span>
<span class="nv">DTB_LIST</span> <span class="o">:=</span> <span class="k">$(</span>addsuffix .dtb,<span class="k">$(</span>DTB_NAMES<span class="k">))</span>
<span class="cp">else</span>
<span class="nv">DTB_LIST</span> <span class="o">:=</span> <span class="k">$(</span>dtb-y<span class="k">)</span>
<span class="cp">endif</span>

<span class="nv">targets</span> <span class="o">+=</span> dtbs dtbs_install
<span class="c"># 将构建Overlay dts的目标添加到targets中进行a6650-scuba-iot-idp-overlay.dts的构建, 输出目标为a6650-scuba-iot-idp-overlay.dtb</span>
<span class="nv">targets</span> <span class="o">+=</span> <span class="k">$(</span>DTB_LIST<span class="k">)</span>
</pre></div>
</div>
<p>看到这里你可能会有疑问? 为什么赋值给targets 关于这一点kernel官方文档有做了初步的说明,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>     <span class="c1"># 对于dtc构建dts的规则做了基本的说明</span>
     dtc
        Create flattened device tree blob object suitable <span class="k">for</span> linking
        into vmlinux. Device tree blobs linked into vmlinux are placed
        <span class="k">in</span> an init section <span class="k">in</span> the image. Platform code *must* copy the
        blob to non-init memory prior to calling unflatten_device_tree<span class="o">()</span>.

        To use this command, simply add *.dtb into obj-y or targets, or make
        some other target depend on %.dtb

        A central rule exists to create <span class="k">$(</span>obj<span class="k">)</span>/%.dtb from <span class="k">$(</span>src<span class="k">)</span>/%.dts<span class="p">;</span>
        architecture Makefiles <span class="k">do</span> no need to explicitly write out that rule.

        Example:
                <span class="nv">targets</span> <span class="o">+=</span> <span class="k">$(</span>dtb-y<span class="k">)</span>
                clean-files +<span class="o">=</span> *.dtb
                DTC_FLAGS ?<span class="o">=</span> -p <span class="m">1024</span>

<span class="c1"># 而dtc自定义是在scripts/Makefile.lib中实现</span>
<span class="nv">quiet_cmd_dtc</span> <span class="o">=</span> DTC     <span class="nv">$@</span>

<span class="nv">cmd_dtc</span> <span class="o">=</span> mkdir -p <span class="k">$(</span>dir <span class="si">${</span><span class="nv">dtc</span><span class="p">-tmp</span><span class="si">}</span><span class="k">)</span> <span class="p">;</span> <span class="se">\</span>
        <span class="k">$(</span>CPP<span class="k">)</span> <span class="k">$(</span>dtc_cpp_flags<span class="k">)</span> -x assembler-with-cpp -o <span class="k">$(</span>dtc-tmp<span class="k">)</span> $&lt; <span class="p">;</span> <span class="se">\</span>
        <span class="k">$(</span>srctree<span class="k">)</span>/scripts/dtc/dtc_overlay -@ -O dtb -o <span class="nv">$@</span> -b <span class="m">0</span> <span class="se">\</span>
                -i <span class="k">$(</span>dir $&lt;<span class="k">)</span> <span class="k">$(</span>DTC_FLAGS<span class="k">)</span> <span class="se">\</span>
                -d <span class="k">$(</span>depfile<span class="k">)</span>.dtc.tmp <span class="k">$(</span>dtc-tmp<span class="k">)</span> <span class="p">;</span> <span class="se">\</span>
        cat <span class="k">$(</span>depfile<span class="k">)</span>.pre.tmp <span class="k">$(</span>depfile<span class="k">)</span>.dtc.tmp &gt; <span class="k">$(</span>depfile<span class="k">)</span>

<span class="k">$(</span>obj<span class="k">)</span>/%.dtb: <span class="k">$(</span>src<span class="k">)</span>/%.dts FORCE
        <span class="k">$(</span>call if_changed_dep,dtc<span class="k">)</span>

dtc-tmp <span class="o">=</span> <span class="k">$(</span>subst <span class="k">$(</span>comma<span class="k">)</span>,_,<span class="k">$(</span>dot-target<span class="k">)</span>.dts.tmp<span class="k">)</span>
</pre></div>
</div>
<p>以上的构建只是将a6650-scuba-iot-idp-overlay.dts编译生成了a6650-scuba-iot-idp-overlay.dtb还是并不是最终烧录到dtb分区的Overlay DT.下面来继续看下中的dtb image是如何生成的.</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="c"># arch/arm/Makefile</span>
<span class="c"># 前面的内容已经讲述了dtbs的构建生成了a6650-scuba-iot-idp-overlay.dtb，下面继续看下$(DTB_OVERLAY_IMAGE_TAGERT)的构建</span>

<span class="nf">zImage-dtb</span><span class="o">:</span> <span class="n">vmlinux</span> <span class="n">scripts</span> <span class="n">dtbs</span>
        <span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> <span class="k">$(</span>build<span class="k">)</span><span class="o">=</span><span class="k">$(</span>boot<span class="k">)</span> <span class="nv">MACHINE</span><span class="o">=</span><span class="k">$(</span>MACHINE<span class="k">)</span> <span class="nv">DTSSUBDIR</span><span class="o">=</span><span class="k">$(</span>DTSSUBDIR<span class="k">)</span> <span class="k">$(</span>boot<span class="k">)</span>/<span class="nv">$@</span>
</pre></div>
</div>
</section>
</section>
<section id="bootloaderdtbdtbo">
<h1>bootloader中如何加载dtb和dtbo<a class="headerlink" href="#bootloaderdtbdtbo" title="此标题的永久链接"></a></h1>
<p>针对MT6762平台, bootloader 是由preloader和lk两部分构成，在这里就不做过多的描述。
我们直接来看下在lk中是如何加载相关DTB内容的.
在lk中是如何加载Main DT的,</p>
<p>参考：</p>
<ul class="simple">
<li><p><span class="xref myst">0003_多机型DTB兼容方案.md</span></p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="w"> </span><span class="n">vendor</span><span class="o">/</span><span class="n">mediatek</span><span class="o">/</span><span class="n">proprietary</span><span class="o">/</span><span class="n">bootable</span><span class="o">/</span><span class="n">bootloader</span><span class="o">/</span><span class="n">lk</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mt_boot</span><span class="o">/</span><span class="n">mt_boot</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="c1">// 在跳转到kernel前需要先加载相关的dtb到内存中</span>
<span class="kt">int</span><span class="w"> </span><span class="n">boot_linux_fdt</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">tags</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">machtype</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ramdisk</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">ramdisk_sz</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">fdt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tags</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">tmpbuf</span><span class="p">[</span><span class="n">TMPBUF_SIZE</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">//当前使用的kernel是32bit</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">g_is_64bit_kernel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">dprintf</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;32 bits kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">zimage_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">kernel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x2c</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">                  </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">kernel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">//在“Main DT和Overlay DT的构建”这一章节中已经做了说明，在这一平台Main DT是直接跟在zImage后面.</span>
<span class="w">        </span><span class="c1">// 获取到dtb_addr(这里的前提是lk已经把zImage-dtb分区的内容全部加载到内存了)      </span>
<span class="w">        </span><span class="n">dtb_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">kernel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zimage_size</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">wake_up_iothread</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">wait_for_iothread</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">//在获取到dtb_addr后，需要校验下dtb的FD_Magic，FD_Magic=0xd00dfeed</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fdt32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dtb_addr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FDT_MAGIC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if CFG_DTB_EARLY_LOADER_SUPPORT</span>
<span class="w">                </span><span class="n">dtb_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">fdt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x4</span><span class="p">));</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">                </span><span class="n">dtb_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdt32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">dtb_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x4</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">dprintf</span><span class="p">(</span><span class="n">CRITICAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Can&#39;t find device tree. Please check your kernel image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">//将加载到内存的Main DT memcpy 到fdt(内存指针)</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">fdt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dtb_addr</span><span class="p">,</span><span class="w"> </span><span class="n">dtb_size</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 将Overlay DT(odmdtbo.img)从dtbo分区加载到内存中并与Main DT合并，合并后的dtb存储在指针:g_fdt</span>
<span class="w">    </span><span class="cm">/*The memory pointed to by &quot;g_fdt&quot; is the location that the Linux kernel expects to find the device tree, and it is at least a few mega-bytes free. The merged device tree is therefore copied to that space.</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="c1">// dtb_overlay函数的具体实现这里就不在展开了，相关代码比较好理解.</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">rtn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtb_overlay</span><span class="p">(</span><span class="n">fdt</span><span class="p">,</span><span class="w"> </span><span class="n">dtb_size</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">platform_atag_append</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//将fdt追加到atag中，最终通过r2寄存器传递给kernel</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_atag_append</span><span class="p">(</span><span class="n">fdt</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w">       </span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="kerneldt">
<h1>kernel中是如何使用获取到合并后的DT<a class="headerlink" href="#kerneldt" title="此标题的永久链接"></a></h1>
<p>在<code class="docutils literal notranslate"><span class="pre">kernel-xx/arch/arm64/kernel/setup.c</span></code>中:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// arch/arm/kernel/setup.c</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">setup_arch</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">machine_desc</span><span class="w"> </span><span class="o">*</span><span class="n">mdesc</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">setup_processor</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* arch/arm/kernel/head-common.S中赋值的.</span>
<span class="cm">    .long   __atags_pointer                 @ r6</span>
<span class="cm">    str     r2, [r6]                        @ Save atags pointer</span>
<span class="cm">    而r2是lk(bootloader)用于与内存通信的媒介，传递了atags的内存地址.</span>
<span class="cm">    r2包含了dtb pointer.</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="n">mdesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_machine_fdt</span><span class="p">(</span><span class="n">__atags_pointer</span><span class="p">);</span><span class="w">   </span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>