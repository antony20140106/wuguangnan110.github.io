<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">README</a></li>
<li><a class="reference internal" href="#refers">refers</a></li>
<li><a class="reference internal" href="#id1">前言</a><ul>
<li><a class="reference internal" href="#input-dev">1、注册 input_dev</a></li>
<li><a class="reference internal" href="#api">2、上报输入事件,事件上报 API 函数</a></li>
<li><a class="reference internal" href="#input-event">3、input_event 结构体</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2">驱动实战</a><ul>
<li><a class="reference internal" href="#input">1、按键 input 驱动程序</a></li>
<li><a class="reference internal" href="#app">2、应用程序APP</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>README</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="readme">
<h1>README<a class="headerlink" href="#readme" title="Permalink to this headline"></a></h1>
<p>linux input子系统介绍。</p>
</section>
<section id="refers">
<h1>refers<a class="headerlink" href="#refers" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/WANGYONGZIXUE/article/details/116462351">linux input子系统</a></p></li>
</ul>
</section>
<section id="id1">
<h1>前言<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p>按键、鼠标、键盘、触摸屏等都属于输入(input)设备，Linux 内核为此专门做了一个叫做 input子系统的框架来处理输入事件。输入设备本质上还是字符设备，只是在此基础上套上了 input 框架。</p>
<p>input 框架
和 pinctrl 和 gpio 子系统一样，input 子系统管理输入的子系统。</p>
<p>中间部分属于Linux 内核空间，分为驱动层、核心层和事件层</p>
<p>驱动层：输入设备的具体驱动程序，比如按键驱动程序，向内核层报告输入内容。
核心层：承上启下，为驱动层提供输入设备注册和操作接口。通知事件层对输入事件进行处理。
事件层：主要和用户空间进行交互。</p>
<p>input 核心层会向 Linux 内核注册一个字符设备,drivers/input/input.c 这个文件，就是 input 输入子系统的核心层</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">class</span><span class="w"> </span><span class="n">input_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">devnode</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">input_devnode</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">input_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register input_dev class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_proc_init</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">fail1</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">INPUT_MAJOR</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                                     </span><span class="n">INPUT_MAX_CHAR_DEVICES</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register char major %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_MAJOR</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">fail2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="nl">fail2</span><span class="p">:</span><span class="w"> </span><span class="n">input_proc_exit</span><span class="p">();</span><span class="w"></span>
<span class="w"> </span><span class="nl">fail1</span><span class="p">:</span><span class="w"> </span><span class="n">class_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_class</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="nf">input_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">input_proc_exit</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">INPUT_MAJOR</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">INPUT_MAX_CHAR_DEVICES</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">class_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_class</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>注册一个字符设备，主设备号为 INPUT_MAJOR，INPUT_MAJOR 定义在 include/uapi/linux/major.h 文件中，定义如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define INPUT_MAJOR 13</span>
</pre></div>
</div>
<p>因此，input 子系统的所有设备主设备号都为 13，我们在使用 input 子系统处理输入设备
的时候就不需要去注册字符设备了，我们只需要向系统注册一个 input_device 即可。</p>
<section id="input-dev">
<h2>1、注册 input_dev<a class="headerlink" href="#input-dev" title="Permalink to this headline"></a></h2>
<p>在使用 input 子系统的时候我们只需要注册一个 input 设备即可，input_dev 结构体表示 input设备，此结构体定义在 include/linux/input.h 文件中:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">phys</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">uniq</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">input_id</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">propbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">INPUT_PROP_CNT</span><span class="p">)];</span><span class="w"></span>

<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">evbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">EV_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">keybit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">KEY_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">relbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">REL_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">absbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">ABS_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mscbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">MSC_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ledbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">LED_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sndbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">SND_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ffbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">FF_CNT</span><span class="p">)];</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">swbit</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">SW_CNT</span><span class="p">)];</span><span class="w"></span>
</pre></div>
</div>
<p>evbit、keybit、 relbit表示输入事件类型，可选的事件类型定义在 include/uapi/linux/input.h 文件中，事件类型如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Event types 事件类型</span>
<span class="cm"> */</span><span class="w"></span>
<span class="cp">#define EV_SYN                  0x00</span>
<span class="cp">#define EV_KEY                  0x01</span>
<span class="cp">#define EV_REL                  0x02</span>
<span class="cp">#define EV_ABS                  0x03</span>
<span class="cp">#define EV_MSC                  0x04</span>
<span class="cp">#define EV_SW                   0x05</span>
<span class="cp">#define EV_LED                  0x11</span>
<span class="cp">#define EV_SND                  0x12</span>
<span class="cp">#define EV_REP                  0x14</span>
<span class="cp">#define EV_FF                   0x15</span>
<span class="cp">#define EV_PWR                  0x16</span>
<span class="cp">#define EV_FF_STATUS            0x17</span>
<span class="cp">#define EV_MAX                  0x1f</span>
<span class="cp">#define EV_CNT                  (EV_MAX+1)</span>
</pre></div>
</div>
<p>按键事件，因此要用到 keybit，keybit 就是按键事件使用的位图，Linux 内核定义了很多按键值，这些按键值定义在 include/uapi/linux/input.h 文件中，按键值如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define KEY_RESERVED            0</span>
<span class="cp">#define KEY_ESC                 1</span>
<span class="cp">#define KEY_1                   2</span>
<span class="cp">#define KEY_2                   3</span>
<span class="cp">#define KEY_3                   4</span>
<span class="cp">#define KEY_4                   5</span>
<span class="cp">#define KEY_5                   6</span>
<span class="cp">#define KEY_6                   7</span>
<span class="cp">#define KEY_7                   8</span>
<span class="cp">#define KEY_8                   9</span>
<span class="cp">#define KEY_9                   10</span>
<span class="cp">#define KEY_0                   11</span>
<span class="cp">#define KEY_MINUS               12</span>
<span class="cp">#define KEY_EQUAL               13</span>
<span class="cp">#define KEY_BACKSPACE           14</span>
<span class="cp">#define KEY_TAB                 15</span>
<span class="cp">#define KEY_Q                   16</span>
<span class="cp">#define KEY_W                   17</span>
<span class="cp">#define KEY_E                   18</span>
<span class="cp">#define KEY_R                   19</span>
<span class="cp">#define KEY_T                   20</span>
<span class="cp">#define KEY_Y                   21</span>
<span class="cp">#define KEY_U                   22</span>
<span class="cp">#define KEY_I                   23</span>
<span class="cp">#define KEY_O                   24</span>
<span class="cp">#define KEY_P                   25</span>
<span class="cp">#define KEY_LEFTBRACE           26</span>
</pre></div>
</div>
<p>编写 input 设备驱动的时候我们需要先申请一个 input_dev 结构体变量,使用input_allocate_device 函数来申请一个 input_dev</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="o">*</span><span class="n">input_allocate_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>申请好一个 input_dev 以后就需要初始化这个 input_dev</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">input_register_device</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>注销 input 驱动</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">input_unregister_device</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>注销 input 设备</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">input_free_device</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>综上所述，input_dev 注册过程如下:</p>
<ol class="arabic simple">
<li><p>使用 input_allocate_device 函数申请一个 input_dev。</p></li>
<li><p>初始化 input_dev 的事件类型以及事件值。</p></li>
<li><p>使用 input_register_device 函数向 Linux 系统注册前面初始化好的 input_dev。</p></li>
<li><p>卸载input驱动的时候需要先使用input_unregister_device函数注销掉注册的input_dev，然后使用 input_free_device 函数释放掉前面申请的 input_dev。</p></li>
</ol>
</section>
<section id="api">
<h2>2、上报输入事件,事件上报 API 函数<a class="headerlink" href="#api" title="Permalink to this headline"></a></h2>
<p>input_event 函数，此函数用于上报指定的事件以及对应的值，函数原型如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">input_event</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span>
<span class="w">						 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span>
<span class="w">						 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span>
<span class="w">						 </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>参数和返回值含义如下：</p>
<ul class="simple">
<li><p>dev：需要上报的 input_dev。</p></li>
<li><p>type: 上报的事件类型，比如 EV_KEY。</p></li>
<li><p>code：事件码，也就是我们注册的按键值，比如 KEY_0、KEY_1 等等。</p></li>
<li><p>value：事件值，比如 1 表示按键按下，0 表示按键松开。</p></li>
</ul>
<p>上报按键所使用的input_report_key 函数,就是使用的input_event</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">input_report_key</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	 </span><span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">EV_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="o">!!</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>内核中还有很多上报函数:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>void input_report_rel(struct input_dev *dev, unsigned int code, int value)
void input_report_abs(struct input_dev *dev, unsigned int code, int value）
void input_report_ff_status(struct input_dev *dev, unsigned int code, int value)
void input_report_switch(struct input_dev *dev, unsigned int code, int value)
void input_mt_sync(struct input_dev *dev)
</pre></div>
</div>
<p>上报事件以后还需要使用 input_sync 函数来告诉 Linux 内核 input 子系统上报结束，input_sync 函数本质是上报一个同步事件.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">input_sync</span><span class="p">(</span><span class="n">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</pre></div>
</div>
<p>上报事件的示例如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">timer_function</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">irq_keydesc</span><span class="w"> </span><span class="o">*</span><span class="n">keydesc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">curkeynum</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">keydesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">num</span><span class="p">];</span><span class="w"></span>
<span class="w">	</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">keydesc</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span><span class="w"> 	</span><span class="cm">/* 读取IO值 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"> 						</span><span class="cm">/* 按下按键 */</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* 上报按键值 */</span><span class="w"></span>
<span class="w">		</span><span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span><span class="w"> </span><span class="n">keydesc</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="cm">/* 最后一个参数表示按下还是松开，1为按下，0为松开 */</span><span class="w"></span>
<span class="w">		</span><span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> 									</span><span class="cm">/* 按键松开 */</span><span class="w"></span>
<span class="w">		</span><span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span><span class="w"> </span><span class="n">keydesc</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w">	</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="input-event">
<h2>3、input_event 结构体<a class="headerlink" href="#input-event" title="Permalink to this headline"></a></h2>
<p>Linux 内核使用 input_event 这个结构体来表示所有的输入事件，input_envent 结构体定义在
include/uapi/linux/input.h 文件中</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">input_event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="n">time</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">__u16</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">__u16</span><span class="w"> </span><span class="n">code</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">__s32</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>type：事件类型，比如 EV_KEY，表示此次事件为按键事件，此成员变量为 16 位。
code：事件码，比如在 EV_KEY 事件中 code 就表示具体的按键码，如：KEY_0、KEY_1
等等这些按键。此成员变量为 16 位。
value：值，比如 EV_KEY 事件中 value 就是按键值，表示按键有没有被按下，如果为 1 的
话说明按键按下，如果为 0 的话说明按键没有被按下或者按键松开了。</p>
</section>
</section>
<section id="id2">
<h1>驱动实战<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h1>
<section id="input">
<h2>1、按键 input 驱动程序<a class="headerlink" href="#input" title="Permalink to this headline"></a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/delay.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/ide.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/init.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/gpio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/cdev.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/device.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/of.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/of_address.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/of_gpio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/input.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/semaphore.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/timer.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/of_irq.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/irq.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/mach/map.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/uaccess.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/io.h&gt;</span><span class="cp"></span>

<span class="cp">#define KEYINPUT_CNT		1			</span><span class="cm">/* 设备号个数 	*/</span><span class="cp"></span>
<span class="cp">#define KEYINPUT_NAME		&quot;keyinput&quot;	</span><span class="cm">/* 名字 		*/</span><span class="cp"></span>
<span class="cp">#define KEY0VALUE			0X01		</span><span class="cm">/* KEY0按键值 	*/</span><span class="cp"></span>
<span class="cp">#define INVAKEY				0XFF		</span><span class="cm">/* 无效的按键值 */</span><span class="cp"></span>
<span class="cp">#define KEY_NUM				1			</span><span class="cm">/* 按键数量 	*/</span><span class="cp"></span>

<span class="cm">/* 中断IO描述结构体 */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">irq_keydesc</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">								</span><span class="cm">/* gpio */</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">irqnum</span><span class="p">;</span><span class="w">								</span><span class="cm">/* 中断号     */</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">					</span><span class="cm">/* 按键对应的键值 */</span><span class="w"></span>
<span class="w">	</span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span><span class="w">							</span><span class="cm">/* 名字 */</span><span class="w"></span>
<span class="w">	</span><span class="n">irqreturn_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w">	</span><span class="cm">/* 中断服务函数 */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/* keyinput设备结构体 */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">devid</span><span class="p">;</span><span class="w">			</span><span class="cm">/* 设备号 	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="n">cdev</span><span class="p">;</span><span class="w">		</span><span class="cm">/* cdev 	*/</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">class</span><span class="w"> </span><span class="o">*</span><span class="k">class</span><span class="p">;</span><span class="w">	</span><span class="cm">/* 类 		*/</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">device</span><span class="p">;</span><span class="w">	</span><span class="cm">/* 设备 	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device_node</span><span class="w">	</span><span class="o">*</span><span class="n">nd</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 设备节点 */</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">timer_list</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="cm">/* 定义一个定时器*/</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">irq_keydesc</span><span class="w"> </span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">KEY_NUM</span><span class="p">];</span><span class="w">	</span><span class="cm">/* 按键描述数组 */</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">curkeynum</span><span class="p">;</span><span class="w">				</span><span class="cm">/* 当前的按键号 */</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">input_dev</span><span class="w"> </span><span class="o">*</span><span class="n">inputdev</span><span class="p">;</span><span class="w">		</span><span class="cm">/* input结构体 */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="w"> </span><span class="n">keyinputdev</span><span class="p">;</span><span class="w">	</span><span class="cm">/* key input设备 */</span><span class="w"></span>

<span class="c1">//中断服务函数</span>
<span class="k">static</span><span class="w"> </span><span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">key0_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dev_id</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">curkeynum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">jiffies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span><span class="w">	</span><span class="cm">/* 10ms定时 用于去抖 */</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">IRQ_HANDLED</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//定时器服务函数，用于按键消抖，定时器到了以后再次读取按键值，如果按键还是处于按下状态就表示按键有效。</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">timer_function</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">irq_keydesc</span><span class="w"> </span><span class="o">*</span><span class="n">keydesc</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">keyinput_dev</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">curkeynum</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">keydesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">num</span><span class="p">];</span><span class="w"></span>
<span class="w">	</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">keydesc</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span><span class="w"> 	</span><span class="cm">/* 读取IO值 */</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"> 						</span><span class="cm">/* 按下按键 */</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* 上报按键值 */</span><span class="w"></span>
<span class="w">		</span><span class="c1">//input_event(dev-&gt;inputdev, EV_KEY, keydesc-&gt;value, 1);</span>
<span class="w">		</span><span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span><span class="w"> </span><span class="n">keydesc</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="cm">/* 最后一个参数表示按下还是松开，1为按下，0为松开 */</span><span class="w"></span>
<span class="w">		</span><span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> 									</span><span class="cm">/* 按键松开 */</span><span class="w"></span>
<span class="w">		</span><span class="c1">//input_event(dev-&gt;inputdev, EV_KEY, keydesc-&gt;value, 0);</span>
<span class="w">		</span><span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span><span class="w"> </span><span class="n">keydesc</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w">	</span>
<span class="p">}</span><span class="w"></span>


<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">keyio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/key&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">nd</span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">){</span><span class="w"></span>
<span class="w">		</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;key node not find!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span>

<span class="w">	</span><span class="cm">/* 提取GPIO */</span><span class="w"></span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEY_NUM</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_get_named_gpio</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">nd</span><span class="w"> </span><span class="p">,</span><span class="s">&quot;key-gpio&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;can&#39;t get key%d</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="cm">/* 初始化key所使用的IO，并且设置成中断模式 */</span><span class="w"></span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEY_NUM</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">memset</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">));</span><span class="w">	</span><span class="cm">/* 缓冲区清零 */</span><span class="w"></span>
<span class="w">		</span><span class="n">sprintf</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;KEY%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">		</span><span class="cm">/* 组合名字 */</span><span class="w"></span>
<span class="w">		</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span><span class="w">	</span>
<span class="w">		</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* 申请中断 */</span><span class="w"></span>
<span class="w">	</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key0_handler</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KEY_0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEY_NUM</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request_irq</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqnum</span><span class="p">,</span><span class="w"> </span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">,</span><span class="w"> </span>
<span class="w">		                 </span><span class="n">IRQF_TRIGGER_FALLING</span><span class="o">|</span><span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span><span class="w"> </span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">keyinputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"></span>
<span class="w">			</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;irq %d request failed!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqnum</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* 创建定时器 */</span><span class="w"></span>
<span class="w">	</span><span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer_function</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* 申请input_dev */</span><span class="w"></span>
<span class="w">	</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">inputdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_allocate_device</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KEYINPUT_NAME</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* 初始化input_dev，设置产生哪些事件 */</span>
<span class="c">	__set_bit(EV_KEY, keyinputdev.inputdev-&gt;evbit);	/* 设置产生按键事件          */</span>
<span class="c">	__set_bit(EV_REP, keyinputdev.inputdev-&gt;evbit);	/* 重复事件，比如按下去不放开，就会一直输出信息 		 */</span>

<span class="c">	/* 初始化input_dev，设置产生哪些按键 */</span>
<span class="c">	__set_bit(KEY_0, keyinputdev.inputdev-&gt;keybit);	</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	keyinputdev.inputdev-&gt;evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);</span>
<span class="c">	keyinputdev.inputdev-&gt;keybit[BIT_WORD(KEY_0)] |= BIT_MASK(KEY_0);</span>
<span class="cp">#endif</span>

<span class="w">	</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">input_set_capability</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">inputdev</span><span class="p">,</span><span class="w"> </span><span class="n">EV_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">KEY_0</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* 注册输入设备 */</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_register_device</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">inputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;register input device failed!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">keyinput_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">keyio_init</span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="nf">keyinput_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* 删除定时器 */</span><span class="w"></span>
<span class="w">	</span><span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span><span class="w">	</span><span class="cm">/* 删除定时器 */</span><span class="w"></span>
<span class="w">		</span>
<span class="w">	</span><span class="cm">/* 释放中断 */</span><span class="w"></span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEY_NUM</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">free_irq</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">irqkeydesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irqnum</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">keyinputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* 释放input_dev */</span><span class="w"></span>
<span class="w">	</span><span class="n">input_unregister_device</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">inputdev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">input_free_device</span><span class="p">(</span><span class="n">keyinputdev</span><span class="p">.</span><span class="n">inputdev</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">module_init</span><span class="p">(</span><span class="n">keyinput_init</span><span class="p">);</span><span class="w"></span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">keyinput_exit</span><span class="p">);</span><span class="w"></span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>使用 KEY_0为按键值</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p>使用中断，</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p>使用定时器，延时10ms去抖</p></li>
</ol>
</li>
</ul>
</section>
<section id="app">
<h2>2、应用程序APP<a class="headerlink" href="#app" title="Permalink to this headline"></a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>**#include &quot;stdio.h&quot;
#include &quot;unistd.h&quot;
#include &quot;sys/types.h&quot;
#include &quot;sys/stat.h&quot;
#include &quot;sys/ioctl.h&quot;
#include &quot;fcntl.h&quot;
#include &quot;stdlib.h&quot;
#include &quot;string.h&quot;
#include &lt;poll.h&gt;
#include &lt;sys/select.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;signal.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;linux/input.h&gt;
/* 定义一个input_event变量，存放输入事件信息 */
static struct input_event inputevent;

int main(int argc, char *argv[])
{
	int fd;
	int err = 0;
	char *filename;

	filename = argv[1];

	if(argc != 2) {
		printf(&quot;Error Usage!\r\n&quot;);
		return -1;
	}

	fd = open(filename, O_RDWR);
	if (fd &lt; 0) {
		printf(&quot;Can&#39;t open file %s\r\n&quot;, filename);
		return -1;
	}

	while (1) {
		err = read(fd, &amp;inputevent, sizeof(inputevent));
		if (err &gt; 0) { /* 读取数据成功 */
			switch (inputevent.type) {
				case EV_KEY:
					if (inputevent.code &lt; BTN_MISC) { /* 键盘键值 */
						printf(&quot;key %d %s\r\n&quot;, inputevent.code, inputevent.value ? &quot;press&quot; : &quot;release&quot;);
					} else {
						printf(&quot;button %d %s\r\n&quot;, inputevent.code, inputevent.value ? &quot;press&quot; : &quot;release&quot;);
					}
					break;

				/* 其他类型的事件，自行处理 */
				case EV_REL:
					break;
				case EV_ABS:
					break;
				case EV_MSC:
					break;
				case EV_SW:
					break;
			}
		} else {
			printf(&quot;读取数据失败\r\n&quot;);
		}
	}
	return 0;
}
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, wugn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JjOE14XScyd75b2C",ck: "JjOE14XScyd75b2C"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JjOE14XScyd75b2C/quote.js?theme=0&f=12&display=1,0,0,0,0,0,1,1"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>