<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">linux i2c偶发读取错误数据问题分析</a></li>
<li><a class="reference internal" href="#id1">参考</a></li>
<li><a class="reference internal" href="#id2">现象</a></li>
<li><a class="reference internal" href="#i2c">i2c读取接口</a></li>
<li><a class="reference internal" href="#id3">解决方案</a></li>
<li><a class="reference internal" href="#id4">接口不同点分析</a></li>
<li><a class="reference internal" href="#i2c-smbus">i2c/smbus数据传输调用流程图</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>linux i2c偶发读取错误数据问题分析</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="linux-i2c">
<h1>linux i2c偶发读取错误数据问题分析<a class="headerlink" href="#linux-i2c" title="此标题的永久链接"></a></h1>
<p>发现charger i2c老是读取的数据由问题，分析一下</p>
</section>
<section id="id1">
<h1>参考<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/c_L_j_/article/details/80845083">关于I2C的那点事：i2c_master_send 和 i2c_master_recv i2c_transfer</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/proware/article/details/124938779">linux i2c smbus驱动</a></p></li>
</ul>
</section>
<section id="id2">
<h1>现象<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>行 102041: 04-03 02:32:00.831 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102090: 04-03 02:32:05.830 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102139: 04-03 02:32:10.835 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102185: 04-03 02:32:15.833 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102233: 04-03 02:32:20.834 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102279: 04-03 02:32:25.842 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0xd0 //错误数据
行 102327: 04-03 02:32:30.836 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102375: 04-03 02:32:35.845 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102420: 04-03 02:32:40.837 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102468: 04-03 02:32:45.839 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102516: 04-03 02:32:50.842 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
行 102562: 04-03 02:32:55.843 E/PAX_CHG (    0): sgm41528_info Reg[0x01] = 0x0a
</pre></div>
</div>
</section>
<section id="i2c">
<h1>i2c读取接口<a class="headerlink" href="#i2c" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">drivers/misc/pax/power/sgm41528_charger.c</span></code>:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">sgm41528_read_byte</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">reg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_client</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_sgm41528_info</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">s32</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i2c_master_send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//第一次寻址，将reg写入</span>
<span class="w">		</span><span class="n">sgm41528_set_i2c_fault_status</span><span class="p">();</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s, send reg[%x] fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">sgm41528_reset_i2c_fault_cnt</span><span class="p">();</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//第二次寻址，接收reg值</span>
<span class="w">		</span><span class="n">sgm41528_set_i2c_fault_status</span><span class="p">();</span><span class="w"></span>
<span class="w">		</span><span class="n">chr_err</span><span class="p">(</span><span class="s">&quot;%s, recv reg[%x] fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">sgm41528_reset_i2c_fault_cnt</span><span class="p">();</span><span class="w"></span>

<span class="w">	</span><span class="c1">//chr_debug(&quot; recv reg[%x]: %02x\n&quot;, reg, buf[0]);</span>
<span class="w">	</span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>可以看到是通过i2c_master_send 和 i2c_master_recv接口进行读取，该过程进行了2次寻址操作，如下：</p>
<p><img alt="0032_0000.png" src="../../../_images/0032_0000.png" /></p>
<p>通过分解后的时序图，可以看到i2c的读数据由以下13个步骤组成。</p>
<ul class="simple">
<li><p>第一步，发送一个起始信号。</p></li>
<li><p>第二步，发送7bit从机地址，即i2c的地址。此处需要注意，发送数据时，无法发送7bit数据，此处发送了7bit地址+1bit读写选择位，即发送7bit+r/w。最低位为1表示读,为0表示写。</p></li>
<li><p>第三步，产生一个ACK应答信号，此应答信号为从机器件产生的应答。</p></li>
<li><p>第四步，发送寄存器地址。</p></li>
<li><p>第五步，产生一个ACK应答信号，此应答信号为从机器件产生的应答。</p></li>
<li><p>第六步，再次发送一个起始信号。</p></li>
<li><p>第七步，发送7bit从机地址，即i2c的地址。此处需要注意，发送数据时，无法发送7bit数据，此处发送了7bit地址+1bit读写选择位，即发送7bit+r/w。最低位为1表示读,为0表示写。</p></li>
<li><p>第八步，产生一个ACK应答信号，此应答信号为从机器件产生的应答。</p></li>
<li><p>第九步，读取一个字节(8bit)的数据。</p></li>
<li><p>第十步，产生一个ACK应答信号，此应答信号为CPU产生。</p></li>
<li><p>第十一步，读取一个CRC校验码。</p></li>
<li><p>第十二步，产生一个NACK信号。此无应答信号由CPU产生。</p></li>
<li><p>第十三步，产生一个停止信号。</p></li>
</ul>
<p>实际逻辑图如下：</p>
<p><img alt="0032_0001.png" src="../../../_images/0032_0001.png" /></p>
</section>
<section id="id3">
<h1>解决方案<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<p>采用SMBUS i2c接口替换i2c_master_send和i2c_master_recv接口，稳定性更高，具体原因未知</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/UM.9.15/kernel/msm-4.19/drivers/misc/pax/power/sgm41528_charger.c</span><span class="w"></span>
<span class="gi">+++ b/UM.9.15/kernel/msm-4.19/drivers/misc/pax/power/sgm41528_charger.c</span><span class="w"></span>
<span class="gu">@@ -63,11 +63,25 @@ static void sgm41528_reset_i2c_fault_cnt(void)</span><span class="w"></span>

<span class="w"> </span>static int sgm41528_read_byte(u8 *data, u8 reg)<span class="w"></span>
<span class="w"> </span>{<span class="w"></span>
<span class="gd">-       unsigned char buf[2] = {0};</span><span class="w"></span>
<span class="gi">+       //unsigned char buf[2] = {0};</span><span class="w"></span>
<span class="w"> </span>       struct i2c_client *client = g_sgm41528_info-&gt;client;<span class="w"></span>
<span class="gi">+       s32 ret;</span><span class="w"></span>

<span class="gi">+</span><span class="w"></span>
<span class="gi">+       ret = i2c_smbus_read_byte_data(client, reg);</span><span class="w"></span>
<span class="gi">+       if (ret &lt; 0) {</span><span class="w"></span>
<span class="gi">+               sgm41528_set_i2c_fault_status();</span><span class="w"></span>
<span class="gi">+               chr_err(&quot;%s, send reg[%x] fail\n&quot;, __func__, reg);</span><span class="w"></span>
<span class="gi">+        return ret;</span><span class="w"></span>
<span class="gi">+    }</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+       sgm41528_reset_i2c_fault_cnt();</span><span class="w"></span>
<span class="gi">+       *data = (u8) ret;</span><span class="w"></span>
<span class="gi">+       /*</span><span class="w"></span>
<span class="w"> </span>       buf[0] = reg;<span class="w"></span>

<span class="gi">+       *data = (u8) ret;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>       if (1 != i2c_master_send(client, buf, 1)) {<span class="w"></span>
<span class="w"> </span>               sgm41528_set_i2c_fault_status();<span class="w"></span>
<span class="w"> </span>               chr_err(&quot;%s, send reg[%x] fail\n&quot;, __func__, reg);<span class="w"></span>
<span class="gu">@@ -86,15 +100,25 @@ static int sgm41528_read_byte(u8 *data, u8 reg)</span><span class="w"></span>

<span class="w"> </span>       //chr_debug(&quot; recv reg[%x]: %02x\n&quot;, reg, buf[0]);<span class="w"></span>
<span class="w"> </span>       *data = buf[0];<span class="w"></span>
<span class="gi">+       */</span><span class="w"></span>

<span class="w"> </span>       return 0;<span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
</pre></div>
</div>
</section>
<section id="id4">
<h1>接口不同点分析<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<p>首先看一下i2c配置：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bengal_defconfig</span></code>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">359</span><span class="p">:</span><span class="n">CONFIG_I2C_CHARDEV</span><span class="o">=</span><span class="n">y</span>
<span class="mi">360</span><span class="p">:</span><span class="n">CONFIG_I2C_QCOM_GENI</span><span class="o">=</span><span class="n">y</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UM.9.15/kernel/msm-4.19/drivers/i2c/Makefile</span></code>i2c相关的代码：</p></li>
</ul>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">obj-$(CONFIG_I2C)</span>       <span class="o">+=</span> i2c-core.o
<span class="nv">i2c-core-objs</span>           <span class="o">:=</span> i2c-core-base.o i2c-core-smbus.o
<span class="nv">obj-$(CONFIG_I2C_CHARDEV)</span>   <span class="o">+=</span> i2c-dev.o
<span class="nv">obj-y</span>               <span class="o">+=</span> algos/ busses/ muxes/

<span class="c"># busses/Makefile</span>
<span class="nv">obj-$(CONFIG_I2C_QCOM_GENI)</span>  <span class="o">+=</span> i2c-qcom-geni.o
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">busses/i2c-qcom-geni.c</span></code>:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_algorithm</span><span class="w"> </span><span class="n">geni_i2c_algo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">master_xfer</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">geni_i2c_xfer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">functionality</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">geni_i2c_func</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>如果控制器支持smbus协议，则对应的驱动设置收发接口smbus_xfer，可以看到这里没有配置，所以我们分别来看一下<code class="docutils literal notranslate"><span class="pre">i2c_smbus_read_byte_data</span></code>和<code class="docutils literal notranslate"><span class="pre">i2c_master_recv</span></code>调用流程吧，可能是这里的区别导致：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>* i2c_master_recv
  └── i2c_transfer_buffer_flags(client, buf, count, I2C_M_RD);
      └── i2c_transfer(client-&gt;adapter, &amp;msg, 1); //drivers/i2c/i2c-core-base.c
          └── __i2c_transfer(adap, msgs, num);
              └── adap-&gt;algo-&gt;master_xfer(adap, msgs, num);
                  └── geni_i2c_xfer //busses/i2c-qcom-geni.c 调用到adapter算法
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">drivers/i2c/i2c-core-smbus.c</span></code>我们不支持<code class="docutils literal notranslate"><span class="pre">smbus_xfer</span></code>接口，最终调用的是<code class="docutils literal notranslate"><span class="pre">i2c_smbus_xfer_emulated</span></code>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>* i2c_smbus_read_byte_data
  └── i2c_smbus_xfer(client-&gt;adapter, client-&gt;addr, client-&gt;flags,
      └── __i2c_smbus_xfer(adapter, addr, flags, read_write,
          ├── if (adapter-&gt;algo-&gt;smbus_xfer)
          │   ├── res = adapter-&gt;algo-&gt;smbus_xfer(adapter, addr, flags,
          │   └── goto trace;
          └── else i2c_smbus_xfer_emulated(adapter, addr, flags, read_write,
</pre></div>
</div>
<p>再详细看一下i2c_smbus_xfer_emulated函数，看注释是利用i2c接口<code class="docutils literal notranslate"><span class="pre">__i2c_transfer</span></code>来模拟smbus：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Simulate a SMBus command using the I2C protocol.</span>
<span class="cm"> * No checking of parameters is done!</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">s32</span><span class="w"> </span><span class="nf">i2c_smbus_xfer_emulated</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="kt">char</span><span class="w"> </span><span class="n">read_write</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="k">union</span><span class="w"> </span><span class="nc">i2c_smbus_data</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * So we need to generate a series of msgs. In the case of writing, we</span>
<span class="cm">     * need to use only one message; when reading, we need two. We</span>
<span class="cm">     * initialize most things with sane defaults, to keep the code below</span>
<span class="cm">     * somewhat simpler.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">msgbuf0</span><span class="p">[</span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">msgbuf1</span><span class="p">[</span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">partial_pec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_msg</span><span class="w"> </span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgbuf0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">I2C_M_RD</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgbuf1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">msgbuf0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_QUICK</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Special case: The read/write field is used as data */</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="w"> </span><span class="o">?</span><span class="w"></span>
<span class="w">                    </span><span class="nl">I2C_M_RD</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BYTE</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cm">/* Special case: only a read! */</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_M_RD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BYTE_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_WORD_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">msgbuf0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">word</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">msgbuf0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">word</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_PROC_CALL</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Special case */</span><span class="w"></span>
<span class="w">        </span><span class="n">read_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">msgbuf0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">word</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">msgbuf0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">word</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BLOCK_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">I2C_M_RECV_LEN</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* block length will be added by</span>
<span class="cm">                       the underlying bus driver */</span><span class="w"></span>
<span class="w">            </span><span class="n">i2c_smbus_try_get_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Invalid block write size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="n">i2c_smbus_try_get_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">command</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BLOCK_PROC_CALL</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Another special case */</span><span class="w"></span>
<span class="w">        </span><span class="n">read_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;Invalid block write size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">i2c_smbus_try_get_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">command</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">        </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">I2C_M_RECV_LEN</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* block length will be added by</span>
<span class="cm">                   the underlying bus driver */</span><span class="w"></span>
<span class="w">        </span><span class="n">i2c_smbus_try_get_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_I2C_BLOCK_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid block %s size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;read&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;write&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">i2c_smbus_try_get_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">i2c_smbus_try_get_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">command</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsupported transaction %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">I2C_CLIENT_PEC</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">I2C_SMBUS_QUICK</span><span class="w"></span>
<span class="w">                      </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">I2C_SMBUS_I2C_BLOCK_DATA</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Compute PEC if first message is a write */</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">I2C_M_RD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="cm">/* Write only */</span><span class="w"></span>
<span class="w">                </span><span class="n">i2c_smbus_add_pec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="cm">/* Write followed by read */</span><span class="w"></span>
<span class="w">                </span><span class="n">partial_pec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_smbus_msg_pec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Ask for PEC if last message is a read */</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">num</span><span class="mi">-1</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">I2C_M_RD</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">[</span><span class="n">num</span><span class="mi">-1</span><span class="p">].</span><span class="n">len</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__i2c_transfer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EIO</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Check PEC if last message is a read */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">num</span><span class="mi">-1</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">I2C_M_RD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_smbus_check_pec</span><span class="p">(</span><span class="n">partial_pec</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">num</span><span class="mi">-1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_write</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">I2C_SMBUS_READ</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BYTE</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgbuf0</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BYTE_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgbuf1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_WORD_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_PROC_CALL</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgbuf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">msgbuf1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_I2C_BLOCK_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BLOCK_DATA</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">I2C_SMBUS_BLOCK_PROC_CALL</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Invalid block size returned: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">                </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="nl">cleanup</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">I2C_M_DMA_SAFE</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">I2C_M_DMA_SAFE</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>具体如何模拟的不深入分析了，反正这个接口就是比直接调用<code class="docutils literal notranslate"><span class="pre">i2c_master_recv</span></code>稳定。。</p>
</section>
<section id="i2c-smbus">
<h1>i2c/smbus数据传输调用流程图<a class="headerlink" href="#i2c-smbus" title="此标题的永久链接"></a></h1>
<p><img alt="0032_0002.png" src="../../../_images/0032_0002.png" /></p>
</section>


           </div>
         <div class="articleComments">
               <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>