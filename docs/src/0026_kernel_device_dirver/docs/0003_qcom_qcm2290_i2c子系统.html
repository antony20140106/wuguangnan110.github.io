<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>wugn</title>

      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script src="../../../_static/js/baidutongji.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> wugn_note
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">README</a></li>
<li><a class="reference internal" href="#refers">refers</a></li>
<li><a class="reference internal" href="#i2c">I2C协议</a></li>
<li><a class="reference internal" href="#id1">I2C子系统框架</a></li>
<li><a class="reference internal" href="#id2">I2C设备控制器注册</a></li>
<li><a class="reference internal" href="#id3">I2C设备驱动层匹配流程</a></li>
<li><a class="reference internal" href="#i2capi">I2C总线核心层API调用实例</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wugn_note</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>README</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="readme">
<h1>README<a class="headerlink" href="#readme" title="此标题的永久链接"></a></h1>
<p>linux i2c子系统学习。</p>
</section>
<section id="refers">
<h1>refers<a class="headerlink" href="#refers" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.csdn.net/thisway_diy/article/details/119906746">Linux系统驱动之I2C_Adapter驱动框架讲解与编写</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/m0_72904998/article/details/127358633">iic（i2c）系统笔记</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/weixin_33755649/article/details/91871193">Kernel I2C子系统</a></p></li>
</ul>
</section>
<section id="i2c">
<h1>I2C协议<a class="headerlink" href="#i2c" title="此标题的永久链接"></a></h1>
<p>i2c是一种两线式串行总线，是半双工同步通信。</p>
<p>I2C总线由两根信号线组成，一条是时钟信号线SCL，一条是数据信号线SDA。一条I2C总线可以接多个设备，每个设备都接入I2C总线的SCL和SDA。I2C总线是主从模式的总线架构，每个设备都可以作为主设备，其他设备作为从设备，但是同一时刻只能有一个主设备。其物理总线拓扑图如下：</p>
<p><img alt="0003_0000.png" src="../../../_images/0003_00006.png" /></p>
<p>总线协议：</p>
<p>（1）起始条件（边沿触发）：当SCL总线处于高电平时，SDA总线从高电平到低电平的跳变触发一次传输的开始条件。</p>
<p>（2）结束条件（边沿触发）：当SCL总线处于高电平时，SDA总线从低电平到高电平的跳变触发一次传输的结束条件。</p>
<p>起始和结束的时序图如下：</p>
<p><img alt="0003_0001.png" src="../../../_images/0003_00014.png" /></p>
<p>（3）数据传输格式：</p>
<p>起始条件触发之后，SCL处于高电平时，检测SDA总线的高低电平值1和0，SCL处于低电平时，SDA高低电平跳变切换数据1和0。</p>
<p>SDA的数据传输以8bit（一个字节）为单位，每个字节传输之后都跟随一个bit的ACK位。起始条件之后的第一个字节应该是地址字段（包含7bit的地址+1bit的R/W位），随后是8bit为单位的数据，数据可以无限制的多次发送。注意，地址字节和每个数据字节之后都跟随一个bit的ACK位。</p>
<p>I2C总线的数据格式如下：</p>
<p><img alt="0003_0002.png" src="../../../_images/0003_00026.png" /></p>
<p>I2C的传输数据时序图如下：</p>
<p><img alt="0003_0003.png" src="../../../_images/0003_00036.png" />
<img alt="0003_0004.png" src="../../../_images/0003_00044.png" /></p>
</section>
<section id="id1">
<h1>I2C子系统框架<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>Kernel中I2C总线框架分为三层：I2C总线核心层，I2C总线控制器驱动层，I2C设备驱动层。</p>
<p>（1）总线核心层(i2c-core)：这是I2C的核心框架层，定义了I2C核心的数据结构，提供了I2C控制器，I2C设备和驱动的注册/注销框架，并提供了设备数据传输接口。如下：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>//控制器注册注销接口：
int i2c_add_adapter(struct i2c_adapter *adapter)；
									void i2c_del_adapter(struct i2c_adapter *adap)；
//设备驱动注册注销接口：
int i2c_register_driver(struct module *owner, struct i2c_driver *driver)；
										void i2c_del_driver(struct i2c_driver *driver)；
//数据传输接口：
int i2c_transfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num)；
int i2c_master_send(const struct i2c_client *client, const char *buf, int count)；
int i2c_master_recv(const struct i2c_client *client, char *buf, int count)；
</pre></div>
</div>
<p>（2）控制器驱动层(i2c-adapter)：由 i2c_adapter 结构描述了某个具体的I2C总线控制器特性，并通过 i2c_algorithm 结构提供了I2C总线周期的开始，停止，数据发送和接收等方法。同一个i2c_algorithm可以提供给多个 i2c_adapter 使用，i2c_adapter在注册的同时，会去（通过设备树配置或者老式的platform相关的硬编码）轮询该i2c总线下的所有i2c设备，并创建对应的 i2c_client 设备。换句话说，注册一个i2c_adapter，该总线下的所有从设备都会被注册到 i2c_bus_type下。</p>
<p>（3）设备驱动层(i2c-driver)：由 i2c_driver 结构表示，用于表示各个具体从设备的驱动，跟 i2c_client 绑定，通过 i2c_client 关联的 adapter的algorithm实现具体从设备的通信协议。
遵循kernel设备驱动框架，i2c_bus_type总线下挂 i2c_driver 和 i2c_client，注册 i2c_driver 的时候，会去轮询 i2c_bus_type 总线下的所有 i2c_client 设备，调用 bus 的 match（）方法，匹配后，调用 i2c_driver 的probe（）方法并关联该 i2c_client。在注册 i2c_adapter 同时，扫描注册该总线下所有的 i2c_client的时候，调用 bus 的match（）方法匹配 i2c_bus_type 总线下的 i2c_driver 驱动后，在调用 i2c_driver的probe（）方法并关联该 i2c_driver。</p>
<p><img alt="0003_0005.png" src="../../../_images/0003_00054.png" /></p>
<ul class="simple">
<li><p>简化版：</p></li>
</ul>
<p><img alt="0003_0006.png" src="../../../_images/0003_00063.png" /></p>
</section>
<section id="id2">
<h1>I2C设备控制器注册<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<p>先看一下重要结构体：</p>
<ul class="simple">
<li><p>i2c_adpater的核心是i2c_algorithm</p></li>
<li><p>i2c_algorithm的核心是master_xfer函数</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_algorithm</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* If an adapter algorithm can&#39;t do I2C-level access, set master_xfer</span>
<span class="cm">	   to NULL. If an adapter algorithm can do SMBus access, set</span>
<span class="cm">	   smbus_xfer. If set to NULL, the SMBus protocol is simulated</span>
<span class="cm">	   using common I2C messages */</span><span class="w"></span>
<span class="w">	</span><span class="cm">/* master_xfer should return the number of messages successfully</span>
<span class="cm">	   processed, or a negative value on error */</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">master_xfer</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adap</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_msg</span><span class="w"> </span><span class="o">*</span><span class="n">msgs</span><span class="p">,</span><span class="w"></span>
<span class="w">			   </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">smbus_xfer</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adap</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"></span>
<span class="w">			   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">read_write</span><span class="p">,</span><span class="w"></span>
<span class="w">			   </span><span class="n">u8</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">i2c_smbus_data</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* To determine what the adapter supports */</span><span class="w"></span>
<span class="w">	</span><span class="n">u32</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">functionality</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_adapter</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"></span>

<span class="cp">#if IS_ENABLED(CONFIG_I2C_SLAVE)</span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">reg_slave</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_client</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unreg_slave</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_client</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">i2c_adapter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">class</span><span class="p">;</span><span class="w">		  </span><span class="cm">/* classes to allow probing for */</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_algorithm</span><span class="w"> </span><span class="o">*</span><span class="n">algo</span><span class="p">;</span><span class="w"> </span><span class="cm">/* the algorithm to access the bus */</span><span class="w"></span>
<span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">algo_data</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="cm">/* data fields that are valid for all devices	*/</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_lock_operations</span><span class="w"> </span><span class="o">*</span><span class="n">lock_ops</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex</span><span class="w"> </span><span class="n">bus_lock</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex</span><span class="w"> </span><span class="n">mux_lock</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span><span class="w">			</span><span class="cm">/* in jiffies */</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">retries</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w">		</span><span class="cm">/* the adapter device */</span><span class="w"></span>

<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">completion</span><span class="w"> </span><span class="n">dev_released</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">userspace_clients_lock</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">userspace_clients</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_bus_recovery_info</span><span class="w"> </span><span class="o">*</span><span class="n">bus_recovery_info</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_adapter_quirks</span><span class="w"> </span><span class="o">*</span><span class="n">quirks</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">irq_domain</span><span class="w"> </span><span class="o">*</span><span class="n">host_notify_domain</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>i2c_algorithm各函数释义如下：</p>
<ul>
<li><p>master_xfer：这是最重要的函数，它实现了一般的I2C传输，用来传输一个或多个i2c_msg</p></li>
<li><p>master_xfer_atomic：
可选的函数，功能跟master_xfer一样，在atomic context环境下使用
比如在关机之前、所有中断都关闭的情况下，用来访问电源管理芯片</p></li>
<li><p>smbus_xfer：实现SMBus传输，如果不提供这个函数，SMBus传输会使用master_xfer来模拟</p></li>
<li><p>smbus_xfer_atomic：
可选的函数，功能跟smbus_xfer一样，在atomic context环境下使用
比如在关机之前、所有中断都关闭的情况下，用来访问电源管理芯片</p></li>
<li><p>functionality：返回所支持的flags：各类I2C_FUNC_*</p></li>
<li><p>reg_slave/unreg_slave：
有些I2C Adapter也可工作与Slave模式，用来实现或模拟一个I2C设备
reg_slave就是让把一个i2c_client注册到I2C Adapter，换句话说就是让这个I2C Adapter模拟该i2c_client</p></li>
<li><p>unreg_slave：反注册</p></li>
</ul>
</li>
</ul>
<p>以qcm2290为例：</p>
<ul class="simple">
<li><p>dts：</p></li>
</ul>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>scuba-qupv3.dtsi:
    qupv3_se0_i2c: i2c@4a80000 {
        compatible = &quot;qcom,i2c-geni&quot;;
        reg = &lt;0x4a80000 0x4000&gt;;
        #address-cells = &lt;1&gt;;
        #size-cells = &lt;0&gt;;
        interrupts = &lt;GIC_SPI 327 IRQ_TYPE_LEVEL_HIGH&gt;;
        clock-names = &quot;se-clk&quot;, &quot;m-ahb&quot;, &quot;s-ahb&quot;;
        clocks = &lt;&amp;gcc GCC_QUPV3_WRAP0_S0_CLK&gt;,
            &lt;&amp;gcc GCC_QUPV3_WRAP_0_M_AHB_CLK&gt;,
            &lt;&amp;gcc GCC_QUPV3_WRAP_0_S_AHB_CLK&gt;;
        pinctrl-names = &quot;default&quot;, &quot;sleep&quot;;
        pinctrl-0 = &lt;&amp;qupv3_se0_i2c_active&gt;;
        pinctrl-1 = &lt;&amp;qupv3_se0_i2c_sleep&gt;;
        dmas = &lt;&amp;gpi_dma0 0 0 3 64 0&gt;,
            &lt;&amp;gpi_dma0 1 0 3 64 0&gt;;
        dma-names = &quot;tx&quot;, &quot;rx&quot;;
        qcom,wrapper-core = &lt;&amp;qupv3_0&gt;;
        status = &quot;disabled&quot;;
    };

scuba-pinctrl.dtsi:
        qupv3_se0_i2c_pins: qupv3_se0_i2c_pins {
            qupv3_se0_i2c_active: qupv3_se0_i2c_active {
                mux {
                    pins = &quot;gpio0&quot;, &quot;gpio1&quot;;
                    function = &quot;qup0&quot;;
                };

                config {
                    pins = &quot;gpio0&quot;, &quot;gpio1&quot;;
                    drive-strength = &lt;2&gt;;
                    bias-pull-up;
                };
            };

            qupv3_se0_i2c_sleep: qupv3_se0_i2c_sleep {
                mux {
                    pins = &quot;gpio0&quot;, &quot;gpio1&quot;;
                    function = &quot;qup0&quot;;
                };

                config {
                    pins = &quot;gpio0&quot;, &quot;gpio1&quot;;
                    drive-strength = &lt;2&gt;;
                    bias-pull-up;
                };
            };
        };
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UM.9.15/kernel/msm-4.19/drivers/i2c/busses/i2c-qcom-geni.c</span></code>:</p></li>
<li><p>核心是probe函数，它要做这几件事：</p>
<ul>
<li><p>根据设备树信息设置硬件(引脚、时钟等)</p></li>
<li><p>分配、设置、注册i2c_apdater</p></li>
</ul>
</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define I2C_AUTO_SUSPEND_DELAY  250</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_algorithm</span><span class="w"> </span><span class="n">geni_i2c_algo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">master_xfer</span><span class="w">	</span><span class="o">=</span><span class="w"> </span><span class="n">geni_i2c_xfer</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">functionality</span><span class="w">	</span><span class="o">=</span><span class="w"> </span><span class="n">geni_i2c_func</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">geni_i2c_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">geni_i2c_dev</span><span class="w"> </span><span class="o">*</span><span class="n">gi2c</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">wrapper_pdev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device_node</span><span class="w"> </span><span class="o">*</span><span class="n">wrapper_ph_node</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">gi2c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gi2c</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gi2c</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arr_idx</span><span class="o">++</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_SE</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* Debug purpose */</span><span class="w"></span>
<span class="w">		</span><span class="n">gi2c_dev_dbg</span><span class="p">[</span><span class="n">arr_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gi2c</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="n">IORESOURCE_MEM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">wrapper_ph_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="s">&quot;qcom,wrapper-core&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">wrapper_ph_node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">wrapper_ph_node</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No wrapper core defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">wrapper_pdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">wrapper_ph_node</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">of_node_put</span><span class="p">(</span><span class="n">wrapper_ph_node</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">wrapper_pdev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">wrapper_pdev</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cannot retrieve wrapper device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">wrapper_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wrapper_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">wrapper_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wrapper_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geni_se_resources_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">,</span><span class="w"> </span><span class="n">I2C_CORE2X_VOTE</span><span class="p">,</span><span class="w"></span>
<span class="w">				     </span><span class="p">(</span><span class="n">DEFAULT_SE_CLK</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DEFAULT_BUS_WIDTH</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;geni_se_resources_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">ctrl_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">se_clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;se-clk&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">se_clk</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">se_clk</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Err getting SE Core clk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">m_ahb_clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;m-ahb&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">m_ahb_clk</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">m_ahb_clk</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Err getting M AHB clk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">s_ahb_clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;s-ahb&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">s_ahb_clk</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">s_ahb_clk</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Err getting S AHB clk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_ioremap_resource</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_pinctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_pinctrl_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_pinctrl</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No pinctrl config specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_pinctrl</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_gpio_active</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">		</span><span class="n">pinctrl_lookup_state</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_pinctrl</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">PINCTRL_DEFAULT</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_gpio_active</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No default config specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_gpio_active</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_gpio_sleep</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">		</span><span class="n">pinctrl_lookup_state</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_pinctrl</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">PINCTRL_SLEEP</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_gpio_sleep</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No sleep config specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">geni_gpio_sleep</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">of_property_read_bool</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qcom,shared&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">is_shared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Multi-EE usecase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qcom,clk-freq-out&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="o">&amp;</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">clk_freq_out</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">clk_freq_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KHz</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bus frequency is set to %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">clk_freq_out</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;IRQ error for i2c-geni</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">geni_i2c_clk_map_idx</span><span class="p">(</span><span class="n">gi2c</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid clk frequency %d KHz: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">i2c_rsc</span><span class="p">.</span><span class="n">clk_freq_out</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_set_mask_and_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_set_mask_and_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;could not set DMA mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">algo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">geni_i2c_algo</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">xfer</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="n">gi2c</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_request_irq</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">geni_i2c_irq</span><span class="p">,</span><span class="w"></span>
<span class="w">			       </span><span class="n">IRQF_TRIGGER_HIGH</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;i2c_geni&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gi2c</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Request_irq failed:%d: err:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">				   </span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">disable_irq</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">,</span><span class="w"> </span><span class="n">gi2c</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">strlcpy</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Geni-I2C&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">name</span><span class="p">));</span><span class="w"></span>

<span class="w">	</span><span class="n">pm_runtime_set_suspended</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">I2C_AUTO_SUSPEND_DELAY</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">dev_err</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Add adapter failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">dev_dbg</span><span class="p">(</span><span class="n">gi2c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;I2C probed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id3">
<h1>I2C设备驱动层匹配流程<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<p>device目前都是以dts形式呈现，如下：</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span>&amp;qupv3_se0_i2c {
    status = &quot;okay&quot;;
    cw2017@63 {
        status = &quot;okay&quot;;
        compatible = &quot;xxx,cw2017&quot;;
        reg = &lt;0x63&gt;;
    };
};
</pre></div>
</div>
<p>具体匹配方式可以参考：</p>
<ul class="simple">
<li><p><span class="xref myst">0028_platform_i2c_driver_probe匹配devices及调用流程.md</span></p></li>
</ul>
</section>
<section id="i2capi">
<h1>I2C总线核心层API调用实例<a class="headerlink" href="#i2capi" title="此标题的永久链接"></a></h1>
<p>驱动用的是smbus协议，兼容i2c，用i2c_smbus_read_i2c_block_data接口比用i2c接口简单高效。但是smbus最大的clock频率为100KHz，而i2c可以支持400KHz或2MHz。</p>
<p>smbus可参考之前写的，这个平台貌似也没定义该协议：</p>
<ul class="simple">
<li><p><span class="xref myst">0022_I2C驱动编程SMBUS介绍.md</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">i2c_core_smbbus.c</span></code>qcom并没有注册<code class="docutils literal notranslate"><span class="pre">adapter-&gt;algo-&gt;smbus_xfer</span></code>接口，所以根据释义还是调用的<code class="docutils literal notranslate"><span class="pre">dapter-&gt;algo-&gt;master_xfer</span></code>:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">s32</span><span class="w"> </span><span class="nf">__i2c_smbus_xfer</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_adapter</span><span class="w"> </span><span class="o">*</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"></span>
<span class="w">		     </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">read_write</span><span class="p">,</span><span class="w"></span>
<span class="w">		     </span><span class="n">u8</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">i2c_smbus_data</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo</span><span class="o">-&gt;</span><span class="n">smbus_xfer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="cm">/* Retry automatically on arbitration loss */</span><span class="w"></span>
<span class="w">		</span><span class="n">orig_jiffies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jiffies</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">;</span><span class="w"> </span><span class="n">try</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo</span><span class="o">-&gt;</span><span class="n">smbus_xfer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">read_write</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"></span>
<span class="w">							</span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="w"></span>
<span class="w">				       </span><span class="n">orig_jiffies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">))</span><span class="w"></span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo</span><span class="o">-&gt;</span><span class="n">master_xfer</span><span class="p">)</span><span class="c1">//:EOPNOTSUPP: Operation not supported</span>
<span class="w">			</span><span class="k">goto</span><span class="w"> </span><span class="n">trace</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="cm">/*</span>
<span class="cm">		 * Fall back to i2c_smbus_xfer_emulated if the adapter doesn&#39;t</span>
<span class="cm">		 * implement native support for the SMBus operation.</span>
<span class="cm">		 */</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

</pre></div>
</div>
<ul class="simple">
<li><p>驱动实例如下：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/i2c.h&gt;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">batt_info</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_client</span><span class="w"> </span><span class="o">*</span><span class="n">i2c_client</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/*Define CW2017 iic read function*/</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cw_read</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_client</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_batt_info</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">try_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_batt_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">try_cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_smbus_read_i2c_block_data</span><span class="p">(</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">cw2017_set_i2c_fault_status</span><span class="p">();</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">BAT_MONITOR_ERR</span><span class="p">(</span><span class="s">&quot;read reg: %x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">cw2017_reset_i2c_fault_cnt</span><span class="p">();</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_batt_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cm">/*Define CW2017 iic write function*/</span><span class="w">		</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cw_write</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">buf</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_client</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_batt_info</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">try_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_batt_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">try_cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">cw2017_set_i2c_fault_status</span><span class="p">();</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">BAT_MONITOR_ERR</span><span class="p">(</span><span class="s">&quot;write reg: %x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reg</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">		</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="n">cw2017_reset_i2c_fault_cnt</span><span class="p">();</span><span class="w"></span>
<span class="w">			</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="w">	</span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_batt_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cw2017_i2c_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_client</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">id</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">batt_info</span><span class="w"> </span><span class="o">*</span><span class="n">batt_info</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">c_devno</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">c_dev</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">class</span><span class="w"> </span><span class="o">*</span><span class="n">bat_class</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cw2017_i2c_probe enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">batt_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">batt_info</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);;</span><span class="w"></span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">batt_info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">BAT_MONITOR_ERR</span><span class="p">(</span><span class="s">&quot;kzmalloc batt info failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">g_batt_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batt_info</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="n">g_batt_info</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">of_device_id</span><span class="w"> </span><span class="n">cw2017_match_table</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">{.</span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;xxx,cw2017&quot;</span><span class="p">,},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_device_id</span><span class="w"> </span><span class="n">cw2017_i2c_id</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="n">CW2017_DEVICE_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">{</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_driver</span><span class="w"> </span><span class="n">cw2017_i2c_driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CW2017_DEVICE_NAME</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="p">.</span><span class="n">of_match_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cw2017_match_table</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">},</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">probe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cw2017_i2c_probe</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">remove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cw2017_i2c_remove</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="p">.</span><span class="n">id_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cw2017_i2c_id</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>


<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">cw2017_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cw2017_i2c_driver</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">module_init</span><span class="p">(</span><span class="n">cw2017_init</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>


           </div>
             <div class="articleComments">
                <comments>
  <script src="https://utteranc.es/client.js"
    repo="iswbm/magic-python"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</comments>
             </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, wugn.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>